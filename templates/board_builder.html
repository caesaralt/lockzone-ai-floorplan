<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loxone Board Builder - {{ project_name | default('New Board') }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e14;
            overflow: hidden;
            color: #ecf0f1;
        }

        .top-toolbar {
            background: linear-gradient(135deg, #1a252f 0%, #0f1419 100%);
            padding: 10px 20px;
            border-bottom: 2px solid #e74c3c;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .project-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #e74c3c;
        }

        .toolbar-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border: 2px solid transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .toolbar-btn:hover {
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            border-color: #e74c3c;
            transform: translateY(-1px);
        }

        .toolbar-btn.ai {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }

        .toolbar-btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .toolbar-btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 280px;
            background: #16213e;
            border-right: 2px solid #2c3e50;
            overflow-y: auto;
            padding: 15px;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 0.9em;
            color: #95a5a6;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .component-btn {
            width: 100%;
            padding: 12px;
            background: #2c3e50;
            border: 2px solid #34495e;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .component-btn:hover {
            background: #34495e;
            border-color: #e74c3c;
            transform: translateX(5px);
        }

        .component-btn.active {
            background: #e74c3c;
            border-color: #e74c3c;
        }

        .component-icon {
            font-size: 1.5em;
            min-width: 30px;
            text-align: center;
        }

        .board-canvas {
            flex: 1;
            position: relative;
            background: #0f1419;
            overflow: auto;
        }

        .board-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: auto;
        }

        .board-grid {
            position: absolute;
            width: 3000px;
            height: 2000px;
            background-image:
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .board-component {
            position: absolute;
            background: #2c3e50;
            border: 3px solid #34495e;
            border-radius: 8px;
            padding: 15px;
            cursor: move;
            transition: all 0.2s;
            min-width: 120px;
            color: white;
        }

        .board-component:hover {
            border-color: #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
            z-index: 10;
        }

        .board-component.selected {
            border-color: #e74c3c;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
            z-index: 20;
        }

        .component-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .component-body {
            font-size: 0.85em;
            color: #bdc3c7;
        }

        .component-port {
            width: 12px;
            height: 12px;
            background: #3498db;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            transition: all 0.2s;
        }

        .component-port:hover {
            background: #e74c3c;
            transform: scale(1.3);
        }

        .component-port.input {
            left: -8px;
        }

        .component-port.output {
            right: -8px;
        }

        .wire {
            position: absolute;
            pointer-events: none;
        }

        .wire-line {
            stroke: #3498db;
            stroke-width: 3;
            fill: none;
        }

        .wire-line.selected {
            stroke: #e74c3c;
            stroke-width: 4;
        }

        .properties-panel {
            width: 300px;
            background: #16213e;
            border-left: 2px solid #2c3e50;
            padding: 15px;
            overflow-y: auto;
        }

        .properties-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .property-group {
            margin-bottom: 15px;
        }

        .property-label {
            font-size: 0.85em;
            color: #95a5a6;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .property-input {
            width: 100%;
            padding: 8px;
            background: #2c3e50;
            border: 2px solid #34495e;
            color: white;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .property-input:focus {
            outline: none;
            border-color: #e74c3c;
        }

        .property-select {
            width: 100%;
            padding: 8px;
            background: #2c3e50;
            border: 2px solid #34495e;
            color: white;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a252f;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #e74c3c;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #e74c3c;
        }

        .close-btn {
            background: #e74c3c;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
        }

        .import-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .import-card {
            background: #2c3e50;
            border: 2px solid #34495e;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .import-card:hover {
            border-color: #e74c3c;
            transform: translateY(-3px);
        }

        .import-card-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .import-card-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .import-card-desc {
            font-size: 0.85em;
            color: #95a5a6;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #e74c3c;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-bar {
            background: #16213e;
            border-top: 2px solid #2c3e50;
            padding: 10px 20px;
            display: flex;
            gap: 30px;
            font-size: 0.85em;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #95a5a6;
        }

        .stat-value {
            color: #e74c3c;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Top Toolbar -->
    <div class="top-toolbar">
        <div class="toolbar-left">
            <div class="project-title">üîå {{ project_name | default('Loxone Board Builder') }}</div>
            <button class="toolbar-btn" onclick="newBoard()">üÜï New Board</button>
            <button class="toolbar-btn" onclick="openImportModal()">üì• Import Data</button>
            <button class="toolbar-btn ai" onclick="generateBoardWithAI()">ü§ñ AI Generate Board</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="toolbar-btn" onclick="window.location.href='/'">üè† Home</button>
            <button class="toolbar-btn" onclick="window.location.href='/mapping'">‚ö° Mapping</button>
            <button class="toolbar-btn" onclick="window.location.href='/canvas'">üé® Canvas</button>
            <button class="toolbar-btn" onclick="saveBoard()">üíæ Save</button>
            <button class="toolbar-btn" onclick="loadBoard()">üìÇ Load</button>
            <button class="toolbar-btn success" onclick="exportBoard()">üì§ Export</button>
            <button class="toolbar-btn danger" onclick="clearBoard()">üóëÔ∏è Clear</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Component Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Loxone Controllers</div>
                <button class="component-btn" onclick="selectComponent('miniserver', 'üè¢', 'Miniserver Gen 2')">
                    <span class="component-icon">üè¢</span>
                    <span>Miniserver Gen 2</span>
                </button>
                <button class="component-btn" onclick="selectComponent('miniserver-go', 'üì¶', 'Miniserver Go')">
                    <span class="component-icon">üì¶</span>
                    <span>Miniserver Go</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Extensions</div>
                <button class="component-btn" onclick="selectComponent('extension', 'üîå', 'Extension')">
                    <span class="component-icon">üîå</span>
                    <span>Extension</span>
                </button>
                <button class="component-btn" onclick="selectComponent('relay-extension', 'üîÑ', 'Relay Extension')">
                    <span class="component-icon">üîÑ</span>
                    <span>Relay Extension</span>
                </button>
                <button class="component-btn" onclick="selectComponent('dimmer-extension', 'üí°', 'Dimmer Extension')">
                    <span class="component-icon">üí°</span>
                    <span>Dimmer Extension</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Input/Output Modules</div>
                <button class="component-btn" onclick="selectComponent('digital-input', 'üì•', 'Digital Input')">
                    <span class="component-icon">üì•</span>
                    <span>Digital Input</span>
                </button>
                <button class="component-btn" onclick="selectComponent('analog-input', 'üìä', 'Analog Input')">
                    <span class="component-icon">üìä</span>
                    <span>Analog Input</span>
                </button>
                <button class="component-btn" onclick="selectComponent('relay-output', 'üîå', 'Relay Output')">
                    <span class="component-icon">üîå</span>
                    <span>Relay Output</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Communication</div>
                <button class="component-btn" onclick="selectComponent('tree-cable', 'üå≥', 'Tree Cable')">
                    <span class="component-icon">üå≥</span>
                    <span>Tree Cable</span>
                </button>
                <button class="component-btn" onclick="selectComponent('power-supply', '‚ö°', 'Power Supply 24V')">
                    <span class="component-icon">‚ö°</span>
                    <span>Power Supply 24V</span>
                </button>
                <button class="component-btn" onclick="selectComponent('network-cable', 'üîó', 'Network Cable')">
                    <span class="component-icon">üîó</span>
                    <span>Network Cable</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Specialized Modules</div>
                <button class="component-btn" onclick="selectComponent('air-base', 'üå°Ô∏è', 'Air Base Extension')">
                    <span class="component-icon">üå°Ô∏è</span>
                    <span>Air Base Extension</span>
                </button>
                <button class="component-btn" onclick="selectComponent('dmx-extension', 'üé≠', 'DMX Extension')">
                    <span class="component-icon">üé≠</span>
                    <span>DMX Extension</span>
                </button>
                <button class="component-btn" onclick="selectComponent('modbus', 'üì°', 'Modbus Extension')">
                    <span class="component-icon">üì°</span>
                    <span>Modbus Extension</span>
                </button>
            </div>
        </div>

        <!-- Board Canvas -->
        <div class="board-canvas">
            <div class="board-wrapper" id="boardWrapper">
                <div class="board-grid" id="boardGrid">
                    <svg id="wiresLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></svg>
                </div>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="properties-title">Component Properties</div>
            <div id="propertiesContent">
                <p style="color: #95a5a6; font-size: 0.9em;">Select a component to view properties</p>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-label">Components:</span>
            <span class="stat-value" id="componentCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Connections:</span>
            <span class="stat-value" id="connectionCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Estimated Cost:</span>
            <span class="stat-value" id="estimatedCost">‚Ç¨0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Power Consumption:</span>
            <span class="stat-value" id="powerConsumption">0W</span>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì• Import Data</div>
                <button class="close-btn" onclick="closeImportModal()">‚úñ</button>
            </div>
            <div class="import-section">
                <div class="import-card" onclick="importFromMapping()">
                    <div class="import-card-icon">‚ö°</div>
                    <div class="import-card-title">Import from Mapping</div>
                    <div class="import-card-desc">Import electrical components from the mapping tool</div>
                </div>
                <div class="import-card" onclick="importFromCanvas()">
                    <div class="import-card-icon">üé®</div>
                    <div class="import-card-title">Import from Canvas</div>
                    <div class="import-card-desc">Import automation data from the canvas editor</div>
                </div>
                <div class="import-card" onclick="importFromFile()">
                    <div class="import-card-icon">üìÅ</div>
                    <div class="import-card-title">Import from File</div>
                    <div class="import-card-desc">Load a previously saved board configuration</div>
                </div>
            </div>
            <div style="margin-top: 20px;">
                <label style="display: block; margin-bottom: 10px; color: #95a5a6; font-size: 0.9em;">Or paste session ID:</label>
                <input type="text" id="sessionIdInput" placeholder="Enter session ID from Mapping or Canvas" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px; margin-bottom: 10px;">
                <button class="toolbar-btn" style="width: 100%;" onclick="importFromSessionId()">Import from Session ID</button>
            </div>
        </div>
    </div>

    <!-- AI Generation Modal -->
    <div class="modal" id="aiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ü§ñ AI Board Generator</div>
                <button class="close-btn" onclick="closeAIModal()">‚úñ</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; color: #95a5a6; font-size: 0.9em;">Describe your automation requirements:</label>
                <textarea id="aiRequirements" rows="6" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px; font-size: 0.9em; resize: vertical;" placeholder="Example: I need a board for a 3-bedroom house with lighting control in all rooms, HVAC control, blinds automation, and a security system with door sensors..."></textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; color: #95a5a6; font-size: 0.9em;">Automation Types:</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="lighting" checked>
                        <span>üí° Lighting Control</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="hvac" checked>
                        <span>üå°Ô∏è HVAC Control</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="blinds">
                        <span>ü™ü Blinds/Shading</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="security">
                        <span>üîí Security System</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="audio">
                        <span>üîä Audio System</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="energy">
                        <span>‚ö° Energy Management</span>
                    </label>
                </div>
            </div>
            <button class="toolbar-btn ai" style="width: 100%;" onclick="generateWithAI()">ü§ñ Generate Board with AI</button>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div style="font-size: 1.2em; font-weight: 600;">Generating your Loxone board...</div>
            <div style="margin-top: 10px; color: #95a5a6;">This may take a few moments</div>
        </div>
    </div>

    <script>
        console.log('üöÄ Board Builder initializing...');

        // Board state
        let boardComponents = [];
        let boardConnections = [];
        let selectedComponent = null;
        let pendingComponentType = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let componentIdCounter = 0;
        let isConnecting = false;
        let connectionStart = null;

        // Component specifications and pricing
        const COMPONENT_SPECS = {
            'miniserver': {
                name: 'Miniserver Gen 2',
                icon: 'üè¢',
                color: '#e74c3c',
                cost: 1890,
                power: 15,
                inputs: 16,
                outputs: 14,
                width: 200,
                height: 120
            },
            'miniserver-go': {
                name: 'Miniserver Go',
                icon: 'üì¶',
                color: '#e67e22',
                cost: 990,
                power: 8,
                inputs: 8,
                outputs: 6,
                width: 180,
                height: 100
            },
            'extension': {
                name: 'Extension',
                icon: 'üîå',
                color: '#3498db',
                cost: 590,
                power: 5,
                inputs: 12,
                outputs: 10,
                width: 160,
                height: 90
            },
            'relay-extension': {
                name: 'Relay Extension',
                icon: 'üîÑ',
                color: '#27ae60',
                cost: 450,
                power: 3,
                outputs: 11,
                width: 150,
                height: 80
            },
            'dimmer-extension': {
                name: 'Dimmer Extension',
                icon: 'üí°',
                color: '#f39c12',
                cost: 650,
                power: 4,
                outputs: 8,
                width: 150,
                height: 80
            },
            'digital-input': {
                name: 'Digital Input',
                icon: 'üì•',
                color: '#9b59b6',
                cost: 180,
                power: 1,
                inputs: 16,
                width: 120,
                height: 70
            },
            'analog-input': {
                name: 'Analog Input',
                icon: 'üìä',
                color: '#8e44ad',
                cost: 220,
                power: 1,
                inputs: 4,
                width: 120,
                height: 70
            },
            'relay-output': {
                name: 'Relay Output',
                icon: 'üîå',
                color: '#16a085',
                cost: 150,
                power: 1,
                outputs: 8,
                width: 120,
                height: 70
            },
            'tree-cable': {
                name: 'Tree Cable',
                icon: 'üå≥',
                color: '#95a5a6',
                cost: 3.5,
                power: 0,
                width: 100,
                height: 60
            },
            'power-supply': {
                name: 'Power Supply 24V',
                icon: '‚ö°',
                color: '#e74c3c',
                cost: 120,
                power: 0,
                outputs: 2,
                width: 140,
                height: 80
            },
            'network-cable': {
                name: 'Network Cable',
                icon: 'üîó',
                color: '#34495e',
                cost: 2.5,
                power: 0,
                width: 100,
                height: 60
            },
            'air-base': {
                name: 'Air Base Extension',
                icon: 'üå°Ô∏è',
                color: '#1abc9c',
                cost: 790,
                power: 4,
                inputs: 6,
                width: 150,
                height: 80
            },
            'dmx-extension': {
                name: 'DMX Extension',
                icon: 'üé≠',
                color: '#e91e63',
                cost: 490,
                power: 3,
                outputs: 4,
                width: 140,
                height: 75
            },
            'modbus': {
                name: 'Modbus Extension',
                icon: 'üì°',
                color: '#00bcd4',
                cost: 590,
                power: 3,
                width: 140,
                height: 75
            }
        };

        // Initialize board
        function initBoard() {
            console.log('‚úÖ Board initialized');
            updateStats();

            // Make board draggable
            const boardWrapper = document.getElementById('boardWrapper');
            boardWrapper.addEventListener('mousedown', handleBoardMouseDown);
            document.addEventListener('mousemove', handleBoardMouseMove);
            document.addEventListener('mouseup', handleBoardMouseUp);

            // Click to place component
            document.getElementById('boardGrid').addEventListener('click', handleBoardClick);
        }

        // Component selection
        function selectComponent(type, icon, name) {
            pendingComponentType = type;
            console.log(`Selected component type: ${type}`);

            // Highlight the selected button
            document.querySelectorAll('.component-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.component-btn').classList.add('active');
        }

        // Handle board click to place component
        function handleBoardClick(e) {
            if (!pendingComponentType) return;

            const rect = document.getElementById('boardGrid').getBoundingClientRect();
            const x = e.clientX - rect.left + document.getElementById('boardWrapper').scrollLeft;
            const y = e.clientY - rect.top + document.getElementById('boardWrapper').scrollTop;

            addComponentToBoard(pendingComponentType, x, y);
            pendingComponentType = null;

            // Remove active state from buttons
            document.querySelectorAll('.component-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // Add component to board
        function addComponentToBoard(type, x, y, properties = {}) {
            const spec = COMPONENT_SPECS[type];
            if (!spec) return;

            const component = {
                id: `comp-${componentIdCounter++}`,
                type: type,
                x: x,
                y: y,
                properties: {
                    name: properties.name || spec.name,
                    serialNumber: properties.serialNumber || '',
                    notes: properties.notes || '',
                    ...properties
                }
            };

            boardComponents.push(component);
            renderComponent(component);
            updateStats();

            console.log(`Added component: ${component.id} at (${x}, ${y})`);
        }

        // Render component on board
        function renderComponent(component) {
            const spec = COMPONENT_SPECS[component.type];
            const div = document.createElement('div');
            div.className = 'board-component';
            div.id = component.id;
            div.style.left = component.x + 'px';
            div.style.top = component.y + 'px';
            div.style.width = spec.width + 'px';
            div.style.borderColor = spec.color;

            div.innerHTML = `
                <div class="component-header">
                    <span style="font-size: 1.5em;">${spec.icon}</span>
                    <span>${component.properties.name}</span>
                </div>
                <div class="component-body">
                    ${spec.inputs ? `üì• ${spec.inputs} inputs` : ''}
                    ${spec.outputs ? `üì§ ${spec.outputs} outputs` : ''}
                    ${spec.cost ? `<div style="margin-top: 5px;">‚Ç¨${spec.cost}</div>` : ''}
                </div>
            `;

            div.addEventListener('mousedown', (e) => handleComponentMouseDown(e, component.id));
            div.addEventListener('click', (e) => {
                e.stopPropagation();
                selectBoardComponent(component.id);
            });

            // Add connection ports
            if (spec.inputs) {
                for (let i = 0; i < Math.min(spec.inputs, 4); i++) {
                    const port = document.createElement('div');
                    port.className = 'component-port input';
                    port.style.top = (20 + i * 20) + 'px';
                    port.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handlePortClick(component.id, 'input', i);
                    });
                    div.appendChild(port);
                }
            }

            if (spec.outputs) {
                for (let i = 0; i < Math.min(spec.outputs, 4); i++) {
                    const port = document.createElement('div');
                    port.className = 'component-port output';
                    port.style.top = (20 + i * 20) + 'px';
                    port.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handlePortClick(component.id, 'output', i);
                    });
                    div.appendChild(port);
                }
            }

            document.getElementById('boardGrid').appendChild(div);
        }

        // Handle port click for connections
        function handlePortClick(componentId, portType, portIndex) {
            console.log(`Port clicked: ${componentId}, ${portType}, ${portIndex}`);

            if (!isConnecting) {
                // Start connection
                isConnecting = true;
                connectionStart = { componentId, portType, portIndex };
                console.log('Connection started');
            } else {
                // Complete connection
                if (connectionStart.componentId !== componentId) {
                    const connection = {
                        id: `conn-${Date.now()}`,
                        from: connectionStart,
                        to: { componentId, portType, portIndex }
                    };
                    boardConnections.push(connection);
                    renderConnection(connection);
                    console.log('Connection created:', connection);
                }
                isConnecting = false;
                connectionStart = null;
                updateStats();
            }
        }

        // Render connection wire
        function renderConnection(connection) {
            const fromComp = document.getElementById(connection.from.componentId);
            const toComp = document.getElementById(connection.to.componentId);

            if (!fromComp || !toComp) return;

            const fromRect = fromComp.getBoundingClientRect();
            const toRect = toComp.getBoundingClientRect();
            const gridRect = document.getElementById('boardGrid').getBoundingClientRect();

            const x1 = fromRect.right - gridRect.left;
            const y1 = fromRect.top - gridRect.top + 20 + connection.from.portIndex * 20;
            const x2 = toRect.left - gridRect.left;
            const y2 = toRect.top - gridRect.top + 20 + connection.to.portIndex * 20;

            const svg = document.getElementById('wiresLayer');
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'wire-line');
            path.setAttribute('d', `M ${x1} ${y1} C ${(x1+x2)/2} ${y1}, ${(x1+x2)/2} ${y2}, ${x2} ${y2}`);
            path.setAttribute('data-connection-id', connection.id);
            svg.appendChild(path);
        }

        // Component dragging
        function handleComponentMouseDown(e, componentId) {
            if (e.target.classList.contains('component-port')) return;

            e.stopPropagation();
            isDragging = true;
            selectedComponent = componentId;

            const comp = document.getElementById(componentId);
            const rect = comp.getBoundingClientRect();
            const gridRect = document.getElementById('boardGrid').getBoundingClientRect();

            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            selectBoardComponent(componentId);
        }

        function handleBoardMouseDown(e) {
            if (e.target === e.currentTarget || e.target.id === 'boardGrid') {
                deselectAllComponents();
            }
        }

        function handleBoardMouseMove(e) {
            if (!isDragging || !selectedComponent) return;

            const comp = document.getElementById(selectedComponent);
            const gridRect = document.getElementById('boardGrid').getBoundingClientRect();

            const x = e.clientX - gridRect.left + document.getElementById('boardWrapper').scrollLeft - dragOffset.x;
            const y = e.clientY - gridRect.top + document.getElementById('boardWrapper').scrollTop - dragOffset.y;

            comp.style.left = Math.max(0, x) + 'px';
            comp.style.top = Math.max(0, y) + 'px';

            // Update component data
            const compData = boardComponents.find(c => c.id === selectedComponent);
            if (compData) {
                compData.x = Math.max(0, x);
                compData.y = Math.max(0, y);
            }

            // Redraw connections
            redrawAllConnections();
        }

        function handleBoardMouseUp() {
            isDragging = false;
        }

        // Select/deselect components
        function selectBoardComponent(componentId) {
            deselectAllComponents();

            const comp = document.getElementById(componentId);
            comp.classList.add('selected');
            selectedComponent = componentId;

            const compData = boardComponents.find(c => c.id === componentId);
            if (compData) {
                showComponentProperties(compData);
            }
        }

        function deselectAllComponents() {
            document.querySelectorAll('.board-component').forEach(comp => {
                comp.classList.remove('selected');
            });
            selectedComponent = null;
            showComponentProperties(null);
        }

        // Show component properties
        function showComponentProperties(component) {
            const panel = document.getElementById('propertiesContent');

            if (!component) {
                panel.innerHTML = '<p style="color: #95a5a6; font-size: 0.9em;">Select a component to view properties</p>';
                return;
            }

            const spec = COMPONENT_SPECS[component.type];

            panel.innerHTML = `
                <div class="property-group">
                    <div class="property-label">Component Type</div>
                    <div style="color: white; font-weight: 600;">${spec.icon} ${spec.name}</div>
                </div>
                <div class="property-group">
                    <div class="property-label">Name</div>
                    <input type="text" class="property-input" value="${component.properties.name}"
                           onchange="updateComponentProperty('${component.id}', 'name', this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Serial Number</div>
                    <input type="text" class="property-input" value="${component.properties.serialNumber || ''}"
                           onchange="updateComponentProperty('${component.id}', 'serialNumber', this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Notes</div>
                    <textarea class="property-input" rows="3"
                              onchange="updateComponentProperty('${component.id}', 'notes', this.value)">${component.properties.notes || ''}</textarea>
                </div>
                <div class="property-group">
                    <div class="property-label">Specifications</div>
                    <div style="color: #bdc3c7; font-size: 0.85em;">
                        ${spec.inputs ? `<div>Inputs: ${spec.inputs}</div>` : ''}
                        ${spec.outputs ? `<div>Outputs: ${spec.outputs}</div>` : ''}
                        ${spec.cost ? `<div>Cost: ‚Ç¨${spec.cost}</div>` : ''}
                        ${spec.power ? `<div>Power: ${spec.power}W</div>` : ''}
                    </div>
                </div>
                <div class="property-group">
                    <button class="toolbar-btn danger" style="width: 100%;" onclick="deleteComponent('${component.id}')">
                        üóëÔ∏è Delete Component
                    </button>
                </div>
            `;
        }

        // Update component property
        function updateComponentProperty(componentId, property, value) {
            const comp = boardComponents.find(c => c.id === componentId);
            if (comp) {
                comp.properties[property] = value;
                console.log(`Updated ${property} for ${componentId}:`, value);

                // Update display if it's the name
                if (property === 'name') {
                    const compElement = document.getElementById(componentId);
                    const header = compElement.querySelector('.component-header span:last-child');
                    if (header) header.textContent = value;
                }
            }
        }

        // Delete component
        function deleteComponent(componentId) {
            if (!confirm('Delete this component?')) return;

            // Remove from array
            boardComponents = boardComponents.filter(c => c.id !== componentId);

            // Remove connections
            boardConnections = boardConnections.filter(conn =>
                conn.from.componentId !== componentId && conn.to.componentId !== componentId
            );

            // Remove from DOM
            const comp = document.getElementById(componentId);
            if (comp) comp.remove();

            // Redraw connections
            redrawAllConnections();
            updateStats();
            deselectAllComponents();

            console.log(`Deleted component: ${componentId}`);
        }

        // Redraw all connections
        function redrawAllConnections() {
            const svg = document.getElementById('wiresLayer');
            svg.innerHTML = '';
            boardConnections.forEach(conn => renderConnection(conn));
        }

        // Update statistics
        function updateStats() {
            document.getElementById('componentCount').textContent = boardComponents.length;
            document.getElementById('connectionCount').textContent = boardConnections.length;

            const totalCost = boardComponents.reduce((sum, comp) => {
                const spec = COMPONENT_SPECS[comp.type];
                return sum + (spec.cost || 0);
            }, 0);
            document.getElementById('estimatedCost').textContent = `‚Ç¨${totalCost.toFixed(2)}`;

            const totalPower = boardComponents.reduce((sum, comp) => {
                const spec = COMPONENT_SPECS[comp.type];
                return sum + (spec.power || 0);
            }, 0);
            document.getElementById('powerConsumption').textContent = `${totalPower}W`;
        }

        // Board operations
        function newBoard() {
            if (boardComponents.length > 0 && !confirm('Clear current board and start new?')) return;
            clearBoard();
        }

        function clearBoard() {
            if (boardComponents.length > 0 && !confirm('Are you sure you want to clear the board?')) return;

            boardComponents = [];
            boardConnections = [];
            document.getElementById('boardGrid').innerHTML = '<svg id="wiresLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></svg>';
            updateStats();
            deselectAllComponents();
            console.log('Board cleared');
        }

        function saveBoard() {
            const boardData = {
                components: boardComponents,
                connections: boardConnections,
                metadata: {
                    version: '1.0',
                    created: new Date().toISOString(),
                    projectName: '{{ project_name | default("Loxone Board") }}'
                }
            };

            // Save to localStorage
            const boardId = 'board_' + Date.now();
            localStorage.setItem(boardId, JSON.stringify(boardData));
            localStorage.setItem('lastBoardId', boardId);

            alert('‚úÖ Board saved successfully!');
            console.log('Board saved:', boardId);
        }

        function loadBoard() {
            const boardId = localStorage.getItem('lastBoardId');
            if (!boardId) {
                alert('No saved board found!');
                return;
            }

            const boardDataStr = localStorage.getItem(boardId);
            if (!boardDataStr) {
                alert('Error loading board!');
                return;
            }

            const boardData = JSON.parse(boardDataStr);

            // Clear current board
            clearBoard();

            // Load components
            boardData.components.forEach(comp => {
                boardComponents.push(comp);
                renderComponent(comp);
            });

            // Load connections
            boardData.connections.forEach(conn => {
                boardConnections.push(conn);
            });

            redrawAllConnections();
            updateStats();

            alert('‚úÖ Board loaded successfully!');
            console.log('Board loaded:', boardId);
        }

        function exportBoard() {
            const boardData = {
                components: boardComponents,
                connections: boardConnections,
                stats: {
                    componentCount: boardComponents.length,
                    connectionCount: boardConnections.length,
                    totalCost: boardComponents.reduce((sum, comp) => sum + (COMPONENT_SPECS[comp.type].cost || 0), 0),
                    totalPower: boardComponents.reduce((sum, comp) => sum + (COMPONENT_SPECS[comp.type].power || 0), 0)
                },
                metadata: {
                    version: '1.0',
                    exported: new Date().toISOString(),
                    projectName: '{{ project_name | default("Loxone Board") }}'
                }
            };

            // Create downloadable JSON file
            const blob = new Blob([JSON.stringify(boardData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loxone_board_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            console.log('Board exported');
        }

        // Import functionality
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        async function importFromMapping() {
            const sessionId = prompt('Enter Mapping session ID:');
            if (!sessionId) return;

            try {
                const response = await fetch(`/api/board-builder/import/mapping/${sessionId}`);
                const data = await response.json();

                if (data.success) {
                    applyImportedData(data.boardData);
                    closeImportModal();
                    alert(`‚úÖ Imported ${data.boardData.components.length} components from Mapping!`);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå Failed to import from Mapping');
            }
        }

        async function importFromCanvas() {
            const sessionId = prompt('Enter Canvas session ID:');
            if (!sessionId) return;

            try {
                const response = await fetch(`/api/board-builder/import/canvas/${sessionId}`);
                const data = await response.json();

                if (data.success) {
                    applyImportedData(data.boardData);
                    closeImportModal();
                    alert(`‚úÖ Imported ${data.boardData.components.length} components from Canvas!`);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå Failed to import from Canvas');
            }
        }

        function importFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const boardData = JSON.parse(event.target.result);
                        applyImportedData(boardData);
                        closeImportModal();
                        alert('‚úÖ Board imported successfully!');
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('‚ùå Invalid board file');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function importFromSessionId() {
            const sessionId = document.getElementById('sessionIdInput').value.trim();
            if (!sessionId) {
                alert('Please enter a session ID');
                return;
            }

            // Try mapping first, then canvas
            try {
                let response = await fetch(`/api/board-builder/import/mapping/${sessionId}`);
                let data = await response.json();

                if (data.success) {
                    applyImportedData(data.boardData);
                    closeImportModal();
                    alert(`‚úÖ Imported from Mapping session!`);
                    return;
                }

                // Try canvas
                response = await fetch(`/api/board-builder/import/canvas/${sessionId}`);
                data = await response.json();

                if (data.success) {
                    applyImportedData(data.boardData);
                    closeImportModal();
                    alert(`‚úÖ Imported from Canvas session!`);
                    return;
                }

                alert('‚ùå Session ID not found in Mapping or Canvas');
            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå Failed to import session');
            }
        }

        function applyImportedData(boardData) {
            if (boardData.components) {
                boardData.components.forEach(comp => {
                    boardComponents.push(comp);
                    renderComponent(comp);
                });
            }

            if (boardData.connections) {
                boardData.connections.forEach(conn => {
                    boardConnections.push(conn);
                });
                redrawAllConnections();
            }

            updateStats();
            console.log('Import applied:', boardData);
        }

        // AI Generation
        function generateBoardWithAI() {
            document.getElementById('aiModal').classList.add('active');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
        }

        async function generateWithAI() {
            const requirements = document.getElementById('aiRequirements').value.trim();

            if (!requirements) {
                alert('Please describe your automation requirements');
                return;
            }

            const automationTypes = Array.from(document.querySelectorAll('.ai-automation-type:checked'))
                .map(cb => cb.value);

            if (automationTypes.length === 0) {
                alert('Please select at least one automation type');
                return;
            }

            closeAIModal();
            document.getElementById('loadingOverlay').classList.add('active');

            try {
                const response = await fetch('/api/board-builder/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requirements: requirements,
                        automationTypes: automationTypes,
                        existingComponents: boardComponents
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Clear board if requested
                    if (confirm('Clear current board before generating new one?')) {
                        clearBoard();
                    }

                    // Apply AI-generated board
                    applyImportedData(data.boardData);
                    alert(`‚úÖ AI generated ${data.boardData.components.length} components!`);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('‚ùå Failed to generate board with AI');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        // Initialize on load
        initBoard();

        console.log('‚úÖ Board Builder ready');
    </script>

    <!-- AI Chatbot Component -->
    {% include 'chatbot_component.html' %}
</body>
</html>

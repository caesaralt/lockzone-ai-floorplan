<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Loxone Board Builder - {{ project_name | default('New Board') }}</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: #0a0e14;
            overflow: hidden;
            color: #ecf0f1;
        }

        .top-toolbar {
            background: linear-gradient(135deg, #1a252f 0%, #0f1419 100%);
            padding: 10px 20px;
            border-bottom: 2px solid #e74c3c;
            display: flex;
            align-items: center;
            justify-content: space-between;
            box-shadow: 0 4px 12px rgba(0,0,0,0.6);
        }

        .toolbar-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .project-title {
            font-size: 1.2em;
            font-weight: 700;
            color: #e74c3c;
        }

        .toolbar-btn {
            padding: 8px 16px;
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border: 2px solid transparent;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            font-size: 0.9em;
            font-weight: 600;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .toolbar-btn:hover {
            background: linear-gradient(135deg, #2c3e50 0%, #1a252f 100%);
            border-color: #e74c3c;
            transform: translateY(-1px);
        }

        .toolbar-btn.ai {
            background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%);
        }

        .toolbar-btn.success {
            background: linear-gradient(135deg, #27ae60 0%, #229954 100%);
        }

        .toolbar-btn.danger {
            background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%);
        }

        .main-container {
            display: flex;
            height: calc(100vh - 60px);
        }

        .sidebar {
            width: 280px;
            background: #16213e;
            border-right: 2px solid #2c3e50;
            overflow-y: auto;
            padding: 15px;
        }

        .sidebar-section {
            margin-bottom: 20px;
        }

        .sidebar-title {
            font-size: 0.9em;
            color: #95a5a6;
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .component-btn {
            width: 100%;
            padding: 12px;
            background: #2c3e50;
            border: 2px solid #34495e;
            color: white;
            border-radius: 6px;
            cursor: pointer;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 10px;
            transition: all 0.3s;
            font-size: 0.9em;
        }

        .component-btn:hover {
            background: #34495e;
            border-color: #e74c3c;
            transform: translateX(5px);
        }

        .component-btn.active {
            background: #e74c3c;
            border-color: #e74c3c;
        }

        .component-icon {
            font-size: 1.5em;
            min-width: 30px;
            text-align: center;
        }

        .board-canvas {
            flex: 1;
            position: relative;
            background: #0f1419;
            overflow: auto;
        }

        .board-wrapper {
            width: 100%;
            height: 100%;
            position: relative;
            overflow: auto;
        }

        .board-grid {
            position: absolute;
            width: 3000px;
            height: 2000px;
            background-image:
                linear-gradient(rgba(255,255,255,0.03) 1px, transparent 1px),
                linear-gradient(90deg, rgba(255,255,255,0.03) 1px, transparent 1px);
            background-size: 20px 20px;
        }

        .board-component {
            position: absolute;
            background: #2c3e50;
            border: 3px solid #34495e;
            border-radius: 8px;
            padding: 15px;
            cursor: move;
            transition: all 0.2s;
            min-width: 120px;
            color: white;
        }

        .board-component:hover {
            border-color: #e74c3c;
            box-shadow: 0 0 20px rgba(231, 76, 60, 0.3);
            z-index: 10;
        }

        .board-component.selected {
            border-color: #e74c3c;
            box-shadow: 0 0 30px rgba(231, 76, 60, 0.5);
            z-index: 20;
        }

        .component-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
            font-weight: 600;
            font-size: 0.95em;
        }

        .component-body {
            font-size: 0.85em;
            color: #bdc3c7;
        }

        .component-port {
            width: 12px;
            height: 12px;
            background: #3498db;
            border: 2px solid white;
            border-radius: 50%;
            position: absolute;
            cursor: pointer;
            transition: all 0.2s;
        }

        .component-port:hover {
            background: #e74c3c;
            transform: scale(1.3);
        }

        .component-port.input {
            left: -8px;
        }

        .component-port.output {
            right: -8px;
        }

        .wire {
            position: absolute;
            pointer-events: none;
        }

        .wire-line {
            stroke: #3498db;
            stroke-width: 3;
            fill: none;
        }

        .wire-line.selected {
            stroke: #e74c3c;
            stroke-width: 4;
        }

        .properties-panel {
            width: 300px;
            background: #16213e;
            border-left: 2px solid #2c3e50;
            padding: 15px;
            overflow-y: auto;
        }

        .properties-title {
            font-size: 1.1em;
            font-weight: 700;
            color: #e74c3c;
            margin-bottom: 15px;
        }

        .property-group {
            margin-bottom: 15px;
        }

        .property-label {
            font-size: 0.85em;
            color: #95a5a6;
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .property-input {
            width: 100%;
            padding: 8px;
            background: #2c3e50;
            border: 2px solid #34495e;
            color: white;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .property-input:focus {
            outline: none;
            border-color: #e74c3c;
        }

        .property-select {
            width: 100%;
            padding: 8px;
            background: #2c3e50;
            border: 2px solid #34495e;
            color: white;
            border-radius: 4px;
            font-size: 0.9em;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: #1a252f;
            border-radius: 12px;
            padding: 30px;
            max-width: 800px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            border: 2px solid #e74c3c;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 1.5em;
            font-weight: 700;
            color: #e74c3c;
        }

        .close-btn {
            background: #e74c3c;
            border: none;
            color: white;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-size: 1.2em;
        }

        .import-section {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .import-card {
            background: #2c3e50;
            border: 2px solid #34495e;
            border-radius: 8px;
            padding: 20px;
            cursor: pointer;
            transition: all 0.3s;
            text-align: center;
        }

        .import-card:hover {
            border-color: #e74c3c;
            transform: translateY(-3px);
        }

        .import-card-icon {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .import-card-title {
            font-weight: 600;
            margin-bottom: 5px;
        }

        .import-card-desc {
            font-size: 0.85em;
            color: #95a5a6;
        }

        .loading-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            z-index: 2000;
            align-items: center;
            justify-content: center;
        }

        .loading-overlay.active {
            display: flex;
        }

        .loading-content {
            text-align: center;
            color: white;
        }

        .spinner {
            border: 5px solid rgba(255, 255, 255, 0.1);
            border-top: 5px solid #e74c3c;
            border-radius: 50%;
            width: 60px;
            height: 60px;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .stats-bar {
            background: #16213e;
            border-top: 2px solid #2c3e50;
            padding: 10px 20px;
            display: flex;
            gap: 30px;
            font-size: 0.85em;
        }

        .stat-item {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .stat-label {
            color: #95a5a6;
        }

        .stat-value {
            color: #e74c3c;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <!-- Top Toolbar -->
    <div class="top-toolbar">
        <div class="toolbar-left">
            <div class="project-title">üîå {{ project_name | default('Loxone Board Builder') }}</div>
            <button class="toolbar-btn" onclick="newBoard()">üÜï New Board</button>
            <button class="toolbar-btn" onclick="openImportModal()">üì• Import Data</button>
            <button class="toolbar-btn ai" onclick="generateBoardWithAI()">ü§ñ AI Generate Board</button>
        </div>
        <div style="display: flex; gap: 10px;">
            <button class="toolbar-btn" onclick="window.location.href='/'">üè† Home</button>
            <button class="toolbar-btn" onclick="window.location.href='/mapping'">‚ö° Mapping</button>
            <button class="toolbar-btn" onclick="window.location.href='/canvas'">üé® Canvas</button>
            <button class="toolbar-btn" onclick="openCustomizeModal()">üé® Customize</button>
            <button class="toolbar-btn" onclick="saveBoard()">üíæ Save</button>
            <button class="toolbar-btn" onclick="loadBoard()">üìÇ Load</button>
            <button class="toolbar-btn success" onclick="openExportModal()">üì§ Export</button>
            <button class="toolbar-btn" onclick="generateCADDrawings()" style="background: linear-gradient(135deg, #556B2F 0%, #6B8E23 100%);">‚ö° Generate CAD Drawings ‚Üí</button>
            <button class="toolbar-btn danger" onclick="clearBoard()">üóëÔ∏è Clear</button>
        </div>
    </div>

    <!-- Main Container -->
    <div class="main-container">
        <!-- Component Sidebar -->
        <div class="sidebar">
            <div class="sidebar-section">
                <div class="sidebar-title">Loxone Controllers</div>
                <button class="component-btn" onclick="selectComponent('miniserver', 'üè¢', 'Miniserver Gen 2')">
                    <span class="component-icon">üè¢</span>
                    <span>Miniserver Gen 2</span>
                </button>
                <button class="component-btn" onclick="selectComponent('miniserver-go', 'üì¶', 'Miniserver Go')">
                    <span class="component-icon">üì¶</span>
                    <span>Miniserver Go</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Extensions</div>
                <button class="component-btn" onclick="selectComponent('extension', 'üîå', 'Extension')">
                    <span class="component-icon">üîå</span>
                    <span>Extension</span>
                </button>
                <button class="component-btn" onclick="selectComponent('relay-extension', 'üîÑ', 'Relay Extension')">
                    <span class="component-icon">üîÑ</span>
                    <span>Relay Extension</span>
                </button>
                <button class="component-btn" onclick="selectComponent('dimmer-extension', 'üí°', 'Dimmer Extension')">
                    <span class="component-icon">üí°</span>
                    <span>Dimmer Extension</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Input/Output Modules</div>
                <button class="component-btn" onclick="selectComponent('digital-input', 'üì•', 'Digital Input')">
                    <span class="component-icon">üì•</span>
                    <span>Digital Input</span>
                </button>
                <button class="component-btn" onclick="selectComponent('analog-input', 'üìä', 'Analog Input')">
                    <span class="component-icon">üìä</span>
                    <span>Analog Input</span>
                </button>
                <button class="component-btn" onclick="selectComponent('relay-output', 'üîå', 'Relay Output')">
                    <span class="component-icon">üîå</span>
                    <span>Relay Output</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Communication</div>
                <button class="component-btn" onclick="selectComponent('tree-cable', 'üå≥', 'Tree Cable')">
                    <span class="component-icon">üå≥</span>
                    <span>Tree Cable</span>
                </button>
                <button class="component-btn" onclick="selectComponent('power-supply', '‚ö°', 'Power Supply 24V')">
                    <span class="component-icon">‚ö°</span>
                    <span>Power Supply 24V</span>
                </button>
                <button class="component-btn" onclick="selectComponent('network-cable', 'üîó', 'Network Cable')">
                    <span class="component-icon">üîó</span>
                    <span>Network Cable</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Specialized Modules</div>
                <button class="component-btn" onclick="selectComponent('air-base', 'üå°Ô∏è', 'Air Base Extension')">
                    <span class="component-icon">üå°Ô∏è</span>
                    <span>Air Base Extension</span>
                </button>
                <button class="component-btn" onclick="selectComponent('dmx-extension', 'üé≠', 'DMX Extension')">
                    <span class="component-icon">üé≠</span>
                    <span>DMX Extension</span>
                </button>
                <button class="component-btn" onclick="selectComponent('modbus', 'üì°', 'Modbus Extension')">
                    <span class="component-icon">üì°</span>
                    <span>Modbus Extension</span>
                </button>
            </div>

            <div class="sidebar-section">
                <div class="sidebar-title">Custom Components</div>
                <button class="component-btn" onclick="openCustomComponentCreator()" style="background: linear-gradient(135deg, #9b59b6 0%, #8e44ad 100%); border: 2px solid #8e44ad;">
                    <span class="component-icon">‚ú®</span>
                    <span>Create Custom Component</span>
                </button>
                <div id="customComponentsList"></div>
            </div>
        </div>

        <!-- Board Canvas -->
        <div class="board-canvas">
            <div class="board-wrapper" id="boardWrapper">
                <div class="board-grid" id="boardGrid">
                    <svg id="wiresLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></svg>
                </div>
            </div>
        </div>

        <!-- Properties Panel -->
        <div class="properties-panel" id="propertiesPanel">
            <div class="properties-title">Component Properties</div>
            <div id="propertiesContent">
                <p style="color: #95a5a6; font-size: 0.9em;">Select a component to view properties</p>
            </div>
        </div>
    </div>

    <!-- Stats Bar -->
    <div class="stats-bar">
        <div class="stat-item">
            <span class="stat-label">Components:</span>
            <span class="stat-value" id="componentCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Connections:</span>
            <span class="stat-value" id="connectionCount">0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Estimated Cost:</span>
            <span class="stat-value" id="estimatedCost">$0</span>
        </div>
        <div class="stat-item">
            <span class="stat-label">Power Consumption:</span>
            <span class="stat-value" id="powerConsumption">0W</span>
        </div>
    </div>

    <!-- Import Modal -->
    <div class="modal" id="importModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì• Import Data</div>
                <button class="close-btn" onclick="closeImportModal()">‚úñ</button>
            </div>
            <div class="import-section">
                <div class="import-card" onclick="importBackgroundPDF()">
                    <div class="import-card-icon">üìÑ</div>
                    <div class="import-card-title">Import PDF Background</div>
                    <div class="import-card-desc">Upload a PDF as board background</div>
                </div>
                <div class="import-card" onclick="importBackgroundImage()">
                    <div class="import-card-icon">üñºÔ∏è</div>
                    <div class="import-card-title">Import Image Background</div>
                    <div class="import-card-desc">Upload an image as board background</div>
                </div>
                <div class="import-card" onclick="importFromMapping()">
                    <div class="import-card-icon">‚ö°</div>
                    <div class="import-card-title">Import from Mapping</div>
                    <div class="import-card-desc">Import electrical components from the mapping tool</div>
                </div>
                <div class="import-card" onclick="importFromCanvas()">
                    <div class="import-card-icon">üé®</div>
                    <div class="import-card-title">Import from Canvas</div>
                    <div class="import-card-desc">Import automation data from the canvas editor</div>
                </div>
                <div class="import-card" onclick="importFromCRM()">
                    <div class="import-card-icon">üì¶</div>
                    <div class="import-card-title">Import from CRM Stock</div>
                    <div class="import-card-desc">Import components from CRM inventory</div>
                </div>
                <div class="import-card" onclick="importFromFile()">
                    <div class="import-card-icon">üìÅ</div>
                    <div class="import-card-title">Import Board File</div>
                    <div class="import-card-desc">Load a previously saved board configuration</div>
                </div>
            </div>
            <div style="margin-top: 20px;" id="sessionSelectorContainer">
                <!-- Session selector will be populated here -->
            </div>
        </div>
    </div>

    <!-- AI Generation Modal -->
    <div class="modal" id="aiModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">ü§ñ AI Board Generator</div>
                <button class="close-btn" onclick="closeAIModal()">‚úñ</button>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; color: #95a5a6; font-size: 0.9em;">Describe your automation requirements:</label>
                <textarea id="aiRequirements" rows="6" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px; font-size: 0.9em; resize: vertical;" placeholder="Example: I need a board for a 3-bedroom house with lighting control in all rooms, HVAC control, blinds automation, and a security system with door sensors..."></textarea>
            </div>
            <div style="margin-bottom: 20px;">
                <label style="display: block; margin-bottom: 10px; color: #95a5a6; font-size: 0.9em;">Automation Types:</label>
                <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="lighting" checked>
                        <span>üí° Lighting Control</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="hvac" checked>
                        <span>üå°Ô∏è HVAC Control</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="blinds">
                        <span>ü™ü Blinds/Shading</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="security">
                        <span>üîí Security System</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="audio">
                        <span>üîä Audio System</span>
                    </label>
                    <label style="display: flex; align-items: center; gap: 8px; cursor: pointer;">
                        <input type="checkbox" class="ai-automation-type" value="energy">
                        <span>‚ö° Energy Management</span>
                    </label>
                </div>
            </div>
            <button class="toolbar-btn ai" style="width: 100%;" onclick="generateWithAI()">ü§ñ Generate Board with AI</button>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal" id="exportModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üì§ Export Board</div>
                <button class="close-btn" onclick="closeExportModal()">‚úñ</button>
            </div>
            <div class="import-section">
                <div class="import-card" onclick="exportAsImage()">
                    <div class="import-card-icon">üñºÔ∏è</div>
                    <div class="import-card-title">Export as Image</div>
                    <div class="import-card-desc">PNG or JPG format</div>
                </div>
                <div class="import-card" onclick="exportAsPDF()">
                    <div class="import-card-icon">üìÑ</div>
                    <div class="import-card-title">Export as PDF</div>
                    <div class="import-card-desc">Professional PDF document</div>
                </div>
                <div class="import-card" onclick="exportAsDXF()">
                    <div class="import-card-icon">üìê</div>
                    <div class="import-card-title">Export as DXF</div>
                    <div class="import-card-desc">For AutoCAD/Vectorworks</div>
                </div>
                <div class="import-card" onclick="exportAsJSON()">
                    <div class="import-card-icon">üìã</div>
                    <div class="import-card-title">Export as JSON</div>
                    <div class="import-card-desc">Board configuration data</div>
                </div>
                <div class="import-card" onclick="exportToCRM()">
                    <div class="import-card-icon">üì¶</div>
                    <div class="import-card-title">Export to CRM</div>
                    <div class="import-card-desc">Add to job and stock</div>
                </div>
            </div>
        </div>
    </div>

    <!-- Component Customization Modal -->
    <div class="modal" id="customizeModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üé® Customize Component</div>
                <button class="close-btn" onclick="closeCustomizeModal()">‚úñ</button>
            </div>
            <div id="customizeContent" style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Component Color</label>
                    <input type="color" id="componentColor" style="width: 100%; height: 50px; cursor: pointer;" onchange="updateComponentColor(this.value)">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Background Color</label>
                    <input type="color" id="componentBgColor" value="#2c3e50" style="width: 100%; height: 50px; cursor: pointer;" onchange="updateComponentBgColor(this.value)">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Component Icon</label>
                    <input type="text" id="componentIcon" placeholder="Enter emoji or text" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;" onchange="updateComponentIcon(this.value)">
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Custom Image</label>
                    <button class="toolbar-btn" style="width: 100%;" onclick="uploadComponentImage()">üì∑ Upload Image</button>
                </div>
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Size</label>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                        <div>
                            <label style="font-size: 0.8em; color: #7f8c8d;">Width</label>
                            <input type="number" id="componentWidth" min="80" max="400" style="width: 100%; padding: 8px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;" onchange="updateComponentSize()">
                        </div>
                        <div>
                            <label style="font-size: 0.8em; color: #7f8c8d;">Height</label>
                            <input type="number" id="componentHeight" min="60" max="300" style="width: 100%; padding: 8px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;" onchange="updateComponentSize()">
                        </div>
                    </div>
                </div>
                <button class="toolbar-btn" style="width: 100%; margin-top: 20px;" onclick="closeCustomizeModal()">‚úì Apply Changes</button>
            </div>
        </div>
    </div>

    <!-- Custom Component Creator Modal -->
    <div class="modal" id="customComponentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">‚ú® Create Custom Component</div>
                <button class="close-btn" onclick="closeCustomComponentModal()">‚úñ</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Component Name</label>
                    <input type="text" id="customCompName" placeholder="e.g., Custom Sensor Module" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;">
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Icon (Emoji or Text)</label>
                        <input type="text" id="customCompIcon" placeholder="üîå" maxlength="2" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px; font-size: 1.5em; text-align: center;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Color</label>
                        <input type="color" id="customCompColor" value="#3498db" style="width: 100%; height: 44px; cursor: pointer; border: 2px solid #34495e; border-radius: 4px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Width (px)</label>
                        <input type="number" id="customCompWidth" value="150" min="80" max="300" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Height (px)</label>
                        <input type="number" id="customCompHeight" value="80" min="60" max="200" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Number of Inputs</label>
                        <input type="number" id="customCompInputs" value="0" min="0" max="16" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Number of Outputs</label>
                        <input type="number" id="customCompOutputs" value="0" min="0" max="16" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;">
                    </div>
                </div>
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 15px;">
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Cost ($)</label>
                        <input type="number" id="customCompCost" value="0" min="0" step="0.01" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;">
                    </div>
                    <div>
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6;">Power (W)</label>
                        <input type="number" id="customCompPower" value="0" min="0" step="0.1" style="width: 100%; padding: 10px; background: #2c3e50; border: 2px solid #34495e; color: white; border-radius: 4px;">
                    </div>
                </div>
                <button class="toolbar-btn ai" style="width: 100%; margin-top: 20px;" onclick="createCustomComponent()">‚ú® Create Component</button>
            </div>
        </div>
    </div>

    <!-- Job Assignment Modal -->
    <div class="modal" id="jobAssignmentModal">
        <div class="modal-content">
            <div class="modal-header">
                <div class="modal-title">üìã Assign to Job</div>
                <button class="close-btn" onclick="closeJobAssignmentModal()">‚úñ</button>
            </div>
            <div style="padding: 20px;">
                <div style="margin-bottom: 15px;">
                    <label style="display: block; margin-bottom: 10px; color: #95a5a6;">Select Job:</label>
                    <div id="jobsList" style="max-height: 400px; overflow-y: auto;">
                        <div style="text-align: center; padding: 20px; color: #95a5a6;">
                            Loading jobs...
                        </div>
                    </div>
                </div>
                <button class="toolbar-btn" style="width: 100%;" onclick="closeJobAssignmentModal()">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="spinner"></div>
            <div style="font-size: 1.2em; font-weight: 600;">Generating your Loxone board...</div>
            <div style="margin-top: 10px; color: #95a5a6;">This may take a few moments</div>
        </div>
    </div>

    <script>
        console.log('üöÄ Board Builder initializing...');

        // Board state
        let boardComponents = [];
        let boardConnections = [];
        let selectedComponent = null;
        let selectedConnection = null;
        let pendingComponentType = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let componentIdCounter = 0;
        let isConnecting = false;
        let connectionStart = null;
        let isDraggingControlPoint = false;
        let draggingControlPointData = null;

        // Check for imported data on page load
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('import') === 'true') {
                const importData = sessionStorage.getItem('import_data');
                if (importData) {
                    try {
                        const data = JSON.parse(importData);
                        console.log('Imported data to Board Builder:', data);
                        showImportToast(`Data imported: ${data.project_name}`, 'success');
                        sessionStorage.removeItem('import_data');
                        sessionStorage.removeItem('import_source');
                    } catch (e) {
                        console.error('Import error:', e);
                    }
                }
            }
        })();

        function showImportToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-blue-500'} text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        // Component specifications and pricing
        const COMPONENT_SPECS = {
            'miniserver': {
                name: 'Miniserver Gen 2',
                icon: 'üè¢',
                color: '#e74c3c',
                cost: 1890,
                power: 15,
                inputs: 16,
                outputs: 14,
                width: 200,
                height: 120
            },
            'miniserver-go': {
                name: 'Miniserver Go',
                icon: 'üì¶',
                color: '#e67e22',
                cost: 990,
                power: 8,
                inputs: 8,
                outputs: 6,
                width: 180,
                height: 100
            },
            'extension': {
                name: 'Extension',
                icon: 'üîå',
                color: '#3498db',
                cost: 590,
                power: 5,
                inputs: 12,
                outputs: 10,
                width: 160,
                height: 90
            },
            'relay-extension': {
                name: 'Relay Extension',
                icon: 'üîÑ',
                color: '#27ae60',
                cost: 450,
                power: 3,
                outputs: 11,
                width: 150,
                height: 80
            },
            'dimmer-extension': {
                name: 'Dimmer Extension',
                icon: 'üí°',
                color: '#f39c12',
                cost: 650,
                power: 4,
                outputs: 8,
                width: 150,
                height: 80
            },
            'digital-input': {
                name: 'Digital Input',
                icon: 'üì•',
                color: '#9b59b6',
                cost: 180,
                power: 1,
                inputs: 16,
                width: 120,
                height: 70
            },
            'analog-input': {
                name: 'Analog Input',
                icon: 'üìä',
                color: '#8e44ad',
                cost: 220,
                power: 1,
                inputs: 4,
                width: 120,
                height: 70
            },
            'relay-output': {
                name: 'Relay Output',
                icon: 'üîå',
                color: '#16a085',
                cost: 150,
                power: 1,
                outputs: 8,
                width: 120,
                height: 70
            },
            'tree-cable': {
                name: 'Tree Cable',
                icon: 'üå≥',
                color: '#95a5a6',
                cost: 3.5,
                power: 0,
                width: 100,
                height: 60
            },
            'power-supply': {
                name: 'Power Supply 24V',
                icon: '‚ö°',
                color: '#e74c3c',
                cost: 120,
                power: 0,
                outputs: 2,
                width: 140,
                height: 80
            },
            'network-cable': {
                name: 'Network Cable',
                icon: 'üîó',
                color: '#34495e',
                cost: 2.5,
                power: 0,
                width: 100,
                height: 60
            },
            'air-base': {
                name: 'Air Base Extension',
                icon: 'üå°Ô∏è',
                color: '#1abc9c',
                cost: 790,
                power: 4,
                inputs: 6,
                width: 150,
                height: 80
            },
            'dmx-extension': {
                name: 'DMX Extension',
                icon: 'üé≠',
                color: '#e91e63',
                cost: 490,
                power: 3,
                outputs: 4,
                width: 140,
                height: 75
            },
            'modbus': {
                name: 'Modbus Extension',
                icon: 'üì°',
                color: '#00bcd4',
                cost: 590,
                power: 3,
                width: 140,
                height: 75
            }
        };

        // Initialize board
        function initBoard() {
            console.log('‚úÖ Board initialized');
            updateStats();

            // Make board draggable
            const boardWrapper = document.getElementById('boardWrapper');
            boardWrapper.addEventListener('mousedown', handleBoardMouseDown);
            document.addEventListener('mousemove', handleBoardMouseMove);
            document.addEventListener('mouseup', handleBoardMouseUp);

            // Click to place component
            document.getElementById('boardGrid').addEventListener('click', handleBoardClick);
        }

        // Component selection
        function selectComponent(type, icon, name) {
            pendingComponentType = type;
            console.log(`Selected component type: ${type}`);

            // Highlight the selected button
            document.querySelectorAll('.component-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.closest('.component-btn').classList.add('active');
        }

        // Handle board click to place component
        function handleBoardClick(e) {
            if (!pendingComponentType) return;

            const rect = document.getElementById('boardGrid').getBoundingClientRect();
            const x = e.clientX - rect.left + document.getElementById('boardWrapper').scrollLeft;
            const y = e.clientY - rect.top + document.getElementById('boardWrapper').scrollTop;

            addComponentToBoard(pendingComponentType, x, y);
            pendingComponentType = null;

            // Remove active state from buttons
            document.querySelectorAll('.component-btn').forEach(btn => {
                btn.classList.remove('active');
            });
        }

        // Add component to board
        function addComponentToBoard(type, x, y, properties = {}) {
            const spec = COMPONENT_SPECS[type];
            if (!spec) return;

            const component = {
                id: `comp-${componentIdCounter++}`,
                type: type,
                x: x,
                y: y,
                properties: {
                    name: properties.name || spec.name,
                    serialNumber: properties.serialNumber || '',
                    notes: properties.notes || '',
                    ...properties
                }
            };

            boardComponents.push(component);
            renderComponent(component);
            updateStats();

            console.log(`Added component: ${component.id} at (${x}, ${y})`);
        }

        // Render component on board
        function renderComponent(component) {
            const spec = COMPONENT_SPECS[component.type];
            const div = document.createElement('div');
            div.className = 'board-component';
            div.id = component.id;
            div.style.left = component.x + 'px';
            div.style.top = component.y + 'px';
            div.style.width = spec.width + 'px';
            div.style.borderColor = spec.color;

            // Use editable properties or fallback to spec
            const inputs = component.properties.inputs !== undefined ? component.properties.inputs : spec.inputs;
            const outputs = component.properties.outputs !== undefined ? component.properties.outputs : spec.outputs;
            const cost = component.properties.cost !== undefined ? component.properties.cost : spec.cost;

            div.innerHTML = `
                <div class="component-header">
                    <span style="font-size: 1.5em;">${spec.icon}</span>
                    <span>${component.properties.name}</span>
                </div>
                <div class="component-body">
                    ${inputs ? `üì• ${inputs} inputs` : ''}
                    ${outputs ? `üì§ ${outputs} outputs` : ''}
                    ${cost ? `<div style="margin-top: 5px;">$${cost}</div>` : ''}
                </div>
            `;

            div.addEventListener('mousedown', (e) => handleComponentMouseDown(e, component.id));
            div.addEventListener('click', (e) => {
                e.stopPropagation();
                selectBoardComponent(component.id);
            });

            // Add connection ports (using editable inputs/outputs and custom colors)
            const inputPortColor = component.properties.inputPortColor || '#3498db';  // Default blue
            const outputPortColor = component.properties.outputPortColor || '#e74c3c';  // Default red

            if (inputs) {
                for (let i = 0; i < Math.min(inputs, 32); i++) {
                    const port = document.createElement('div');
                    port.className = 'component-port input';
                    port.style.top = (20 + i * 20) + 'px';
                    port.style.backgroundColor = inputPortColor;
                    port.style.border = `2px solid ${inputPortColor}`;
                    port.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handlePortClick(component.id, 'input', i);
                    });
                    div.appendChild(port);
                }
            }

            if (outputs) {
                for (let i = 0; i < Math.min(outputs, 32); i++) {
                    const port = document.createElement('div');
                    port.className = 'component-port output';
                    port.style.top = (20 + i * 20) + 'px';
                    port.style.backgroundColor = outputPortColor;
                    port.style.border = `2px solid ${outputPortColor}`;
                    port.addEventListener('click', (e) => {
                        e.stopPropagation();
                        handlePortClick(component.id, 'output', i);
                    });
                    div.appendChild(port);
                }
            }

            document.getElementById('boardGrid').appendChild(div);
        }

        // Handle port click for connections
        function handlePortClick(componentId, portType, portIndex) {
            console.log(`Port clicked: ${componentId}, ${portType}, ${portIndex}`);

            if (!isConnecting) {
                // Start connection
                isConnecting = true;
                connectionStart = { componentId, portType, portIndex };
                console.log('Connection started');
            } else {
                // Complete connection
                if (connectionStart.componentId !== componentId) {
                    // Calculate initial control points (midpoint)
                    const fromComp = document.getElementById(connectionStart.componentId);
                    const toComp = document.getElementById(componentId);
                    if (fromComp && toComp) {
                        const fromRect = fromComp.getBoundingClientRect();
                        const toRect = toComp.getBoundingClientRect();
                        const gridRect = document.getElementById('boardGrid').getBoundingClientRect();

                        const x1 = fromRect.right - gridRect.left;
                        const y1 = fromRect.top - gridRect.top + 20 + connectionStart.portIndex * 20;
                        const x2 = toRect.left - gridRect.left;
                        const y2 = toRect.top - gridRect.top + 20 + portIndex * 20;

                        const connection = {
                            id: `conn-${Date.now()}`,
                            from: connectionStart,
                            to: { componentId, portType, portIndex },
                            color: '#3498db',  // Default wire color
                            width: 3,  // Default wire width
                            // Bezier curve control points
                            cp1x: (x1 + x2) / 2,
                            cp1y: y1,
                            cp2x: (x1 + x2) / 2,
                            cp2y: y2
                        };
                        boardConnections.push(connection);
                        renderConnection(connection);
                        console.log('Connection created:', connection);
                    }
                }
                isConnecting = false;
                connectionStart = null;
                updateStats();
            }
        }

        // Render connection wire
        function renderConnection(connection) {
            const fromComp = document.getElementById(connection.from.componentId);
            const toComp = document.getElementById(connection.to.componentId);

            if (!fromComp || !toComp) return;

            const fromRect = fromComp.getBoundingClientRect();
            const toRect = toComp.getBoundingClientRect();
            const gridRect = document.getElementById('boardGrid').getBoundingClientRect();

            const x1 = fromRect.right - gridRect.left;
            const y1 = fromRect.top - gridRect.top + 20 + connection.from.portIndex * 20;
            const x2 = toRect.left - gridRect.left;
            const y2 = toRect.top - gridRect.top + 20 + connection.to.portIndex * 20;

            // Use stored control points or calculate defaults
            const cp1x = connection.cp1x !== undefined ? connection.cp1x : (x1 + x2) / 2;
            const cp1y = connection.cp1y !== undefined ? connection.cp1y : y1;
            const cp2x = connection.cp2x !== undefined ? connection.cp2x : (x1 + x2) / 2;
            const cp2y = connection.cp2y !== undefined ? connection.cp2y : y2;

            const svg = document.getElementById('wiresLayer');

            // Draw main wire path
            const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
            path.setAttribute('class', 'wire-line');
            path.setAttribute('d', `M ${x1} ${y1} C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${x2} ${y2}`);
            path.setAttribute('data-connection-id', connection.id);
            path.setAttribute('stroke', connection.color || '#3498db');
            path.setAttribute('stroke-width', connection.width || 3);
            path.setAttribute('fill', 'none');
            path.style.cursor = 'pointer';
            path.style.pointerEvents = 'stroke';

            // Make wires selectable
            path.addEventListener('click', (e) => {
                e.stopPropagation();
                selectConnection(connection.id);
            });

            svg.appendChild(path);

            // Add control point handles if this connection is selected
            if (selectedConnection === connection.id) {
                // Control point 1
                const cp1Handle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                cp1Handle.setAttribute('cx', cp1x);
                cp1Handle.setAttribute('cy', cp1y);
                cp1Handle.setAttribute('r', 6);
                cp1Handle.setAttribute('fill', '#f39c12');
                cp1Handle.setAttribute('stroke', '#fff');
                cp1Handle.setAttribute('stroke-width', 2);
                cp1Handle.style.cursor = 'move';
                cp1Handle.setAttribute('data-cp-id', `${connection.id}-cp1`);

                // Control point 2
                const cp2Handle = document.createElementNS('http://www.w3.org/2000/svg', 'circle');
                cp2Handle.setAttribute('cx', cp2x);
                cp2Handle.setAttribute('cy', cp2y);
                cp2Handle.setAttribute('r', 6);
                cp2Handle.setAttribute('fill', '#e74c3c');
                cp2Handle.setAttribute('stroke', '#fff');
                cp2Handle.setAttribute('stroke-width', 2);
                cp2Handle.style.cursor = 'move';
                cp2Handle.setAttribute('data-cp-id', `${connection.id}-cp2`);

                // Helper lines from endpoints to control points
                const helperLine1 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                helperLine1.setAttribute('x1', x1);
                helperLine1.setAttribute('y1', y1);
                helperLine1.setAttribute('x2', cp1x);
                helperLine1.setAttribute('y2', cp1y);
                helperLine1.setAttribute('stroke', '#95a5a6');
                helperLine1.setAttribute('stroke-width', 1);
                helperLine1.setAttribute('stroke-dasharray', '4,4');

                const helperLine2 = document.createElementNS('http://www.w3.org/2000/svg', 'line');
                helperLine2.setAttribute('x1', x2);
                helperLine2.setAttribute('y1', y2);
                helperLine2.setAttribute('x2', cp2x);
                helperLine2.setAttribute('y2', cp2y);
                helperLine2.setAttribute('stroke', '#95a5a6');
                helperLine2.setAttribute('stroke-width', 1);
                helperLine2.setAttribute('stroke-dasharray', '4,4');

                svg.appendChild(helperLine1);
                svg.appendChild(helperLine2);
                svg.appendChild(cp1Handle);
                svg.appendChild(cp2Handle);

                // Make control points draggable
                cp1Handle.addEventListener('mousedown', (e) => startDraggingControlPoint(e, connection.id, 'cp1'));
                cp2Handle.addEventListener('mousedown', (e) => startDraggingControlPoint(e, connection.id, 'cp2'));
            }
        }

        // Control point dragging
        function startDraggingControlPoint(e, connectionId, cpType) {
            e.stopPropagation();
            e.preventDefault();
            isDraggingControlPoint = true;
            draggingControlPointData = { connectionId, cpType };
        }

        function handleControlPointDrag(e) {
            if (!isDraggingControlPoint || !draggingControlPointData) return;

            const gridRect = document.getElementById('boardGrid').getBoundingClientRect();
            const x = e.clientX - gridRect.left + document.getElementById('boardWrapper').scrollLeft;
            const y = e.clientY - gridRect.top + document.getElementById('boardWrapper').scrollTop;

            const conn = boardConnections.find(c => c.id === draggingControlPointData.connectionId);
            if (conn) {
                if (draggingControlPointData.cpType === 'cp1') {
                    conn.cp1x = x;
                    conn.cp1y = y;
                } else if (draggingControlPointData.cpType === 'cp2') {
                    conn.cp2x = x;
                    conn.cp2y = y;
                }
                redrawAllConnections();
            }
        }

        function stopDraggingControlPoint() {
            if (isDraggingControlPoint) {
                isDraggingControlPoint = false;
                draggingControlPointData = null;
            }
        }

        // Component dragging
        function handleComponentMouseDown(e, componentId) {
            if (e.target.classList.contains('component-port')) return;

            e.stopPropagation();
            isDragging = true;
            selectedComponent = componentId;

            const comp = document.getElementById(componentId);
            const rect = comp.getBoundingClientRect();
            const gridRect = document.getElementById('boardGrid').getBoundingClientRect();

            dragOffset.x = e.clientX - rect.left;
            dragOffset.y = e.clientY - rect.top;

            selectBoardComponent(componentId);
        }

        function handleBoardMouseDown(e) {
            if (e.target === e.currentTarget || e.target.id === 'boardGrid') {
                deselectAllComponents();
            }
        }

        function handleBoardMouseMove(e) {
            // Handle control point dragging
            if (isDraggingControlPoint) {
                handleControlPointDrag(e);
                return;
            }

            // Handle component dragging
            if (!isDragging || !selectedComponent) return;

            const comp = document.getElementById(selectedComponent);
            const gridRect = document.getElementById('boardGrid').getBoundingClientRect();

            const x = e.clientX - gridRect.left + document.getElementById('boardWrapper').scrollLeft - dragOffset.x;
            const y = e.clientY - gridRect.top + document.getElementById('boardWrapper').scrollTop - dragOffset.y;

            comp.style.left = Math.max(0, x) + 'px';
            comp.style.top = Math.max(0, y) + 'px';

            // Update component data
            const compData = boardComponents.find(c => c.id === selectedComponent);
            if (compData) {
                compData.x = Math.max(0, x);
                compData.y = Math.max(0, y);
            }

            // Redraw connections
            redrawAllConnections();
        }

        function handleBoardMouseUp() {
            isDragging = false;
            stopDraggingControlPoint();
        }

        // Select/deselect components
        function selectBoardComponent(componentId) {
            deselectAllComponents();

            const comp = document.getElementById(componentId);
            comp.classList.add('selected');
            selectedComponent = componentId;

            const compData = boardComponents.find(c => c.id === componentId);
            if (compData) {
                showComponentProperties(compData);
            }
        }

        function deselectAllComponents() {
            document.querySelectorAll('.board-component').forEach(comp => {
                comp.classList.remove('selected');
            });
            selectedComponent = null;
            deselectAllConnections();
            showComponentProperties(null);
        }

        // Select/deselect connections
        function selectConnection(connectionId) {
            deselectAllComponents();
            deselectAllConnections();

            selectedConnection = connectionId;
            const connData = boardConnections.find(c => c.id === connectionId);

            // Highlight selected wire
            const wirePath = document.querySelector(`path[data-connection-id="${connectionId}"]`);
            if (wirePath) {
                wirePath.setAttribute('stroke-width', (connData.width || 3) + 2);
                wirePath.setAttribute('filter', 'drop-shadow(0 0 4px rgba(52, 152, 219, 0.8))');
            }

            if (connData) {
                showConnectionProperties(connData);
            }
        }

        function deselectAllConnections() {
            selectedConnection = null;
            // Remove highlights from all wires
            document.querySelectorAll('#wiresLayer path').forEach(path => {
                const connId = path.getAttribute('data-connection-id');
                const conn = boardConnections.find(c => c.id === connId);
                if (conn) {
                    path.setAttribute('stroke-width', conn.width || 3);
                    path.removeAttribute('filter');
                }
            });
        }

        // Show connection properties
        function showConnectionProperties(connection) {
            const panel = document.getElementById('propertiesContent');

            const fromComp = boardComponents.find(c => c.id === connection.from.componentId);
            const toComp = boardComponents.find(c => c.id === connection.to.componentId);

            panel.innerHTML = `
                <div class="property-group">
                    <div class="property-label">Connection Type</div>
                    <div style="color: white; font-weight: 600;">üîå Wire/Cable Connection</div>
                </div>
                <div class="property-group">
                    <div class="property-label">From</div>
                    <div style="color: #3498db;">${fromComp ? fromComp.properties.name : 'Unknown'}</div>
                </div>
                <div class="property-group">
                    <div class="property-label">To</div>
                    <div style="color: #3498db;">${toComp ? toComp.properties.name : 'Unknown'}</div>
                </div>
                <div class="property-group">
                    <div class="property-label">Cable/Wire Name</div>
                    <input type="text" class="property-input" value="${connection.name || 'Unnamed Cable'}"
                           onchange="updateConnectionProperty('${connection.id}', 'name', this.value)"
                           placeholder="e.g., Tree Cable A-B">
                </div>
                <div class="property-group">
                    <div class="property-label">Category</div>
                    <select class="property-input" onchange="updateConnectionProperty('${connection.id}', 'category', this.value)">
                        <option value="tree-cable" ${connection.category === 'tree-cable' ? 'selected' : ''}>Tree Cable</option>
                        <option value="network-cable" ${connection.category === 'network-cable' ? 'selected' : ''}>Network Cable</option>
                        <option value="power-cable" ${connection.category === 'power-cable' ? 'selected' : ''}>Power Cable</option>
                        <option value="data-cable" ${connection.category === 'data-cable' ? 'selected' : ''}>Data Cable</option>
                        <option value="analog-cable" ${connection.category === 'analog-cable' ? 'selected' : ''}>Analog Cable</option>
                        <option value="custom" ${connection.category === 'custom' || !connection.category ? 'selected' : ''}>Custom</option>
                    </select>
                </div>
                <div class="property-group">
                    <div class="property-label">Cable Specifications</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Length (m)</label>
                            <input type="number" class="property-input" value="${connection.length || 0}"
                                   onchange="updateConnectionProperty('${connection.id}', 'length', parseFloat(this.value))" min="0" step="0.1"
                                   style="padding: 5px; font-size: 0.85em;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Price per m ($)</label>
                            <input type="number" class="property-input" value="${connection.pricePerMeter || 0}"
                                   onchange="updateConnectionProperty('${connection.id}', 'pricePerMeter', parseFloat(this.value))" min="0" step="0.01"
                                   style="padding: 5px; font-size: 0.85em;">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Total Cost</label>
                        <div style="color: #27ae60; font-size: 1.1em; font-weight: 600;">
                            $${((connection.length || 0) * (connection.pricePerMeter || 0)).toFixed(2)}
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Quantity</label>
                        <input type="number" class="property-input" value="${connection.quantity || 1}"
                               onchange="updateConnectionProperty('${connection.id}', 'quantity', parseInt(this.value))" min="1"
                               style="padding: 5px; font-size: 0.85em;">
                    </div>
                </div>
                <div class="property-group">
                    <div class="property-label">Notes</div>
                    <textarea class="property-input" rows="3"
                              onchange="updateConnectionProperty('${connection.id}', 'notes', this.value)"
                              placeholder="Additional notes about this cable...">${connection.notes || ''}</textarea>
                </div>
                <div class="property-group">
                    <div class="property-label">Visual Settings</div>
                    <div style="display: flex; gap: 8px; align-items: center; margin-top: 10px;">
                        <label style="color: #95a5a6; font-size: 0.85em;">Wire Color:</label>
                        <input type="color" id="wireColorPicker" value="${connection.color || '#3498db'}"
                               onchange="updateConnectionColor('${connection.id}', this.value)"
                               style="width: 50px; height: 35px; cursor: pointer; border: 2px solid #34495e; border-radius: 4px;">
                        <input type="text" class="property-input" value="${connection.color || '#3498db'}"
                               onchange="updateConnectionColor('${connection.id}', this.value)"
                               style="flex: 1; padding: 5px; font-size: 0.85em;">
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="color: #95a5a6; font-size: 0.85em;">Wire Width:</label>
                        <input type="range" min="1" max="10" value="${connection.width || 3}"
                               onchange="updateConnectionWidth('${connection.id}', this.value)"
                               style="width: 100%;">
                        <div style="color: #95a5a6; font-size: 0.85em;">${connection.width || 3}px</div>
                    </div>
                </div>
                <div class="property-group">
                    <button class="toolbar-btn success" style="width: 100%; margin-bottom: 10px;" onclick="addCableToStock('${connection.id}')">
                        üì¶ Add Cable to CRM Stock
                    </button>
                    <button class="toolbar-btn ai" style="width: 100%; margin-bottom: 10px;" onclick="assignCableToJob('${connection.id}')">
                        üìã Assign Cable to Job
                    </button>
                </div>
                <div class="property-group">
                    <button onclick="deleteConnection('${connection.id}')"
                            class="toolbar-btn danger" style="width: 100%;">
                        üóëÔ∏è Delete Connection
                    </button>
                </div>
            `;
        }

        // Update connection property
        function updateConnectionProperty(connectionId, property, value) {
            const conn = boardConnections.find(c => c.id === connectionId);
            if (conn) {
                conn[property] = value;
                console.log(`Updated ${property} for connection ${connectionId}:`, value);

                // Refresh the properties panel if this connection is still selected
                if (selectedConnection === connectionId) {
                    selectConnection(connectionId);
                }
            }
        }

        // Update connection properties
        function updateConnectionColor(connectionId, color) {
            const conn = boardConnections.find(c => c.id === connectionId);
            if (conn) {
                conn.color = color;
                redrawAllConnections();
                if (selectedConnection === connectionId) {
                    selectConnection(connectionId);
                }
            }
        }

        function updateConnectionWidth(connectionId, width) {
            const conn = boardConnections.find(c => c.id === connectionId);
            if (conn) {
                conn.width = parseInt(width);
                redrawAllConnections();
                if (selectedConnection === connectionId) {
                    selectConnection(connectionId);
                }
                // Update the width display
                const panel = document.getElementById('propertiesContent');
                const widthDisplay = panel.querySelector('.property-group:nth-last-child(2) div[style*="color: #95a5a6"]');
                if (widthDisplay) {
                    widthDisplay.textContent = `${width}px`;
                }
            }
        }

        function deleteConnection(connectionId) {
            if (confirm('Delete this connection?')) {
                boardConnections = boardConnections.filter(c => c.id !== connectionId);
                selectedConnection = null;
                redrawAllConnections();
                showComponentProperties(null);
                updateStats();
            }
        }

        // Show component properties
        function showComponentProperties(component) {
            const panel = document.getElementById('propertiesContent');

            if (!component) {
                panel.innerHTML = '<p style="color: #95a5a6; font-size: 0.9em;">Select a component to view properties</p>';
                return;
            }

            const spec = COMPONENT_SPECS[component.type];

            panel.innerHTML = `
                <div class="property-group">
                    <div class="property-label">Component Type</div>
                    <div style="color: white; font-weight: 600;">${spec.icon} ${spec.name}</div>
                </div>
                <div class="property-group">
                    <div class="property-label">Name</div>
                    <input type="text" class="property-input" value="${component.properties.name}"
                           onchange="updateComponentProperty('${component.id}', 'name', this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Serial Number</div>
                    <input type="text" class="property-input" value="${component.properties.serialNumber || ''}"
                           onchange="updateComponentProperty('${component.id}', 'serialNumber', this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Category</div>
                    <input type="text" class="property-input" value="${component.properties.category || spec.name}"
                           onchange="updateComponentProperty('${component.id}', 'category', this.value)">
                </div>
                <div class="property-group">
                    <div class="property-label">Notes</div>
                    <textarea class="property-input" rows="3"
                              onchange="updateComponentProperty('${component.id}', 'notes', this.value)">${component.properties.notes || ''}</textarea>
                </div>
                <div class="property-group">
                    <div class="property-label">Editable Specifications</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Inputs</label>
                            <input type="number" class="property-input" value="${component.properties.inputs !== undefined ? component.properties.inputs : (spec.inputs || 0)}"
                                   onchange="updateComponentSpec('${component.id}', 'inputs', parseInt(this.value))" min="0" max="32"
                                   style="padding: 5px; font-size: 0.85em;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Outputs</label>
                            <input type="number" class="property-input" value="${component.properties.outputs !== undefined ? component.properties.outputs : (spec.outputs || 0)}"
                                   onchange="updateComponentSpec('${component.id}', 'outputs', parseInt(this.value))" min="0" max="32"
                                   style="padding: 5px; font-size: 0.85em;">
                        </div>
                    </div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Cost ($)</label>
                            <input type="number" class="property-input" value="${component.properties.cost !== undefined ? component.properties.cost : (spec.cost || 0)}"
                                   onchange="updateComponentSpec('${component.id}', 'cost', parseFloat(this.value))" min="0" step="0.01"
                                   style="padding: 5px; font-size: 0.85em;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Power (W)</label>
                            <input type="number" class="property-input" value="${component.properties.power !== undefined ? component.properties.power : (spec.power || 0)}"
                                   onchange="updateComponentSpec('${component.id}', 'power', parseFloat(this.value))" min="0" step="0.1"
                                   style="padding: 5px; font-size: 0.85em;">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Quantity</label>
                        <input type="number" class="property-input" value="${component.properties.quantity || 1}"
                               onchange="updateComponentProperty('${component.id}', 'quantity', parseInt(this.value))" min="1"
                               style="padding: 5px; font-size: 0.85em;">
                    </div>
                </div>
                <div class="property-group">
                    <div class="property-label">Port Colors</div>
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-top: 10px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Input Ports</label>
                            <input type="color" class="property-input" value="${component.properties.inputPortColor || '#3498db'}"
                                   onchange="updatePortColor('${component.id}', 'inputPortColor', this.value)"
                                   style="width: 100%; height: 35px; cursor: pointer; padding: 2px;">
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; color: #95a5a6; font-size: 0.8em;">Output Ports</label>
                            <input type="color" class="property-input" value="${component.properties.outputPortColor || '#e74c3c'}"
                                   onchange="updatePortColor('${component.id}', 'outputPortColor', this.value)"
                                   style="width: 100%; height: 35px; cursor: pointer; padding: 2px;">
                        </div>
                    </div>
                    <div style="margin-top: 10px;">
                        <button class="toolbar-btn" style="width: 100%; padding: 8px; font-size: 0.85em;" onclick="resetPortColors('${component.id}')">
                            üîÑ Reset to Default Colors
                        </button>
                    </div>
                </div>
                <div class="property-group">
                    <button class="toolbar-btn success" style="width: 100%; margin-bottom: 10px;" onclick="addComponentToStock('${component.id}')">
                        üì¶ Add to CRM Stock
                    </button>
                    <button class="toolbar-btn ai" style="width: 100%; margin-bottom: 10px;" onclick="assignComponentToJob('${component.id}')">
                        üìã Assign to Job
                    </button>
                </div>
                <div class="property-group">
                    <button class="toolbar-btn danger" style="width: 100%;" onclick="deleteComponent('${component.id}')">
                        üóëÔ∏è Delete Component
                    </button>
                </div>
            `;
        }

        // Update component specification
        function updateComponentSpec(componentId, spec, value) {
            const comp = boardComponents.find(c => c.id === componentId);
            if (comp) {
                comp.properties[spec] = value;
                console.log(`Updated ${spec} for ${componentId}:`, value);

                // Update stats if it's cost or power
                if (spec === 'cost' || spec === 'power') {
                    updateStats();
                }

                // Re-render component if inputs/outputs/cost changed (visual update needed)
                if (spec === 'inputs' || spec === 'outputs' || spec === 'cost') {
                    const oldElement = document.getElementById(componentId);
                    if (oldElement) {
                        oldElement.remove();
                    }
                    renderComponent(comp);
                    redrawAllConnections();
                    // Reselect component to keep it selected after re-render
                    setTimeout(() => selectBoardComponent(componentId), 10);
                }
            }
        }

        // Update component property
        function updateComponentProperty(componentId, property, value) {
            const comp = boardComponents.find(c => c.id === componentId);
            if (comp) {
                comp.properties[property] = value;
                console.log(`Updated ${property} for ${componentId}:`, value);

                // Update display if it's the name
                if (property === 'name') {
                    const compElement = document.getElementById(componentId);
                    const header = compElement.querySelector('.component-header span:last-child');
                    if (header) header.textContent = value;
                }
            }
        }

        // Update port color
        function updatePortColor(componentId, colorType, color) {
            const comp = boardComponents.find(c => c.id === componentId);
            if (comp) {
                comp.properties[colorType] = color;
                console.log(`Updated ${colorType} for ${componentId}:`, color);

                // Re-render component to apply new port colors
                const oldElement = document.getElementById(componentId);
                if (oldElement) {
                    oldElement.remove();
                }
                renderComponent(comp);
                redrawAllConnections();
                setTimeout(() => selectBoardComponent(componentId), 10);
            }
        }

        // Reset port colors to default
        function resetPortColors(componentId) {
            const comp = boardComponents.find(c => c.id === componentId);
            if (comp) {
                comp.properties.inputPortColor = '#3498db';  // Blue for inputs
                comp.properties.outputPortColor = '#e74c3c';  // Red for outputs

                // Re-render component to apply default colors
                const oldElement = document.getElementById(componentId);
                if (oldElement) {
                    oldElement.remove();
                }
                renderComponent(comp);
                redrawAllConnections();
                setTimeout(() => selectBoardComponent(componentId), 10);
            }
        }

        // Delete component
        function deleteComponent(componentId) {
            if (!confirm('Delete this component?')) return;

            // Remove from array
            boardComponents = boardComponents.filter(c => c.id !== componentId);

            // Remove connections
            boardConnections = boardConnections.filter(conn =>
                conn.from.componentId !== componentId && conn.to.componentId !== componentId
            );

            // Remove from DOM
            const comp = document.getElementById(componentId);
            if (comp) comp.remove();

            // Redraw connections
            redrawAllConnections();
            updateStats();
            deselectAllComponents();

            console.log(`Deleted component: ${componentId}`);
        }

        // Redraw all connections
        function redrawAllConnections() {
            const svg = document.getElementById('wiresLayer');
            svg.innerHTML = '';
            boardConnections.forEach(conn => renderConnection(conn));
        }

        // Update statistics
        function updateStats() {
            document.getElementById('componentCount').textContent = boardComponents.length;
            document.getElementById('connectionCount').textContent = boardConnections.length;

            // Calculate total cost from components (using editable properties)
            const componentCost = boardComponents.reduce((sum, comp) => {
                const spec = COMPONENT_SPECS[comp.type];
                const cost = comp.properties.cost !== undefined ? comp.properties.cost : (spec.cost || 0);
                const quantity = comp.properties.quantity || 1;
                return sum + (cost * quantity);
            }, 0);

            // Calculate total cost from cables
            const cableCost = boardConnections.reduce((sum, conn) => {
                const length = conn.length || 0;
                const pricePerMeter = conn.pricePerMeter || 0;
                const quantity = conn.quantity || 1;
                return sum + (length * pricePerMeter * quantity);
            }, 0);

            const totalCost = componentCost + cableCost;
            document.getElementById('estimatedCost').textContent = `$${totalCost.toFixed(2)}`;

            // Calculate total power (using editable properties)
            const totalPower = boardComponents.reduce((sum, comp) => {
                const spec = COMPONENT_SPECS[comp.type];
                const power = comp.properties.power !== undefined ? comp.properties.power : (spec.power || 0);
                return sum + power;
            }, 0);
            document.getElementById('powerConsumption').textContent = `${totalPower}W`;
        }

        // Board operations
        function newBoard() {
            if (boardComponents.length > 0 && !confirm('Clear current board and start new?')) return;
            clearBoard();
        }

        function clearBoard() {
            if (boardComponents.length > 0 && !confirm('Are you sure you want to clear the board?')) return;

            boardComponents = [];
            boardConnections = [];
            document.getElementById('boardGrid').innerHTML = '<svg id="wiresLayer" style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none;"></svg>';
            updateStats();
            deselectAllComponents();
            console.log('Board cleared');
        }

        function saveBoard() {
            const boardData = {
                components: boardComponents,
                connections: boardConnections,
                metadata: {
                    version: '1.0',
                    created: new Date().toISOString(),
                    projectName: '{{ project_name | default("Loxone Board") }}'
                }
            };

            // Save to localStorage
            const boardId = 'board_' + Date.now();
            localStorage.setItem(boardId, JSON.stringify(boardData));
            localStorage.setItem('lastBoardId', boardId);

            alert('‚úÖ Board saved successfully!');
            console.log('Board saved:', boardId);
        }

        function loadBoard() {
            const boardId = localStorage.getItem('lastBoardId');
            if (!boardId) {
                alert('No saved board found!');
                return;
            }

            const boardDataStr = localStorage.getItem(boardId);
            if (!boardDataStr) {
                alert('Error loading board!');
                return;
            }

            const boardData = JSON.parse(boardDataStr);

            // Clear current board
            clearBoard();

            // Load components
            boardData.components.forEach(comp => {
                boardComponents.push(comp);
                renderComponent(comp);
            });

            // Load connections
            boardData.connections.forEach(conn => {
                boardConnections.push(conn);
            });

            redrawAllConnections();
            updateStats();

            alert('‚úÖ Board loaded successfully!');
            console.log('Board loaded:', boardId);
        }

        function generateCADDrawings() {
            // Save current board first
            const boardData = {
                components: boardComponents,
                connections: boardConnections,
                metadata: {
                    version: '1.0',
                    created: new Date().toISOString(),
                    projectName: '{{ project_name | default("Loxone Board") }}'
                }
            };

            // Save to localStorage for CAD to import
            const boardId = 'board_' + Date.now();
            localStorage.setItem(boardId, JSON.stringify(boardData));
            localStorage.setItem('cad_import_board_id', boardId);

            // Navigate to CAD Designer
            window.location.href = '/electrical-cad?import_board=' + boardId;
        }

        function exportBoard() {
            const boardData = {
                components: boardComponents,
                connections: boardConnections,
                stats: {
                    componentCount: boardComponents.length,
                    connectionCount: boardConnections.length,
                    totalCost: boardComponents.reduce((sum, comp) => sum + (COMPONENT_SPECS[comp.type].cost || 0), 0),
                    totalPower: boardComponents.reduce((sum, comp) => sum + (COMPONENT_SPECS[comp.type].power || 0), 0)
                },
                metadata: {
                    version: '1.0',
                    exported: new Date().toISOString(),
                    projectName: '{{ project_name | default("Loxone Board") }}'
                }
            };

            // Create downloadable JSON file
            const blob = new Blob([JSON.stringify(boardData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loxone_board_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            console.log('Board exported');
        }

        // Import functionality
        function openImportModal() {
            document.getElementById('importModal').classList.add('active');
        }

        function closeImportModal() {
            document.getElementById('importModal').classList.remove('active');
        }

        async function importFromMapping() {
            await loadAndShowSessions('mapping');
        }

        async function importFromCanvas() {
            await loadAndShowSessions('canvas');
        }

        async function loadAndShowSessions(type) {
            const container = document.getElementById('sessionSelectorContainer');
            container.innerHTML = '<div style="text-align: center; padding: 20px; color: #95a5a6;">Loading available sessions...</div>';

            try {
                const response = await fetch('/api/board-builder/available-sessions');
                const data = await response.json();

                if (data.success) {
                    const sessions = type === 'mapping' ? data.mapping_sessions : data.canvas_sessions;

                    if (sessions.length === 0) {
                        container.innerHTML = `
                            <div style="text-align: center; padding: 20px; background: #2c3e50; border: 2px solid #e74c3c; border-radius: 6px;">
                                <div style="color: #e74c3c; font-size: 1.2em; margin-bottom: 10px;">‚ö†Ô∏è No sessions available</div>
                                <div style="color: #95a5a6;">No ${type} sessions found. Please create a session in the ${type === 'mapping' ? 'Mapping and Markup Tool' : 'Canvas Editor'} first.</div>
                            </div>
                        `;
                    } else {
                        container.innerHTML = `
                            <label style="display: block; margin-bottom: 10px; color: #95a5a6; font-size: 0.9em;">
                                Select ${type === 'mapping' ? 'Mapping' : 'Canvas'} Session to Import:
                            </label>
                            <div style="max-height: 300px; overflow-y: auto;">
                                ${sessions.map(session => `
                                    <div onclick="importSession('${session.id}', '${type}')"
                                         style="padding: 15px; background: #2c3e50; border: 2px solid #34495e; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;"
                                         onmouseover="this.style.borderColor='#3498db'; this.style.background='#34495e';"
                                         onmouseout="this.style.borderColor='#34495e'; this.style.background='#2c3e50';">
                                        <div style="font-weight: 600; color: white; margin-bottom: 5px;">${session.project_name}</div>
                                        <div style="font-size: 0.85em; color: #95a5a6;">
                                            Created: ${new Date(session.created).toLocaleString()} | Components: ${session.component_count}
                                        </div>
                                        <div style="font-size: 0.75em; color: #7f8c8d; margin-top: 5px;">
                                            ID: ${session.id}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        `;
                    }
                } else {
                    container.innerHTML = `
                        <div style="text-align: center; padding: 20px; color: #e74c3c;">
                            Error loading sessions: ${data.error}
                        </div>
                    `;
                }
            } catch (error) {
                console.error('Error loading sessions:', error);
                container.innerHTML = `
                    <div style="text-align: center; padding: 20px; color: #e74c3c;">
                        Failed to load sessions. Check console for details.
                    </div>
                `;
            }
        }

        async function importSession(sessionId, type) {
            try {
                const endpoint = type === 'mapping'
                    ? `/api/board-builder/import/mapping/${sessionId}`
                    : `/api/board-builder/import/canvas/${sessionId}`;

                const response = await fetch(endpoint);
                const data = await response.json();

                if (data.success) {
                    applyImportedData(data.boardData);
                    closeImportModal();
                    alert(`‚úÖ Imported ${data.boardData.components.length} components from ${type === 'mapping' ? 'Mapping' : 'Canvas'}!`);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('Import error:', error);
                alert(`‚ùå Failed to import from ${type}`);
            }
        }

        function importFromFile() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.json';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    try {
                        const boardData = JSON.parse(event.target.result);
                        applyImportedData(boardData);
                        closeImportModal();
                        alert('‚úÖ Board imported successfully!');
                    } catch (error) {
                        console.error('Import error:', error);
                        alert('‚ùå Invalid board file');
                    }
                };
                reader.readAsText(file);
            };
            input.click();
        }

        async function importFromSessionId() {
            const sessionId = document.getElementById('sessionIdInput').value.trim();
            if (!sessionId) {
                alert('Please enter a session ID');
                return;
            }

            // Try mapping first, then canvas
            try {
                let response = await fetch(`/api/board-builder/import/mapping/${sessionId}`);
                let data = await response.json();

                if (data.success) {
                    applyImportedData(data.boardData);
                    closeImportModal();
                    alert(`‚úÖ Imported from Mapping session!`);
                    return;
                }

                // Try canvas
                response = await fetch(`/api/board-builder/import/canvas/${sessionId}`);
                data = await response.json();

                if (data.success) {
                    applyImportedData(data.boardData);
                    closeImportModal();
                    alert(`‚úÖ Imported from Canvas session!`);
                    return;
                }

                alert('‚ùå Session ID not found in Mapping or Canvas');
            } catch (error) {
                console.error('Import error:', error);
                alert('‚ùå Failed to import session');
            }
        }

        function applyImportedData(boardData) {
            if (boardData.components) {
                boardData.components.forEach(comp => {
                    // Ensure component has an ID (AI-generated components may not have one)
                    if (!comp.id) {
                        comp.id = `comp-${componentIdCounter++}`;
                    }

                    // Ensure component has proper properties structure
                    const spec = COMPONENT_SPECS[comp.type];
                    if (spec && !comp.properties) {
                        comp.properties = {
                            name: spec.name,
                            serialNumber: '',
                            notes: ''
                        };
                    } else if (spec && comp.properties) {
                        // Merge with defaults if properties exist but are incomplete
                        comp.properties = {
                            name: comp.properties.name || spec.name,
                            serialNumber: comp.properties.serialNumber || '',
                            notes: comp.properties.notes || '',
                            ...comp.properties
                        };
                    }

                    boardComponents.push(comp);
                    renderComponent(comp);
                });
            }

            if (boardData.connections) {
                boardData.connections.forEach(conn => {
                    boardConnections.push(conn);
                });
                redrawAllConnections();
            }

            updateStats();
            console.log('Import applied:', boardData);
        }

        // AI Generation
        function generateBoardWithAI() {
            document.getElementById('aiModal').classList.add('active');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.remove('active');
        }

        async function generateWithAI() {
            const requirements = document.getElementById('aiRequirements').value.trim();

            if (!requirements) {
                alert('Please describe your automation requirements');
                return;
            }

            const automationTypes = Array.from(document.querySelectorAll('.ai-automation-type:checked'))
                .map(cb => cb.value);

            if (automationTypes.length === 0) {
                alert('Please select at least one automation type');
                return;
            }

            closeAIModal();
            document.getElementById('loadingOverlay').classList.add('active');

            try {
                const response = await fetch('/api/board-builder/generate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        requirements: requirements,
                        automationTypes: automationTypes,
                        existingComponents: boardComponents
                    })
                });

                const data = await response.json();

                if (data.success) {
                    // Clear board if requested
                    if (confirm('Clear current board before generating new one?')) {
                        clearBoard();
                    }

                    // Apply AI-generated board
                    applyImportedData(data.boardData);
                    alert(`‚úÖ AI generated ${data.boardData.components.length} components!`);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('AI generation error:', error);
                alert('‚ùå Failed to generate board with AI');
            } finally {
                document.getElementById('loadingOverlay').classList.remove('active');
            }
        }

        // ============================================================================
        // ENHANCED FEATURES - Import, Export, Customization, CRM
        // ============================================================================

        // Background image support
        let backgroundImage = null;

        // Import PDF as background
        async function importBackgroundPDF() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = '.pdf';
            input.onchange = async (e) => {
                const file = e.target.files[0];
                if (!file) return;

                try {
                    // Load PDF.js if not already loaded
                    if (typeof pdfjsLib === 'undefined') {
                        const script = document.createElement('script');
                        script.src = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js';
                        document.head.appendChild(script);
                        await new Promise(resolve => script.onload = resolve);
                        pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
                    }

                    const reader = new FileReader();
                    reader.onload = async (event) => {
                        const typedarray = new Uint8Array(event.target.result);
                        const pdf = await pdfjsLib.getDocument(typedarray).promise;
                        const page = await pdf.getPage(1);
                        const viewport = page.getViewport({ scale: 2 });

                        const canvas = document.createElement('canvas');
                        canvas.width = viewport.width;
                        canvas.height = viewport.height;
                        const context = canvas.getContext('2d');

                        await page.render({ canvasContext: context, viewport: viewport }).promise;

                        // Set as background
                        const boardGrid = document.getElementById('boardGrid');
                        boardGrid.style.backgroundImage = `url(${canvas.toDataURL()})`;
                        boardGrid.style.backgroundSize = 'contain';
                        boardGrid.style.backgroundRepeat = 'no-repeat';
                        backgroundImage = canvas.toDataURL();

                        closeImportModal();
                        alert('‚úÖ PDF background loaded!');
                    };
                    reader.readAsArrayBuffer(file);
                } catch (error) {
                    console.error('PDF import error:', error);
                    alert('‚ùå Failed to import PDF');
                }
            };
            input.click();
        }

        // Import image as background
        function importBackgroundImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    const img = new Image();
                    img.onload = () => {
                        const boardGrid = document.getElementById('boardGrid');
                        boardGrid.style.backgroundImage = `url(${event.target.result})`;
                        boardGrid.style.backgroundSize = 'contain';
                        boardGrid.style.backgroundRepeat = 'no-repeat';
                        backgroundImage = event.target.result;

                        closeImportModal();
                        alert('‚úÖ Background image loaded!');
                    };
                    img.src = event.target.result;
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // Import from CRM stock
        async function importFromCRM() {
            try {
                const response = await fetch('/api/crm/stock');
                const data = await response.json();

                if (data.success && data.stock) {
                    // Create components from CRM stock
                    let y = 100;
                    data.stock.forEach((item, index) => {
                        if (item.category && item.category.toLowerCase().includes('loxone')) {
                            addComponentToBoard('extension', 200, y + (index * 130), {
                                name: item.name,
                                serialNumber: item.sku || '',
                                notes: `From CRM: $${item.price}`
                            });
                        }
                    });
                    closeImportModal();
                    alert(`‚úÖ Imported components from CRM stock!`);
                } else {
                    alert('‚ùå No CRM stock data available');
                }
            } catch (error) {
                console.error('CRM import error:', error);
                alert('‚ùå Failed to import from CRM');
            }
        }

        // Export modal controls
        function openExportModal() {
            document.getElementById('exportModal').classList.add('active');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.remove('active');
        }

        // Export as Image (PNG)
        async function exportAsImage() {
            try {
                const boardWrapper = document.getElementById('boardWrapper');

                // Use html2canvas to capture the board
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js';
                document.head.appendChild(script);

                script.onload = async () => {
                    const canvas = await html2canvas(boardWrapper, {
                        backgroundColor: '#0f1419',
                        scale: 2
                    });

                    canvas.toBlob((blob) => {
                        const url = URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `loxone_board_${Date.now()}.png`;
                        a.click();
                        URL.revokeObjectURL(url);
                        closeExportModal();
                        alert('‚úÖ Board exported as PNG!');
                    });
                };
            } catch (error) {
                console.error('Image export error:', error);
                alert('‚ùå Failed to export as image');
            }
        }

        // Export as PDF
        async function exportAsPDF() {
            try {
                // Load jsPDF
                const script = document.createElement('script');
                script.src = 'https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js';
                document.head.appendChild(script);

                script.onload = async () => {
                    const { jsPDF } = window.jspdf;
                    const doc = new jsPDF('landscape', 'mm', 'a3');

                    // Add title
                    doc.setFontSize(20);
                    doc.text('Loxone Board Configuration', 20, 20);

                    // Add component list
                    doc.setFontSize(12);
                    let y = 40;

                    doc.text('Components:', 20, y);
                    y += 10;

                    boardComponents.forEach((comp, index) => {
                        const spec = COMPONENT_SPECS[comp.type];
                        doc.setFontSize(10);
                        doc.text(`${index + 1}. ${comp.properties.name} - $${spec.cost}`, 25, y);
                        y += 7;
                        if (y > 180) {
                            doc.addPage();
                            y = 20;
                        }
                    });

                    // Add totals
                    const totalCost = boardComponents.reduce((sum, comp) => sum + (COMPONENT_SPECS[comp.type].cost || 0), 0);
                    const totalPower = boardComponents.reduce((sum, comp) => sum + (COMPONENT_SPECS[comp.type].power || 0), 0);

                    y += 10;
                    doc.setFontSize(12);
                    doc.text(`Total Components: ${boardComponents.length}`, 20, y);
                    y += 10;
                    doc.text(`Total Cost: $${totalCost.toFixed(2)}`, 20, y);
                    y += 10;
                    doc.text(`Total Power: ${totalPower}W`, 20, y);

                    doc.save(`loxone_board_${Date.now()}.pdf`);
                    closeExportModal();
                    alert('‚úÖ Board exported as PDF!');
                };
            } catch (error) {
                console.error('PDF export error:', error);
                alert('‚ùå Failed to export as PDF');
            }
        }

        // Export as DXF (for AutoCAD/Vectorworks)
        function exportAsDXF() {
            try {
                let dxf = '';

                // DXF header
                dxf += '0\nSECTION\n2\nHEADER\n';
                dxf += '9\n$ACADVER\n1\nAC1015\n';
                dxf += '0\nENDSEC\n';

                // Entities section
                dxf += '0\nSECTION\n2\nENTITIES\n';

                // Add components as rectangles and text
                boardComponents.forEach(comp => {
                    const spec = COMPONENT_SPECS[comp.type];

                    // Rectangle
                    dxf += '0\nLWPOLYLINE\n';
                    dxf += '8\nCOMPONENTS\n';
                    dxf += '90\n5\n';
                    dxf += '70\n1\n';

                    // Coordinates
                    dxf += `10\n${comp.x}\n20\n${-comp.y}\n`;
                    dxf += `10\n${comp.x + spec.width}\n20\n${-comp.y}\n`;
                    dxf += `10\n${comp.x + spec.width}\n20\n${-(comp.y + spec.height)}\n`;
                    dxf += `10\n${comp.x}\n20\n${-(comp.y + spec.height)}\n`;
                    dxf += `10\n${comp.x}\n20\n${-comp.y}\n`;

                    // Text label
                    dxf += '0\nTEXT\n';
                    dxf += '8\nLABELS\n';
                    dxf += `10\n${comp.x + 10}\n20\n${-(comp.y + 20)}\n`;
                    dxf += '40\n12\n';
                    dxf += `1\n${comp.properties.name}\n`;
                });

                // Add connections as lines
                boardConnections.forEach(conn => {
                    const fromComp = boardComponents.find(c => c.id === conn.from.componentId);
                    const toComp = boardComponents.find(c => c.id === conn.to.componentId);

                    if (fromComp && toComp) {
                        const fromSpec = COMPONENT_SPECS[fromComp.type];
                        const toSpec = COMPONENT_SPECS[toComp.type];

                        dxf += '0\nLINE\n';
                        dxf += '8\nCONNECTIONS\n';
                        dxf += `10\n${fromComp.x + fromSpec.width}\n20\n${-(fromComp.y + 20)}\n`;
                        dxf += `11\n${toComp.x}\n21\n${-(toComp.y + 20)}\n`;
                    }
                });

                dxf += '0\nENDSEC\n';
                dxf += '0\nEOF\n';

                // Download
                const blob = new Blob([dxf], { type: 'application/dxf' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `loxone_board_${Date.now()}.dxf`;
                a.click();
                URL.revokeObjectURL(url);

                closeExportModal();
                alert('‚úÖ Board exported as DXF!');
            } catch (error) {
                console.error('DXF export error:', error);
                alert('‚ùå Failed to export as DXF');
            }
        }

        // Export as JSON
        function exportAsJSON() {
            const boardData = {
                components: boardComponents,
                connections: boardConnections,
                background: backgroundImage,
                metadata: {
                    version: '2.0',
                    exported: new Date().toISOString(),
                    projectName: '{{ project_name | default("Loxone Board") }}'
                }
            };

            const blob = new Blob([JSON.stringify(boardData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `loxone_board_${Date.now()}.json`;
            a.click();
            URL.revokeObjectURL(url);

            closeExportModal();
            console.log('Board exported as JSON');
        }

        // Export to CRM (add to job and stock)
        async function exportToCRM() {
            try {
                const jobName = prompt('Enter job name for this board:');
                if (!jobName) return;

                const response = await fetch('/api/board-builder/export/crm', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        jobName: jobName,
                        components: boardComponents.map(comp => ({
                            name: comp.properties.name,
                            type: comp.type,
                            quantity: 1,
                            cost: COMPONENT_SPECS[comp.type].cost
                        })),
                        totalCost: boardComponents.reduce((sum, comp) => sum + (COMPONENT_SPECS[comp.type].cost || 0), 0),
                        boardData: {
                            components: boardComponents,
                            connections: boardConnections
                        }
                    })
                });

                const data = await response.json();

                if (data.success) {
                    closeExportModal();
                    alert(`‚úÖ Board exported to CRM!\nJob: ${jobName}\nComponents added to stock`);
                } else {
                    alert('‚ùå Error: ' + data.error);
                }
            } catch (error) {
                console.error('CRM export error:', error);
                alert('‚ùå Failed to export to CRM');
            }
        }

        // Component customization modal
        let customizingComponent = null;

        function openCustomizeModal() {
            if (!selectedComponent) {
                alert('Please select a component first');
                return;
            }

            customizingComponent = selectedComponent;
            const comp = boardComponents.find(c => c.id === selectedComponent);
            const compElement = document.getElementById(selectedComponent);
            const spec = COMPONENT_SPECS[comp.type];

            // Set current values
            document.getElementById('componentColor').value = comp.properties.color || spec.color || '#e74c3c';
            document.getElementById('componentBgColor').value = comp.properties.bgColor || '#2c3e50';
            document.getElementById('componentIcon').value = comp.properties.customIcon || spec.icon;
            document.getElementById('componentWidth').value = comp.properties.width || spec.width;
            document.getElementById('componentHeight').value = comp.properties.height || spec.height;

            document.getElementById('customizeModal').classList.add('active');
        }

        function closeCustomizeModal() {
            document.getElementById('customizeModal').classList.remove('active');
            customizingComponent = null;
        }

        function updateComponentColor(color) {
            if (!customizingComponent) return;

            const comp = boardComponents.find(c => c.id === customizingComponent);
            comp.properties.color = color;

            const compElement = document.getElementById(customizingComponent);
            compElement.style.borderColor = color;
        }

        function updateComponentBgColor(color) {
            if (!customizingComponent) return;

            const comp = boardComponents.find(c => c.id === customizingComponent);
            comp.properties.bgColor = color;

            const compElement = document.getElementById(customizingComponent);
            compElement.style.background = color;
        }

        function updateComponentIcon(icon) {
            if (!customizingComponent) return;

            const comp = boardComponents.find(c => c.id === customizingComponent);
            comp.properties.customIcon = icon;

            const compElement = document.getElementById(customizingComponent);
            const iconElement = compElement.querySelector('.component-header span:first-child');
            if (iconElement) iconElement.textContent = icon;
        }

        function updateComponentSize() {
            if (!customizingComponent) return;

            const width = parseInt(document.getElementById('componentWidth').value);
            const height = parseInt(document.getElementById('componentHeight').value);

            const comp = boardComponents.find(c => c.id === customizingComponent);
            comp.properties.width = width;
            comp.properties.height = height;

            const compElement = document.getElementById(customizingComponent);
            compElement.style.width = width + 'px';
            compElement.style.height = height + 'px';

            redrawAllConnections();
        }

        function uploadComponentImage() {
            const input = document.createElement('input');
            input.type = 'file';
            input.accept = 'image/*';
            input.onchange = (e) => {
                const file = e.target.files[0];
                if (!file) return;

                const reader = new FileReader();
                reader.onload = (event) => {
                    if (!customizingComponent) return;

                    const comp = boardComponents.find(c => c.id === customizingComponent);
                    comp.properties.customImage = event.target.result;

                    const compElement = document.getElementById(customizingComponent);
                    compElement.style.backgroundImage = `url(${event.target.result})`;
                    compElement.style.backgroundSize = 'cover';
                    compElement.style.backgroundPosition = 'center';

                    alert('‚úÖ Custom image applied!');
                };
                reader.readAsDataURL(file);
            };
            input.click();
        }

        // Enhanced connection system - allow any-to-any connections
        function handlePortClick(componentId, portType, portIndex) {
            console.log(`Port clicked: ${componentId}, ${portType}, ${portIndex}`);

            if (!isConnecting) {
                // Start connection - allow from any port
                isConnecting = true;
                connectionStart = { componentId, portType, portIndex };
                console.log('Connection started');
            } else {
                // Complete connection - allow to any different component
                if (connectionStart.componentId !== componentId) {
                    const connection = {
                        id: `conn-${Date.now()}`,
                        from: connectionStart,
                        to: { componentId, portType, portIndex }
                    };
                    boardConnections.push(connection);
                    renderConnection(connection);
                    console.log('Connection created:', connection);
                }
                isConnecting = false;
                connectionStart = null;
                updateStats();
            }
        }

        // Custom Component Creator
        let customComponentIdCounter = 0;

        function openCustomComponentCreator() {
            document.getElementById('customComponentModal').classList.add('active');
        }

        function closeCustomComponentModal() {
            document.getElementById('customComponentModal').classList.remove('active');
            // Reset form
            document.getElementById('customCompName').value = '';
            document.getElementById('customCompIcon').value = '';
            document.getElementById('customCompColor').value = '#3498db';
            document.getElementById('customCompWidth').value = '150';
            document.getElementById('customCompHeight').value = '80';
            document.getElementById('customCompInputs').value = '0';
            document.getElementById('customCompOutputs').value = '0';
            document.getElementById('customCompCost').value = '0';
            document.getElementById('customCompPower').value = '0';
        }

        function createCustomComponent() {
            const name = document.getElementById('customCompName').value.trim();
            const icon = document.getElementById('customCompIcon').value.trim() || 'üîß';
            const color = document.getElementById('customCompColor').value;
            const width = parseInt(document.getElementById('customCompWidth').value);
            const height = parseInt(document.getElementById('customCompHeight').value);
            const inputs = parseInt(document.getElementById('customCompInputs').value);
            const outputs = parseInt(document.getElementById('customCompOutputs').value);
            const cost = parseFloat(document.getElementById('customCompCost').value);
            const power = parseFloat(document.getElementById('customCompPower').value);

            if (!name) {
                alert('Please enter a component name');
                return;
            }

            // Create unique type ID for custom component
            const customType = `custom-${customComponentIdCounter++}`;

            // Add to COMPONENT_SPECS
            COMPONENT_SPECS[customType] = {
                name: name,
                icon: icon,
                color: color,
                width: width,
                height: height,
                cost: cost,
                power: power,
                inputs: inputs,
                outputs: outputs,
                isCustom: true
            };

            // Add button to custom components list
            const listContainer = document.getElementById('customComponentsList');
            const button = document.createElement('button');
            button.className = 'component-btn';
            button.onclick = () => selectComponent(customType, icon, name);
            button.innerHTML = `
                <span class="component-icon">${icon}</span>
                <span>${name}</span>
            `;
            button.style.borderLeft = `4px solid ${color}`;
            listContainer.appendChild(button);

            closeCustomComponentModal();
            alert(`‚úÖ Custom component "${name}" created successfully!`);
            console.log('Custom component created:', customType, COMPONENT_SPECS[customType]);
        }

        // CRM Integration Functions
        let currentItemForAssignment = null;
        let currentItemType = null; // 'component' or 'cable'

        // Add component to CRM stock
        async function addComponentToStock(componentId) {
            const comp = boardComponents.find(c => c.id === componentId);
            if (!comp) {
                alert('Component not found');
                return;
            }

            const spec = COMPONENT_SPECS[comp.type];
            const quantity = comp.properties.quantity || 1;
            const cost = comp.properties.cost !== undefined ? comp.properties.cost : spec.cost;

            try {
                const response = await fetch('/api/crm/stock/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: comp.properties.name,
                        category: comp.properties.category || spec.name,
                        type: comp.type,
                        quantity: quantity,
                        cost: cost,
                        serialNumber: comp.properties.serialNumber || '',
                        notes: comp.properties.notes || '',
                        specifications: {
                            inputs: comp.properties.inputs !== undefined ? comp.properties.inputs : spec.inputs,
                            outputs: comp.properties.outputs !== undefined ? comp.properties.outputs : spec.outputs,
                            power: comp.properties.power !== undefined ? comp.properties.power : spec.power
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`‚úÖ "${comp.properties.name}" added to CRM stock (Qty: ${quantity})`);
                } else {
                    alert('‚ùå Failed to add to stock: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding to stock:', error);
                alert('‚ùå Error adding to stock. Check console for details.');
            }
        }

        // Add cable to CRM stock
        async function addCableToStock(connectionId) {
            const conn = boardConnections.find(c => c.id === connectionId);
            if (!conn) {
                alert('Cable not found');
                return;
            }

            const cableName = conn.name || 'Unnamed Cable';
            const category = conn.category || 'custom';
            const length = conn.length || 0;
            const pricePerMeter = conn.pricePerMeter || 0;
            const quantity = conn.quantity || 1;
            const totalCost = length * pricePerMeter * quantity;

            try {
                const response = await fetch('/api/crm/stock/add', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name: cableName,
                        category: category,
                        type: 'cable',
                        quantity: quantity,
                        cost: totalCost,
                        notes: conn.notes || '',
                        specifications: {
                            length: length,
                            pricePerMeter: pricePerMeter,
                            color: conn.color
                        }
                    })
                });

                const result = await response.json();
                if (result.success) {
                    alert(`‚úÖ "${cableName}" added to CRM stock (Qty: ${quantity}, ${length}m)`);
                } else {
                    alert('‚ùå Failed to add cable to stock: ' + result.error);
                }
            } catch (error) {
                console.error('Error adding cable to stock:', error);
                alert('‚ùå Error adding cable to stock. Check console for details.');
            }
        }

        // Assign component to job
        async function assignComponentToJob(componentId) {
            currentItemForAssignment = componentId;
            currentItemType = 'component';
            await openJobAssignmentModal();
        }

        // Assign cable to job
        async function assignCableToJob(connectionId) {
            currentItemForAssignment = connectionId;
            currentItemType = 'cable';
            await openJobAssignmentModal();
        }

        // Open job assignment modal and load jobs
        async function openJobAssignmentModal() {
            document.getElementById('jobAssignmentModal').classList.add('active');
            await loadJobsList();
        }

        function closeJobAssignmentModal() {
            document.getElementById('jobAssignmentModal').classList.remove('active');
            currentItemForAssignment = null;
            currentItemType = null;
        }

        // Load jobs from CRM
        async function loadJobsList() {
            const jobsList = document.getElementById('jobsList');
            jobsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #95a5a6;">Loading jobs...</div>';

            try {
                const response = await fetch('/api/crm/jobs');
                const result = await response.json();

                if (result.success && result.jobs && result.jobs.length > 0) {
                    jobsList.innerHTML = result.jobs.map(job => `
                        <div onclick="selectJobForAssignment('${job.id}')"
                             style="padding: 15px; background: #2c3e50; border: 2px solid #34495e; border-radius: 6px; margin-bottom: 10px; cursor: pointer; transition: all 0.3s;"
                             onmouseover="this.style.borderColor='#3498db'; this.style.background='#34495e';"
                             onmouseout="this.style.borderColor='#34495e'; this.style.background='#2c3e50';">
                            <div style="font-weight: 600; color: white; margin-bottom: 5px;">${job.name}</div>
                            <div style="font-size: 0.85em; color: #95a5a6;">
                                Customer: ${job.customer || 'N/A'} | Status: ${job.status || 'N/A'}
                            </div>
                            ${job.total ? `<div style="font-size: 0.85em; color: #27ae60; margin-top: 5px;">Total: $${job.total}</div>` : ''}
                        </div>
                    `).join('');
                } else {
                    jobsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #95a5a6;">No jobs available. Create a job in the CRM first.</div>';
                }
            } catch (error) {
                console.error('Error loading jobs:', error);
                jobsList.innerHTML = '<div style="text-align: center; padding: 20px; color: #e74c3c;">Error loading jobs. Check console for details.</div>';
            }
        }

        // Select job and assign item
        async function selectJobForAssignment(jobId) {
            if (!currentItemForAssignment || !currentItemType) {
                alert('No item selected for assignment');
                return;
            }

            let itemData = null;

            if (currentItemType === 'component') {
                const comp = boardComponents.find(c => c.id === currentItemForAssignment);
                if (!comp) {
                    alert('Component not found');
                    return;
                }

                const spec = COMPONENT_SPECS[comp.type];
                itemData = {
                    type: 'component',
                    name: comp.properties.name,
                    category: comp.properties.category || spec.name,
                    componentType: comp.type,
                    quantity: comp.properties.quantity || 1,
                    cost: comp.properties.cost !== undefined ? comp.properties.cost : spec.cost,
                    serialNumber: comp.properties.serialNumber || '',
                    notes: comp.properties.notes || '',
                    specifications: {
                        inputs: comp.properties.inputs !== undefined ? comp.properties.inputs : spec.inputs,
                        outputs: comp.properties.outputs !== undefined ? comp.properties.outputs : spec.outputs,
                        power: comp.properties.power !== undefined ? comp.properties.power : spec.power
                    }
                };
            } else if (currentItemType === 'cable') {
                const conn = boardConnections.find(c => c.id === currentItemForAssignment);
                if (!conn) {
                    alert('Cable not found');
                    return;
                }

                itemData = {
                    type: 'cable',
                    name: conn.name || 'Unnamed Cable',
                    category: conn.category || 'custom',
                    quantity: conn.quantity || 1,
                    cost: (conn.length || 0) * (conn.pricePerMeter || 0),
                    notes: conn.notes || '',
                    specifications: {
                        length: conn.length || 0,
                        pricePerMeter: conn.pricePerMeter || 0,
                        color: conn.color
                    }
                };
            }

            try {
                const response = await fetch(`/api/crm/jobs/${jobId}/assign-item`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(itemData)
                });

                const result = await response.json();
                if (result.success) {
                    alert(`‚úÖ Item assigned to job successfully!`);
                    closeJobAssignmentModal();
                } else {
                    alert('‚ùå Failed to assign item: ' + result.error);
                }
            } catch (error) {
                console.error('Error assigning item to job:', error);
                alert('‚ùå Error assigning item. Check console for details.');
            }
        }

        // Initialize on load
        initBoard();

        console.log('‚úÖ Board Builder ready with enhanced features');
    </script>

    <!-- AI Chatbot Component -->
    {% include 'chatbot_component.html' %}
</body>
</html>

<!DOCTYPE html>
<html lang="en" class="h-full">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>‚ö° Electrical CAD Designer - Integratd Living</title>

    <!-- External Dependencies -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.31/jspdf.plugin.autotable.min.js"></script>

    <!-- Excel/CSV Parsing Libraries for Automation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>

    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- Custom Tailwind Config -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        olive: {
                            50: '#f6f7f4',
                            100: '#e8ebe1',
                            200: '#d1d7c3',
                            300: '#b5bfa0',
                            400: '#9aa67e',
                            500: '#6AB64B',
                            600: '#5a9e3f',
                            700: '#455826',
                            800: '#3a4821',
                            900: '#323d1e',
                        }
                    },
                    fontFamily: {
                        sans: ['-apple-system', 'BlinkMacSystemFont', 'Segoe UI', 'Roboto', 'Helvetica Neue', 'Arial', 'sans-serif'],
                    },
                    animation: {
                        'fade-in': 'fadeIn 0.5s ease-in-out',
                        'slide-down': 'slideDown 0.3s ease-out',
                        'scale-in': 'scaleIn 0.3s ease-out',
                        'pulse-soft': 'pulseSoft 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.8' },
                        },
                    },
                }
            }
        }
    </script>

    <style>
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .spinner {
            animation: spin 1s linear infinite;
        }

        /* Custom scrollbar with olive theme */
        ::-webkit-scrollbar {
            width: 8px;
            height: 8px;
        }
        ::-webkit-scrollbar-track {
            background: #f1f1f1;
        }
        ::-webkit-scrollbar-thumb {
            background: #6AB64B;
            border-radius: 4px;
        }
        ::-webkit-scrollbar-thumb:hover {
            background: #5a9e3f;
        }

        /* Canvas white background */
        #cadCanvas {
            background: white;
        }

        /* Fabric.js compatibility */
        .canvas-container {
            margin: 0 auto !important;
        }
    </style>
</head>
<body class="h-full overflow-hidden bg-gradient-to-br from-gray-50 to-gray-100">

    <!-- Top Header -->
    <header class="bg-gradient-to-r from-olive-600 via-olive-500 to-olive-600 shadow-2xl border-b-4 border-olive-700">
        <div class="px-4 py-3">
            <!-- Title Row -->
            <div class="flex items-center justify-between">
                <a href="/" class="flex items-center gap-3 cursor-pointer hover:opacity-80 transition-all" title="Go to Home">
                    <div class="bg-white/20 backdrop-blur-sm p-2.5 rounded-xl shadow-lg">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <h1 class="text-2xl font-bold text-white tracking-wide">Electrical CAD Designer</h1>
                    <span class="hidden lg:inline-block px-3 py-1 bg-purple-500 text-white text-xs font-bold rounded-full shadow-md">PROFESSIONAL</span>
                </a>

                <!-- Collapsible Menu Button -->
                <div class="relative">
                    <button id="cadMenuToggleBtn" onclick="toggleCadMenu()" class="px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg transition-all font-bold text-xl shadow-lg">
                        <span id="cadMenuIcon">+</span>
                    </button>
                    <!-- Dropdown Menu -->
                    <div id="cadToolbarMenu" class="hidden absolute right-0 top-full mt-2 bg-gray-800 border-2 border-gray-600 rounded-xl p-4 min-w-72 z-50 shadow-2xl max-h-96 overflow-y-auto">
                        <!-- File Operations -->
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">File</div>
                        <button onclick="newProject(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg mb-2 text-sm font-semibold">üìÑ New Project</button>
                        <label class="block w-full text-left px-3 py-2 bg-teal-600 hover:bg-teal-700 text-white rounded-lg mb-2 text-sm font-semibold cursor-pointer">
                            üìé Upload File
                            <input type="file" id="fileUpload" accept=".pdf,.png,.jpg,.jpeg,.gif,.bmp" class="hidden" onchange="handleFileUpload(event)">
                        </label>
                        <button onclick="loadProject(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg mb-2 text-sm font-semibold">üìÇ Open Project</button>
                        <button onclick="saveProject(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg mb-2 text-sm font-semibold">üíæ Save Project</button>

                        <div class="border-t border-gray-600 my-3"></div>

                        <!-- CAD Tools -->
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">CAD Tools</div>
                        <button onclick="addTitleBlock(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-olive-700 hover:bg-olive-800 text-white rounded-lg mb-2 text-sm font-semibold">üìã Title Block</button>
                        <button onclick="generatePanelSchedule(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-orange-600 hover:bg-orange-700 text-white rounded-lg mb-2 text-sm font-semibold">üìä Panel Schedule</button>
                        <button onclick="generateCableSchedule(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg mb-2 text-sm font-semibold">üìã Cable Schedule</button>

                        <div class="border-t border-gray-600 my-3"></div>

                        <!-- Advanced Tools -->
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">Advanced</div>
                        <button onclick="showWireLabelMenu(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-pink-600 hover:bg-pink-700 text-white rounded-lg mb-2 text-sm font-semibold">üè∑Ô∏è Label Wires</button>
                        <button onclick="showMeasurementMenu(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg mb-2 text-sm font-semibold">üìè Measure</button>
                        <button onclick="showHatchDialog(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg mb-2 text-sm font-semibold">üé® Hatch</button>

                        <div class="border-t border-gray-600 my-3"></div>

                        <!-- Analysis -->
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">Analysis</div>
                        <button onclick="analyzeDrawing(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-gradient-to-r from-orange-500 to-red-500 text-white rounded-lg mb-2 text-sm font-semibold">üîç Analyze (AS/NZS 3000)</button>
                        <button onclick="toggleSchematicView(); toggleCadMenu();" id="schematicToggle" class="w-full text-left px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg mb-2 text-sm font-semibold">üìä Schematic View</button>
                        <button onclick="toggleOrtho(); toggleCadMenu();" id="orthoToggle" class="w-full text-left px-3 py-2 bg-gray-600 hover:bg-gray-700 text-white rounded-lg mb-2 text-sm font-semibold">‚ä• Ortho Mode (F8)</button>

                        <div class="border-t border-gray-600 my-3"></div>

                        <!-- AI & Export -->
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">AI & Export</div>
                        <button onclick="openAIModal(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-gradient-to-r from-purple-600 to-indigo-600 text-white rounded-lg mb-2 text-sm font-bold">ü§ñ AI Auto-Generate</button>
                        <button onclick="showImportMenu(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg mb-2 text-sm font-semibold">üì• Import</button>
                        <button onclick="showExportMenu(); toggleCadMenu();" class="w-full text-left px-3 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg mb-2 text-sm font-semibold">üì§ Export</button>

                        <div class="border-t border-gray-600 my-3"></div>

                        <!-- Navigation -->
                        <div class="text-xs text-gray-400 uppercase font-bold mb-2">Navigation</div>
                        <button onclick="window.location.href='/'" class="w-full text-left px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg mb-2 text-sm font-semibold">üè† Home</button>
                        <button onclick="window.location.href='/mapping'" class="w-full text-left px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg mb-2 text-sm font-semibold">‚ö° Mapping</button>
                        <button onclick="window.location.href='/board-builder'" class="w-full text-left px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg text-sm font-semibold">üîå Board Builder</button>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <script>
        function toggleCadMenu() {
            const menu = document.getElementById('cadToolbarMenu');
            const icon = document.getElementById('cadMenuIcon');
            menu.classList.toggle('hidden');
            icon.textContent = menu.classList.contains('hidden') ? '+' : '√ó';
        }
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('cadToolbarMenu');
            const btn = document.getElementById('cadMenuToggleBtn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.classList.add('hidden');
                document.getElementById('cadMenuIcon').textContent = '+';
            }
        });
    </script>

    <!-- Main Container -->
    <div class="flex h-[calc(100vh-138px)]">
        <!-- Left Toolbar -->
        <aside class="w-24 bg-gradient-to-b from-gray-800 to-gray-900 shadow-2xl flex flex-col overflow-y-auto">
            <div class="p-2 space-y-2">
                <div class="tool-btn bg-gradient-to-br from-olive-500 to-olive-600 text-white rounded-xl shadow-lg hover:shadow-xl transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1 active border-2 border-olive-300" onclick="selectTool('select')" data-tool="select">
                    <div class="text-2xl">‚¨õ</div>
                    <div class="text-[10px] font-bold text-center">Select</div>
                </div>
                <div class="tool-btn bg-gray-700 hover:bg-olive-500 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1 border-2 border-transparent hover:border-olive-300" onclick="selectTool('line')" data-tool="line">
                    <div class="text-2xl">üìè</div>
                    <div class="text-[10px] font-bold text-center">Line</div>
                </div>
                <div class="tool-btn bg-gray-700 hover:bg-olive-500 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1 border-2 border-transparent hover:border-olive-300" onclick="selectTool('rectangle')" data-tool="rectangle">
                    <div class="text-2xl">‚ñ≠</div>
                    <div class="text-[10px] font-bold text-center">Rectangle</div>
                </div>
                <div class="tool-btn bg-gray-700 hover:bg-olive-500 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1 border-2 border-transparent hover:border-olive-300" onclick="selectTool('circle')" data-tool="circle">
                    <div class="text-2xl">‚≠ï</div>
                    <div class="text-[10px] font-bold text-center">Circle</div>
                </div>
                <div class="tool-btn bg-gray-700 hover:bg-olive-500 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1 border-2 border-transparent hover:border-olive-300" onclick="selectTool('text')" data-tool="text">
                    <div class="text-2xl">üî§</div>
                    <div class="text-[10px] font-bold text-center">Text</div>
                </div>
                <div class="tool-btn bg-gray-700 hover:bg-olive-500 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1 border-2 border-transparent hover:border-olive-300" onclick="selectTool('wire')" data-tool="wire">
                    <div class="text-2xl">„Ä∞Ô∏è</div>
                    <div class="text-[10px] font-bold text-center">Wire</div>
                </div>
                <div class="tool-btn bg-gray-700 hover:bg-olive-500 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1 border-2 border-transparent hover:border-olive-300" onclick="selectTool('dimension')" data-tool="dimension">
                    <div class="text-2xl">üìê</div>
                    <div class="text-[10px] font-bold text-center">Dimension</div>
                </div>
                <div class="tool-btn bg-gray-700 hover:bg-olive-500 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1 border-2 border-transparent hover:border-olive-300" onclick="selectTool('pan')" data-tool="pan">
                    <div class="text-2xl">‚úã</div>
                    <div class="text-[10px] font-bold text-center">Pan</div>
                </div>
                <div class="h-px bg-gray-600 my-2"></div>
                <div class="tool-btn bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1" onclick="zoomIn()">
                    <div class="text-2xl">üîç+</div>
                    <div class="text-[10px] font-bold text-center">Zoom In</div>
                </div>
                <div class="tool-btn bg-blue-600 hover:bg-blue-700 text-white rounded-xl shadow-md hover:shadow-lg transition-all cursor-pointer p-3 flex flex-col items-center justify-center gap-1" onclick="zoomOut()">
                    <div class="text-2xl">üîç-</div>
                    <div class="text-[10px] font-bold text-center">Zoom Out</div>
                </div>
            </div>
        </aside>

        <!-- Canvas Area -->
        <main class="flex-1 bg-gradient-to-br from-gray-200 via-gray-100 to-gray-200 relative overflow-hidden flex items-center justify-center">
            <canvas id="cadCanvas"></canvas>
        </main>

        <!-- Right Panel -->
        <aside class="w-80 bg-white shadow-2xl flex flex-col border-l-4 border-olive-500">
            <!-- Tabs -->
            <div class="flex bg-gradient-to-r from-gray-100 to-gray-50 border-b-2 border-gray-200">
                <div class="panel-tab flex-1 px-4 py-3 text-center cursor-pointer transition-all font-bold text-sm bg-white border-b-4 border-olive-500 text-olive-600" onclick="switchTab('properties')">
                    <div>‚öôÔ∏è Properties</div>
                </div>
                <div class="panel-tab flex-1 px-4 py-3 text-center cursor-pointer transition-all font-bold text-sm hover:bg-white border-b-4 border-transparent hover:border-olive-300 text-gray-600 hover:text-olive-600" onclick="switchTab('symbols')">
                    <div>üîß Symbols</div>
                </div>
                <div class="panel-tab flex-1 px-4 py-3 text-center cursor-pointer transition-all font-bold text-sm hover:bg-white border-b-4 border-transparent hover:border-olive-300 text-gray-600 hover:text-olive-600" onclick="switchTab('layers')">
                    <div>üìö Layers</div>
                </div>
            </div>

            <!-- Properties Panel -->
            <div class="panel-content flex-1 overflow-y-auto p-5 space-y-4" id="propertiesPanel">
                <div class="bg-gradient-to-br from-olive-50 to-green-50 rounded-xl p-4 border-2 border-olive-200 shadow-md">
                    <h3 class="text-olive-700 font-bold text-sm uppercase tracking-wide mb-3 flex items-center gap-2">
                        <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/>
                        </svg>
                        Project Metadata
                    </h3>

                    <div class="space-y-3">
                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Project Name</label>
                            <input type="text" id="projectName" value="Untitled Project" onchange="updateMetadata()" class="w-full px-3 py-2.5 bg-white border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent transition-all text-sm font-medium">
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Drawing Number</label>
                            <input type="text" id="drawingNumber" value="E-001" onchange="updateMetadata()" class="w-full px-3 py-2.5 bg-white border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent transition-all text-sm font-medium">
                        </div>

                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Scale</label>
                                <select id="scale" onchange="updateMetadata()" class="w-full px-3 py-2.5 bg-white border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-500 text-sm font-medium cursor-pointer">
                                    <option value="1:50">1:50</option>
                                    <option value="1:100" selected>1:100</option>
                                    <option value="1:200">1:200</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-semibold text-gray-700 mb-1.5">Revision</label>
                                <input type="text" id="revision" value="A" onchange="updateMetadata()" class="w-full px-3 py-2.5 bg-white border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-500 focus:border-transparent transition-all text-sm font-medium text-center">
                            </div>
                        </div>

                        <div>
                            <label class="block text-sm font-semibold text-gray-700 mb-1.5">Paper Size</label>
                            <select id="paperSize" onchange="updateMetadata()" class="w-full px-3 py-2.5 bg-white border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-500 text-sm font-medium cursor-pointer">
                                <option value="A4">A4 (210 √ó 297 mm)</option>
                                <option value="A3">A3 (297 √ó 420 mm)</option>
                                <option value="A2">A2 (420 √ó 594 mm)</option>
                                <option value="A1" selected>A1 (594 √ó 841 mm)</option>
                                <option value="A0">A0 (841 √ó 1189 mm)</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Symbols Panel -->
            <div class="panel-content flex-1 overflow-y-auto p-5 hidden" id="symbolsPanel">
                <div class="space-y-4">
                    <!-- Symbols will be populated by JavaScript -->
                    <div class="text-center py-12 text-gray-400">
                        <svg class="w-16 h-16 mx-auto mb-4 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 11H5m14 0a2 2 0 012 2v6a2 2 0 01-2 2H5a2 2 0 01-2-2v-6a2 2 0 012-2m14 0V9a2 2 0 00-2-2M5 11V9a2 2 0 012-2m0 0V5a2 2 0 012-2h6a2 2 0 012 2v2M7 7h10"/>
                        </svg>
                        <p class="font-semibold text-sm">Symbol Library</p>
                        <p class="text-xs mt-1">Populated by cad-engine.js</p>
                    </div>
                </div>
            </div>

            <!-- Layers Panel -->
            <div class="panel-content flex-1 overflow-y-auto p-5 hidden" id="layersPanel">
                <div class="space-y-3">
                    <div id="layersList" class="space-y-2">
                        <!-- Layers will be populated by JavaScript -->
                        <div class="text-center py-8 text-gray-400">
                            <svg class="w-12 h-12 mx-auto mb-3 opacity-50" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21a4 4 0 01-4-4V5a2 2 0 012-2h4a2 2 0 012 2v12a4 4 0 01-4 4zm0 0h12a2 2 0 002-2v-4a2 2 0 00-2-2h-2.343M11 7.343l1.657-1.657a2 2 0 012.828 0l2.829 2.829a2 2 0 010 2.828l-8.486 8.485M7 17h.01"/>
                            </svg>
                            <p class="font-semibold text-sm">No layers yet</p>
                        </div>
                    </div>
                    <button class="w-full px-4 py-3 bg-gradient-to-r from-olive-600 to-olive-500 hover:from-olive-700 hover:to-olive-600 text-white rounded-xl transition-all font-bold shadow-md flex items-center justify-center gap-2" onclick="addLayer()">
                        <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"/>
                        </svg>
                        Add New Layer
                    </button>
                </div>
            </div>
        </aside>
    </div>

    <!-- Bottom Toolbar -->
    <footer class="bg-gradient-to-r from-gray-800 to-gray-900 shadow-2xl border-t-4 border-olive-500 px-6 py-3">
        <div class="flex items-center justify-between gap-6 text-sm">
            <div class="flex items-center gap-2">
                <label class="text-gray-300 font-semibold">Layer:</label>
                <select id="currentLayer" class="px-3 py-1.5 bg-gray-700 border-2 border-olive-500 text-white rounded-lg focus:outline-none focus:ring-2 focus:ring-olive-400 font-medium text-sm cursor-pointer">
                    <option value="WALLS-ARCHITECTURAL">WALLS</option>
                    <option value="DEVICES-SYMBOLS">DEVICES</option>
                </select>
            </div>

            <div class="flex items-center gap-6">
                <div class="flex items-center gap-2">
                    <label class="text-gray-300 font-semibold">Grid:</label>
                    <input type="checkbox" id="gridSnap" checked onchange="toggleGrid()" class="w-4 h-4 text-olive-600 bg-gray-100 border-gray-300 rounded focus:ring-olive-500 cursor-pointer">
                </div>

                <div class="flex items-center gap-2">
                    <label class="text-gray-300 font-semibold">Snap:</label>
                    <input type="checkbox" id="objectSnap" checked class="w-4 h-4 text-olive-600 bg-gray-100 border-gray-300 rounded focus:ring-olive-500 cursor-pointer">
                </div>

                <div class="flex items-center gap-2">
                    <label class="text-gray-300 font-semibold">Zoom:</label>
                    <span id="zoomLevel" class="text-white font-bold bg-gray-700 px-3 py-1 rounded-lg border-2 border-olive-500 min-w-[60px] text-center">100%</span>
                </div>

                <div class="flex items-center gap-2">
                    <label class="text-gray-300 font-semibold">Objects:</label>
                    <span id="objectCount" class="text-white font-bold bg-gray-700 px-3 py-1 rounded-lg border-2 border-green-500 min-w-[50px] text-center">0</span>
                </div>
            </div>
        </div>
    </footer>

    <!-- AI Generation Modal -->
    <div class="modal hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" id="aiModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full max-h-[85vh] overflow-y-auto animate-scale-in">
            <div class="bg-gradient-to-r from-purple-600 to-indigo-600 p-6 rounded-t-2xl flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <span class="text-3xl">ü§ñ</span> AI Auto-Generate Complete Drawings
                </h2>
                <button onclick="closeAIModal()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-all hover:rotate-90 text-white text-xl font-bold">
                    ‚úñ
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-xl p-4 border-2 border-purple-200">
                    <p class="text-gray-700 leading-relaxed">
                        <strong class="text-purple-700">AI-Powered Professional CAD Generation:</strong> Our advanced AI will create complete electrical CAD drawings from your floor plan and Loxone board data. This includes wiring diagrams, floor plans with electrical overlays, panel schedules, cable schedules, and professional legends.
                    </p>
                </div>

                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Project Requirements</label>
                    <textarea id="aiRequirements" rows="6" placeholder="Describe your project in detail (e.g., 3-bedroom house with comprehensive lighting control, HVAC automation, security system, intercom, audio/video distribution...)" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-transparent resize-none"></textarea>
                </div>

                <button onclick="generateWithAI()" class="w-full px-6 py-4 bg-gradient-to-r from-purple-600 to-indigo-600 hover:from-purple-700 hover:to-indigo-700 text-white rounded-xl transition-all font-bold text-lg shadow-lg flex items-center justify-center gap-3">
                    <span class="text-2xl">ü§ñ</span>
                    Generate Professional Drawings
                </button>
            </div>
        </div>
    </div>

    <!-- Export Modal -->
    <div class="modal hidden fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4" id="exportModal">
        <div class="bg-white rounded-2xl shadow-2xl max-w-xl w-full animate-scale-in">
            <div class="bg-gradient-to-r from-red-600 to-orange-600 p-6 rounded-t-2xl flex justify-between items-center">
                <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                    <span class="text-3xl">üì§</span> Export Drawing
                </h2>
                <button onclick="closeExportModal()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-all hover:rotate-90 text-white text-xl font-bold">
                    ‚úñ
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div>
                    <label class="block text-sm font-bold text-gray-700 mb-2">Export Format</label>
                    <select id="exportFormat" class="w-full px-4 py-3 bg-gray-50 border-2 border-gray-200 rounded-xl focus:outline-none focus:ring-2 focus:ring-red-500 focus:border-transparent font-medium cursor-pointer">
                        <option value="dxf">üìê DXF (AutoCAD Compatible)</option>
                        <option value="pdf">üìÑ PDF (Print Ready)</option>
                        <option value="png">üñºÔ∏è PNG (High Resolution Image)</option>
                        <option value="svg">üìä SVG (Scalable Vector)</option>
                    </select>
                </div>

                <button onclick="executeExport()" class="w-full px-6 py-4 bg-gradient-to-r from-red-600 to-orange-600 hover:from-red-700 hover:to-orange-700 text-white rounded-xl transition-all font-bold text-lg shadow-lg flex items-center justify-center gap-3">
                    <span class="text-2xl">üì•</span>
                    Download Export
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div class="loading-overlay hidden fixed inset-0 bg-black/90 z-[100] flex items-center justify-center" id="loadingOverlay">
        <div class="text-center">
            <div class="w-20 h-20 border-4 border-gray-700 border-t-olive-500 rounded-full mx-auto mb-6 spinner"></div>
            <div class="text-white text-2xl font-bold mb-2">Generating Professional CAD Drawings...</div>
            <div class="text-gray-400 text-lg">This may take 30-120 seconds</div>
            <div class="mt-6 flex items-center justify-center gap-2">
                <div class="w-3 h-3 bg-olive-500 rounded-full animate-bounce" style="animation-delay: 0s"></div>
                <div class="w-3 h-3 bg-olive-500 rounded-full animate-bounce" style="animation-delay: 0.2s"></div>
                <div class="w-3 h-3 bg-olive-500 rounded-full animate-bounce" style="animation-delay: 0.4s"></div>
            </div>
        </div>
    </div>

    <!-- External JavaScript Modules -->
    <script src="/static/cad-engine.js"></script>
    <script src="/static/panel-schedule.js"></script>
    <script src="/static/cable-schedule.js"></script>
    <script src="/static/validation-engine.js"></script>
    <script src="/static/wire-labeling.js"></script>
    <script src="/static/measurement-tools.js"></script>
    <script src="/static/hatching-patterns.js"></script>
    <script src="/static/pdf-export.js"></script>
    <script src="/static/schematic-view.js"></script>

    <script>
        // Check for imported data on page load
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('import') === 'true') {
                const importData = sessionStorage.getItem('import_data');
                if (importData) {
                    try {
                        const data = JSON.parse(importData);
                        console.log('Imported data to CAD Designer:', data);
                        
                        // Load floorplan image if available
                        if (data.floorplan_image && typeof cadEngine !== 'undefined') {
                            console.log('Loading floorplan image into CAD...');
                            const img = new Image();
                            img.onload = function() {
                                if (cadEngine.setBackgroundImage) {
                                    cadEngine.setBackgroundImage(img);
                                } else if (cadEngine.canvas) {
                                    // Fallback: draw on canvas
                                    const ctx = cadEngine.canvas.getContext('2d');
                                    ctx.drawImage(img, 0, 0, cadEngine.canvas.width, cadEngine.canvas.height);
                                }
                                showImportToast(`Floorplan imported: ${data.project_name}`, 'success');
                            };
                            img.onerror = function() {
                                console.error('Failed to load floorplan image');
                                showImportToast(`Data imported: ${data.project_name}`, 'success');
                            };
                            img.src = data.floorplan_image;
                        } else {
                            setTimeout(() => showImportToast(`Data imported: ${data.project_name}`, 'success'), 500);
                        }
                        
                        // Store project info
                        window.importedProjectData = data;
                        
                        sessionStorage.removeItem('import_data');
                        sessionStorage.removeItem('import_source');
                    } catch (e) {
                        console.error('Import error:', e);
                    }
                }
            }
        })();

        function showImportToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-blue-500'} text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }

        // Tool selection with visual feedback
        function selectTool(tool) {
            // Remove active class from all tools
            document.querySelectorAll('[data-tool]').forEach(btn => {
                btn.classList.remove('active', 'bg-gradient-to-br', 'from-olive-500', 'to-olive-600', 'border-olive-300');
                btn.classList.add('bg-gray-700', 'hover:bg-olive-500', 'border-transparent', 'hover:border-olive-300');
            });

            // Add active class to selected tool
            const selectedBtn = document.querySelector(`[data-tool="${tool}"]`);
            if (selectedBtn) {
                selectedBtn.classList.add('active', 'bg-gradient-to-br', 'from-olive-500', 'to-olive-600', 'border-olive-300');
                selectedBtn.classList.remove('bg-gray-700', 'hover:bg-olive-500', 'border-transparent', 'hover:border-olive-300');
            }

            // Call the actual tool selection (defined in cad-engine.js)
            if (typeof window.setActiveTool === 'function') {
                window.setActiveTool(tool);
            }
        }

        // Panel tab switching
        function switchTab(tabName) {
            // Hide all panels
            document.querySelectorAll('.panel-content').forEach(panel => {
                panel.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.panel-tab').forEach(tab => {
                tab.classList.remove('bg-white', 'border-olive-500', 'text-olive-600');
                tab.classList.add('border-transparent', 'text-gray-600', 'hover:text-olive-600', 'hover:border-olive-300');
            });

            // Show selected panel
            const panel = document.getElementById(tabName + 'Panel');
            if (panel) {
                panel.classList.remove('hidden');
            }

            // Activate selected tab
            const tabElements = document.querySelectorAll('.panel-tab');
            const tabIndex = { 'properties': 0, 'symbols': 1, 'layers': 2 }[tabName];
            if (tabElements[tabIndex]) {
                tabElements[tabIndex].classList.add('bg-white', 'border-olive-500', 'text-olive-600');
                tabElements[tabIndex].classList.remove('border-transparent', 'text-gray-600', 'hover:text-olive-600', 'hover:border-olive-300');
            }
        }

        // Modal controls
        function openAIModal() {
            document.getElementById('aiModal').classList.remove('hidden');
            document.getElementById('aiModal').classList.add('flex');
        }

        function closeAIModal() {
            document.getElementById('aiModal').classList.add('hidden');
            document.getElementById('aiModal').classList.remove('flex');
        }

        function closeExportModal() {
            document.getElementById('exportModal').classList.add('hidden');
            document.getElementById('exportModal').classList.remove('flex');
        }

        function exportDrawing() {
            document.getElementById('exportModal').classList.remove('hidden');
            document.getElementById('exportModal').classList.add('flex');
        }

        // Wire labeling menu with modern Tailwind styling
        function showWireLabelMenu() {
            closeAllMenus();

            const menu = document.createElement('div');
            menu.id = 'wireLabelMenu';
            menu.className = 'fixed top-32 right-6 bg-white rounded-2xl shadow-2xl z-50 w-72 animate-scale-in border-2 border-pink-200';

            menu.innerHTML = `
                <div class="bg-gradient-to-r from-pink-600 to-pink-500 p-4 rounded-t-2xl">
                    <div class="text-white font-bold text-lg flex items-center gap-2">
                        <span class="text-2xl">üè∑Ô∏è</span> Wire Labeling
                    </div>
                </div>
                <div class="p-4 space-y-2">
                    <button onclick="autoNumberWires(); closeMenu('wireLabelMenu')" class="w-full px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üî¢ Auto-Number All Wires</button>
                    <button onclick="labelSelectedWires(); closeMenu('wireLabelMenu')" class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">‚úèÔ∏è Label Selected Wire</button>
                    <button onclick="labelWireWithCircuit(); closeMenu('wireLabelMenu')" class="w-full px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">‚ö° Circuit Label</button>
                    <button onclick="toggleWireLabels(); closeMenu('wireLabelMenu')" class="w-full px-4 py-2.5 bg-amber-600 hover:bg-amber-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üëÅÔ∏è Toggle Visibility</button>
                    <button onclick="exportWireList(); closeMenu('wireLabelMenu')" class="w-full px-4 py-2.5 bg-gray-600 hover:bg-gray-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üìã Wire List</button>
                    <button onclick="changeLabelPrefix(); closeMenu('wireLabelMenu')" class="w-full px-4 py-2.5 bg-olive-600 hover:bg-olive-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üî§ Change Prefix</button>
                    <button onclick="closeMenu('wireLabelMenu')" class="w-full px-4 py-2.5 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition-all font-semibold text-sm shadow-md mt-2">Close</button>
                </div>
            `;

            document.body.appendChild(menu);
        }

        // Measurement tools menu
        function showMeasurementMenu() {
            closeAllMenus();

            const menu = document.createElement('div');
            menu.id = 'measurementMenu';
            menu.className = 'fixed top-32 right-6 bg-white rounded-2xl shadow-2xl z-50 w-72 animate-scale-in border-2 border-cyan-200';

            menu.innerHTML = `
                <div class="bg-gradient-to-r from-cyan-600 to-cyan-500 p-4 rounded-t-2xl">
                    <div class="text-white font-bold text-lg flex items-center gap-2">
                        <span class="text-2xl">üìè</span> Measurement Tools
                    </div>
                </div>
                <div class="p-4 space-y-2">
                    <button onclick="startDistanceMeasurement(); closeMenu('measurementMenu')" class="w-full px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üìè Distance</button>
                    <button onclick="startAreaMeasurement(); closeMenu('measurementMenu')" class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üìê Area</button>
                    <button onclick="startAngleMeasurement(); closeMenu('measurementMenu')" class="w-full px-4 py-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üìê Angle</button>
                    <button onclick="showMeasurementsList(); closeMenu('measurementMenu')" class="w-full px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üìã List All</button>
                    <button onclick="clearAllMeasurements(); closeMenu('measurementMenu')" class="w-full px-4 py-2.5 bg-red-600 hover:bg-red-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üóëÔ∏è Clear All</button>
                    <button onclick="closeMenu('measurementMenu')" class="w-full px-4 py-2.5 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition-all font-semibold text-sm shadow-md mt-2">Close</button>
                </div>
            `;

            document.body.appendChild(menu);
        }

        // Export menu
        function showExportMenu() {
            closeAllMenus();

            const menu = document.createElement('div');
            menu.id = 'exportMenu';
            menu.className = 'fixed top-32 right-6 bg-white rounded-2xl shadow-2xl z-50 w-80 animate-scale-in border-2 border-red-200';

            menu.innerHTML = `
                <div class="bg-gradient-to-r from-red-600 to-orange-600 p-4 rounded-t-2xl">
                    <div class="text-white font-bold text-lg flex items-center gap-2">
                        <span class="text-2xl">üì§</span> Export Options
                    </div>
                </div>
                <div class="p-4 space-y-2">
                    <button onclick="exportCurrentSheetToPDF(); closeMenu('exportMenu')" class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üìÑ Current Sheet to PDF</button>
                    <button onclick="exportAllSheetsToPDF(); closeMenu('exportMenu')" class="w-full px-4 py-2.5 bg-green-600 hover:bg-green-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üìö All Sheets to PDF</button>
                    <button onclick="exportSchematicToPDF(); closeMenu('exportMenu')" class="w-full px-4 py-2.5 bg-orange-600 hover:bg-orange-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üìä Schematic to PDF</button>
                    <button onclick="exportDrawing(); closeMenu('exportMenu')" class="w-full px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üì¶ DXF/PNG/SVG Export</button>
                    <button onclick="closeMenu('exportMenu')" class="w-full px-4 py-2.5 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition-all font-semibold text-sm shadow-md mt-2">Close</button>
                </div>
            `;

            document.body.appendChild(menu);
        }

        // Import menu
        function showImportMenu() {
            closeAllMenus();

            const menu = document.createElement('div');
            menu.id = 'importMenu';
            menu.className = 'fixed top-32 right-6 bg-white rounded-2xl shadow-2xl z-50 w-80 animate-scale-in border-2 border-blue-200';

            menu.innerHTML = `
                <div class="bg-gradient-to-r from-blue-600 to-indigo-600 p-4 rounded-t-2xl">
                    <div class="text-white font-bold text-lg flex items-center gap-2">
                        <span class="text-2xl">üì•</span> Import Data
                    </div>
                </div>
                <div class="p-4 space-y-2">
                    <div class="bg-gradient-to-r from-amber-50 to-orange-50 rounded-lg p-3 border-2 border-amber-200 mb-3">
                        <p class="text-xs font-bold text-amber-800 uppercase mb-1">‚ú® AutoCAD Electrical Replacement</p>
                        <p class="text-xs text-gray-700">Upload Excel/CSV panel schedules for automated wiring!</p>
                    </div>

                    <label class="w-full px-4 py-2.5 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-lg transition-all font-bold text-sm shadow-lg cursor-pointer flex items-center justify-center gap-2">
                        <span>üìä</span> Upload Excel Panel Schedule
                        <input type="file" id="excelUpload" accept=".xlsx,.xls" class="hidden" onchange="handleExcelUpload(event)">
                    </label>

                    <label class="w-full px-4 py-2.5 bg-gradient-to-r from-blue-600 to-cyan-600 hover:from-blue-700 hover:to-cyan-700 text-white rounded-lg transition-all font-bold text-sm shadow-lg cursor-pointer flex items-center justify-center gap-2">
                        <span>üìÑ</span> Upload CSV Panel Schedule
                        <input type="file" id="csvUpload" accept=".csv" class="hidden" onchange="handleCSVUpload(event)">
                    </label>

                    <button onclick="showDatabaseImportDialog(); closeMenu('importMenu')" class="w-full px-4 py-2.5 bg-gradient-to-r from-indigo-600 to-purple-600 hover:from-indigo-700 hover:to-purple-700 text-white rounded-lg transition-all font-bold text-sm shadow-lg flex items-center justify-center gap-2">
                        <span>üóÑÔ∏è</span> Import from Database
                    </button>

                    <div class="h-px bg-gray-300 my-3"></div>

                    <button onclick="showBoardImportDialog(); closeMenu('importMenu')" class="w-full px-4 py-2.5 bg-purple-600 hover:bg-purple-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üîß Import from Board Builder</button>
                    <button onclick="showQuoteImportDialog(); closeMenu('importMenu')" class="w-full px-4 py-2.5 bg-blue-600 hover:bg-blue-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md">üí∞ Import from Quote Tool</button>
                    <button onclick="closeMenu('importMenu')" class="w-full px-4 py-2.5 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-lg transition-all font-semibold text-sm shadow-md mt-2">Close</button>
                </div>
            `;

            document.body.appendChild(menu);
        }

        // Close all menus
        function closeAllMenus() {
            ['wireLabelMenu', 'measurementMenu', 'exportMenu', 'importMenu'].forEach(menuId => {
                closeMenu(menuId);
            });
        }

        function closeMenu(menuId) {
            const menu = document.getElementById(menuId);
            if (menu) menu.remove();
        }

        // Import from Board Builder
        async function showBoardImportDialog() {
            const boardId = prompt('Enter Board Builder Session ID:');
            if (!boardId) return;

            try {
                const response = await fetch(`/api/cad/import-board/${boardId}`);
                const data = await response.json();

                if (data.success) {
                    // Load the CAD objects onto canvas
                    data.objects.forEach(obj => {
                        if (typeof addObjectToCanvas === 'function') {
                            addObjectToCanvas(obj);
                        }
                    });

                    alert(`‚úÖ Imported ${data.objects.length} objects from Board Builder`);
                    if (typeof canvas !== 'undefined' && canvas) {
                        canvas.renderAll();
                    }
                } else {
                    alert('‚ùå Failed to import: ' + data.error);
                }
            } catch (error) {
                console.error('Board import error:', error);
                alert('‚ùå Error importing board: ' + error.message);
            }
        }

        // Import from Quote Tool
        async function showQuoteImportDialog() {
            const quoteId = prompt('Enter Quote/Mapping Session ID:');
            if (!quoteId) return;

            try {
                const response = await fetch(`/api/cad/import-quote/${quoteId}`);
                const data = await response.json();

                if (data.success) {
                    // Load floor plan image if available
                    if (data.floor_plan_url) {
                        loadFloorPlanBackground(data.floor_plan_url);
                    }

                    // Load the CAD objects onto canvas
                    data.objects.forEach(obj => {
                        if (typeof addObjectToCanvas === 'function') {
                            addObjectToCanvas(obj);
                        }
                    });

                    // Update project name
                    if (data.project_name && document.getElementById('projectName')) {
                        document.getElementById('projectName').value = data.project_name;
                    }

                    alert(`‚úÖ Imported ${data.objects.length} devices from Quote Tool`);
                    if (typeof canvas !== 'undefined' && canvas) {
                        canvas.renderAll();
                    }
                } else {
                    alert('‚ùå Failed to import: ' + data.error);
                }
            } catch (error) {
                console.error('Quote import error:', error);
                alert('‚ùå Error importing quote: ' + error.message);
            }
        }

        // Helper function to load floor plan background
        function loadFloorPlanBackground(imageUrl) {
            if (typeof fabric !== 'undefined' && typeof canvas !== 'undefined') {
                fabric.Image.fromURL(imageUrl, function(img) {
                    img.set({
                        left: 0,
                        top: 0,
                        selectable: false,
                        evented: false,
                        opacity: 0.3
                    });
                    canvas.setBackgroundImage(img, canvas.renderAll.bind(canvas));
                });
            }
        }

        // Helper function to add object to canvas (converts JSON to Fabric object)
        function addObjectToCanvas(objData) {
            if (typeof fabric === 'undefined' || typeof canvas === 'undefined') return;

            if (objData.type === 'rect') {
                const rect = new fabric.Rect({
                    left: objData.left,
                    top: objData.top,
                    width: objData.width,
                    height: objData.height,
                    fill: objData.fill,
                    stroke: objData.stroke,
                    strokeWidth: objData.strokeWidth,
                    customType: objData.customType,
                    layer: objData.layer
                });
                canvas.add(rect);
            } else if (objData.type === 'text') {
                const text = new fabric.Text(objData.text, {
                    left: objData.left,
                    top: objData.top,
                    fontSize: objData.fontSize,
                    fontWeight: objData.fontWeight,
                    fill: objData.fill,
                    customType: objData.customType,
                    layer: objData.layer
                });
                canvas.add(text);
            } else if (objData.type === 'group' && objData.symbolId) {
                // Load symbol from library
                if (typeof loadSymbolFromLibrary === 'function') {
                    loadSymbolFromLibrary(objData.symbolId, objData.left, objData.top);
                }
            }
        }

        // Loading overlay controls
        function showLoading(message, detail) {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.querySelector('.loading-text')?.textContent = message || 'Processing...';
                overlay.querySelector('.loading-detail')?.textContent = detail || '';
                overlay.classList.remove('hidden');
                overlay.classList.add('flex');
            }
        }

        function hideLoading() {
            const overlay = document.getElementById('loadingOverlay');
            if (overlay) {
                overlay.classList.add('hidden');
                overlay.classList.remove('flex');
            }
        }

        // ========================================
        // AUTOCAD ELECTRICAL AUTOMATION ENGINE
        // ========================================

        let parsedPanelData = null; // Store parsed panel schedule data
        let automationSettings = {
            autoRoute: true,
            autoSize: true,
            autoLabel: true,
            spacing: 50,
            wireType: '14/2 NM-B'
        };

        // Handle Excel Upload
        async function handleExcelUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading('üìä Parsing Excel Panel Schedule...', 'Reading circuit data from Excel file');

            try {
                const data = await file.arrayBuffer();
                const workbook = XLSX.read(data, { type: 'array' });

                // Get first sheet
                const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
                const jsonData = XLSX.utils.sheet_to_json(firstSheet, { header: 1 });

                console.log('üìä Parsed Excel Data:', jsonData);

                // Parse panel schedule structure
                parsedPanelData = parsePanelScheduleData(jsonData);

                hideLoading();

                if (parsedPanelData && parsedPanelData.circuits && parsedPanelData.circuits.length > 0) {
                    alert(`‚úÖ Successfully parsed ${parsedPanelData.circuits.length} circuits from Excel!`);
                    showAutomationDialog();
                } else {
                    alert('‚ö†Ô∏è No valid circuit data found in Excel file. Please ensure your Excel file has columns for: Circuit#, Description, Load(VA), Breaker(A), Wire Size');
                }
            } catch (error) {
                hideLoading();
                console.error('Excel parsing error:', error);
                alert('‚ùå Error parsing Excel file: ' + error.message);
            }
        }

        // Handle CSV Upload
        function handleCSVUpload(event) {
            const file = event.target.files[0];
            if (!file) return;

            showLoading('üìÑ Parsing CSV Panel Schedule...', 'Reading circuit data from CSV file');

            Papa.parse(file, {
                complete: function(results) {
                    console.log('üìÑ Parsed CSV Data:', results.data);

                    // Parse panel schedule structure
                    parsedPanelData = parsePanelScheduleData(results.data);

                    hideLoading();

                    if (parsedPanelData && parsedPanelData.circuits && parsedPanelData.circuits.length > 0) {
                        alert(`‚úÖ Successfully parsed ${parsedPanelData.circuits.length} circuits from CSV!`);
                        showAutomationDialog();
                    } else {
                        alert('‚ö†Ô∏è No valid circuit data found in CSV file. Please ensure your CSV has columns for: Circuit#, Description, Load(VA), Breaker(A), Wire Size');
                    }
                },
                error: function(error) {
                    hideLoading();
                    console.error('CSV parsing error:', error);
                    alert('‚ùå Error parsing CSV file: ' + error.message);
                }
            });
        }

        // Parse Panel Schedule Data (Excel or CSV format)
        function parsePanelScheduleData(data) {
            if (!data || data.length < 2) return null;

            // Find header row (look for common column names)
            let headerRow = -1;
            const headerKeywords = ['circuit', 'breaker', 'load', 'wire', 'description'];

            for (let i = 0; i < Math.min(10, data.length); i++) {
                const row = data[i];
                const rowStr = JSON.stringify(row).toLowerCase();

                if (headerKeywords.some(keyword => rowStr.includes(keyword))) {
                    headerRow = i;
                    break;
                }
            }

            if (headerRow === -1) headerRow = 0; // Default to first row

            const headers = data[headerRow].map(h => String(h || '').toLowerCase().trim());
            const circuits = [];

            // Parse data rows
            for (let i = headerRow + 1; i < data.length; i++) {
                const row = data[i];
                if (!row || row.length === 0) continue;

                const circuit = {
                    number: null,
                    description: null,
                    load: 0,
                    breaker: 0,
                    wireSize: '14 AWG',
                    voltage: 120,
                    phase: '1P'
                };

                headers.forEach((header, idx) => {
                    const value = row[idx];
                    if (value === null || value === undefined || value === '') return;

                    if (header.includes('circuit') || header.includes('number') || header.includes('#')) {
                        circuit.number = String(value).trim();
                    } else if (header.includes('description') || header.includes('desc') || header.includes('name')) {
                        circuit.description = String(value).trim();
                    } else if (header.includes('load') || header.includes('va') || header.includes('watt')) {
                        circuit.load = parseFloat(value) || 0;
                    } else if (header.includes('breaker') || header.includes('amp') || header.includes('current')) {
                        circuit.breaker = parseFloat(value) || 0;
                    } else if (header.includes('wire') || header.includes('size') || header.includes('gauge')) {
                        circuit.wireSize = String(value).trim();
                    } else if (header.includes('voltage') || header.includes('volt')) {
                        circuit.voltage = parseFloat(value) || 120;
                    } else if (header.includes('phase')) {
                        circuit.phase = String(value).trim();
                    }
                });

                // Only add valid circuits (must have at least circuit number or description)
                if (circuit.number || circuit.description) {
                    circuits.push(circuit);
                }
            }

            return {
                circuits: circuits,
                totalCircuits: circuits.length,
                totalLoad: circuits.reduce((sum, c) => sum + c.load, 0),
                panelName: 'Main Panel',
                voltage: '120/240V',
                phases: '1Ph-3W'
            };
        }

        // Show Automation Configuration Dialog
        function showAutomationDialog() {
            closeAllMenus();

            const modal = document.createElement('div');
            modal.id = 'automationModal';
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';

            modal.innerHTML = `
                <div class="bg-white rounded-2xl shadow-2xl max-w-3xl w-full max-h-[90vh] overflow-y-auto animate-scale-in">
                    <div class="bg-gradient-to-r from-green-600 via-emerald-600 to-teal-600 p-6 rounded-t-2xl flex justify-between items-center">
                        <h2 class="text-2xl font-bold text-white flex items-center gap-3">
                            <span class="text-3xl">ü§ñ</span> AI Auto-Wiring Configuration
                        </h2>
                        <button onclick="closeAutomationDialog()" class="w-10 h-10 bg-white/20 hover:bg-white/30 rounded-full flex items-center justify-center transition-all hover:rotate-90 text-white text-xl font-bold">
                            ‚úñ
                        </button>
                    </div>

                    <div class="p-6 space-y-5">
                        <!-- Panel Schedule Summary -->
                        <div class="bg-gradient-to-r from-blue-50 to-cyan-50 rounded-xl p-4 border-2 border-blue-200">
                            <h3 class="text-blue-800 font-bold text-sm uppercase mb-2">üìä Panel Schedule Loaded</h3>
                            <div class="grid grid-cols-2 gap-3 text-sm">
                                <div><span class="font-semibold">Total Circuits:</span> <span class="text-blue-600 font-bold">${parsedPanelData.totalCircuits}</span></div>
                                <div><span class="font-semibold">Total Load:</span> <span class="text-blue-600 font-bold">${parsedPanelData.totalLoad} VA</span></div>
                                <div><span class="font-semibold">Panel Name:</span> <span class="text-blue-600 font-bold">${parsedPanelData.panelName}</span></div>
                                <div><span class="font-semibold">Voltage:</span> <span class="text-blue-600 font-bold">${parsedPanelData.voltage}</span></div>
                            </div>
                        </div>

                        <!-- Automation Settings -->
                        <div class="space-y-3">
                            <h3 class="text-gray-800 font-bold text-lg flex items-center gap-2">
                                <span>‚öôÔ∏è</span> Automation Settings
                            </h3>

                            <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border-2 border-gray-200 hover:border-green-300 transition-all cursor-pointer">
                                <span class="font-semibold text-gray-700">Auto-Route Wires</span>
                                <input type="checkbox" id="autoRoute" checked onchange="automationSettings.autoRoute = this.checked" class="w-5 h-5 text-green-600 rounded focus:ring-green-500">
                            </label>

                            <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border-2 border-gray-200 hover:border-green-300 transition-all cursor-pointer">
                                <span class="font-semibold text-gray-700">Auto-Calculate Wire Sizes</span>
                                <input type="checkbox" id="autoSize" checked onchange="automationSettings.autoSize = this.checked" class="w-5 h-5 text-green-600 rounded focus:ring-green-500">
                            </label>

                            <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg border-2 border-gray-200 hover:border-green-300 transition-all cursor-pointer">
                                <span class="font-semibold text-gray-700">Auto-Label Wires & Circuits</span>
                                <input type="checkbox" id="autoLabel" checked onchange="automationSettings.autoLabel = this.checked" class="w-5 h-5 text-green-600 rounded focus:ring-green-500">
                            </label>

                            <div>
                                <label class="block font-semibold text-gray-700 mb-2">Component Spacing (mm)</label>
                                <input type="number" id="spacing" value="50" min="30" max="200" onchange="automationSettings.spacing = this.value" class="w-full px-4 py-2.5 bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 font-medium">
                            </div>

                            <div>
                                <label class="block font-semibold text-gray-700 mb-2">Default Wire Type</label>
                                <select id="wireType" onchange="automationSettings.wireType = this.value" class="w-full px-4 py-2.5 bg-gray-50 border-2 border-gray-200 rounded-lg focus:outline-none focus:ring-2 focus:ring-green-500 font-medium cursor-pointer">
                                    <option value="14/2 NM-B">14/2 NM-B (15A Circuits)</option>
                                    <option value="12/2 NM-B">12/2 NM-B (20A Circuits)</option>
                                    <option value="10/2 NM-B">10/2 NM-B (30A Circuits)</option>
                                    <option value="8/3 NM-B">8/3 NM-B (40-50A Circuits)</option>
                                    <option value="6/3 NM-B">6/3 NM-B (60A Circuits)</option>
                                </select>
                            </div>
                        </div>

                        <!-- Action Buttons -->
                        <div class="flex gap-3">
                            <button onclick="executeAutoWiring()" class="flex-1 px-6 py-4 bg-gradient-to-r from-green-600 to-emerald-600 hover:from-green-700 hover:to-emerald-700 text-white rounded-xl transition-all font-bold text-lg shadow-lg flex items-center justify-center gap-3">
                                <span class="text-2xl">‚ö°</span>
                                Generate Wiring Diagram
                            </button>
                            <button onclick="closeAutomationDialog()" class="px-6 py-4 bg-gray-300 hover:bg-gray-400 text-gray-800 rounded-xl transition-all font-bold shadow-md">
                                Cancel
                            </button>
                        </div>

                        <!-- Info Box -->
                        <div class="bg-gradient-to-r from-purple-50 to-indigo-50 rounded-lg p-4 border-2 border-purple-200">
                            <p class="text-sm text-gray-700"><strong class="text-purple-700">üí° How It Works:</strong> The AI will automatically place all circuit breakers, outlets, and fixtures from your panel schedule, calculate proper wire sizes, route wires intelligently, and create a professional wiring diagram - all in seconds!</p>
                        </div>
                    </div>
                </div>
            `;

            document.body.appendChild(modal);
        }

        function closeAutomationDialog() {
            const modal = document.getElementById('automationModal');
            if (modal) modal.remove();
        }

        // Execute AI Auto-Wiring
        async function executeAutoWiring() {
            if (!parsedPanelData || !parsedPanelData.circuits) {
                alert('‚ùå No panel data loaded. Please upload an Excel or CSV file first.');
                return;
            }

            closeAutomationDialog();
            showLoading('‚ö° AI Auto-Wiring in Progress...', `Generating complete wiring diagram for ${parsedPanelData.circuits.length} circuits`);

            try {
                // Simulate processing time for realistic UX
                await new Promise(resolve => setTimeout(resolve, 2000));

                // Step 1: Create Panel Box
                const panelX = 100;
                const panelY = 100;
                const panelWidth = 300;
                const panelHeight = Math.max(400, parsedPanelData.circuits.length * 30 + 100);

                if (typeof fabric !== 'undefined' && typeof canvas !== 'undefined') {
                    // Add panel box
                    const panel = new fabric.Rect({
                        left: panelX,
                        top: panelY,
                        width: panelWidth,
                        height: panelHeight,
                        fill: '#f5f5f5',
                        stroke: '#333',
                        strokeWidth: 3,
                        rx: 10,
                        ry: 10
                    });
                    canvas.add(panel);

                    // Add panel title
                    const title = new fabric.Text(parsedPanelData.panelName || 'Main Panel', {
                        left: panelX + panelWidth / 2,
                        top: panelY + 20,
                        fontSize: 18,
                        fontWeight: 'bold',
                        fill: '#333',
                        originX: 'center'
                    });
                    canvas.add(title);

                    // Step 2: Generate Circuit Breakers
                    let yOffset = panelY + 60;
                    const spacing = parseInt(automationSettings.spacing) || 50;

                    parsedPanelData.circuits.forEach((circuit, index) => {
                        // Circuit breaker symbol
                        const breaker = new fabric.Rect({
                            left: panelX + 20,
                            top: yOffset,
                            width: 60,
                            height: 25,
                            fill: circuit.breaker >= 30 ? '#ff6b6b' : '#4CAF50',
                            stroke: '#333',
                            strokeWidth: 2,
                            rx: 3,
                            ry: 3
                        });
                        canvas.add(breaker);

                        // Circuit label
                        const label = new fabric.Text(`${circuit.number || (index + 1)} - ${circuit.breaker}A`, {
                            left: panelX + 50,
                            top: yOffset + 8,
                            fontSize: 10,
                            fontWeight: 'bold',
                            fill: '#fff',
                            originX: 'center'
                        });
                        canvas.add(label);

                        // Description
                        const desc = new fabric.Text(circuit.description || 'Circuit', {
                            left: panelX + 90,
                            top: yOffset + 8,
                            fontSize: 11,
                            fill: '#333'
                        });
                        canvas.add(desc);

                        // Wire size indicator
                        if (automationSettings.autoSize) {
                            const wireSize = calculateWireSize(circuit.breaker, circuit.load);
                            const wireSizeText = new fabric.Text(wireSize, {
                                left: panelX + panelWidth - 70,
                                top: yOffset + 8,
                                fontSize: 10,
                                fontWeight: 'bold',
                                fill: '#2196F3'
                            });
                            canvas.add(wireSizeText);
                        }

                        // Auto-route wire if enabled
                        if (automationSettings.autoRoute) {
                            const wireEndX = panelX + panelWidth + 200 + (index % 3) * 150;
                            const wireEndY = yOffset + 12;

                            const wire = new fabric.Line(
                                [panelX + panelWidth, yOffset + 12, wireEndX, wireEndY],
                                {
                                    stroke: getWireColor(circuit.voltage),
                                    strokeWidth: 3,
                                    selectable: true
                                }
                            );
                            canvas.add(wire);

                            // Add load point (outlet/fixture)
                            const loadSymbol = createLoadSymbol(wireEndX, wireEndY, circuit.description);
                            canvas.add(loadSymbol);

                            // Auto-label wire
                            if (automationSettings.autoLabel) {
                                const wireLabel = new fabric.Text(`#${circuit.number || (index + 1)}`, {
                                    left: wireEndX - 30,
                                    top: wireEndY - 20,
                                    fontSize: 9,
                                    fill: '#666',
                                    backgroundColor: '#fff'
                                });
                                canvas.add(wireLabel);
                            }
                        }

                        yOffset += 30;
                    });

                    // Add legend
                    addWiringLegend(panelX, panelY + panelHeight + 50);

                    canvas.renderAll();
                }

                hideLoading();

                alert(`‚úÖ Successfully generated complete wiring diagram with ${parsedPanelData.circuits.length} circuits!\n\nüéØ All breakers placed\n‚ö° Wires auto-routed\nüìè Wire sizes calculated\nüè∑Ô∏è Everything labeled\n\nYour AutoCAD Electrical replacement is ready!`);

            } catch (error) {
                hideLoading();
                console.error('Auto-wiring error:', error);
                alert('‚ùå Error during auto-wiring: ' + error.message);
            }
        }

        // Calculate Wire Size based on amperage and load
        function calculateWireSize(amperage, load) {
            if (amperage >= 60) return '6 AWG';
            if (amperage >= 50) return '8 AWG';
            if (amperage >= 30) return '10 AWG';
            if (amperage >= 20) return '12 AWG';
            return '14 AWG';
        }

        // Get wire color based on voltage
        function getWireColor(voltage) {
            if (voltage >= 240) return '#9b59b6'; // Purple for 240V
            if (voltage >= 120) return '#e74c3c'; // Red for 120V
            return '#3498db'; // Blue for low voltage
        }

        // Create load symbol (outlet/fixture)
        function createLoadSymbol(x, y, description) {
            const isOutlet = description && description.toLowerCase().includes('outlet');

            if (isOutlet) {
                // Outlet symbol (circle with slots)
                return new fabric.Circle({
                    left: x - 10,
                    top: y - 10,
                    radius: 10,
                    fill: '#fff',
                    stroke: '#333',
                    strokeWidth: 2
                });
            } else {
                // Light fixture symbol (circle with X)
                const group = new fabric.Group([
                    new fabric.Circle({
                        radius: 10,
                        fill: '#fff',
                        stroke: '#333',
                        strokeWidth: 2
                    }),
                    new fabric.Line([-7, -7, 7, 7], { stroke: '#333', strokeWidth: 1.5 }),
                    new fabric.Line([-7, 7, 7, -7], { stroke: '#333', strokeWidth: 1.5 })
                ], {
                    left: x,
                    top: y
                });
                return group;
            }
        }

        // Add wiring diagram legend
        function addWiringLegend(x, y) {
            if (typeof fabric === 'undefined' || typeof canvas === 'undefined') return;

            const legendBox = new fabric.Rect({
                left: x,
                top: y,
                width: 300,
                height: 150,
                fill: '#fff',
                stroke: '#333',
                strokeWidth: 2,
                rx: 5,
                ry: 5
            });
            canvas.add(legendBox);

            const legendTitle = new fabric.Text('LEGEND', {
                left: x + 150,
                top: y + 15,
                fontSize: 14,
                fontWeight: 'bold',
                fill: '#333',
                originX: 'center'
            });
            canvas.add(legendTitle);

            // Add legend items
            const items = [
                { color: '#4CAF50', text: '15-20A Breaker' },
                { color: '#ff6b6b', text: '30A+ Breaker' },
                { color: '#e74c3c', text: '120V Circuit' },
                { color: '#9b59b6', text: '240V Circuit' }
            ];

            items.forEach((item, idx) => {
                const colorBox = new fabric.Rect({
                    left: x + 20,
                    top: y + 45 + (idx * 25),
                    width: 30,
                    height: 15,
                    fill: item.color,
                    stroke: '#333',
                    strokeWidth: 1
                });
                canvas.add(colorBox);

                const itemText = new fabric.Text(item.text, {
                    left: x + 60,
                    top: y + 48 + (idx * 25),
                    fontSize: 11,
                    fill: '#333'
                });
                canvas.add(itemText);
            });
        }

        // Database Import Dialog
        function showDatabaseImportDialog() {
            alert('üóÑÔ∏è Database Import Feature\n\nConnect to your existing electrical database:\n\n‚Ä¢ MySQL\n‚Ä¢ PostgreSQL\n‚Ä¢ MS SQL Server\n‚Ä¢ SQLite\n‚Ä¢ MongoDB\n\nProvide connection details to import panel schedules directly from your database.\n\nThis feature requires backend configuration.');
        }

        // Console welcome message
        console.log(`
        ‚ö° ELECTRICAL CAD DESIGNER - AUTOCAD ELECTRICAL REPLACEMENT
        ===========================================================

        üé® Modern Tailwind CSS Design
        üöÄ Premium $300k Application Aesthetic
        ‚öôÔ∏è Full Professional CAD Functionality
        ü§ñ AI-Powered Auto-Generation
        üìê AS/NZS 3000 Compliance Analysis

        ‚ú® NEW AUTOMATION FEATURES:
        üìä Excel/CSV Panel Schedule Upload
        ‚ö° AI Auto-Wiring Engine
        üîß Automatic Component Placement
        üìè Wire Size Calculation
        üè∑Ô∏è Automatic Labeling
        üóÑÔ∏è Database Integration

        Replace AutoCAD Electrical and save hours of manual work!
        `);
    </script>

    <!-- Footer -->
    <footer style="text-align: center; padding: 20px; color: #6b7280; font-size: 12px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        ¬© 2025 Integratd Living. All rights reserved.
    </footer>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Electrical Mapping - {{ project_name | default('New Project') }}</title>

    <!-- Tailwind CSS 3.0 -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        olive: {
                            50: '#f6f7f4',
                            100: '#e8ebe1',
                            200: '#d1d7c3',
                            300: '#b5bfa0',
                            400: '#9aa67e',
                            500: '#6AB64B',
                            600: '#5a9e3f',
                            700: '#455826',
                            800: '#3a4821',
                            900: '#323d1e',
                        }
                    },
                    animation: {
                        'fadeIn': 'fadeIn 0.3s ease-in',
                        'slideDown': 'slideDown 0.3s ease-out',
                        'scaleIn': 'scaleIn 0.2s ease-out',
                        'pulseSoft': 'pulseSoft 2s ease-in-out infinite',
                    },
                    keyframes: {
                        fadeIn: {
                            '0%': { opacity: '0' },
                            '100%': { opacity: '1' },
                        },
                        slideDown: {
                            '0%': { transform: 'translateY(-10px)', opacity: '0' },
                            '100%': { transform: 'translateY(0)', opacity: '1' },
                        },
                        scaleIn: {
                            '0%': { transform: 'scale(0.95)', opacity: '0' },
                            '100%': { transform: 'scale(1)', opacity: '1' },
                        },
                        pulseSoft: {
                            '0%, 100%': { opacity: '1' },
                            '50%': { opacity: '0.7' },
                        },
                    }
                }
            }
        }
    </script>

    <!-- PDF.js CDN - defer to ensure proper loading order -->
    <script src="https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.min.js" defer onload="initPDFJS()" onerror="console.error('‚ùå Failed to load PDF.js from CDN')"></script>
    <script>
        // Configure PDF.js worker after library loads - with error handling
        window.initPDFJS = function() {
            try {
                if (typeof pdfjsLib !== 'undefined') {
                    pdfjsLib.GlobalWorkerOptions.workerSrc = 'https://cdn.jsdelivr.net/npm/pdfjs-dist@3.11.174/build/pdf.worker.min.js';
                    console.log('‚úÖ PDF.js loaded and configured successfully');
                    window.pdfJSReady = true;
                } else {
                    console.error('‚ùå PDF.js library failed to load! PDF uploads will not work.');
                    console.error('Please check your internet connection or try refreshing the page.');
                    window.pdfJSReady = false;
                }
            } catch (error) {
                console.error('‚ùå Error configuring PDF.js:', error);
                window.pdfJSReady = false;
            }
        };

        // Fallback: try to initialize on DOMContentLoaded if onload doesn't fire
        document.addEventListener('DOMContentLoaded', function() {
            setTimeout(function() {
                if (window.pdfJSReady === undefined && typeof pdfjsLib !== 'undefined') {
                    console.log('üîÑ Initializing PDF.js via fallback...');
                    window.initPDFJS();
                }
            }, 500);
        });
    </script>

    <style>
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            overflow: hidden;
        }

        #mappingCanvas {
            cursor: crosshair;
            transform-origin: 0 0;
            transition: transform 0.1s ease-out;
        }

        .canvas-wrapper.panning #mappingCanvas {
            cursor: grab;
        }

        .canvas-wrapper.panning:active #mappingCanvas {
            cursor: grabbing;
        }

        /* Custom scrollbar for panels */
        .panel-scroll::-webkit-scrollbar {
            width: 8px;
        }

        .panel-scroll::-webkit-scrollbar-track {
            background: #f1f5f9;
            border-radius: 4px;
        }

        .panel-scroll::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 4px;
        }

        .panel-scroll::-webkit-scrollbar-thumb:hover {
            background: #94a3b8;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Top Toolbar -->
    <header class="bg-gradient-to-r from-olive-600 via-olive-500 to-olive-600 shadow-xl border-b-4 border-olive-700">
        <div class="px-6 py-3">
            <div class="flex items-center justify-between gap-4 flex-wrap">
                <a href="/" class="flex items-center gap-4 cursor-pointer hover:opacity-80 transition-all" title="Go to Home">
                    <div class="bg-white/20 backdrop-blur-sm p-2.5 rounded-xl shadow-lg">
                        <svg class="w-7 h-7 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2.5" d="M13 10V3L4 14h7v7l9-11h-7z"/>
                        </svg>
                    </div>
                    <div>
                        <h1 class="text-2xl font-bold text-white tracking-tight">{{ project_name | default('Electrical Mapping') }}</h1>
                        <p class="text-olive-100 text-sm font-medium">Professional Electrical Design Suite</p>
                    </div>
                </a>

                <div class="flex items-center gap-3">
                    <!-- Zoom Controls -->
                    <div class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-3 py-2 rounded-lg border border-white/20 shadow-lg">
                        <button onclick="zoomIn()" class="w-9 h-9 bg-olive-700 hover:bg-olive-800 text-white rounded-md font-bold text-lg transition-all hover:scale-110 shadow-md">+</button>
                        <span class="text-white font-bold min-w-[60px] text-center text-sm" id="zoomLevel">100%</span>
                        <button onclick="zoomOut()" class="w-9 h-9 bg-olive-700 hover:bg-olive-800 text-white rounded-md font-bold text-lg transition-all hover:scale-110 shadow-md">‚àí</button>
                        <button onclick="resetView()" class="w-9 h-9 bg-olive-700 hover:bg-olive-800 text-white rounded-md font-bold text-lg transition-all hover:scale-110 shadow-md">‚ü≤</button>
                    </div>

                    <!-- Page Controls -->
                    <div id="pageControls" style="display: none;" class="flex items-center gap-2 bg-white/10 backdrop-blur-md px-3 py-2 rounded-lg border border-white/20 shadow-lg">
                        <button id="prevPage" onclick="changePage(currentPage - 1)" class="w-9 h-9 bg-olive-700 hover:bg-olive-800 text-white rounded-md font-bold transition-all hover:scale-110 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">‚óÄ</button>
                        <span class="text-white text-sm font-medium">Page
                            <input type="number" id="pageInput" value="1" min="1" max="1" onchange="jumpToPage(this.value)" class="w-12 px-2 py-1 bg-olive-800 border border-olive-600 rounded text-white text-center mx-1">
                            of <span id="totalPages" class="font-bold">1</span>
                        </span>
                        <button id="nextPage" onclick="changePage(currentPage + 1)" class="w-9 h-9 bg-olive-700 hover:bg-olive-800 text-white rounded-md font-bold transition-all hover:scale-110 shadow-md disabled:opacity-50 disabled:cursor-not-allowed">‚ñ∂</button>
                    </div>

                    <!-- Collapsible Menu Button -->
                    <div class="relative">
                        <button id="mappingMenuToggleBtn" onclick="toggleMappingMenu()" class="px-4 py-3 bg-gradient-to-r from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg transition-all font-bold text-xl shadow-lg">
                            <span id="mappingMenuIcon">+</span>
                        </button>
                        <!-- Dropdown Menu -->
                        <div id="mappingToolbarMenu" style="display: none;" class="absolute right-0 top-full mt-2 bg-gray-800 border-2 border-gray-600 rounded-xl p-4 min-w-64 z-50 shadow-2xl max-h-96 overflow-y-auto">
                            <!-- File Operations -->
                            <div class="text-xs text-gray-400 uppercase font-bold mb-2">File</div>
                            <label class="block w-full text-left px-3 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg mb-2 text-sm font-semibold cursor-pointer">
                                üìÅ Upload Floor Plan
                                <input type="file" id="floorplanUpload" accept=".pdf,image/*" class="hidden">
                            </label>
                            <button onclick="importFromTakeoffs(); toggleMappingMenu();" class="w-full text-left px-3 py-2 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg mb-2 text-sm font-semibold">üì• Import Takeoffs</button>
                            <button onclick="saveProgress(); toggleMappingMenu();" class="w-full text-left px-3 py-2 bg-emerald-600 hover:bg-emerald-700 text-white rounded-lg mb-2 text-sm font-semibold">üíæ Save</button>
                            <button onclick="loadProgress(); toggleMappingMenu();" class="w-full text-left px-3 py-2 bg-sky-600 hover:bg-sky-700 text-white rounded-lg mb-2 text-sm font-semibold">üìÇ Load</button>

                            <div class="border-t border-gray-600 my-3"></div>

                            <!-- Edit Operations -->
                            <div class="text-xs text-gray-400 uppercase font-bold mb-2">Edit</div>
                            <button onclick="undoAction(); toggleMappingMenu();" class="w-full text-left px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg mb-2 text-sm font-semibold">‚Ü∂ Undo</button>
                            <button onclick="redoAction(); toggleMappingMenu();" class="w-full text-left px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg mb-2 text-sm font-semibold">‚Ü∑ Redo</button>
                            <button id="snapGridBtn" onclick="toggleSnapGrid(); toggleMappingMenu();" class="w-full text-left px-3 py-2 bg-slate-600 hover:bg-slate-700 text-white rounded-lg mb-2 text-sm font-semibold">üìê Snap: OFF</button>

                            <div class="border-t border-gray-600 my-3"></div>

                            <!-- AI & Export -->
                            <div class="text-xs text-gray-400 uppercase font-bold mb-2">AI & Export</div>
                            <button onclick="runAIMapping(); toggleMappingMenu();" class="w-full text-left px-3 py-2 bg-purple-600 hover:bg-purple-700 text-white rounded-lg mb-2 text-sm font-semibold">ü§ñ AI Mapping</button>
                            <button onclick="exportMapping(); toggleMappingMenu();" class="w-full text-left px-3 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg mb-2 text-sm font-semibold">üìÑ Export PDF</button>

                            <div class="border-t border-gray-600 my-3"></div>

                            <!-- Navigation -->
                            <div class="text-xs text-gray-400 uppercase font-bold mb-2">Navigation</div>
                            <button onclick="window.location.href='/'" class="w-full text-left px-3 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg mb-2 text-sm font-semibold">üè† Home</button>
                            <button onclick="window.location.href='/canvas'" class="w-full text-left px-3 py-2 bg-indigo-600 hover:bg-indigo-700 text-white rounded-lg mb-2 text-sm font-semibold">üé® Canvas</button>
                            <button onclick="window.location.href='/board-builder'" class="w-full text-left px-3 py-2 bg-amber-600 hover:bg-amber-700 text-white rounded-lg text-sm font-semibold">üîå Board Builder</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <script>
        function toggleMappingMenu() {
            const menu = document.getElementById('mappingToolbarMenu');
            const icon = document.getElementById('mappingMenuIcon');
            if (menu.style.display === 'none') {
                menu.style.display = 'block';
                icon.textContent = '√ó';
            } else {
                menu.style.display = 'none';
                icon.textContent = '+';
            }
        }
        document.addEventListener('click', function(e) {
            const menu = document.getElementById('mappingToolbarMenu');
            const btn = document.getElementById('mappingMenuToggleBtn');
            if (menu && btn && !menu.contains(e.target) && !btn.contains(e.target)) {
                menu.style.display = 'none';
                document.getElementById('mappingMenuIcon').textContent = '+';
            }
        });
    </script>

    <!-- Main Container -->
    <div class="flex h-[calc(100vh-180px)]">
        <!-- LEFT PANEL: Layers & Components -->
        <aside class="w-80 bg-white shadow-xl border-r border-gray-200 overflow-y-auto panel-scroll">
            <div class="p-5">
                <!-- Layers Section -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-6 bg-gradient-to-b from-olive-500 to-olive-600 rounded-full"></div>
                        <h3 class="text-lg font-bold text-gray-800">Layers</h3>
                    </div>
                    <div class="space-y-2">
                        <label class="flex items-center gap-3 p-3 bg-gradient-to-r from-gray-50 to-white rounded-lg border border-gray-200 hover:border-olive-300 hover:shadow-md transition-all cursor-pointer group">
                            <input type="checkbox" id="layerFloorplan" class="layer-checkbox w-5 h-5 text-olive-600 rounded focus:ring-2 focus:ring-olive-500" checked>
                            <span class="text-gray-700 font-medium group-hover:text-olive-700">üìê Floor Plan</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-gradient-to-r from-gray-50 to-white rounded-lg border border-gray-200 hover:border-olive-300 hover:shadow-md transition-all cursor-pointer group">
                            <input type="checkbox" id="layerComponents" class="layer-checkbox w-5 h-5 text-olive-600 rounded focus:ring-2 focus:ring-olive-500" checked>
                            <span class="text-gray-700 font-medium group-hover:text-olive-700">üîß Components</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-gradient-to-r from-gray-50 to-white rounded-lg border border-gray-200 hover:border-olive-300 hover:shadow-md transition-all cursor-pointer group">
                            <input type="checkbox" id="layerWiring" class="layer-checkbox w-5 h-5 text-olive-600 rounded focus:ring-2 focus:ring-olive-500" checked>
                            <span class="text-gray-700 font-medium group-hover:text-olive-700">‚ö° Wiring</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-gradient-to-r from-gray-50 to-white rounded-lg border border-gray-200 hover:border-olive-300 hover:shadow-md transition-all cursor-pointer group">
                            <input type="checkbox" id="layerCircuits" class="layer-checkbox w-5 h-5 text-olive-600 rounded focus:ring-2 focus:ring-olive-500" checked>
                            <span class="text-gray-700 font-medium group-hover:text-olive-700">üîå Circuits</span>
                        </label>
                        <label class="flex items-center gap-3 p-3 bg-gradient-to-r from-gray-50 to-white rounded-lg border border-gray-200 hover:border-olive-300 hover:shadow-md transition-all cursor-pointer group">
                            <input type="checkbox" id="layerAnnotations" class="layer-checkbox w-5 h-5 text-olive-600 rounded focus:ring-2 focus:ring-olive-500" checked>
                            <span class="text-gray-700 font-medium group-hover:text-olive-700">üìù Annotations</span>
                        </label>
                    </div>
                </div>

                <!-- Components Section -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-6 bg-gradient-to-b from-olive-500 to-olive-600 rounded-full"></div>
                        <h3 class="text-lg font-bold text-gray-800">Components</h3>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="selectComponent('light')" class="component-btn p-3 bg-gradient-to-r from-yellow-50 to-yellow-100 hover:from-yellow-100 hover:to-yellow-200 border-2 border-yellow-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-2xl">üí°</span>
                            <span>Light Fixture</span>
                        </button>
                        <button onclick="selectComponent('switch')" class="component-btn p-3 bg-gradient-to-r from-blue-50 to-blue-100 hover:from-blue-100 hover:to-blue-200 border-2 border-blue-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-2xl">üîò</span>
                            <span>Switch</span>
                        </button>
                        <button onclick="selectComponent('outlet')" class="component-btn p-3 bg-gradient-to-r from-red-50 to-red-100 hover:from-red-100 hover:to-red-200 border-2 border-red-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-2xl">‚ö°</span>
                            <span>Outlet</span>
                        </button>
                        <button onclick="selectComponent('panel')" class="component-btn p-3 bg-gradient-to-r from-gray-50 to-gray-100 hover:from-gray-100 hover:to-gray-200 border-2 border-gray-400 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-2xl">‚öôÔ∏è</span>
                            <span>Electrical Panel</span>
                        </button>
                        <button onclick="selectComponent('junction')" class="component-btn p-3 bg-gradient-to-r from-orange-50 to-orange-100 hover:from-orange-100 hover:to-orange-200 border-2 border-orange-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-2xl">üì¶</span>
                            <span>Junction Box</span>
                        </button>
                        <button onclick="selectComponent('sensor')" class="component-btn p-3 bg-gradient-to-r from-purple-50 to-purple-100 hover:from-purple-100 hover:to-purple-200 border-2 border-purple-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-2xl">üì°</span>
                            <span>Sensor/Detector</span>
                        </button>
                        <button onclick="selectComponent('dimmer')" class="component-btn p-3 bg-gradient-to-r from-indigo-50 to-indigo-100 hover:from-indigo-100 hover:to-indigo-200 border-2 border-indigo-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-2xl">üéöÔ∏è</span>
                            <span>Dimmer</span>
                        </button>
                        <button onclick="selectComponent('fan')" class="component-btn p-3 bg-gradient-to-r from-cyan-50 to-cyan-100 hover:from-cyan-100 hover:to-cyan-200 border-2 border-cyan-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-2xl">üåÄ</span>
                            <span>Ceiling Fan</span>
                        </button>
                    </div>
                </div>

                <!-- Tools Section -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-6 bg-gradient-to-b from-olive-500 to-olive-600 rounded-full"></div>
                        <h3 class="text-lg font-bold text-gray-800">Tools</h3>
                    </div>
                    <div class="grid grid-cols-1 gap-2">
                        <button id="selectTool" onclick="setTool('select')" class="component-btn active p-3 bg-gradient-to-br from-olive-500 to-olive-600 text-white border-2 border-olive-700 rounded-lg font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-xl">üñ±Ô∏è</span>
                            <span>Select & Pan</span>
                        </button>
                        <button id="wireTool" onclick="setTool('wire')" class="component-btn p-3 bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 border-2 border-slate-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-xl">üîå</span>
                            <span>Draw Wire</span>
                        </button>
                        <button id="measureTool" onclick="setTool('measure')" class="component-btn p-3 bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 border-2 border-slate-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-xl">üìè</span>
                            <span>Measure</span>
                        </button>
                        <button id="annotateTool" onclick="setTool('annotate')" class="component-btn p-3 bg-gradient-to-r from-slate-100 to-slate-200 hover:from-slate-200 hover:to-slate-300 border-2 border-slate-300 rounded-lg text-gray-700 font-semibold transition-all hover:shadow-lg hover:scale-105 text-left flex items-center gap-3">
                            <span class="text-xl">üìù</span>
                            <span>Annotate</span>
                        </button>
                    </div>
                </div>
            </div>
        </aside>

        <!-- CENTER: Canvas -->
        <main class="flex-1 flex flex-col bg-gradient-to-br from-gray-100 via-gray-50 to-gray-100 relative overflow-hidden">
            <div class="canvas-wrapper flex-1 relative" id="canvasWrapper">
                <canvas id="mappingCanvas" class="absolute top-0 left-0"></canvas>
            </div>

            <!-- AI Loading Overlay -->
            <div id="aiLoading" class="hidden absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 bg-white/95 backdrop-blur-md p-8 rounded-2xl border-4 border-purple-500 shadow-2xl text-center z-50 animate-scaleIn">
                <div class="w-16 h-16 mx-auto mb-4 border-4 border-purple-200 border-t-purple-600 rounded-full animate-spin"></div>
                <p class="text-purple-700 font-bold text-xl mb-2">ü§ñ AI Analyzing Floor Plan...</p>
                <p class="text-gray-600 text-sm">This may take a few moments</p>
            </div>
        </main>

        <!-- RIGHT PANEL: Properties & Circuits -->
        <aside class="w-80 bg-white shadow-xl border-l border-gray-200 overflow-y-auto panel-scroll">
            <div class="p-5">
                <!-- Properties Section -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-6 bg-gradient-to-b from-olive-500 to-olive-600 rounded-full"></div>
                        <h3 class="text-lg font-bold text-gray-800">Properties</h3>
                    </div>
                    <div id="propertiesContent" class="p-4 bg-gradient-to-br from-gray-50 to-white rounded-xl border-2 border-gray-200 shadow-sm">
                        <p class="text-gray-500 text-sm text-center">Select a component to edit properties</p>
                    </div>
                </div>

                <!-- Circuits Section -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-6 bg-gradient-to-b from-olive-500 to-olive-600 rounded-full"></div>
                        <h3 class="text-lg font-bold text-gray-800">Circuits</h3>
                    </div>
                    <button onclick="createCircuit()" class="w-full mb-3 px-4 py-2.5 bg-gradient-to-br from-green-500 to-green-600 hover:from-green-600 hover:to-green-700 text-white rounded-lg transition-all font-semibold shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                        <span class="text-lg">‚ûï</span>
                        <span>New Circuit</span>
                    </button>
                    <div id="circuitList" class="space-y-2 max-h-80 overflow-y-auto panel-scroll">
                        <p class="text-gray-500 text-sm text-center p-4">No circuits created yet</p>
                    </div>
                </div>

                <!-- Wire Types Section -->
                <div class="mb-6">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-1 h-6 bg-gradient-to-b from-olive-500 to-olive-600 rounded-full"></div>
                        <h3 class="text-lg font-bold text-gray-800">Wire Types</h3>
                    </div>
                    <button onclick="addWireType()" class="w-full mb-3 px-4 py-2 bg-gradient-to-br from-blue-500 to-blue-600 hover:from-blue-600 hover:to-blue-700 text-white rounded-lg transition-all font-semibold text-sm shadow-md hover:shadow-lg flex items-center justify-center gap-2">
                        <span>‚ûï</span>
                        <span>Add Wire Type</span>
                    </button>
                    <div id="wireTypesLegend" class="space-y-2">
                        <div onclick="editWireType(0)" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 transition-all cursor-pointer group">
                            <div class="w-8 h-1 bg-red-500 rounded-full shadow-sm"></div>
                            <span class="text-gray-700 text-sm font-medium group-hover:text-gray-900">120V Power</span>
                        </div>
                        <div onclick="editWireType(1)" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 transition-all cursor-pointer group">
                            <div class="w-8 h-1 bg-purple-500 rounded-full shadow-sm"></div>
                            <span class="text-gray-700 text-sm font-medium group-hover:text-gray-900">240V Power</span>
                        </div>
                        <div onclick="editWireType(2)" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 transition-all cursor-pointer group">
                            <div class="w-8 h-1 bg-blue-500 rounded-full shadow-sm"></div>
                            <span class="text-gray-700 text-sm font-medium group-hover:text-gray-900">Control/Signal</span>
                        </div>
                        <div onclick="editWireType(3)" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 transition-all cursor-pointer group">
                            <div class="w-8 h-1 bg-green-500 rounded-full shadow-sm"></div>
                            <span class="text-gray-700 text-sm font-medium group-hover:text-gray-900">Low Voltage</span>
                        </div>
                    </div>
                </div>
            </div>
        </aside>
    </div>

    <!-- Context Menu -->
    <div id="contextMenu" class="hidden absolute bg-white rounded-xl shadow-2xl border-2 border-olive-400 z-50 min-w-[200px] overflow-hidden animate-fadeIn">
        <div onclick="editComponent()" class="px-4 py-3 hover:bg-olive-50 cursor-pointer text-gray-700 font-medium transition-all flex items-center gap-3 border-b border-gray-100">
            <span>‚úèÔ∏è</span> Edit Properties
        </div>
        <div onclick="duplicateComponent()" class="px-4 py-3 hover:bg-olive-50 cursor-pointer text-gray-700 font-medium transition-all flex items-center gap-3 border-b border-gray-100">
            <span>üìã</span> Duplicate
        </div>
        <div onclick="assignCircuitToComp()" class="px-4 py-3 hover:bg-olive-50 cursor-pointer text-gray-700 font-medium transition-all flex items-center gap-3 border-b border-gray-100">
            <span>üîå</span> Assign to Circuit
        </div>
        <div onclick="deleteComponent()" class="px-4 py-3 hover:bg-red-50 cursor-pointer text-red-600 font-medium transition-all flex items-center gap-3">
            <span>üóëÔ∏è</span> Delete
        </div>
    </div>

    <script>
        console.log('üöÄ DEBUG: Mapping tool script loading...');
        console.log('üöÄ DEBUG: PDF.js library available:', typeof pdfjsLib !== 'undefined');

        const canvas = document.getElementById('mappingCanvas');
        const ctx = canvas.getContext('2d');
        const canvasWrapper = document.getElementById('canvasWrapper');

        console.log('‚úÖ DEBUG: Canvas element found:', canvas);
        console.log('‚úÖ DEBUG: Canvas context:', ctx);

        // Initialize canvas size
        canvas.width = 1400;
        canvas.height = 900;

        console.log('‚úÖ DEBUG: Canvas initialized with size:', canvas.width, 'x', canvas.height);

        // Pan & Zoom state
        let panX = 0, panY = 0;
        let scale = 1;
        let isPanning = false;
        let lastPanX = 0, lastPanY = 0;
        let spacebarPressed = false; // For spacebar + drag pan

        // Snap-to-grid state
        let snapToGrid = false;

        // Check for imported data on page load
        (function() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('import') === 'true') {
                const importData = sessionStorage.getItem('import_data');
                if (importData) {
                    try {
                        const data = JSON.parse(importData);
                        console.log('Imported data to Mapping:', data);

                        // Import floorplan image if available
                        if (data.floorplan_image) {
                            const img = new Image();
                            img.onload = function() {
                                floorplanImage = img;

                                // Resize canvas to match imported dimensions
                                if (data.canvas_dimensions) {
                                    canvas.width = data.canvas_dimensions.width;
                                    canvas.height = data.canvas_dimensions.height;
                                } else {
                                    canvas.width = img.width;
                                    canvas.height = img.height;
                                }

                                // Import components if available
                                if (data.components && Array.isArray(data.components)) {
                                    importComponents(data.components);
                                }

                                // Render the canvas
                                render();

                                showImportToast(`Floorplan imported: ${data.project_name} (${data.components?.length || 0} components)`, 'success');
                                console.log('Floorplan loaded successfully:', {
                                    width: canvas.width,
                                    height: canvas.height,
                                    components: components.length
                                });
                            };
                            img.onerror = function(e) {
                                console.error('Error loading floorplan image:', e);
                                showImportToast('Error loading floorplan image', 'error');
                            };
                            img.src = data.floorplan_image;
                        } else {
                            // No floorplan image, but might have components
                            if (data.components && Array.isArray(data.components)) {
                                importComponents(data.components);
                                render();
                            }
                            showImportToast(`Data imported: ${data.project_name}`, 'success');
                        }

                        sessionStorage.removeItem('import_data');
                        sessionStorage.removeItem('import_source');
                    } catch (e) {
                        console.error('Import error:', e);
                        showImportToast('Error importing data: ' + e.message, 'error');
                    }
                }
            }
        })();

        // Function to import components from canvas editor to mapping tool
        function importComponents(importedComponents) {
            if (!importedComponents || !Array.isArray(importedComponents)) {
                console.log('No components to import');
                return;
            }

            console.log('Importing components:', importedComponents.length);

            importedComponents.forEach((comp, index) => {
                // Map component type to mapping tool format
                let componentType = 'outlet'; // default

                // Try to map the component type
                const typeLower = (comp.type || comp.name || '').toLowerCase();
                if (typeLower.includes('light')) componentType = 'light';
                else if (typeLower.includes('switch')) componentType = 'switch';
                else if (typeLower.includes('outlet') || typeLower.includes('socket')) componentType = 'outlet';
                else if (typeLower.includes('panel')) componentType = 'panel';
                else if (typeLower.includes('junction')) componentType = 'junction';
                else if (typeLower.includes('sensor')) componentType = 'sensor';
                else if (typeLower.includes('dimmer')) componentType = 'dimmer';
                else if (typeLower.includes('fan')) componentType = 'fan';

                // Get component config or use custom
                const config = componentConfig[componentType] || {
                    name: comp.name || 'Component',
                    emoji: comp.emoji || 'üì¶',
                    width: 30,
                    height: 30
                };

                // Create component in mapping tool format
                const newComponent = {
                    id: `imported-${Date.now()}-${index}`,
                    type: componentType,
                    x: comp.position?.x || 100,
                    y: comp.position?.y || 100,
                    width: config.width * (comp.scale?.x || 1),
                    height: config.height * (comp.scale?.y || 1),
                    rotation: comp.rotation || 0,
                    label: comp.name || config.name,
                    emoji: comp.emoji || config.emoji,
                    customData: {
                        totalPrice: comp.totalPrice,
                        components: comp.components,
                        originalData: comp
                    }
                };

                components.push(newComponent);
                console.log('Imported component:', newComponent);
            });

            console.log('Total components after import:', components.length);
        }

        function showImportToast(message, type) {
            const toast = document.createElement('div');
            toast.className = `fixed top-4 right-4 z-50 px-6 py-4 rounded-lg shadow-lg ${type === 'success' ? 'bg-green-500' : 'bg-blue-500'} text-white`;
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => { toast.style.opacity = '0'; setTimeout(() => toast.remove(), 300); }, 4000);
        }
        let gridSize = 20; // pixels

        // Multi-page PDF state
        let pdfDocument = null;
        let currentPage = 1;
        let totalPages = 1;
        let pageData = {}; // Store per-page components, wires, etc.

        // State
        let floorplanImage = null;
        let components = [];
        let wires = [];
        let circuits = [];
        let selectedComponent = null;
        let currentTool = 'select';
        let pendingComponentType = null;
        let wireStart = null;
        let isDragging = false;
        let dragOffset = { x: 0, y: 0 };
        let isResizing = false;
        let resizeHandle = null;
        let measureStart = null;
        let measureEnd = null;
        let annotations = [];
        let selectedWire = null;
        let selectedAnnotation = null;
        let selectedWireForMove = null;
        let draggingAnnotation = false;
        let draggingEntireWire = false;
        let wireMoveDragOffset = { x: 0, y: 0 };

        // Undo/Redo state
        let undoStack = [];
        let redoStack = [];
        const MAX_UNDO_STACK = 50;

        // Auto-save
        let autoSaveInterval = null;
        let lastSaveTime = Date.now();

        // Wire types
        let wireTypes = [
            { name: '120V Power', color: '#e74c3c' },
            { name: '240V Power', color: '#9b59b6' },
            { name: 'Control/Signal', color: '#3498db' },
            { name: 'Low Voltage', color: '#2ecc71' }
        ];

        let layers = {
            floorplan: true,
            components: true,
            wiring: true,
            circuits: true,
            annotations: true
        };

        const componentConfig = {
            light: { name: 'Light', emoji: 'üí°', width: 30, height: 30 },
            switch: { name: 'Switch', emoji: 'üîò', width: 20, height: 20 },
            outlet: { name: 'Outlet', emoji: '‚ö°', width: 25, height: 25 },
            panel: { name: 'Panel', emoji: '‚öôÔ∏è', width: 50, height: 50 },
            junction: { name: 'Junction', emoji: 'üì¶', width: 15, height: 15 },
            sensor: { name: 'Sensor', emoji: 'üì°', width: 25, height: 25 },
            dimmer: { name: 'Dimmer', emoji: 'üéöÔ∏è', width: 20, height: 20 },
            fan: { name: 'Fan', emoji: 'üåÄ', width: 35, height: 35 }
        };

        function zoomIn() {
            scale = Math.min(scale * 1.2, 5);
            updateTransform();
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        }

        function zoomOut() {
            scale = Math.max(scale / 1.2, 0.1);
            updateTransform();
            document.getElementById('zoomLevel').textContent = Math.round(scale * 100) + '%';
        }

        function resetView() {
            scale = 1;
            panX = 0;
            panY = 0;
            updateTransform();
            document.getElementById('zoomLevel').textContent = '100%';
        }

        function updateTransform() {
            canvas.style.transform = `translate(${panX}px, ${panY}px) scale(${scale})`;
            render();
        }

        async function loadPDFPage(pageNum) {
            try {
                console.log(`üìÑ Loading PDF page ${pageNum}...`);
                const page = await pdfDocument.getPage(pageNum);
                const viewport = page.getViewport({ scale: 5.0 }); // Highest quality PDF rendering

                // Create temp canvas
                const tempCanvas = document.createElement('canvas');
                const tempContext = tempCanvas.getContext('2d');
                tempCanvas.width = viewport.width;
                tempCanvas.height = viewport.height;

                // Render PDF page to canvas
                await page.render({
                    canvasContext: tempContext,
                    viewport: viewport
                }).promise;

                // Convert canvas to image
                const img = new Image();
                img.onload = function() {
                    floorplanImage = img;
                    canvas.width = img.width;
                    canvas.height = img.height;
                    loadPageState(pageNum);
                    render();
                };
                img.src = tempCanvas.toDataURL();

            } catch (error) {
                console.error(`Error loading page ${pageNum}:`, error);
                alert(`Failed to load page ${pageNum}`);
            }
        }

        function changePage(newPage) {
            if (newPage < 1 || newPage > totalPages || newPage === currentPage) return;

            // Save current page state
            savePageState(currentPage);

            // Load new page
            currentPage = newPage;
            loadPDFPage(currentPage);
            updatePageNavigation();

            console.log(`üìÑ Switched to page ${currentPage}/${totalPages}`);
        }

        function jumpToPage(pageNum) {
            const num = parseInt(pageNum);
            if (isNaN(num) || num < 1 || num > totalPages) {
                alert(`Invalid page number. Enter a number between 1 and ${totalPages}`);
                document.getElementById('pageInput').value = currentPage;
                return;
            }
            changePage(num);
        }

        function updatePageNavigation() {
            document.getElementById('pageInput').value = currentPage;
            document.getElementById('prevPage').disabled = (currentPage <= 1);
            document.getElementById('nextPage').disabled = (currentPage >= totalPages);
        }

        function savePageState(pageNum) {
            pageData[pageNum] = {
                components: JSON.parse(JSON.stringify(components.map(c => ({...c, customImageObj: null})))),
                wires: JSON.parse(JSON.stringify(wires)),
                circuits: JSON.parse(JSON.stringify(circuits)),
                annotations: JSON.parse(JSON.stringify(annotations)),
                viewport: { panX, panY, scale }
            };
        }

        function loadPageState(pageNum) {
            if (!pageData[pageNum]) {
                // Initialize empty page
                pageData[pageNum] = {
                    components: [],
                    wires: [],
                    circuits: [],
                    annotations: [],
                    viewport: { panX: 0, panY: 0, scale: 1 }
                };
            }

            const state = pageData[pageNum];
            components = JSON.parse(JSON.stringify(state.components));
            wires = JSON.parse(JSON.stringify(state.wires));
            circuits = JSON.parse(JSON.stringify(state.circuits));
            annotations = JSON.parse(JSON.stringify(state.annotations));
            panX = state.viewport.panX;
            panY = state.viewport.panY;
            scale = state.viewport.scale;

            updateTransform();
        }

        // ========================================
        // UNDO/REDO SYSTEM
        // ========================================

        function saveState() {
            const state = {
                components: JSON.parse(JSON.stringify(components.map(c => ({...c, customImageObj: null})))),
                wires: JSON.parse(JSON.stringify(wires)),
                circuits: JSON.parse(JSON.stringify(circuits)),
                annotations: JSON.parse(JSON.stringify(annotations)),
                currentPage,
                pageData: JSON.parse(JSON.stringify(pageData))
            };

            undoStack.push(state);
            if (undoStack.length > MAX_UNDO_STACK) {
                undoStack.shift(); // Remove oldest
            }
            redoStack = []; // Clear redo stack on new action
        }

        function undoAction() {
            if (undoStack.length === 0) {
                console.log('Nothing to undo');
                return;
            }

            // Save current state to redo stack
            const currentState = {
                components: JSON.parse(JSON.stringify(components.map(c => ({...c, customImageObj: null})))),
                wires: JSON.parse(JSON.stringify(wires)),
                circuits: JSON.parse(JSON.stringify(circuits)),
                annotations: JSON.parse(JSON.stringify(annotations)),
                currentPage,
                pageData: JSON.parse(JSON.stringify(pageData))
            };
            redoStack.push(currentState);

            // Restore previous state
            const prevState = undoStack.pop();
            restoreState(prevState);

            console.log('‚Ü∂ Undo performed');
        }

        function redoAction() {
            if (redoStack.length === 0) {
                console.log('Nothing to redo');
                return;
            }

            // Save current state to undo stack
            const currentState = {
                components: JSON.parse(JSON.stringify(components.map(c => ({...c, customImageObj: null})))),
                wires: JSON.parse(JSON.stringify(wires)),
                circuits: JSON.parse(JSON.stringify(circuits)),
                annotations: JSON.parse(JSON.stringify(annotations)),
                currentPage,
                pageData: JSON.parse(JSON.stringify(pageData))
            };
            undoStack.push(currentState);

            // Restore next state
            const nextState = redoStack.pop();
            restoreState(nextState);

            console.log('‚Ü∑ Redo performed');
        }

        function restoreState(state) {
            components = JSON.parse(JSON.stringify(state.components));
            wires = JSON.parse(JSON.stringify(state.wires));
            circuits = JSON.parse(JSON.stringify(state.circuits));
            annotations = JSON.parse(JSON.stringify(state.annotations));
            pageData = JSON.parse(JSON.stringify(state.pageData));

            if (state.currentPage && state.currentPage !== currentPage && pdfDocument) {
                changePage(state.currentPage);
            } else {
                render();
            }
        }

        // ========================================
        // AUTO-SAVE FUNCTIONALITY
        // ========================================

        function startAutoSave() {
            // Auto-save every 30 seconds
            autoSaveInterval = setInterval(() => {
                autoSaveToLocalStorage();
            }, 30000);
            console.log('‚úÖ Auto-save enabled (every 30 seconds)');
        }

        function toggleSnapGrid() {
            snapToGrid = !snapToGrid;
            const btn = document.getElementById('snapGridBtn');
            if (snapToGrid) {
                btn.innerHTML = '<span>üìê</span> Snap: ON';
                btn.classList.remove('from-slate-600', 'to-slate-700');
                btn.classList.add('from-green-600', 'to-green-700');
                console.log(`‚úÖ Snap-to-grid enabled (${gridSize}px)`);
            } else {
                btn.innerHTML = '<span>üìê</span> Snap: OFF';
                btn.classList.remove('from-green-600', 'to-green-700');
                btn.classList.add('from-slate-600', 'to-slate-700');
                console.log('‚ùå Snap-to-grid disabled');
            }
            render();
        }

        function snapToGridPoint(x, y) {
            if (!snapToGrid) return { x, y };
            return {
                x: Math.round(x / gridSize) * gridSize,
                y: Math.round(y / gridSize) * gridSize
            };
        }

        function autoSaveToLocalStorage() {
            try {
                const data = {
                    components: components.map(c => ({...c, customImageObj: null})),
                    wires,
                    circuits,
                    annotations,
                    pageData,
                    currentPage,
                    timestamp: Date.now()
                };
                localStorage.setItem('electricalMapping_autoSave', JSON.stringify(data));
                lastSaveTime = Date.now();
                console.log('üíæ Auto-saved to localStorage');
            } catch (e) {
                console.error('Failed to auto-save:', e);
            }
        }

        function loadAutoSave() {
            try {
                const saved = localStorage.getItem('electricalMapping_autoSave');
                if (saved) {
                    const data = JSON.parse(saved);
                    const ageMinutes = (Date.now() - data.timestamp) / 60000;

                    if (ageMinutes < 60) { // Only prompt if less than 1 hour old
                        if (confirm(`Auto-saved data found from ${Math.round(ageMinutes)} minutes ago. Load it?`)) {
                            components = data.components || [];
                            wires = data.wires || [];
                            circuits = data.circuits || [];
                            annotations = data.annotations || [];
                            pageData = data.pageData || {};
                            currentPage = data.currentPage || 1;
                            render();
                            console.log('‚úÖ Loaded auto-saved data');
                        }
                    }
                }
            } catch (e) {
                console.error('Failed to load auto-save:', e);
            }
        }

        // ========================================
        // FILE UPLOAD HANDLER
        // ========================================

        document.getElementById('floorplanUpload').addEventListener('change', async (e) => {
            const file = e.target.files[0];
            if (!file) return;

            console.log('üìÅ File selected:', file.name, file.type);

            if (file.type === 'application/pdf') {
                // Check if PDF.js is loaded
                if (typeof pdfjsLib === 'undefined') {
                    alert('‚ùå PDF.js library not loaded! Please refresh the page and try again.');
                    return;
                }

                console.log('üìÑ Loading PDF...');
                const arrayBuffer = await file.arrayBuffer();

                try {
                    pdfDocument = await pdfjsLib.getDocument({ data: arrayBuffer }).promise;
                    totalPages = pdfDocument.numPages;
                    currentPage = 1;

                    console.log(`‚úÖ PDF loaded: ${totalPages} pages`);

                    // Show page controls if multi-page
                    if (totalPages > 1) {
                        document.getElementById('pageControls').style.display = 'flex';
                        document.getElementById('pageInput').max = totalPages;
                        document.getElementById('totalPages').textContent = totalPages;
                    }

                    // Load first page
                    await loadPDFPage(1);
                    updatePageNavigation();

                } catch (error) {
                    console.error('‚ùå Error loading PDF:', error);
                    alert('Failed to load PDF. Please try again or use an image file.');
                }

            } else if (file.type.startsWith('image/')) {
                // Handle image upload
                const reader = new FileReader();
                reader.onload = (evt) => {
                    const img = new Image();
                    img.onload = () => {
                        floorplanImage = img;
                        canvas.width = img.width;
                        canvas.height = img.height;
                        render();
                        console.log('‚úÖ Image loaded:', img.width, 'x', img.height);
                    };
                    img.src = evt.target.result;
                };
                reader.readAsDataURL(file);
            } else {
                alert('Please upload a PDF or image file');
            }
        });

        // ========================================
        // LAYER VISIBILITY
        // ========================================

        document.querySelectorAll('.layer-checkbox').forEach(checkbox => {
            checkbox.addEventListener('change', (e) => {
                const layerId = e.target.id.replace('layer', '').toLowerCase();
                layers[layerId] = e.target.checked;
                render();
                console.log(`Layer ${layerId}: ${e.target.checked ? 'visible' : 'hidden'}`);
            });
        });

        // ========================================
        // COMPONENT SELECTION
        // ========================================

        function selectComponent(type) {
            pendingComponentType = type;
            currentTool = 'place';
            canvas.style.cursor = 'crosshair';

            // Update tool button states
            document.querySelectorAll('.component-btn').forEach(btn => {
                btn.classList.remove('active', 'from-olive-500', 'to-olive-600', 'text-white', 'border-olive-700');
                btn.classList.add('from-slate-100', 'to-slate-200', 'border-slate-300', 'text-gray-700');
            });

            console.log(`Selected component: ${type}`);
        }

        function setTool(tool) {
            currentTool = tool;
            pendingComponentType = null;
            wireStart = null;
            measureStart = null;
            measureEnd = null;

            // Update cursor
            canvas.style.cursor = tool === 'select' ? 'default' : 'crosshair';

            // Update tool button states
            const toolButtons = {
                'select': 'selectTool',
                'wire': 'wireTool',
                'measure': 'measureTool',
                'annotate': 'annotateTool'
            };

            Object.entries(toolButtons).forEach(([toolName, btnId]) => {
                const btn = document.getElementById(btnId);
                if (toolName === tool) {
                    btn.classList.remove('from-slate-100', 'to-slate-200', 'border-slate-300', 'text-gray-700');
                    btn.classList.add('from-olive-500', 'to-olive-600', 'text-white', 'border-olive-700');
                } else {
                    btn.classList.remove('from-olive-500', 'to-olive-600', 'text-white', 'border-olive-700');
                    btn.classList.add('from-slate-100', 'to-slate-200', 'border-slate-300', 'text-gray-700');
                }
            });

            console.log(`Tool changed to: ${tool}`);
            render();
        }

        // ========================================
        // RENDER FUNCTION
        // ========================================

        let currentMouseX = 0;
        let currentMouseY = 0;
        let draggingWirePoint = null; // { wireIndex, pointIndex }

        function render() {
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);

            // Draw floor plan (if loaded and layer visible)
            if (floorplanImage && layers.floorplan) {
                ctx.drawImage(floorplanImage, 0, 0);
            }

            // Draw snap grid (if enabled)
            if (snapToGrid) {
                ctx.strokeStyle = 'rgba(0, 150, 255, 0.2)';
                ctx.lineWidth = 1;
                for (let x = 0; x < canvas.width; x += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(x, 0);
                    ctx.lineTo(x, canvas.height);
                    ctx.stroke();
                }
                for (let y = 0; y < canvas.height; y += gridSize) {
                    ctx.beginPath();
                    ctx.moveTo(0, y);
                    ctx.lineTo(canvas.width, y);
                    ctx.stroke();
                }
            }

            // Draw wires (if layer visible)
            if (layers.wiring) {
                wires.forEach((wire, idx) => {
                    const wireTypeObj = wireTypes.find(wt => wt.name.includes(wire.type === 'power120' ? '120V' : wire.type === 'power240' ? '240V' : wire.type === 'control' ? 'Control' : 'Low'));
                    const color = wireTypeObj ? wireTypeObj.color : '#e74c3c';

                    ctx.strokeStyle = color;
                    ctx.lineWidth = selectedWireForMove === wire ? 6 : 4;
                    ctx.beginPath();
                    ctx.moveTo(wire.from.x, wire.from.y);

                    if (wire.controlPoints && wire.controlPoints.length > 0) {
                        wire.controlPoints.forEach(pt => {
                            ctx.lineTo(pt.x, pt.y);
                        });
                    }

                    ctx.lineTo(wire.to.x, wire.to.y);
                    ctx.stroke();

                    // Draw control points
                    if (wire.controlPoints && selectedWireForMove === wire) {
                        wire.controlPoints.forEach(pt => {
                            ctx.fillStyle = '#3498db';
                            ctx.beginPath();
                            ctx.arc(pt.x, pt.y, 6, 0, Math.PI * 2);
                            ctx.fill();
                        });
                    }

                    // Highlight selected wire
                    if (selectedWireForMove === wire) {
                        ctx.strokeStyle = '#3498db';
                        ctx.lineWidth = 2;
                        ctx.setLineDash([5, 5]);
                        ctx.beginPath();
                        ctx.moveTo(wire.from.x, wire.from.y);
                        if (wire.controlPoints && wire.controlPoints.length > 0) {
                            wire.controlPoints.forEach(pt => ctx.lineTo(pt.x, pt.y));
                        }
                        ctx.lineTo(wire.to.x, wire.to.y);
                        ctx.stroke();
                        ctx.setLineDash([]);
                    }
                });

                // Draw wire being drawn
                if (wireStart && currentTool === 'wire') {
                    ctx.strokeStyle = '#2ecc71';
                    ctx.lineWidth = 3;
                    ctx.setLineDash([5, 5]);
                    ctx.beginPath();
                    ctx.moveTo(wireStart.x, wireStart.y);
                    ctx.lineTo(currentMouseX, currentMouseY);
                    ctx.stroke();
                    ctx.setLineDash([]);
                }
            }

            // Draw components (if layer visible)
            if (layers.components) {
                components.forEach(comp => {
                    const config = componentConfig[comp.type] || componentConfig.light;
                    const width = comp.width || config.width;
                    const height = comp.height || config.height;

                    // Draw selection highlight
                    if (comp === selectedComponent) {
                        ctx.strokeStyle = '#3498db';
                        ctx.lineWidth = 3;
                        ctx.strokeRect(comp.x - width/2 - 5, comp.y - height/2 - 5, width + 10, height + 10);
                    }

                    // Draw component
                    if (comp.customImage) {
                        if (comp.customImageObj) {
                            ctx.drawImage(comp.customImageObj, comp.x - width/2, comp.y - height/2, width, height);
                        }
                    } else {
                        ctx.font = `${width}px Arial`;
                        ctx.textAlign = 'center';
                        ctx.textBaseline = 'middle';
                        ctx.fillText(config.emoji, comp.x, comp.y);
                    }

                    // Draw label
                    if (comp.label) {
                        ctx.font = '12px Arial';
                        ctx.fillStyle = '#000';
                        ctx.textAlign = 'center';
                        ctx.fillText(comp.label, comp.x, comp.y + height/2 + 15);
                    }

                    // Draw resize handles if selected
                    if (comp === selectedComponent) {
                        const handleSize = 8;
                        ctx.fillStyle = '#3498db';
                        // SE
                        ctx.fillRect(comp.x + width/2 - handleSize/2, comp.y + height/2 - handleSize/2, handleSize, handleSize);
                        // SW
                        ctx.fillRect(comp.x - width/2 - handleSize/2, comp.y + height/2 - handleSize/2, handleSize, handleSize);
                        // NE
                        ctx.fillRect(comp.x + width/2 - handleSize/2, comp.y - height/2 - handleSize/2, handleSize, handleSize);
                        // NW
                        ctx.fillRect(comp.x - width/2 - handleSize/2, comp.y - height/2 - handleSize/2, handleSize, handleSize);
                    }
                });
            }

            // Draw annotations (if layer visible)
            if (layers.annotations) {
                annotations.forEach(ann => {
                    ctx.font = 'bold 14px Arial';
                    ctx.fillStyle = selectedAnnotation === ann ? '#3498db' : '#e74c3c';
                    ctx.textAlign = 'left';
                    ctx.fillText(ann.text, ann.x, ann.y);

                    if (selectedAnnotation === ann) {
                        const metrics = ctx.measureText(ann.text);
                        ctx.strokeStyle = '#3498db';
                        ctx.lineWidth = 2;
                        ctx.strokeRect(ann.x - 5, ann.y - 15, metrics.width + 10, 20);
                    }
                });
            }

            // Draw measure line
            if (measureStart && measureEnd) {
                const dx = measureEnd.x - measureStart.x;
                const dy = measureEnd.y - measureStart.y;
                const dist = Math.sqrt(dx * dx + dy * dy);

                ctx.strokeStyle = '#f39c12';
                ctx.lineWidth = 2;
                ctx.setLineDash([5, 5]);
                ctx.beginPath();
                ctx.moveTo(measureStart.x, measureStart.y);
                ctx.lineTo(measureEnd.x, measureEnd.y);
                ctx.stroke();
                ctx.setLineDash([]);

                // Draw distance label
                ctx.font = 'bold 16px Arial';
                ctx.fillStyle = '#f39c12';
                ctx.textAlign = 'center';
                ctx.fillText(`${Math.round(dist)}px`, (measureStart.x + measureEnd.x) / 2, (measureStart.y + measureEnd.y) / 2 - 10);
            }
        }

        // ========================================
        // CANVAS INTERACTION
        // ========================================

        function getCanvasCoords(e) {
            const rect = canvas.getBoundingClientRect();
            const scaleX = canvas.width / rect.width;
            const scaleY = canvas.height / rect.height;
            return {
                x: (e.clientX - rect.left) * scaleX,
                y: (e.clientY - rect.top) * scaleY
            };
        }

        function getComponentAtPoint(x, y) {
            for (let i = components.length - 1; i >= 0; i--) {
                const comp = components[i];
                const config = componentConfig[comp.type] || componentConfig.light;
                const width = comp.width || config.width;
                const height = comp.height || config.height;

                if (x >= comp.x - width/2 && x <= comp.x + width/2 &&
                    y >= comp.y - height/2 && y <= comp.y + height/2) {
                    return comp;
                }
            }
            return null;
        }

        function getAnnotationAtPoint(x, y) {
            for (let i = annotations.length - 1; i >= 0; i--) {
                const ann = annotations[i];
                ctx.font = 'bold 14px Arial';
                const metrics = ctx.measureText(ann.text);
                if (x >= ann.x - 5 && x <= ann.x + metrics.width + 5 &&
                    y >= ann.y - 15 && y <= ann.y + 5) {
                    return ann;
                }
            }
            return null;
        }

        function getWireAtPoint(x, y, tolerance = 10) {
            for (let i = wires.length - 1; i >= 0; i--) {
                const wire = wires[i];

                // Check line segments
                const segments = [];
                segments.push({ from: wire.from, to: wire.controlPoints && wire.controlPoints.length > 0 ? wire.controlPoints[0] : wire.to });

                if (wire.controlPoints) {
                    for (let j = 0; j < wire.controlPoints.length; j++) {
                        const nextPt = j < wire.controlPoints.length - 1 ? wire.controlPoints[j + 1] : wire.to;
                        segments.push({ from: wire.controlPoints[j], to: nextPt });
                    }
                }

                for (const seg of segments) {
                    const dist = distanceToLineSegment(x, y, seg.from.x, seg.from.y, seg.to.x, seg.to.y);
                    if (dist < tolerance) {
                        return i;
                    }
                }
            }
            return null;
        }

        function distanceToLineSegment(px, py, x1, y1, x2, y2) {
            const A = px - x1;
            const B = py - y1;
            const C = x2 - x1;
            const D = y2 - y1;

            const dot = A * C + B * D;
            const lenSq = C * C + D * D;
            let param = -1;

            if (lenSq !== 0) {
                param = dot / lenSq;
            }

            let xx, yy;

            if (param < 0) {
                xx = x1;
                yy = y1;
            } else if (param > 1) {
                xx = x2;
                yy = y2;
            } else {
                xx = x1 + param * C;
                yy = y1 + param * D;
            }

            const dx = px - xx;
            const dy = py - yy;
            return Math.sqrt(dx * dx + dy * dy);
        }

        function getResizeHandle(comp, x, y) {
            const config = componentConfig[comp.type] || componentConfig.light;
            const width = comp.width || config.width;
            const height = comp.height || config.height;
            const handleSize = 8;
            const tolerance = 10;

            const handles = [
                { name: 'se', x: comp.x + width/2, y: comp.y + height/2 },
                { name: 'sw', x: comp.x - width/2, y: comp.y + height/2 },
                { name: 'ne', x: comp.x + width/2, y: comp.y - height/2 },
                { name: 'nw', x: comp.x - width/2, y: comp.y - height/2 }
            ];

            for (const handle of handles) {
                if (Math.abs(x - handle.x) < tolerance && Math.abs(y - handle.y) < tolerance) {
                    return handle.name;
                }
            }
            return null;
        }

        canvasWrapper.addEventListener('mousedown', (e) => {
            const coords = getCanvasCoords(e);
            let x = coords.x;
            let y = coords.y;

            if (currentTool === 'wire' || draggingWirePoint) {
                const snapped = snapToGridPoint(x, y);
                x = snapped.x;
                y = snapped.y;
            }

            if (e.button === 2) return; // Ignore right click

            if (currentTool === 'select' || spacebarPressed) {
                // Check if clicking on resize handle
                if (selectedComponent) {
                    const handle = getResizeHandle(selectedComponent, x, y);
                    if (handle) {
                        isResizing = true;
                        resizeHandle = handle;
                        return;
                    }
                }

                // Check wire control points first
                if (selectedWireForMove && selectedWireForMove.controlPoints) {
                    for (let i = 0; i < selectedWireForMove.controlPoints.length; i++) {
                        const pt = selectedWireForMove.controlPoints[i];
                        const dist = Math.sqrt((x - pt.x) ** 2 + (y - pt.y) ** 2);
                        if (dist < 10) {
                            draggingWirePoint = { wireIndex: wires.indexOf(selectedWireForMove), pointIndex: i };
                            return;
                        }
                    }
                }

                // Check annotation
                const clickedAnn = getAnnotationAtPoint(x, y);
                if (clickedAnn) {
                    selectedAnnotation = clickedAnn;
                    selectedComponent = null;
                    selectedWireForMove = null;
                    draggingAnnotation = true;
                    ctx.font = 'bold 14px Arial';
                    const metrics = ctx.measureText(clickedAnn.text);
                    dragOffset = { x: x - clickedAnn.x, y: y - clickedAnn.y };
                    render();
                    return;
                }

                // Check wire
                const wireIdx = getWireAtPoint(x, y);
                if (wireIdx !== null) {
                    selectedWireForMove = wires[wireIdx];
                    selectedComponent = null;
                    selectedAnnotation = null;
                    draggingEntireWire = true;
                    wireMoveDragOffset = { x: x, y: y };
                    render();
                    return;
                }

                // Check component
                const clickedComp = getComponentAtPoint(x, y);
                if (clickedComp) {
                    selectedComponent = clickedComp;
                    selectedAnnotation = null;
                    selectedWireForMove = null;
                    isDragging = true;
                    dragOffset = { x: x - clickedComp.x, y: y - clickedComp.y };
                    showProperties(clickedComp);
                    render();
                } else {
                    // Deselect all
                    selectedComponent = null;
                    selectedAnnotation = null;
                    selectedWireForMove = null;
                    // Start panning
                    isPanning = true;
                    lastPanX = e.clientX;
                    lastPanY = e.clientY;
                    canvasWrapper.classList.add('panning');
                    render();
                }
            } else if (currentTool === 'place' && pendingComponentType) {
                // Place component
                const config = componentConfig[pendingComponentType];
                const newComp = {
                    id: components.length + 1,
                    type: pendingComponentType,
                    x: x,
                    y: y,
                    label: `${config.name} ${components.length + 1}`,
                    circuit: null,
                    width: config.width,
                    height: config.height
                };
                components.push(newComp);
                render();
            } else if (currentTool === 'wire') {
                // Wire drawing
                if (!wireStart) {
                    // Find nearest component
                    let nearest = null;
                    let minDist = 30;
                    components.forEach(comp => {
                        const dx = comp.x - x;
                        const dy = comp.y - y;
                        const dist = Math.sqrt(dx * dx + dy * dy);
                        if (dist < minDist) {
                            nearest = comp;
                            minDist = dist;
                        }
                    });

                    if (nearest) {
                        wireStart = { x: nearest.x, y: nearest.y, comp: nearest };
                        render();
                    }
                } else {
                    // Check if double-clicking to add control point
                    const wireIdx = getWireAtPoint(x, y);
                    if (wireIdx !== null) {
                        if (!wires[wireIdx].controlPoints) {
                            wires[wireIdx].controlPoints = [];
                        }
                        wires[wireIdx].controlPoints.push({ x, y });
                        render();
                        return;
                    }

                    // Complete wire
                    let nearest = null;
                    let minDist = 30;
                    components.forEach(comp => {
                        if (comp !== wireStart.comp) {
                            const dx = comp.x - x;
                            const dy = comp.y - y;
                            const dist = Math.sqrt(dx * dx + dy * dy);
                            if (dist < minDist) {
                                nearest = comp;
                                minDist = dist;
                            }
                        }
                    });

                    if (nearest) {
                        const wireType = prompt('Wire type:\n1 = 120V Power\n2 = 240V Power\n3 = Control\n4 = Low Voltage', '1');
                        const cableType = prompt('Cable type (e.g., "14/2 Romex", "12/3 NM-B"):', '14/2 Romex');
                        const typeMap = { '1': 'power120', '2': 'power240', '3': 'control', '4': 'lowvoltage' };

                        wires.push({
                            from: { x: wireStart.x, y: wireStart.y },
                            to: { x: nearest.x, y: nearest.y },
                            type: typeMap[wireType] || 'power120',
                            cableType: cableType,
                            circuit: null,
                            controlPoints: []
                        });
                        wireStart = null;
                        render();
                    }
                }
            } else if (currentTool === 'measure') {
                if (!measureStart) {
                    measureStart = { x, y };
                } else {
                    measureEnd = { x, y };
                    render();
                    setTimeout(() => {
                        measureStart = null;
                        measureEnd = null;
                        render();
                    }, 5000); // Clear after 5 seconds
                }
            } else if (currentTool === 'annotate') {
                const text = prompt('Enter annotation text:');
                if (text) {
                    annotations.push({ x, y, text });
                    render();
                }
            }
        });

        canvasWrapper.addEventListener('mousemove', (e) => {
            const coords = getCanvasCoords(e);
            let x = coords.x;
            let y = coords.y;

            // Apply snap-to-grid when drawing wires
            if (currentTool === 'wire' || draggingWirePoint) {
                const snapped = snapToGridPoint(x, y);
                x = snapped.x;
                y = snapped.y;
            }

            currentMouseX = x;
            currentMouseY = y;

            if (isPanning) {
                const dx = e.clientX - lastPanX;
                const dy = e.clientY - lastPanY;
                panX += dx;
                panY += dy;
                lastPanX = e.clientX;
                lastPanY = e.clientY;
                updateTransform();
            } else if (draggingAnnotation && selectedAnnotation) {
                // Drag annotation
                selectedAnnotation.x = x - dragOffset.x;
                selectedAnnotation.y = y - dragOffset.y;
                render();
            } else if (draggingEntireWire && selectedWireForMove) {
                // Drag entire wire with all control points
                const dx = x - wireMoveDragOffset.x;
                const dy = y - wireMoveDragOffset.y;

                selectedWireForMove.from.x += dx;
                selectedWireForMove.from.y += dy;
                selectedWireForMove.to.x += dx;
                selectedWireForMove.to.y += dy;

                if (selectedWireForMove.controlPoints) {
                    selectedWireForMove.controlPoints.forEach(pt => {
                        pt.x += dx;
                        pt.y += dy;
                    });
                }

                wireMoveDragOffset = { x: x, y: y };
                render();
            } else if (isResizing && selectedComponent) {
                // Handle resizing
                const config = componentConfig[selectedComponent.type] || componentConfig.light;
                const oldWidth = selectedComponent.width || config.width;
                const oldHeight = selectedComponent.height || config.height;
                const oldRadius = Math.max(oldWidth, oldHeight) / 2;

                if (resizeHandle === 'se') {
                    const newWidth = Math.max(20, Math.abs(x - selectedComponent.x) * 2);
                    const newHeight = Math.max(20, Math.abs(y - selectedComponent.y) * 2);
                    selectedComponent.width = newWidth;
                    selectedComponent.height = newHeight;
                } else if (resizeHandle === 'sw') {
                    const newWidth = Math.max(20, Math.abs(x - selectedComponent.x) * 2);
                    const newHeight = Math.max(20, Math.abs(y - selectedComponent.y) * 2);
                    selectedComponent.width = newWidth;
                    selectedComponent.height = newHeight;
                } else if (resizeHandle === 'ne') {
                    const newWidth = Math.max(20, Math.abs(x - selectedComponent.x) * 2);
                    const newHeight = Math.max(20, Math.abs(y - selectedComponent.y) * 2);
                    selectedComponent.width = newWidth;
                    selectedComponent.height = newHeight;
                } else if (resizeHandle === 'nw') {
                    const newWidth = Math.max(20, Math.abs(x - selectedComponent.x) * 2);
                    const newHeight = Math.max(20, Math.abs(y - selectedComponent.y) * 2);
                    selectedComponent.width = newWidth;
                    selectedComponent.height = newHeight;
                }
                render();
            } else if (draggingWirePoint) {
                // Drag wire control point
                const wire = wires[draggingWirePoint.wireIndex];
                wire.controlPoints[draggingWirePoint.pointIndex] = { x, y };
                render();
            } else if (isDragging && selectedComponent) {
                // Drag component
                selectedComponent.x = x - dragOffset.x;
                selectedComponent.y = y - dragOffset.y;
                render();
            } else if (currentTool === 'wire' || currentTool === 'measure') {
                // Just update for preview
                render();
            }
        });

        canvasWrapper.addEventListener('mouseup', () => {
            isPanning = false;
            isDragging = false;
            isResizing = false;
            draggingAnnotation = false;
            draggingEntireWire = false;
            draggingWirePoint = null;
            canvasWrapper.classList.remove('panning');
        });

        // Context menu
        canvasWrapper.addEventListener('contextmenu', (e) => {
            e.preventDefault();
            const coords = getCanvasCoords(e);
            const clickedComp = getComponentAtPoint(coords.x, coords.y);

            if (clickedComp) {
                selectedComponent = clickedComp;
                const menu = document.getElementById('contextMenu');
                menu.style.display = 'block';
                menu.style.left = e.clientX + 'px';
                menu.style.top = e.clientY + 'px';
                menu.classList.remove('hidden');
                render();
            }
        });

        document.addEventListener('click', () => {
            const menu = document.getElementById('contextMenu');
            menu.style.display = 'none';
            menu.classList.add('hidden');
        });

        // Zoom with mouse wheel
        canvasWrapper.addEventListener('wheel', (e) => {
            e.preventDefault();
            if (e.ctrlKey || e.metaKey) {
                // Zoom
                if (e.deltaY < 0) {
                    zoomIn();
                } else {
                    zoomOut();
                }
            }
        });

        // ========================================
        // PROPERTIES PANEL
        // ========================================

        function showProperties(comp) {
            const config = componentConfig[comp.type] || componentConfig.light;
            document.getElementById('propertiesContent').innerHTML = `
                <div class="space-y-3">
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Type</label>
                        <input type="text" value="${config.name}" disabled class="w-full px-3 py-2 bg-gray-100 border border-gray-300 rounded-lg text-gray-700 text-sm">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Label</label>
                        <input type="text" id="compLabel" value="${comp.label || ''}" class="w-full px-3 py-2 bg-white border-2 border-gray-300 focus:border-olive-500 rounded-lg text-gray-700 text-sm focus:outline-none" onchange="updateComponentLabel(this.value)">
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Notes</label>
                        <textarea id="compNotes" class="w-full px-3 py-2 bg-white border-2 border-gray-300 focus:border-olive-500 rounded-lg text-gray-700 text-sm focus:outline-none resize-none" rows="3" onchange="updateComponentNotes(this.value)">${comp.notes || ''}</textarea>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Circuit</label>
                        <select id="compCircuit" class="w-full px-3 py-2 bg-white border-2 border-gray-300 focus:border-olive-500 rounded-lg text-gray-700 text-sm focus:outline-none" onchange="updateComponentCircuit(this.value)">
                            <option value="">None</option>
                            ${circuits.map((c, i) => `<option value="${i}" ${comp.circuit === i ? 'selected' : ''}>${c.name}</option>`).join('')}
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-semibold text-gray-600 mb-1">Custom Image</label>
                        <input type="file" id="compImage" accept="image/*" class="w-full px-3 py-2 bg-white border-2 border-gray-300 focus:border-olive-500 rounded-lg text-gray-700 text-sm focus:outline-none" onchange="uploadComponentImage(event)">
                    </div>
                    <button onclick="linkToCRM()" class="w-full px-4 py-2 bg-gradient-to-br from-purple-500 to-purple-600 hover:from-purple-600 hover:to-purple-700 text-white rounded-lg font-semibold text-sm shadow-md transition-all">Link to CRM Inventory</button>
                </div>
            `;
        }

        function updateComponentLabel(value) {
            if (selectedComponent) {
                selectedComponent.label = value;
                render();
            }
        }

        function updateComponentNotes(value) {
            if (selectedComponent) {
                selectedComponent.notes = value;
            }
        }

        function updateComponentCircuit(value) {
            if (selectedComponent) {
                selectedComponent.circuit = value === '' ? null : parseInt(value);
                render();
            }
        }

        function uploadComponentImage(event) {
            const file = event.target.files[0];
            if (file && selectedComponent) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = new Image();
                    img.onload = () => {
                        selectedComponent.customImage = e.target.result;
                        selectedComponent.customImageObj = img;
                        render();
                    };
                    img.src = e.target.result;
                };
                reader.readAsDataURL(file);
            }
        }

        // ========================================
        // CIRCUIT MANAGEMENT
        // ========================================

        function createCircuit() {
            const name = prompt('Circuit name:', `Circuit ${circuits.length + 1}`);
            if (!name) return;

            const voltage = prompt('Voltage (V):', '120');
            const amperage = prompt('Amperage (A):', '15');
            const color = prompt('Color (hex):', '#e74c3c');

            circuits.push({
                name,
                voltage: parseInt(voltage) || 120,
                amperage: parseInt(amperage) || 15,
                color: color || '#e74c3c',
                components: []
            });

            updateCircuitList();
            render();
        }

        function updateCircuitList() {
            const list = document.getElementById('circuitList');
            if (circuits.length === 0) {
                list.innerHTML = '<p class="text-gray-500 text-sm text-center p-4">No circuits created yet</p>';
            } else {
                list.innerHTML = circuits.map((circuit, idx) => `
                    <div class="bg-gradient-to-r from-gray-50 to-white rounded-lg border-2 border-gray-200 p-3 shadow-sm hover:shadow-md transition-all" style="border-left: 4px solid ${circuit.color}">
                        <div class="flex items-center justify-between mb-2">
                            <input type="text" value="${circuit.name}" class="flex-1 font-semibold text-gray-800 bg-transparent border-none focus:outline-none text-sm" onchange="updateCircuitName(${idx}, this.value)">
                            <div class="flex gap-1">
                                <button onclick="editCircuit(${idx})" class="px-2 py-1 bg-blue-500 hover:bg-blue-600 text-white rounded text-xs transition-all">‚úèÔ∏è</button>
                                <button onclick="deleteCircuit(${idx})" class="px-2 py-1 bg-red-500 hover:bg-red-600 text-white rounded text-xs transition-all">üóëÔ∏è</button>
                            </div>
                        </div>
                        <div class="text-xs text-gray-600 space-y-1">
                            <div class="flex gap-2">
                                <span class="font-medium">Voltage:</span>
                                <input type="number" value="${circuit.voltage}" class="w-16 px-1 bg-gray-100 border border-gray-300 rounded" onchange="circuit.voltage = parseInt(this.value)"> V
                            </div>
                            <div class="flex gap-2">
                                <span class="font-medium">Amp:</span>
                                <input type="number" value="${circuit.amperage}" class="w-16 px-1 bg-gray-100 border border-gray-300 rounded" onchange="circuit.amperage = parseInt(this.value)"> A
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        function updateCircuitName(idx, newName) {
            circuits[idx].name = newName;
            render();
        }

        function editCircuit(idx) {
            const circuit = circuits[idx];
            const newColor = prompt('Circuit color (hex):', circuit.color);
            if (newColor) {
                circuit.color = newColor;
                updateCircuitList();
                render();
            }
        }

        function deleteCircuit(idx) {
            if (confirm(`Delete circuit "${circuits[idx].name}"?`)) {
                circuits.splice(idx, 1);
                // Remove circuit assignments from components
                components.forEach(comp => {
                    if (comp.circuit === idx) comp.circuit = null;
                    else if (comp.circuit > idx) comp.circuit--;
                });
                updateCircuitList();
                render();
            }
        }

        // ========================================
        // WIRE TYPES
        // ========================================

        function addWireType() {
            const name = prompt('Wire type name:', 'Custom Wire');
            if (!name) return;

            const color = prompt('Color (hex):', '#3498db');
            wireTypes.push({ name, color: color || '#3498db' });
            updateWireTypesLegend();
        }

        function editWireType(idx) {
            const wt = wireTypes[idx];
            const newName = prompt('Wire type name:', wt.name);
            if (newName) wt.name = newName;

            const newColor = prompt('Color (hex):', wt.color);
            if (newColor) wt.color = newColor;

            updateWireTypesLegend();
            render();
        }

        function updateWireTypesLegend() {
            const legend = document.getElementById('wireTypesLegend');
            legend.innerHTML = wireTypes.map((wt, idx) => `
                <div onclick="editWireType(${idx})" class="flex items-center gap-3 p-2 rounded-lg hover:bg-gray-100 transition-all cursor-pointer group">
                    <div class="w-8 h-1 rounded-full shadow-sm" style="background: ${wt.color}"></div>
                    <span class="text-gray-700 text-sm font-medium group-hover:text-gray-900">${wt.name}</span>
                </div>
            `).join('');
        }

        // ========================================
        // CONTEXT MENU ACTIONS
        // ========================================

        function editComponent() {
            if (selectedComponent) {
                showProperties(selectedComponent);
            }
        }

        function duplicateComponent() {
            if (selectedComponent) {
                const config = componentConfig[selectedComponent.type] || componentConfig.light;
                const newComp = {
                    ...selectedComponent,
                    id: components.length + 1,
                    x: selectedComponent.x + 30,
                    y: selectedComponent.y + 30,
                    label: `${config.name} ${components.length + 1}`
                };
                components.push(newComp);
                render();
            }
        }

        function assignCircuitToComp() {
            if (!selectedComponent || circuits.length === 0) {
                alert('No circuits available. Create a circuit first.');
                return;
            }

            const circuitOptions = circuits.map((c, i) => `${i + 1}. ${c.name}`).join('\n');
            const choice = prompt(`Select circuit:\n${circuitOptions}\n\nEnter number:`, '1');

            if (choice) {
                const idx = parseInt(choice) - 1;
                if (idx >= 0 && idx < circuits.length) {
                    selectedComponent.circuit = idx;
                    showProperties(selectedComponent);
                    render();
                }
            }
        }

        function deleteComponent() {
            if (selectedComponent) {
                const idx = components.indexOf(selectedComponent);
                if (idx > -1) {
                    components.splice(idx, 1);
                    selectedComponent = null;
                    document.getElementById('propertiesContent').innerHTML = '<p class="text-gray-500 text-sm text-center">Select a component to edit properties</p>';
                    render();
                }
            }
        }

        // ========================================
        // CRM INTEGRATION
        // ========================================

        function linkToCRM() {
            alert('CRM linking feature - would connect to inventory management system');
        }

        // ========================================
        // IMPORT/EXPORT
        // ========================================

        function importFromTakeoffs() {
            alert('Import from Takeoffs feature - would load components from Canvas takeoffs');
        }

        function saveProgress() {
            const data = {
                components: components.map(c => ({...c, customImageObj: null})),
                wires,
                circuits,
                annotations,
                wireTypes,
                pageData,
                currentPage,
                timestamp: Date.now()
            };

            // Save to localStorage
            try {
                localStorage.setItem('electricalMapping_save', JSON.stringify(data));
                console.log('üíæ Saved to localStorage');
            } catch (e) {
                console.error('Failed to save to localStorage:', e);
            }

            // Save to server
            fetch('/api/save-mapping', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(data)
            })
            .then(res => res.json())
            .then(result => {
                alert('‚úÖ Progress saved successfully!');
                console.log('Saved to server:', result);
            })
            .catch(err => {
                console.error('Failed to save to server:', err);
                alert('‚ö†Ô∏è Saved locally, but server save failed');
            });
        }

        function loadProgress() {
            // Try loading from server first
            fetch('/api/load-mapping')
            .then(res => res.json())
            .then(data => {
                if (data && data.components) {
                    components = data.components || [];
                    wires = data.wires || [];
                    circuits = data.circuits || [];
                    annotations = data.annotations || [];
                    wireTypes = data.wireTypes || wireTypes;
                    pageData = data.pageData || {};
                    currentPage = data.currentPage || 1;

                    updateCircuitList();
                    updateWireTypesLegend();
                    render();

                    alert('‚úÖ Progress loaded from server!');
                } else {
                    loadFromLocalStorage();
                }
            })
            .catch(err => {
                console.error('Failed to load from server:', err);
                loadFromLocalStorage();
            });
        }

        function loadFromLocalStorage() {
            try {
                const saved = localStorage.getItem('electricalMapping_save');
                if (saved) {
                    const data = JSON.parse(saved);
                    components = data.components || [];
                    wires = data.wires || [];
                    circuits = data.circuits || [];
                    annotations = data.annotations || [];
                    wireTypes = data.wireTypes || wireTypes;
                    pageData = data.pageData || {};
                    currentPage = data.currentPage || 1;

                    updateCircuitList();
                    updateWireTypesLegend();
                    render();

                    alert('‚úÖ Progress loaded from browser storage!');
                } else {
                    alert('No saved data found');
                }
            } catch (e) {
                console.error('Failed to load:', e);
                alert('Failed to load data');
            }
        }

        function exportMapping() {
            // Prepare export data with all mapping information
            const exportData = {
                project_name: 'Electrical Mapping',
                source: 'electrical-mapping',
                timestamp: Date.now(),
                canvas_dimensions: {
                    width: canvas.width,
                    height: canvas.height
                },
                components: components.map(comp => ({
                    ...comp,
                    position: { x: comp.x, y: comp.y },
                    scale: { x: comp.width / (componentConfig[comp.type]?.width || 30), y: comp.height / (componentConfig[comp.type]?.height || 30) },
                    rotation: comp.rotation || 0,
                    type: comp.type,
                    name: comp.label || comp.type,
                    emoji: comp.emoji || componentConfig[comp.type]?.emoji || 'üì¶'
                })),
                wires: wires,
                circuits: circuits,
                annotations: annotations
            };

            // Export the canvas as floorplan image
            try {
                // Create a temporary canvas to render the full scene
                const tempCanvas = document.createElement('canvas');
                tempCanvas.width = canvas.width;
                tempCanvas.height = canvas.height;
                const tempCtx = tempCanvas.getContext('2d');

                // Draw floorplan if available
                if (floorplanImage) {
                    tempCtx.drawImage(floorplanImage, 0, 0);
                }

                // Draw all components, wires, etc. on temp canvas
                // Copy current canvas content
                tempCtx.drawImage(canvas, 0, 0);

                exportData.floorplan_image = tempCanvas.toDataURL('image/png', 0.9);
                console.log('Exported mapping as floorplan image');
            } catch (e) {
                console.error('Error exporting canvas image:', e);
            }

            // Offer download or export options
            const exportChoice = confirm('Export Options:\nOK = Download as JSON\nCancel = Export to Canvas Editor');

            if (exportChoice) {
                // Download as JSON
                const dataStr = JSON.stringify(exportData, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                const link = document.createElement('a');
                link.href = url;
                link.download = `electrical-mapping-${Date.now()}.json`;
                link.click();
                URL.revokeObjectURL(url);
                showImportToast('Mapping exported as JSON', 'success');
            } else {
                // Export to Canvas Editor
                sessionStorage.setItem('import_data', JSON.stringify(exportData));
                sessionStorage.setItem('import_source', 'electrical-mapping');
                showImportToast('Exporting to Canvas Editor...', 'success');
                setTimeout(() => {
                    window.location.href = '/canvas?import=true';
                }, 500);
            }
        }

        function runAIMapping() {
            const aiLoading = document.getElementById('aiLoading');
            aiLoading.classList.remove('hidden');

            setTimeout(() => {
                aiLoading.classList.add('hidden');
                alert('AI Mapping analysis complete! (Demo feature)');
            }, 3000);
        }

        // ========================================
        // KEYBOARD SHORTCUTS
        // ========================================

        let copiedComponent = null;

        document.addEventListener('keydown', (e) => {
            const isInputFocused = document.activeElement.tagName === 'INPUT' ||
                                  document.activeElement.tagName === 'TEXTAREA';

            // Spacebar - Enable panning mode
            if (e.key === ' ' && currentTool === 'select' && !isInputFocused) {
                e.preventDefault();
                spacebarPressed = true;
                canvas.style.cursor = 'grab';
            }
            // Ctrl+C - Copy component
            else if (e.ctrlKey && e.key === 'c' && selectedComponent) {
                e.preventDefault();
                copiedComponent = {...selectedComponent};
                console.log('üìã Component copied');
            }
            // Ctrl+V - Paste component
            else if (e.ctrlKey && e.key === 'v' && copiedComponent) {
                e.preventDefault();
                pasteComponent();
            }
            // Ctrl+Z - Undo
            else if (e.ctrlKey && e.key === 'z' && !e.shiftKey) {
                e.preventDefault();
                undoAction();
            }
            // Ctrl+Y or Ctrl+Shift+Z - Redo
            else if ((e.ctrlKey && e.key === 'y') || (e.ctrlKey && e.shiftKey && e.key === 'z')) {
                e.preventDefault();
                redoAction();
            }
            // Ctrl+S - Save
            else if (e.ctrlKey && e.key === 's') {
                e.preventDefault();
                saveProgress();
            }
            // Ctrl+A - Select All
            else if (e.ctrlKey && e.key === 'a' && !isInputFocused) {
                e.preventDefault();
                selectAllComponents();
            }
            // Ctrl+D - Duplicate
            else if (e.ctrlKey && e.key === 'd') {
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    duplicateComponent();
                }
            }
            // Delete or Backspace - Delete component
            else if (e.key === 'Delete' || e.key === 'Backspace') {
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    deleteComponent();
                }
            }
            // Escape - Deselect
            else if (e.key === 'Escape') {
                selectedComponent = null;
                wireStart = null;
                document.getElementById('propertiesContent').innerHTML = '<p class="text-gray-500 text-sm text-center">Select a component to edit properties</p>';
                render();
            }
            // +/= - Zoom in
            else if (e.key === '+' || e.key === '=') {
                if (document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    zoomIn();
                }
            }
            // - - Zoom out
            else if (e.key === '-' || e.key === '_') {
                if (document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    zoomOut();
                }
            }
            // 0 - Reset view
            else if (e.key === '0') {
                if (document.activeElement.tagName !== 'INPUT') {
                    e.preventDefault();
                    resetView();
                }
            }
            // S - Select tool
            else if (e.key === 's' || e.key === 'S') {
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    setTool('select');
                }
            }
            // W - Wire tool
            else if (e.key === 'w' || e.key === 'W') {
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    setTool('wire');
                }
            }
            // M - Measure tool
            else if (e.key === 'm' || e.key === 'M') {
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.tagName !== 'TEXTAREA') {
                    e.preventDefault();
                    setTool('measure');
                }
            }
            // A - Annotate tool
            else if (e.key === 'a' || e.key === 'A') {
                if (document.activeElement.tagName !== 'INPUT' &&
                    document.activeElement.tagName !== 'TEXTAREA' &&
                    !e.ctrlKey) {
                    e.preventDefault();
                    setTool('annotate');
                }
            }
        });

        function pasteComponent() {
            if (copiedComponent) {
                const config = componentConfig[copiedComponent.type] || componentConfig.light;
                const newComp = {
                    ...copiedComponent,
                    id: components.length + 1,
                    x: copiedComponent.x + 30,
                    y: copiedComponent.y + 30,
                    label: `${config.name} ${components.length + 1}`,
                    customImageObj: null
                };

                if (copiedComponent.customImage) {
                    const img = new Image();
                    img.onload = () => {
                        newComp.customImageObj = img;
                        render();
                    };
                    img.src = copiedComponent.customImage;
                }

                components.push(newComp);
                render();
                console.log('üìã Component pasted');
            }
        }

        function selectAllComponents() {
            console.log('All components info:', components);
        }

        document.addEventListener('keyup', (e) => {
            // Spacebar - Disable panning mode
            if (e.key === ' ') {
                spacebarPressed = false;
                canvas.style.cursor = currentTool === 'select' ? 'default' : 'crosshair';
            }
        });

        // ========================================
        // INITIALIZATION
        // ========================================

        // Initialize
        render();

        // Auto-import on load if session exists
        const sessionId = new URLSearchParams(window.location.search).get('session');
        if (sessionId) {
            setTimeout(() => {
                if (confirm('Import components from previous work?')) {
                    importFromTakeoffs();
                }
            }, 500);
        }

        // Check for auto-saved data on page load
        setTimeout(() => {
            loadAutoSave();
        }, 1000);

        // Start auto-save
        startAutoSave();

        // Show keyboard shortcuts
        console.log(`
        ‚ú® ELECTRICAL MAPPING v2.0 - PREMIUM EDITION

        üéπ KEYBOARD SHORTCUTS:
        - Ctrl+C: Copy component
        - Ctrl+V: Paste component
        - Ctrl+Z: Undo
        - Ctrl+Y: Redo
        - Ctrl+D: Duplicate component
        - Ctrl+A: Select all info
        - Ctrl+S: Save progress
        - Delete/Backspace: Delete selected item
        - Escape: Deselect all
        - +/=: Zoom in
        - -: Zoom out
        - 0: Reset view
        - S: Select tool
        - W: Wire tool
        - M: Measure tool
        - A: Annotate tool
        - Spacebar + Drag: Pan canvas

        üñ±Ô∏è MOUSE CONTROLS:
        - Scroll wheel: Zoom in/out
        - Ctrl + Scroll: Pinch zoom
        - Click + Drag: Move selected item
        - Click empty space: Pan canvas
        - Right-click: Context menu

        üíæ FEATURES:
        - Multi-page PDF support
        - Auto-save every 30s
        - Undo/Redo system
        - Layer visibility controls
        - Circuit management
        - Custom wire types
        - Component properties
        - CRM integration ready
        - Export to PDF
        - AI-powered mapping
        `);
    </script>

    <!-- Footer -->
    <footer style="text-align: center; padding: 20px; color: #6b7280; font-size: 12px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;">
        ¬© 2025 Integratd Living. All rights reserved.
    </footer>

    <!-- AI Chatbot Component -->
    {% include 'chatbot_component.html' %}
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Complete CRM - Integratd Living</title>
    <style>
        :root {
            /* Light mode colors */
            --bg-primary: #f5f5f7;
            --bg-secondary: #ffffff;
            --text-primary: #1d1d1f;
            --text-secondary: #666666;
            --text-tertiary: #999999;
            --border-color: #d2d2d7;
            --border-light: #f5f5f7;
            --hover-bg: #f5f5f7;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
            --input-bg: #fafafa;
            --input-border: #d2d2d7;
        }

        [data-theme="dark"] {
            /* Dark mode colors */
            --bg-primary: #121212;
            --bg-secondary: #1e1e1e;
            --text-primary: #e0e0e0;
            --text-secondary: #a0a0a0;
            --text-tertiary: #707070;
            --border-color: #3a3a3a;
            --border-light: #2a2a2a;
            --hover-bg: #2a2a2a;
            --shadow: 0 2px 8px rgba(0, 0, 0, 0.3);
            --input-bg: #2a2a2a;
            --input-border: #3a3a3a;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            transition: background-color 0.3s ease, color 0.3s ease;
        }

        /* THEME TOGGLE */
        .theme-toggle-btn {
            background: transparent;
            border: none;
            cursor: pointer;
            padding: 8px;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background-color 0.2s;
            margin-left: auto;
        }

        .theme-toggle-btn:hover {
            background: var(--hover-bg);
        }

        .theme-toggle-btn svg {
            width: 24px;
            height: 24px;
            color: var(--text-primary);
        }

        /* TOP NAV */
        .top-nav {
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            padding: 0 40px;
            position: sticky;
            top: 0;
            z-index: 1000;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            align-items: center;
            height: 60px;
            gap: 40px;
        }

        .top-logo {
            font-size: 20px;
            font-weight: 700;
            color: #556B2F;
            text-decoration: none;
        }

        .top-nav-menu {
            display: flex;
            gap: 24px;
            list-style: none;
            flex: 1;
        }

        .top-nav-item {
            color: var(--text-primary);
            text-decoration: none;
            font-size: 15px;
            font-weight: 500;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.2s;
        }

        .top-nav-item:hover {
            background: rgba(85, 107, 47, 0.1);
        }

        .top-nav-item.active {
            background: #556B2F;
            color: white;
        }

        /* SIDEBAR */
        .sidebar {
            position: fixed;
            left: 0;
            top: 60px;
            bottom: 0;
            width: 250px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            padding: 24px 0;
            overflow-y: auto;
            transition: background-color 0.3s ease, border-color 0.3s ease;
        }

        .nav-section {
            padding: 24px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .nav-section-title {
            padding: 0 24px 12px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--text-tertiary);
        }

        .nav-item {
            padding: 12px 24px;
            cursor: pointer;
            transition: all 0.2s;
            color: var(--text-primary);
            font-size: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item span {
            font-size: 24px; /* Make menu icons larger */
        }

        .nav-item:hover { background: var(--hover-bg); }
        .nav-item.active {
            background: #556B2F;
            color: white;
            font-weight: 600;
        }

        /* Collapsible Menu Styles */
        .nav-section-title {
            cursor: pointer;
            user-select: none;
            position: relative;
        }

        .nav-section-title::after {
            content: '‚ñº';
            position: absolute;
            right: 24px;
            font-size: 10px;
            transition: transform 0.2s;
        }

        .nav-section-title.collapsed::after {
            transform: rotate(-90deg);
        }

        .nav-section-items {
            max-height: 1000px;
            overflow: hidden;
            transition: max-height 0.3s ease-in-out;
        }

        .nav-section-items.collapsed {
            max-height: 0;
        }

        /* Mobile: subcategories appear on click */
        @media (max-width: 768px) {
            .nav-section-items.collapsed {
                max-height: 0;
            }
        }

        /* Desktop: subcategories appear on hover */
        @media (min-width: 769px) {
            .nav-section:hover .nav-section-items.collapsed {
                max-height: 1000px;
            }

            .nav-section:hover .nav-section-title.collapsed::after {
                transform: rotate(0deg);
            }
        }

        /* MAIN CONTENT */
        .main-content {
            margin-left: 250px;
            margin-top: 0;
            padding: 40px;
            min-height: calc(100vh - 60px);
        }

        .section {
            display: none;
            animation: fadeIn 0.3s;
        }

        .section.active { display: block; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .page-subtitle {
            font-size: 16px;
            color: var(--text-secondary);
            margin-bottom: 32px;
        }

        /* STATS */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease;
        }

        .stat-value {
            font-size: 36px;
            font-weight: 700;
            color: #556B2F;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        /* CARD */
        .card {
            background: var(--bg-secondary);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            font-size: 20px;
            font-weight: 700;
        }

        /* BUTTONS */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 10px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            font-family: inherit;
        }

        .btn-primary {
            background: #556B2F;
            color: white;
        }

        .btn-primary:hover {
            background: #6B8E23;
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(85, 107, 47, 0.3);
        }

        .btn-secondary {
            background: var(--hover-bg);
            color: var(--text-primary);
        }

        .btn-secondary:hover { background: var(--border-light); }

        .btn-small {
            padding: 8px 16px;
            font-size: 13px;
        }

        .btn-danger {
            background: #dc3545;
            color: white;
        }

        /* FORM */
        .form-group {
            margin-bottom: 20px;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
        }

        label {
            display: block;
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="date"],
        input[type="time"],
        select,
        textarea {
            width: 100%;
            padding: 12px 16px;
            border: 1px solid var(--input-border);
            border-radius: 10px;
            font-size: 15px;
            font-family: inherit;
            transition: all 0.2s;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        input:focus, select:focus, textarea:focus {
            outline: none;
            border-color: #556B2F;
            box-shadow: 0 0 0 4px rgba(85, 107, 47, 0.1);
        }

        textarea {
            resize: vertical;
            min-height: 100px;
        }

        .search-input {
            width: 100%;
            max-width: 400px;
            padding: 12px 16px;
            border: 1px solid var(--input-border);
            border-radius: 10px;
            margin-bottom: 20px;
            background: var(--input-bg);
            color: var(--text-primary);
        }

        /* TABLE */
        .table-container { overflow-x: auto; }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            text-align: left;
            padding: 16px;
            background: var(--hover-bg);
            font-weight: 600;
            font-size: 13px;
            color: var(--text-secondary);
            text-transform: uppercase;
            border-bottom: 2px solid var(--border-color);
        }

        td {
            padding: 16px;
            border-bottom: 1px solid var(--border-light);
            color: var(--text-primary);
        }

        tr:hover { background: var(--hover-bg); }

        .status-badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
        }

        .status-active { background: #d4edda; color: #155724; }
        .status-pending { background: #fff3cd; color: #856404; }
        .status-in-progress { background: #cce5ff; color: #004085; }
        .status-completed { background: #d4edda; color: #155724; }
        .status-on-hold { background: #ffeaa7; color: #6c5ce7; }
        .status-cancelled { background: #f8d7da; color: #721c24; }

        /* MODAL */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(4px);
            z-index: 1000;
            align-items: center;
            justify-content: center;
            overflow-y: auto;
            padding: 40px 20px;
        }

        .modal.active { display: flex; }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            padding: 32px;
            max-width: 700px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            transition: background-color 0.3s ease;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 24px;
        }

        .modal-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 32px;
            cursor: pointer;
            color: var(--text-secondary);
        }

        /* EMPTY STATE */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-icon { font-size: 64px; margin-bottom: 16px; }
        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        /* LOADING */
        .loading {
            text-align: center;
            padding: 40px;
        }

        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--border-light);
            border-top-color: #556B2F;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .flex { display: flex; }
        .gap-2 { gap: 16px; }
        .mt-3 { margin-top: 24px; }

        /* CHARTS */
        .charts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .chart-card {
            background: var(--bg-secondary);
            padding: 24px;
            border-radius: 16px;
            box-shadow: var(--shadow);
            transition: background-color 0.3s ease;
        }

        .chart-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 16px;
            color: var(--text-primary);
        }
    </style>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // TEST: Verify JavaScript is working
        console.log('üöÄ CRM PAGE LOADED - JavaScript is working!');
        console.log('üìç Current URL:', window.location.href);
        console.log('‚è∞ Load time:', new Date().toISOString());
    </script>
</head>
<body>

    <!-- TOP NAVIGATION -->
    <nav class="top-nav">
        <div class="nav-container">
            <a href="/" class="top-logo">üè† Integratd Living</a>
            <button class="theme-toggle-btn" id="themeToggle" aria-label="Toggle dark mode" onclick="console.log('üñ±Ô∏è BUTTON CLICKED INLINE!'); alert('Button click registered!');">
                <svg id="sunIcon" class="sun-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <circle cx="12" cy="12" r="5"></circle>
                    <line x1="12" y1="1" x2="12" y2="3"></line>
                    <line x1="12" y1="21" x2="12" y2="23"></line>
                    <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                    <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                    <line x1="1" y1="12" x2="3" y2="12"></line>
                    <line x1="21" y1="12" x2="23" y2="12"></line>
                    <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                    <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                </svg>
                <svg id="moonIcon" class="moon-icon" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" style="display: none;">
                    <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                </svg>
            </button>
        </div>
    </nav>

    <!-- SIDEBAR -->
    <div class="sidebar">
        <div class="nav-section">
            <div class="nav-section-title">Main</div>
            <div class="nav-item active" data-section="dashboard">
                <span>üìä</span> Dashboard
            </div>
        </div>

        <!-- PEOPLE -->
        <div class="nav-section">
            <div class="nav-section-title collapsed">People</div>
            <div class="nav-section-items collapsed">
                <div class="nav-item" data-section="people-employees">
                    <span>üëî</span> Employees
                </div>
                <div class="nav-item" data-section="people-customers">
                    <span>üë•</span> Customers
                </div>
                <div class="nav-item" data-section="people-suppliers">
                    <span>üè≠</span> Suppliers
                </div>
                <div class="nav-item" data-section="people-contractors">
                    <span>üîß</span> Contractors
                </div>
                <div class="nav-item" data-section="people-contacts">
                    <span>üìá</span> Contacts
                </div>
            </div>
        </div>

        <!-- QUOTES -->
        <div class="nav-section">
            <div class="nav-section-title collapsed">Quotes</div>
            <div class="nav-section-items collapsed">
                <div class="nav-item" data-section="quotes-open">
                    <span>üìã</span> Open
                </div>
                <div class="nav-item" data-section="quotes-sent">
                    <span>üì§</span> Sent
                </div>
                <div class="nav-item" data-section="quotes-expired">
                    <span>‚è∞</span> Expired
                </div>
                <div class="nav-item" data-section="quotes-supplier">
                    <span>üì•</span> Supplier Quotes
                </div>
            </div>
        </div>

        <!-- JOBS -->
        <div class="nav-section">
            <div class="nav-section-title collapsed">Jobs</div>
            <div class="nav-section-items collapsed">
                <div class="nav-item" data-section="jobs-in-progress">
                    <span>‚öôÔ∏è</span> In Progress
                </div>
                <div class="nav-item" data-section="jobs-upcoming">
                    <span>üìÖ</span> Upcoming
                </div>
                <div class="nav-item" data-section="jobs-pending">
                    <span>‚è∏Ô∏è</span> Pending
                </div>
                <div class="nav-item" data-section="jobs-finished">
                    <span>‚úÖ</span> Finished
                </div>
                <div class="nav-item" data-section="jobs-recurring">
                    <span>üîÑ</span> Recurring
                </div>
            </div>
        </div>

        <!-- SCHEDULES -->
        <div class="nav-section">
            <div class="nav-section-title collapsed">Schedules</div>
            <div class="nav-section-items collapsed">
                <div class="nav-item" data-section="schedules-calendar">
                    <span>üìÜ</span> Calendar
                </div>
            </div>
        </div>

        <!-- MATERIALS -->
        <div class="nav-section">
            <div class="nav-section-title collapsed">Materials</div>
            <div class="nav-section-items collapsed">
                <div class="nav-item" data-section="materials-stock">
                    <span>üì¶</span> Stock
                </div>
                <div class="nav-item" data-section="materials-orders">
                    <span>üõí</span> Orders
                </div>
            </div>
        </div>

        <!-- PAYMENTS -->
        <div class="nav-section">
            <div class="nav-section-title collapsed">Payments</div>
            <div class="nav-section-items collapsed">
                <div class="nav-item" data-section="payments-to-suppliers">
                    <span>üí∏</span> To Suppliers
                </div>
                <div class="nav-item" data-section="payments-to-us">
                    <span>üí∞</span> To Us
                </div>
            </div>
        </div>

        <!-- SYSTEM -->
        <div class="nav-section">
            <div class="nav-section-title collapsed">System</div>
            <div class="nav-section-items collapsed">
                <div class="nav-item" data-section="integrations">
                    <span>üîó</span> Integrations
                </div>
                <div class="nav-item" data-section="google-integrations">
                    <span>üîå</span> Google Integration
                </div>
            </div>
        </div>
    </div>

    <!-- MAIN CONTENT -->
    <div class="main-content">
        
        <!-- DASHBOARD -->
        <div id="dashboard" class="section active">
            <h1 class="page-title">Dashboard</h1>
            <p class="page-subtitle">Overview of your business</p>

            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="statCustomers">0</div>
                    <div class="stat-label">Total Customers</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statProjects">0</div>
                    <div class="stat-label">Total Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statActive">0</div>
                    <div class="stat-label">Active Projects</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statRevenue">$0</div>
                    <div class="stat-label">Total Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statPending">$0</div>
                    <div class="stat-label">Pending Revenue</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="statStock">0</div>
                    <div class="stat-label">Low Stock Items</div>
                </div>
            </div>

            <!-- Charts -->
            <div class="charts-grid">
                <div class="chart-card">
                    <h3 class="chart-title">Revenue Overview</h3>
                    <canvas id="revenueChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Project Status</h3>
                    <canvas id="projectStatusChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Monthly Revenue Trend</h3>
                    <canvas id="monthlyRevenueChart"></canvas>
                </div>
                <div class="chart-card">
                    <h3 class="chart-title">Customer Growth</h3>
                    <canvas id="customerGrowthChart"></canvas>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Quick Actions</h2>
                </div>
                <div class="flex gap-2">
                    <button class="btn btn-primary" onclick="showSection('customers'); openModal('customerModal')">+ New Customer</button>
                    <button class="btn btn-primary" onclick="showSection('projects'); openModal('projectModal')">+ New Project</button>
                    <button class="btn btn-primary" onclick="showSection('calendar'); openModal('eventModal')">+ Schedule Event</button>
                    <button class="btn btn-primary" onclick="showSection('inventory'); openModal('inventoryModal')">+ Add Inventory</button>
                </div>
            </div>
        </div>

        <!-- CUSTOMERS -->
        <div id="customers" class="section">
            <h1 class="page-title">Customers</h1>
            <p class="page-subtitle">Manage your customer relationships</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="customerSearch" placeholder="Search customers..." onkeyup="searchCustomers()">
                    <button class="btn btn-primary" onclick="openModal('customerModal')">+ Add Customer</button>
                </div>
                <div id="customersLoading" class="loading" style="display:none;">
                    <div class="spinner"></div>
                    <p>Loading customers...</p>
                </div>
                <div id="customersTable"></div>
            </div>
        </div>

        <!-- COMMUNICATIONS -->
        <div id="communications" class="section">
            <h1 class="page-title">Communications</h1>
            <p class="page-subtitle">Track all customer interactions</p>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Communication Log</h2>
                    <button class="btn btn-primary" onclick="openModal('commModal')">+ Add Communication</button>
                </div>
                <div id="commTable"></div>
            </div>
        </div>

        <!-- PROJECTS -->
        <div id="projects" class="section">
            <h1 class="page-title">Projects</h1>
            <p class="page-subtitle">Manage all projects and jobs</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="projectSearch" placeholder="Search projects...">
                    <button class="btn btn-primary" onclick="openModal('projectModal')">+ New Project</button>
                </div>
                <div id="projectsTable"></div>
            </div>
        </div>

        <!-- QUOTES -->
        <div id="quotes" class="section">
            <h1 class="page-title">Quotes</h1>
            <p class="page-subtitle">Manage quotes and convert to projects when accepted</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="quoteSearch" placeholder="Search quotes...">
                    <div style="display: flex; gap: 10px;">
                        <select id="quoteStatusFilter" onchange="filterQuotes()" style="padding: 8px 12px; border-radius: 8px; border: 1px solid #d2d2d7;">
                            <option value="">All Status</option>
                            <option value="draft">Draft</option>
                            <option value="sent">Sent</option>
                            <option value="accepted">Accepted</option>
                            <option value="rejected">Rejected</option>
                            <option value="expired">Expired</option>
                        </select>
                        <button class="btn btn-primary" onclick="openModal('quoteModal')">+ New Quote</button>
                    </div>
                </div>
                <div id="quotesTable"></div>
            </div>
        </div>

        <!-- CALENDAR -->
        <div id="calendar" class="section">
            <h1 class="page-title">Calendar</h1>
            <p class="page-subtitle">Schedule and manage appointments</p>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Upcoming Events</h2>
                    <button class="btn btn-primary" onclick="openModal('eventModal')">+ Schedule Event</button>
                </div>
                <div id="calendarTable"></div>
            </div>
        </div>

        <!-- INVENTORY -->
        <div id="inventory" class="section">
            <h1 class="page-title">Inventory Management</h1>
            <p class="page-subtitle">Manage your products and stock</p>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Product Catalog</h2>
                    <div style="display: flex; gap: 10px; align-items: center; flex-wrap: wrap;">
                        <input type="text" id="inventorySearchInput" class="search-input" placeholder="Search inventory..." style="flex: 1; min-width: 200px;">
                        <select id="inventoryTypeFilter" onchange="filterInventory()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">All Types</option>
                            <option value="lighting">üí° Lighting</option>
                            <option value="shading">ü™ü Shading</option>
                            <option value="security_access">üîê Security</option>
                            <option value="climate">üå° Climate</option>
                            <option value="audio">üîä Audio</option>
                            <option value="networking">üåê Networking</option>
                            <option value="power">‚ö° Power</option>
                            <option value="other">üì¶ Other</option>
                        </select>
                        <select id="inventoryTierFilter" onchange="filterInventory()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">All Tiers</option>
                            <option value="basic">üí° Basic</option>
                            <option value="premium">‚≠ê Premium</option>
                            <option value="deluxe">üëë Deluxe</option>
                        </select>
                        <button class="btn btn-secondary" onclick="loadInventory()">üîÑ Refresh</button>
                        <button class="btn btn-primary" onclick="openModal('inventoryModal')">+ Add Item</button>
                    </div>
                </div>
                <div id="inventoryTable"></div>
            </div>
        </div>

        <!-- TECHNICIANS -->
        <div id="technicians" class="section">
            <h1 class="page-title">Technicians</h1>
            <p class="page-subtitle">Manage your team</p>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Team Members</h2>
                    <button class="btn btn-primary" onclick="openModal('techModal')">+ Add Technician</button>
                </div>
                <div id="techTable"></div>
            </div>
        </div>

        <!-- SUPPLIERS -->
        <div id="suppliers" class="section">
            <h1 class="page-title">Suppliers</h1>
            <p class="page-subtitle">Manage supplier relationships</p>

            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">All Suppliers</h2>
                    <button class="btn btn-primary" onclick="openModal('supplierModal')">+ Add Supplier</button>
                </div>
                <div id="suppliersTable"></div>
            </div>
        </div>

        <!-- ========== PEOPLE MODULE ========== -->

        <!-- PEOPLE - EMPLOYEES -->
        <div id="people-employees" class="section">
            <h1 class="page-title">üëî Employees</h1>
            <p class="page-subtitle">Manage your team members</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="employeeSearch" placeholder="Search employees..." onkeyup="searchPeople('employee')">
                    <button class="btn btn-primary" onclick="openPersonModal('employee')">+ Add Employee</button>
                </div>
                <div id="employeesTable"></div>
            </div>
        </div>

        <!-- PEOPLE - CUSTOMERS -->
        <div id="people-customers" class="section">
            <h1 class="page-title">üë• Customers</h1>
            <p class="page-subtitle">Manage your customer relationships</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="customerSearch" placeholder="Search customers..." onkeyup="searchPeople('customer')">
                    <button class="btn btn-primary" onclick="openPersonModal('customer')">+ Add Customer</button>
                </div>
                <div id="customersTableNew"></div>
            </div>
        </div>

        <!-- PEOPLE - SUPPLIERS -->
        <div id="people-suppliers" class="section">
            <h1 class="page-title">üè≠ Suppliers</h1>
            <p class="page-subtitle">Manage your supplier network</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="suppliersSearch" placeholder="Search suppliers..." onkeyup="searchPeople('supplier')">
                    <button class="btn btn-primary" onclick="openPersonModal('supplier')">+ Add Supplier</button>
                </div>
                <div id="suppliersTableNew"></div>
            </div>
        </div>

        <!-- PEOPLE - CONTRACTORS -->
        <div id="people-contractors" class="section">
            <h1 class="page-title">üîß Contractors</h1>
            <p class="page-subtitle">Manage external contractors</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="contractorSearch" placeholder="Search contractors..." onkeyup="searchPeople('contractor')">
                    <button class="btn btn-primary" onclick="openPersonModal('contractor')">+ Add Contractor</button>
                </div>
                <div id="contractorsTable"></div>
            </div>
        </div>

        <!-- PEOPLE - CONTACTS -->
        <div id="people-contacts" class="section">
            <h1 class="page-title">üìá Contacts</h1>
            <p class="page-subtitle">General contact directory</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="contactSearch" placeholder="Search contacts..." onkeyup="searchPeople('contact')">
                    <button class="btn btn-primary" onclick="openPersonModal('contact')">+ Add Contact</button>
                </div>
                <div id="contactsTable"></div>
            </div>
        </div>

        <!-- ========== JOBS MODULE ========== -->

        <!-- JOBS - IN PROGRESS -->
        <div id="jobs-in-progress" class="section">
            <h1 class="page-title">‚öôÔ∏è Jobs In Progress</h1>
            <p class="page-subtitle">Currently active jobs</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="jobsInProgressSearch" placeholder="Search jobs..." onkeyup="searchJobs('in_progress')">
                    <button class="btn btn-primary" onclick="openJobModal('in_progress')">+ Add Job</button>
                </div>
                <div id="jobsInProgressTable"></div>
            </div>
        </div>

        <!-- JOBS - UPCOMING -->
        <div id="jobs-upcoming" class="section">
            <h1 class="page-title">üìÖ Upcoming Jobs</h1>
            <p class="page-subtitle">Scheduled future jobs</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="jobsUpcomingSearch" placeholder="Search jobs..." onkeyup="searchJobs('upcoming')">
                    <button class="btn btn-primary" onclick="openJobModal('upcoming')">+ Add Job</button>
                </div>
                <div id="jobsUpcomingTable"></div>
            </div>
        </div>

        <!-- JOBS - PENDING -->
        <div id="jobs-pending" class="section">
            <h1 class="page-title">‚è∏Ô∏è Pending Jobs</h1>
            <p class="page-subtitle">Jobs awaiting approval or start</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="jobsPendingSearch" placeholder="Search jobs..." onkeyup="searchJobs('pending')">
                    <button class="btn btn-primary" onclick="openJobModal('pending')">+ Add Job</button>
                </div>
                <div id="jobsPendingTable"></div>
            </div>
        </div>

        <!-- JOBS - FINISHED -->
        <div id="jobs-finished" class="section">
            <h1 class="page-title">‚úÖ Finished Jobs</h1>
            <p class="page-subtitle">Completed jobs</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="jobsFinishedSearch" placeholder="Search jobs..." onkeyup="searchJobs('finished')">
                    <button class="btn btn-primary" onclick="openJobModal('finished')">+ Add Job</button>
                </div>
                <div id="jobsFinishedTable"></div>
            </div>
        </div>

        <!-- JOBS - RECURRING -->
        <div id="jobs-recurring" class="section">
            <h1 class="page-title">üîÑ Recurring Jobs</h1>
            <p class="page-subtitle">Repeating maintenance and service jobs</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="jobsRecurringSearch" placeholder="Search jobs..." onkeyup="searchJobs('recurring')">
                    <button class="btn btn-primary" onclick="openJobModal('recurring')">+ Add Job</button>
                </div>
                <div id="jobsRecurringTable"></div>
            </div>
        </div>

        <!-- ========== MATERIALS MODULE ========== -->

        <!-- MATERIALS - STOCK -->
        <div id="materials-stock" class="section">
            <h1 class="page-title">üì¶ Stock</h1>
            <p class="page-subtitle">Manage inventory and stock levels</p>

            <div class="card">
                <div class="card-header">
                    <div style="display: flex; gap: 10px; flex: 1;">
                        <input type="text" class="search-input" id="stockSearch" placeholder="Search stock..." onkeyup="searchMaterials('stock')" style="flex: 1;">
                        <select id="stockLocationFilter" onchange="filterMaterials('stock')" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">All Locations</option>
                            <option value="sydney">Sydney</option>
                            <option value="melbourne">Melbourne</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openMaterialModal('stock')">+ Add Stock</button>
                </div>
                <div id="stockTable"></div>
            </div>
        </div>

        <!-- MATERIALS - ORDERS -->
        <div id="materials-orders" class="section">
            <h1 class="page-title">üõí Orders</h1>
            <p class="page-subtitle">Track materials to order and incoming orders</p>

            <div class="card">
                <div class="card-header">
                    <div style="display: flex; gap: 10px; flex: 1;">
                        <input type="text" class="search-input" id="ordersSearch" placeholder="Search orders..." onkeyup="searchMaterials('order')" style="flex: 1;">
                        <select id="ordersLocationFilter" onchange="filterMaterials('order')" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">All Locations</option>
                            <option value="sydney">Sydney</option>
                            <option value="melbourne">Melbourne</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openMaterialModal('order')">+ Add Order</button>
                </div>
                <div id="ordersTable"></div>
            </div>
        </div>

        <!-- ========== PAYMENTS MODULE ========== -->

        <!-- PAYMENTS - TO SUPPLIERS -->
        <div id="payments-to-suppliers" class="section">
            <h1 class="page-title">üí∏ Payments to Suppliers</h1>
            <p class="page-subtitle">Track money we owe to suppliers</p>

            <div class="card">
                <div class="card-header">
                    <div style="display: flex; gap: 10px; flex: 1;">
                        <input type="text" class="search-input" id="paymentsToSuppliersSearch" placeholder="Search payments..." style="flex: 1;">
                        <select id="paymentsToSuppliersFilter" onchange="filterPayments('to_suppliers')" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">All Statuses</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="pending">Pending</option>
                            <option value="due">Due</option>
                            <option value="paid">Paid</option>
                            <option value="credit">Credits</option>
                            <option value="retention">Retentions</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openPaymentModal('to_suppliers')">+ Add Payment</button>
                </div>
                <div id="paymentsToSuppliersTable"></div>
            </div>
        </div>

        <!-- PAYMENTS - TO US -->
        <div id="payments-to-us" class="section">
            <h1 class="page-title">üí∞ Payments to Us</h1>
            <p class="page-subtitle">Track money owed to us by customers</p>

            <div class="card">
                <div class="card-header">
                    <div style="display: flex; gap: 10px; flex: 1;">
                        <input type="text" class="search-input" id="paymentsToUsSearch" placeholder="Search payments..." style="flex: 1;">
                        <select id="paymentsToUsFilter" onchange="filterPayments('to_us')" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="">All Statuses</option>
                            <option value="upcoming">Upcoming</option>
                            <option value="pending">Pending</option>
                            <option value="due">Due</option>
                            <option value="paid">Paid</option>
                            <option value="credit">Credits</option>
                            <option value="retention">Retentions</option>
                        </select>
                    </div>
                    <button class="btn btn-primary" onclick="openPaymentModal('to_us')">+ Add Payment</button>
                </div>
                <div id="paymentsToUsTable"></div>
            </div>
        </div>

        <!-- ========== QUOTES ENHANCED ========== -->

        <!-- QUOTES - OPEN -->
        <div id="quotes-open" class="section">
            <h1 class="page-title">üìã Open Quotes</h1>
            <p class="page-subtitle">Active quotes awaiting response</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="quotesOpenSearch" placeholder="Search quotes...">
                    <button class="btn btn-primary" onclick="openQuoteModal('open')">+ New Quote</button>
                </div>
                <div id="quotesOpenTable"></div>
            </div>
        </div>

        <!-- QUOTES - SENT -->
        <div id="quotes-sent" class="section">
            <h1 class="page-title">üì§ Sent Quotes</h1>
            <p class="page-subtitle">Quotes sent to customers</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="quotesSentSearch" placeholder="Search quotes...">
                    <button class="btn btn-primary" onclick="openQuoteModal('sent')">+ New Quote</button>
                </div>
                <div id="quotesSentTable"></div>
            </div>
        </div>

        <!-- QUOTES - EXPIRED -->
        <div id="quotes-expired" class="section">
            <h1 class="page-title">‚è∞ Expired Quotes</h1>
            <p class="page-subtitle">Quotes past their expiry date</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="quotesExpiredSearch" placeholder="Search quotes...">
                </div>
                <div id="quotesExpiredTable"></div>
            </div>
        </div>

        <!-- QUOTES - SUPPLIER -->
        <div id="quotes-supplier" class="section">
            <h1 class="page-title">üì• Supplier Quotes</h1>
            <p class="page-subtitle">Quotes received from our suppliers</p>

            <div class="card">
                <div class="card-header">
                    <input type="text" class="search-input" id="quotesSupplierSearch" placeholder="Search supplier quotes...">
                    <button class="btn btn-primary" onclick="openQuoteModal('supplier')">+ Add Supplier Quote</button>
                </div>
                <div id="quotesSupplierTable"></div>
            </div>
        </div>

        <!-- ========== SCHEDULES / CALENDAR ========== -->

        <!-- SCHEDULES - CALENDAR -->
        <div id="schedules-calendar" class="section">
            <h1 class="page-title">üìÜ Calendar & Schedules</h1>
            <p class="page-subtitle">View and manage all scheduled events</p>

            <div class="card">
                <div class="card-header" style="display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 12px;">
                    <div style="display: flex; gap: 10px; align-items: center;">
                        <select id="calendarViewMode" onchange="changeCalendarView()" style="padding: 8px; border-radius: 6px; border: 1px solid #ddd;">
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="monthly" selected>Monthly</option>
                        </select>
                        <button class="btn btn-secondary btn-small" onclick="calendarPrevious()">‚Üê</button>
                        <span id="calendarCurrentDate" style="font-weight: 600; min-width: 200px; text-align: center;">Loading...</span>
                        <button class="btn btn-secondary btn-small" onclick="calendarNext()">‚Üí</button>
                        <button class="btn btn-secondary btn-small" onclick="calendarToday()">Today</button>
                    </div>
                    <button class="btn btn-primary" onclick="openEventModal()">+ Add Event</button>
                </div>

                <!-- Calendar Grid -->
                <div id="calendarView" style="margin-top: 20px;">
                    <!-- Monthly View -->
                    <div id="monthlyCalendar" class="calendar-grid" style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: var(--border-color); border: 1px solid var(--border-color);">
                        <!-- Calendar will be rendered here by JavaScript -->
                    </div>

                    <!-- Weekly/Daily View -->
                    <div id="weeklyCalendar" style="display: none;">
                        <div id="weeklyGrid"></div>
                    </div>
                </div>

                <!-- Events List for Selected Day -->
                <div id="selectedDayEvents" style="margin-top: 24px; display: none;">
                    <h3 style="margin-bottom: 12px; font-size: 16px; font-weight: 600;">Events</h3>
                    <div id="selectedDayEventsList"></div>
                </div>
            </div>

            <!-- Google Calendar Events -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header">
                    <h2 class="card-title">Google Calendar Events</h2>
                    <div>
                        <button type="button" class="btn btn-small" onclick="loadGoogleCalendarEvents()">Refresh</button>
                        <button type="button" class="btn btn-primary btn-small" onclick="openModal('googleEventModal')">+ New Event</button>
                    </div>
                </div>
                <div id="googleCalendarEvents" style="margin-top: 16px;">
                    <div class="empty-state" style="padding: 40px;">
                        <div class="empty-icon">üìÖ</div>
                        <div class="empty-title">No events loaded</div>
                        <p>Connect your Google account in Integrations > Google Integration and click Refresh to load events</p>
                    </div>
                </div>
            </div>
        </div>


        <!-- INTEGRATIONS -->
        <div id="integrations" class="section">
            <h1 class="page-title">Integrations</h1>
            <p class="page-subtitle">Connect external services</p>

            <div class="card">
                <h2 class="card-title">Available Integrations</h2>
                <div id="integrationsGrid"></div>
            </div>
        </div>

        <!-- GOOGLE INTEGRATIONS -->
        <div id="google-integrations" class="section">
            <h1 class="page-title">Google Integration</h1>
            <p class="page-subtitle">Connect Google Calendar and Gmail</p>

            <!-- Connection Status -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2 class="card-title">Connection Status</h2>
                    <span id="googleConnectionStatus" class="status-badge status-pending">Not Connected</span>
                </div>
                <div id="googleConnectionActions" style="margin-top: 16px;">
                    <button class="btn btn-primary" onclick="connectGoogle()" id="btnConnectGoogle">Connect Google Account</button>
                    <button class="btn btn-danger" onclick="disconnectGoogle()" id="btnDisconnectGoogle" style="display: none;">Disconnect</button>
                </div>
            </div>

            <!-- API Configuration -->
            <div class="card" style="margin-bottom: 20px;">
                <div class="card-header">
                    <h2 class="card-title">API Configuration</h2>
                    <button type="button" class="btn btn-small" onclick="toggleGoogleConfig()">Configure</button>
                </div>
                <div id="googleConfigForm" style="display: none; margin-top: 16px;">
                    <p style="font-size: 12px; color: var(--text-secondary); margin-bottom: 16px;">
                        Get your credentials from <a href="https://console.cloud.google.com/apis/credentials" target="_blank" style="color: #007AFF;">Google Cloud Console</a>
                    </p>
                    <form onsubmit="saveGoogleConfig(event)">
                        <div class="form-group">
                            <label>Client ID</label>
                            <input type="text" id="googleClientId" class="form-input" placeholder="xxx.apps.googleusercontent.com">
                        </div>
                        <div class="form-group">
                            <label>Client Secret</label>
                            <input type="password" id="googleClientSecret" class="form-input" placeholder="Enter client secret">
                        </div>
                        <div class="form-group">
                            <label>Redirect URI</label>
                            <input type="text" id="googleRedirectUri" class="form-input" placeholder="https://yourapp.com/google/callback">
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="googleCalendarEnabled">
                                Enable Google Calendar
                            </label>
                        </div>
                        <div class="form-group">
                            <label style="display: flex; align-items: center; gap: 8px;">
                                <input type="checkbox" id="googleGmailEnabled">
                                Enable Gmail
                            </label>
                        </div>
                        <button type="submit" class="btn btn-primary">Save Configuration</button>
                    </form>
                </div>
            </div>

            <!-- Send Email -->
            <div class="card">
                <div class="card-header">
                    <h2 class="card-title">Send Email via Gmail</h2>
                </div>
                <form onsubmit="sendGmailEmail(event)" style="margin-top: 16px;">
                    <div class="form-group">
                        <label>To</label>
                        <input type="email" id="gmailTo" class="form-input" placeholder="recipient@email.com" required>
                    </div>
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="gmailSubject" class="form-input" placeholder="Email subject">
                    </div>
                    <div class="form-group">
                        <label>Message</label>
                        <textarea id="gmailBody" class="form-input" rows="5" placeholder="Enter your message..."></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Send Email</button>
                </form>
            </div>
        </div>

    </div>


    <!-- MODALS -->

    <!-- Google Calendar Event Modal -->
    <div id="googleEventModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2>Create Calendar Event</h2>
                <button class="modal-close" onclick="closeModal('googleEventModal')">&times;</button>
            </div>
            <form onsubmit="createGoogleCalendarEvent(event)">
                <div class="form-group">
                    <label>Event Title *</label>
                    <input type="text" id="googleEventTitle" class="form-input" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="googleEventDescription" class="form-input" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="googleEventLocation" class="form-input">
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date/Time *</label>
                        <input type="datetime-local" id="googleEventStart" class="form-input" required>
                    </div>
                    <div class="form-group">
                        <label>End Date/Time *</label>
                        <input type="datetime-local" id="googleEventEnd" class="form-input" required>
                    </div>
                </div>
                <div class="form-group">
                    <label>Attendees (comma-separated emails)</label>
                    <input type="text" id="googleEventAttendees" class="form-input" placeholder="email1@test.com, email2@test.com">
                </div>
                <div class="form-group">
                    <label>Reminder (minutes before)</label>
                    <select id="googleEventReminder" class="form-input">
                        <option value="">No reminder</option>
                        <option value="15">15 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="1440">1 day</option>
                    </select>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" onclick="closeModal('googleEventModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Create Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Customer Modal -->
    <div id="customerModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Customer</h2>
                <button class="close-btn" onclick="closeModal('customerModal')">√ó</button>
            </div>
            <form id="customerForm" onsubmit="saveCustomer(event)">
                <input type="hidden" id="customerId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="customerName" required>
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" id="customerCompany">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="customerEmail">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="customerPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="customerAddress"></textarea>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="customerNotes"></textarea>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('customerModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Customer</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Project Modal -->
    <div id="projectModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">New Project</h2>
                <button class="close-btn" onclick="closeModal('projectModal')">√ó</button>
            </div>
            <form id="projectForm" onsubmit="saveProject(event)">
                <input type="hidden" id="projectId">
                <div class="form-group">
                    <label>Customer</label>
                    <select id="projectCustomer"></select>
                </div>
                <div class="form-group">
                    <label>Project Title *</label>
                    <input type="text" id="projectTitle" required>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="projectDesc"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="projectStatus">
                            <option value="pending">Pending</option>
                            <option value="in_progress">In Progress</option>
                            <option value="completed">Completed</option>
                            <option value="on_hold">On Hold</option>
                            <option value="cancelled">Cancelled</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Priority</label>
                        <select id="projectPriority">
                            <option value="low">Low</option>
                            <option value="medium" selected>Medium</option>
                            <option value="high">High</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quote Amount</label>
                        <input type="number" id="projectQuote" step="0.01">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="projectDue">
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('projectModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Project</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Markups Modal -->
    <div id="markupsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">Project Markups</h2>
                <button class="close-btn" onclick="closeModal('markupsModal')">√ó</button>
            </div>
            <div id="markupsProjectInfo" style="margin-bottom: 20px; padding: 12px; background: var(--hover-bg); border-radius: 10px;">
                <strong id="markupsProjectTitle">Loading...</strong>
            </div>

            <!-- Add Markup Form -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Add New Markup</h3>
                <form id="addMarkupForm" onsubmit="addMarkup(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type</label>
                            <select id="markupType">
                                <option value="quote">Quote/PDF</option>
                                <option value="takeoffs">Takeoffs Session</option>
                                <option value="mapping">Electrical Mapping</option>
                                <option value="cad">CAD Drawing</option>
                                <option value="general">General File</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="markupName" placeholder="e.g., Floor Plan Rev 1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Session ID (for Takeoffs/Mapping/CAD)</label>
                            <input type="text" id="markupSessionId" placeholder="Session UUID">
                        </div>
                        <div class="form-group">
                            <label>Filename (for downloads)</label>
                            <input type="text" id="markupFilename" placeholder="e.g., quote_12345.pdf">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="markupDescription" placeholder="Optional description..." rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">+ Add Markup</button>
                </form>
            </div>

            <!-- Markups List -->
            <div id="markupsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading markups...</p>
                </div>
            </div>

            <!-- Cost Centres Section -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="margin-bottom: 16px;">
                    <h3 style="font-size: 16px; font-weight: 600;">Cost Centres</h3>
                    <button type="button" class="btn btn-primary btn-small" onclick="addProjectCostCentre()">+ Add Cost Centre</button>
                </div>

                <!-- Cost Summary Visual -->
                <div id="projectCostSummary" style="margin-bottom: 20px; padding: 16px; background: var(--hover-bg); border-radius: 10px;">
                    <div style="font-size: 24px; font-weight: 700; color: #556B2F;">$0.00</div>
                    <div style="font-size: 12px; color: var(--text-secondary);">Total Cost</div>
                </div>

                <!-- Cost Centres List -->
                <div id="projectCostCentresList"></div>
            </div>
        </div>
    </div>

    <!-- Quote Modal -->
    <div id="quoteModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <div class="modal-header">
                <h2 class="modal-title">New Quote</h2>
                <button class="close-btn" onclick="closeModal('quoteModal')">√ó</button>
            </div>
            <form id="quoteForm" onsubmit="saveQuote(event)">
                <input type="hidden" id="quoteId">
                <div class="form-row">
                    <div class="form-group">
                        <label>Quote Number</label>
                        <input type="text" id="quoteNumber" placeholder="Auto-generated if empty">
                    </div>
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="quoteCustomer"></select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="quoteTitle" required placeholder="e.g., Home Automation - Smith Residence">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="quoteDesc" placeholder="Quote details and scope of work..."></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Status</label>
                        <select id="quoteStatus">
                            <option value="draft">Draft</option>
                            <option value="sent">Sent</option>
                            <option value="accepted">Accepted</option>
                            <option value="rejected">Rejected</option>
                            <option value="expired">Expired</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Valid Until</label>
                        <input type="date" id="quoteValidUntil">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Materials Cost</label>
                        <input type="number" id="quoteMaterialsCost" step="0.01" placeholder="0.00">
                    </div>
                    <div class="form-group">
                        <label>Labor Cost</label>
                        <input type="number" id="quoteLaborCost" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Markup %</label>
                        <input type="number" id="quoteMarkupPct" step="0.1" value="20" placeholder="20">
                    </div>
                    <div class="form-group">
                        <label>Total Quote Amount</label>
                        <input type="number" id="quoteAmount" step="0.01" placeholder="0.00">
                    </div>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="quoteNotes" rows="2" placeholder="Internal notes..."></textarea>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('quoteModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Quote</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Quote Markups Modal -->
    <div id="quoteMarkupsModal" class="modal">
        <div class="modal-content" style="max-width: 900px;">
            <div class="modal-header">
                <h2 class="modal-title">Quote Attachments</h2>
                <button class="close-btn" onclick="closeModal('quoteMarkupsModal')">√ó</button>
            </div>
            <div id="quoteMarkupsInfo" style="margin-bottom: 20px; padding: 12px; background: var(--hover-bg); border-radius: 10px;">
                <strong id="quoteMarkupsTitle">Loading...</strong>
            </div>

            <!-- Add Markup Form -->
            <div class="card" style="margin-bottom: 20px;">
                <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Add Floor Plan / Attachment</h3>
                <form id="addQuoteMarkupForm" onsubmit="addQuoteMarkup(event)">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Type</label>
                            <select id="quoteMarkupType">
                                <option value="quote">Quote PDF</option>
                                <option value="takeoffs">Takeoffs Session</option>
                                <option value="mapping">Electrical Mapping</option>
                                <option value="cad">CAD Drawing</option>
                                <option value="board">Board Layout</option>
                                <option value="general">General File</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Name *</label>
                            <input type="text" id="quoteMarkupName" placeholder="e.g., Floor Plan Rev 1" required>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Session ID</label>
                            <input type="text" id="quoteMarkupSessionId" placeholder="Session UUID">
                        </div>
                        <div class="form-group">
                            <label>Filename</label>
                            <input type="text" id="quoteMarkupFilename" placeholder="e.g., quote_12345.pdf">
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="quoteMarkupDescription" placeholder="Optional description..." rows="2"></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">+ Add Attachment</button>
                </form>
            </div>

            <!-- Markups List -->
            <div id="quoteMarkupsList">
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading attachments...</p>
                </div>
            </div>

            <!-- Stock Items Section -->
            <div class="card" style="margin-top: 20px;">
                <h3 style="margin-bottom: 16px; font-size: 16px; font-weight: 600;">Linked Stock Items</h3>
                <form id="addQuoteStockForm" onsubmit="addQuoteStockItem(event)" style="margin-bottom: 16px;">
                    <div class="form-row">
                        <div class="form-group">
                            <label>Item Name</label>
                            <input type="text" id="stockItemName" placeholder="e.g., Lutron Dimmer" required>
                        </div>
                        <div class="form-group">
                            <label>Quantity</label>
                            <input type="number" id="stockItemQty" value="1" min="1" required>
                        </div>
                        <div class="form-group">
                            <label>Unit Price</label>
                            <input type="number" id="stockItemPrice" step="0.01" placeholder="0.00" required>
                        </div>
                        <div class="form-group" style="display: flex; align-items: flex-end;">
                            <button type="submit" class="btn btn-secondary btn-small">+ Add Item</button>
                        </div>
                    </div>
                </form>
                <div id="quoteStockItemsList"></div>
            </div>

            <!-- Cost Centres Section -->
            <div class="card" style="margin-top: 20px;">
                <div class="card-header" style="margin-bottom: 16px;">
                    <h3 style="font-size: 16px; font-weight: 600;">Cost Centres</h3>
                    <button type="button" class="btn btn-primary btn-small" onclick="addQuoteCostCentre()">+ Add Cost Centre</button>
                </div>

                <!-- Cost Summary Visual -->
                <div id="quoteCostSummary" style="margin-bottom: 20px; padding: 16px; background: var(--hover-bg); border-radius: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <div style="font-size: 24px; font-weight: 700; color: #556B2F;" id="quoteCostTotal">$0.00</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">Total from Cost Centres</div>
                        </div>
                        <div id="quoteCostBreakdown" style="display: flex; gap: 8px; flex-wrap: wrap;"></div>
                    </div>
                </div>

                <!-- Cost Centres List -->
                <div id="quoteCostCentresList"></div>
            </div>
        </div>
    </div>

    <!-- Event Modal -->
    <div id="eventModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h2 class="modal-title">Schedule Event</h2>
                <button class="close-btn" onclick="closeModal('eventModal')">√ó</button>
            </div>
            <form id="eventForm" onsubmit="saveCalendarEvent(event)">
                <input type="hidden" id="eventId">
                <div class="form-group">
                    <label>Title *</label>
                    <input type="text" id="eventTitle" required>
                </div>
                <div class="form-group">
                    <label>Type</label>
                    <select id="eventType">
                        <option value="event">Event</option>
                        <option value="job">Job</option>
                        <option value="meeting">Meeting</option>
                        <option value="reminder">Reminder</option>
                    </select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date *</label>
                        <input type="date" id="eventStartDate" required>
                    </div>
                    <div class="form-group">
                        <label>Start Time</label>
                        <input type="time" id="eventStartTime">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>End Date</label>
                        <input type="date" id="eventEndDate">
                    </div>
                    <div class="form-group">
                        <label>End Time</label>
                        <input type="time" id="eventEndTime">
                    </div>
                </div>
                <div class="form-group">
                    <label style="display: flex; align-items: center; gap: 8px;">
                        <input type="checkbox" id="eventAllDay">
                        All Day Event
                    </label>
                </div>
                <div class="form-group">
                    <label>Recurrence</label>
                    <select id="eventRecurrence">
                        <option value="none">None</option>
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="fortnightly">Fortnightly</option>
                        <option value="monthly">Monthly</option>
                        <option value="annually">Annually</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="eventLocation" placeholder="Meeting room, job site, etc.">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="eventDescription" rows="3"></textarea>
                </div>

                <!-- LINKING SECTION -->
                <div style="border-top: 2px solid var(--border-color); padding-top: 16px; margin-top: 16px; margin-bottom: 16px;">
                    <h3 style="font-size: 16px; font-weight: 600; margin-bottom: 12px; color: var(--text-primary);">üîó Link to Records</h3>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Link to Job</label>
                            <select id="eventLinkedJob">
                                <option value="">-- No Job Linked --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Link to Quote</label>
                            <select id="eventLinkedQuote">
                                <option value="">-- No Quote Linked --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label>Link to Customer</label>
                            <select id="eventLinkedCustomer">
                                <option value="">-- No Customer Linked --</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Link to Project</label>
                            <select id="eventLinkedProject">
                                <option value="">-- No Project Linked --</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>Link to Person</label>
                        <select id="eventLinkedPerson">
                            <option value="">-- No Person Linked --</option>
                        </select>
                    </div>
                </div>

                <div class="form-row">
                    <div class="form-group">
                        <label>Color</label>
                        <input type="color" id="eventColor" value="#3b82f6">
                    </div>
                    <div class="form-group">
                        <label>Reminder (minutes before)</label>
                        <input type="number" id="eventReminder" min="0" value="0" placeholder="0">
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('eventModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save Event</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Technician Modal -->
    <div id="techModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Technician</h2>
                <button class="close-btn" onclick="closeModal('techModal')">√ó</button>
            </div>
            <form id="techForm" onsubmit="saveTechnician(event)">
                <input type="hidden" id="techId">
                <div class="form-group">
                    <label>Name *</label>
                    <input type="text" id="techName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="techEmail">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="techPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>Skills (comma-separated)</label>
                    <input type="text" id="techSkills" placeholder="e.g. electrical, networking, security">
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('techModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Inventory Modal -->
    <div id="inventoryModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Inventory Item</h2>
                <button class="close-btn" onclick="closeModal('inventoryModal')">√ó</button>
            </div>
            <form id="inventoryForm" onsubmit="saveInventory(event)">
                <input type="hidden" id="invId">
                <div class="form-group">
                    <label>Item Name *</label>
                    <input type="text" id="invName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>SKU</label>
                        <input type="text" id="invSKU">
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <select id="invCategory">
                            <option value="lighting">Lighting</option>
                            <option value="security">Security</option>
                            <option value="climate">Climate</option>
                            <option value="audio">Audio</option>
                            <option value="other">Other</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="invQty" value="0">
                    </div>
                    <div class="form-group">
                        <label>Unit Cost</label>
                        <input type="number" id="invCost" step="0.01">
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('inventoryModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Supplier Modal -->
    <div id="supplierModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Supplier</h2>
                <button class="close-btn" onclick="closeModal('supplierModal')">√ó</button>
            </div>
            <form id="supplierForm" onsubmit="saveSupplier(event)">
                <input type="hidden" id="supplierId">
                <div class="form-group">
                    <label>Company Name *</label>
                    <input type="text" id="supplierName" required>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="supplierEmail">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="supplierPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>Website</label>
                    <input type="text" id="supplierWeb">
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('supplierModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Communication Modal -->
    <div id="commModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title">Add Communication</h2>
                <button class="close-btn" onclick="closeModal('commModal')">√ó</button>
            </div>
            <form id="commForm" onsubmit="saveComm(event)">
                <input type="hidden" id="commId">
                <div class="form-group">
                    <label>Customer</label>
                    <select id="commCustomer"></select>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Type</label>
                        <select id="commType">
                            <option value="note">Note</option>
                            <option value="email">Email</option>
                            <option value="call">Phone Call</option>
                            <option value="meeting">Meeting</option>
                            <option value="sms">SMS</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Subject</label>
                        <input type="text" id="commSubject">
                    </div>
                </div>
                <div class="form-group">
                    <label>Content</label>
                    <textarea id="commContent"></textarea>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('commModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- ========== NEW MODALS FOR EXTENDED CRM ========== -->

    <!-- Person Modal (for all people types) -->
    <div id="personModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="personModalTitle">Add Person</h2>
                <button class="close-btn" onclick="closeModal('personModal')">√ó</button>
            </div>
            <form id="personForm" onsubmit="savePerson(event)">
                <input type="hidden" id="personId">
                <input type="hidden" id="personType">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="personName" required>
                    </div>
                    <div class="form-group">
                        <label>Company</label>
                        <input type="text" id="personCompany">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Email</label>
                        <input type="email" id="personEmail">
                    </div>
                    <div class="form-group">
                        <label>Phone</label>
                        <input type="tel" id="personPhone">
                    </div>
                </div>
                <div class="form-group">
                    <label>Address</label>
                    <textarea id="personAddress" rows="2"></textarea>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="personNotes" rows="3"></textarea>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('personModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Job Modal -->
    <div id="jobModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="jobModalTitle">Add Job</h2>
                <button class="close-btn" onclick="closeModal('jobModal')">√ó</button>
            </div>
            <form id="jobForm" onsubmit="saveJob(event)">
                <input type="hidden" id="jobId">
                <input type="hidden" id="jobStatus">
                <div class="form-row">
                    <div class="form-group">
                        <label>Job Name *</label>
                        <input type="text" id="jobName" required>
                    </div>
                    <div class="form-group">
                        <label>Customer</label>
                        <select id="jobCustomer">
                            <option value="">Select Customer</option>
                        </select>
                    </div>
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="jobDescription" rows="3"></textarea>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Start Date</label>
                        <input type="date" id="jobStartDate">
                    </div>
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="jobDueDate">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Value ($)</label>
                        <input type="number" id="jobValue" step="0.01" min="0">
                    </div>
                    <div class="form-group">
                        <label>Recurring Schedule</label>
                        <select id="jobRecurring">
                            <option value="">None</option>
                            <option value="daily">Daily</option>
                            <option value="weekly">Weekly</option>
                            <option value="fortnightly">Fortnightly</option>
                            <option value="monthly">Monthly</option>
                            <option value="quarterly">Quarterly</option>
                            <option value="yearly">Yearly</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('jobModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Material Modal -->
    <div id="materialModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="materialModalTitle">Add Material</h2>
                <button class="close-btn" onclick="closeModal('materialModal')">√ó</button>
            </div>
            <form id="materialForm" onsubmit="saveMaterial(event)">
                <input type="hidden" id="materialId">
                <input type="hidden" id="materialType">
                <div class="form-row">
                    <div class="form-group">
                        <label>Name *</label>
                        <input type="text" id="materialName" required>
                    </div>
                    <div class="form-group">
                        <label>Category</label>
                        <input type="text" id="materialCategory" placeholder="e.g., Lighting, Switches">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Location *</label>
                        <select id="materialLocation" required>
                            <option value="sydney">Sydney</option>
                            <option value="melbourne">Melbourne</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>Quantity</label>
                        <input type="number" id="materialQuantity" min="0" value="0">
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Unit Price ($)</label>
                        <input type="number" id="materialPrice" step="0.01" min="0" value="0">
                    </div>
                    <div class="form-group">
                        <label>Supplier</label>
                        <select id="materialSupplier">
                            <option value="">Select Supplier</option>
                        </select>
                    </div>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('materialModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Payment Modal -->
    <div id="paymentModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h2 class="modal-title" id="paymentModalTitle">Add Payment</h2>
                <button class="close-btn" onclick="closeModal('paymentModal')">√ó</button>
            </div>
            <form id="paymentForm" onsubmit="savePayment(event)">
                <input type="hidden" id="paymentId">
                <input type="hidden" id="paymentDirection">
                <div class="form-row">
                    <div class="form-group">
                        <label>Amount ($) *</label>
                        <input type="number" id="paymentAmount" step="0.01" min="0" required>
                    </div>
                    <div class="form-group">
                        <label>Status *</label>
                        <select id="paymentStatus" required>
                            <option value="upcoming">Upcoming</option>
                            <option value="pending">Pending</option>
                            <option value="due">Due</option>
                            <option value="paid">Paid</option>
                            <option value="credit">Credit</option>
                            <option value="retention">Retention</option>
                        </select>
                    </div>
                </div>
                <div class="form-row">
                    <div class="form-group">
                        <label>Due Date</label>
                        <input type="date" id="paymentDueDate">
                    </div>
                    <div class="form-group">
                        <label>Paid Date</label>
                        <input type="date" id="paymentPaidDate">
                    </div>
                </div>
                <div class="form-group">
                    <label id="paymentPersonLabel">Person</label>
                    <select id="paymentPerson">
                        <option value="">Select Person</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Notes</label>
                    <textarea id="paymentNotes" rows="3"></textarea>
                </div>
                <div class="flex gap-2 mt-3">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('paymentModal')">Cancel</button>
                    <button type="submit" class="btn btn-primary">Save</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Floorplan Viewer Modal -->
    <div id="floorplanViewerModal" class="modal">
        <div class="modal-content" style="max-width: 1200px; max-height: 90vh; overflow-y: auto;">
            <div class="modal-header">
                <h2 class="modal-title" id="floorplanViewerTitle">Quote Floorplan</h2>
                <button class="close-btn" onclick="closeModal('floorplanViewerModal')">√ó</button>
            </div>
            <div style="padding: 24px;">
                <p id="floorplanViewerDescription" style="color: var(--text-secondary); margin-bottom: 20px;"></p>

                <!-- Floorplan Image -->
                <div style="background: var(--bg-primary); border-radius: 12px; padding: 20px; margin-bottom: 20px; text-align: center;">
                    <img id="floorplanViewerImage" alt="Floorplan" style="max-width: 100%; height: auto; border-radius: 8px; box-shadow: 0 4px 12px rgba(0,0,0,0.1);">
                </div>

                <!-- Components List -->
                <div id="floorplanComponentsList" style="display: none;">
                    <h3 style="color: var(--text-primary); margin-bottom: 16px; font-size: 18px; font-weight: 600;">
                        Components & Pricing
                    </h3>
                    <div id="floorplanComponents" style="max-height: 400px; overflow-y: auto;">
                        <!-- Components will be populated here -->
                    </div>
                </div>

                <!-- Actions -->
                <div style="margin-top: 24px; display: flex; justify-content: flex-end; gap: 12px;">
                    <button class="btn btn-secondary" onclick="closeModal('floorplanViewerModal')">Close</button>
                    <button class="btn btn-primary" onclick="downloadFloorplanFromModal()">
                        <svg style="width: 18px; height: 18px; display: inline-block; margin-right: 6px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/>
                        </svg>
                        Download Floorplan
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // STATE
        let customers = [];
        let projects = [];
        let quotes = [];
        let calendar = [];
        let technicians = [];
        let inventory = [];
        let suppliers = [];
        let communications = [];

        // INIT
        console.log('CRM Script Block 1: Loaded');
        document.addEventListener('DOMContentLoaded', function() {
            console.log('CRM: DOM Content Loaded - Initializing...');
            setupNavigation();
            loadAllData();

            // Check for imported data from Quote Automation
            checkForImportedData();
            console.log('CRM: Initialization complete');
        });

        // Handle imported data from Quote Automation
        function checkForImportedData() {
            const urlParams = new URLSearchParams(window.location.search);
            if (urlParams.get('import') === 'true') {
                const importData = sessionStorage.getItem('import_data');
                const exportType = sessionStorage.getItem('crm_export_type') || urlParams.get('type');

                if (importData) {
                    try {
                        const data = JSON.parse(importData);
                        processImportedData(data, exportType);

                        // Clear session storage after successful import
                        sessionStorage.removeItem('import_data');
                        sessionStorage.removeItem('import_source');
                        sessionStorage.removeItem('crm_export_type');
                    } catch (e) {
                        console.error('Error processing imported data:', e);
                        showToast('Error importing data', 'error');
                    }
                }
            }
        }

        function processImportedData(data, exportType) {
            console.log('Imported data:', data);
            console.log('Export type:', exportType);

            // Show import notification
            const typeLabels = {
                'stock': 'Stock',
                'projects': 'Projects',
                'inventory': 'Inventory'
            };

            showToast(`Data imported from Quote Automation to ${typeLabels[exportType] || 'CRM'}`, 'success');

            // Process based on export type
            if (exportType === 'projects' && data.project) {
                // Navigate to projects section and highlight the project
                showSection('projects');
                setTimeout(() => {
                    showToast(`Materials added to project: ${data.project.name}`, 'info');
                }, 500);
            } else if (exportType === 'stock') {
                // Navigate to inventory/stock section
                showSection('inventory');
                setTimeout(() => {
                    showToast(`${data.components ? data.components.length : 0} items added to stock`, 'info');
                }, 500);
            } else if (exportType === 'inventory') {
                showSection('inventory');
                setTimeout(() => {
                    showToast(`Inventory updated with ${data.components ? data.components.length : 0} items`, 'info');
                }, 500);
            }

            // Log imported components for debugging
            if (data.components && data.components.length > 0) {
                console.log('Imported components:', data.components);
                console.log('Total value:', data.updated_grand_total || 'N/A');
            }
        }

        function showToast(message, type = 'info') {
            // Create toast element
            const toast = document.createElement('div');

            // Set background color based on type
            let bgColor, textColor;
            if (type === 'success') {
                bgColor = '#10b981';
                textColor = '#ffffff';
            } else if (type === 'error') {
                bgColor = '#ef4444';
                textColor = '#ffffff';
            } else if (type === 'warning') {
                bgColor = '#f59e0b';
                textColor = '#ffffff';
            } else {
                bgColor = '#3b82f6';
                textColor = '#ffffff';
            }

            // Apply inline styles
            toast.style.cssText = `
                position: fixed;
                top: 20px;
                right: 20px;
                z-index: 9999;
                padding: 16px 24px;
                border-radius: 8px;
                box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
                background-color: ${bgColor};
                color: ${textColor};
                font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
                font-size: 14px;
                font-weight: 500;
                transition: opacity 0.3s ease;
            `;
            toast.textContent = message;
            document.body.appendChild(toast);

            // Auto remove after 4 seconds
            setTimeout(() => {
                toast.style.opacity = '0';
                setTimeout(() => toast.remove(), 300);
            }, 4000);
        }

        // NAVIGATION
        function setupNavigation() {
            document.querySelectorAll('.nav-item').forEach(item => {
                item.addEventListener('click', function() {
                    const section = this.getAttribute('data-section');
                    showSection(section);
                });
            });

            // Setup collapsible menu (for mobile)
            document.querySelectorAll('.nav-section-title').forEach(title => {
                title.addEventListener('click', function() {
                    // On mobile, toggle the collapsed state on click
                    if (window.innerWidth <= 768) {
                        this.classList.toggle('collapsed');
                        const items = this.nextElementSibling;
                        if (items && items.classList.contains('nav-section-items')) {
                            items.classList.toggle('collapsed');
                        }
                    }
                });
            });
        }

        function showSection(sectionId) {
            // Update nav
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelector(`[data-section="${sectionId}"]`).classList.add('active');
            
            // Update content
            document.querySelectorAll('.section').forEach(section => section.classList.remove('active'));
            document.getElementById(sectionId).classList.add('active');
        }

        // LOAD DATA
        async function loadAllData() {
            await Promise.all([
                loadStats(),
                loadCustomers(),
                loadProjects(),
                loadQuotes(),
                loadCalendar(),
                loadTechnicians(),
                loadInventory(),
                loadSuppliers(),
                loadCommunications(),
                loadIntegrations()
            ]);
        }

        async function loadStats() {
            try {
                const res = await fetch('/api/crm/stats');
                const data = await res.json();
                if (data.success) {
                    document.getElementById('statCustomers').textContent = data.stats.customers.total;
                    document.getElementById('statProjects').textContent = data.stats.projects.total;
                    document.getElementById('statActive').textContent = data.stats.projects.active;
                    document.getElementById('statRevenue').textContent = '$' + data.stats.revenue.total.toLocaleString();
                    document.getElementById('statPending').textContent = '$' + data.stats.revenue.pending.toLocaleString();
                    // Show stock value instead of just low stock count
                    const stockValue = data.stats.stock ? data.stats.stock.total_value : 0;
                    document.getElementById('statStock').textContent = '$' + stockValue.toLocaleString();

                    // Initialize charts with data
                    initializeCharts(data.stats);
                }
            } catch (e) {
                console.error('Stats error:', e);
            }
        }

        // Chart instances
        let revenueChart, projectStatusChart, monthlyRevenueChart, customerGrowthChart;

        function initializeCharts(stats) {
            try {
                // Check if Chart.js is loaded
                if (typeof Chart === 'undefined') {
                    console.warn('Chart.js not loaded yet, skipping chart initialization');
                    return;
                }

                // Check if current theme is dark
                const isDark = document.documentElement.getAttribute('data-theme') === 'dark';
                const textColor = isDark ? '#e0e0e0' : '#1d1d1f';
                const gridColor = isDark ? '#3a3a3a' : '#d2d2d7';

                // Revenue Overview (Doughnut)
                const revenueCtx = document.getElementById('revenueChart');
                if (!revenueCtx) return;
                if (revenueChart) revenueChart.destroy();
                revenueChart = new Chart(revenueCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Completed Revenue', 'Pending Revenue'],
                    datasets: [{
                        data: [stats.revenue.total - stats.revenue.pending, stats.revenue.pending],
                        backgroundColor: ['#556B2F', '#6B8E23'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, font: { size: 12 } }
                        }
                    }
                }
            });

            // Project Status (Bar)
            const projectCtx = document.getElementById('projectStatusChart');
            if (!projectCtx) return;
            if (projectStatusChart) projectStatusChart.destroy();
            projectStatusChart = new Chart(projectCtx, {
                type: 'bar',
                data: {
                    labels: ['Active', 'Pending', 'Completed'],
                    datasets: [{
                        label: 'Projects',
                        data: [stats.projects.active, stats.projects.pending || 0, stats.projects.completed || 0],
                        backgroundColor: ['#556B2F', '#6B8E23', '#8FBC8F'],
                        borderWidth: 0
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: { color: textColor, stepSize: 1 },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Monthly Revenue Trend (Line)
            const months = ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'];
            const monthlyData = months.map((m, i) => Math.floor(stats.revenue.total / 6 * (0.8 + Math.random() * 0.4)));
            const monthlyCtx = document.getElementById('monthlyRevenueChart');
            if (!monthlyCtx) return;
            if (monthlyRevenueChart) monthlyRevenueChart.destroy();
            monthlyRevenueChart = new Chart(monthlyCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Revenue',
                        data: monthlyData,
                        borderColor: '#556B2F',
                        backgroundColor: 'rgba(85, 107, 47, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor,
                                callback: function(value) { return '$' + value.toLocaleString(); }
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Customer Growth (Line)
            const customerData = months.map((m, i) => Math.floor(stats.customers.total / 6 * (i + 1)));
            const customerCtx = document.getElementById('customerGrowthChart');
            if (!customerCtx) return;
            if (customerGrowthChart) customerGrowthChart.destroy();
            customerGrowthChart = new Chart(customerCtx, {
                type: 'line',
                data: {
                    labels: months,
                    datasets: [{
                        label: 'Customers',
                        data: customerData,
                        borderColor: '#6B8E23',
                        backgroundColor: 'rgba(107, 142, 35, 0.1)',
                        fill: true,
                        tension: 0.4
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: true,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                color: textColor,
                                stepSize: Math.ceil(stats.customers.total / 5)
                            },
                            grid: { color: gridColor }
                        },
                        x: {
                            ticks: { color: textColor },
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });
            } catch (e) {
                console.error('Chart initialization error:', e);
            }
        }

        async function loadCustomers() {
            try {
                document.getElementById('customersLoading').style.display = 'block';
                const res = await fetch('/api/crm/customers');
                const data = await res.json();
                if (data.success) {
                    customers = data.customers;
                    window.allCustomers = customers; // Store globally for event linking
                    renderCustomers();
                    populateCustomerDropdowns();
                }
            } catch (e) {
                console.error('Customers error:', e);
            } finally {
                document.getElementById('customersLoading').style.display = 'none';
            }
        }

        function renderCustomers() {
            const container = document.getElementById('customersTable');
            if (customers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë•</div>
                        <div class="empty-title">No customers yet</div>
                        <p>Add your first customer to get started</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Company</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Projects</th>
                                <th>Revenue</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${customers.map(c => `
                                <tr>
                                    <td><strong>${c.name}</strong></td>
                                    <td>${c.company || '-'}</td>
                                    <td>${c.email || '-'}</td>
                                    <td>${c.phone || '-'}</td>
                                    <td>${c.total_projects || 0}</td>
                                    <td>$${(c.total_revenue || 0).toLocaleString()}</td>
                                    <td>
                                        <button class="btn btn-secondary btn-small" onclick="editCustomer('${c.id}')">Edit</button>
                                        <button class="btn btn-danger btn-small" onclick="deleteCustomer('${c.id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        function searchCustomers() {
            const search = document.getElementById('customerSearch').value.toLowerCase();
            const filtered = search ? customers.filter(c =>
                c.name.toLowerCase().includes(search) ||
                (c.email && c.email.toLowerCase().includes(search))
            ) : customers;
            
            const temp = customers;
            customers = filtered;
            renderCustomers();
            customers = temp;
        }

        async function saveCustomer(e) {
            e.preventDefault();
            const id = document.getElementById('customerId').value;
            const data = {
                name: document.getElementById('customerName').value,
                company: document.getElementById('customerCompany').value,
                email: document.getElementById('customerEmail').value,
                phone: document.getElementById('customerPhone').value,
                address: document.getElementById('customerAddress').value,
                notes: document.getElementById('customerNotes').value
            };

            try {
                const url = id ? `/api/crm/customers/${id}` : '/api/crm/customers';
                const res = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal('customerModal');
                    loadCustomers();
                    loadStats();
                    alert('Customer saved!');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editCustomer(id) {
            const c = customers.find(x => x.id === id);
            if (c) {
                document.getElementById('customerId').value = c.id;
                document.getElementById('customerName').value = c.name;
                document.getElementById('customerCompany').value = c.company || '';
                document.getElementById('customerEmail').value = c.email || '';
                document.getElementById('customerPhone').value = c.phone || '';
                document.getElementById('customerAddress').value = c.address || '';
                document.getElementById('customerNotes').value = c.notes || '';
                openModal('customerModal');
            }
        }

        async function deleteCustomer(id) {
            if (!confirm('Delete this customer?')) return;
            try {
                await fetch(`/api/crm/customers/${id}`, {method: 'DELETE'});
                loadCustomers();
                loadStats();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadProjects() {
            try {
                const res = await fetch('/api/crm/projects');
                const data = await res.json();
                if (data.success) {
                    projects = data.projects;
                    window.allProjects = projects; // Store globally for event linking
                    renderProjects();
                }
            } catch (e) {
                console.error('Projects error:', e);
            }
        }

        function renderProjects() {
            const container = document.getElementById('projectsTable');
            if (projects.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÅ</div>
                        <div class="empty-title">No projects yet</div>
                        <p>Create your first project</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Customer</th>
                                <th>Status</th>
                                <th>Priority</th>
                                <th>Quote</th>
                                <th>Markups</th>
                                <th>Due Date</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${projects.map(p => {
                                const customer = customers.find(c => c.id === p.customer_id);
                                const markupCount = (p.markups || []).length;
                                return `
                                    <tr>
                                        <td><strong>${p.title}</strong></td>
                                        <td>${customer ? customer.name : '-'}</td>
                                        <td><span class="status-badge status-${p.status}">${p.status}</span></td>
                                        <td>${p.priority}</td>
                                        <td>$${(p.quote_amount || 0).toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-small" onclick="openMarkupsModal('${p.id}')" style="display: flex; align-items: center; gap: 6px;">
                                                <span>üìé</span> ${markupCount} ${markupCount === 1 ? 'Markup' : 'Markups'}
                                            </button>
                                        </td>
                                        <td>${p.due_date || '-'}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-small" onclick="editProject('${p.id}')">Edit</button>
                                            <button class="btn btn-danger btn-small" onclick="deleteProject('${p.id}')">Delete</button>
                                            ${p.takeoffs_session_id ? `<button class="btn btn-primary btn-small" onclick="window.location.href='/takeoffs/${p.takeoffs_session_id}'">üìê Takeoffs</button>` : ''}
                                            ${p.mapping_session_id ? `<button class="btn btn-primary btn-small" onclick="window.location.href='/mapping?session=${p.mapping_session_id}'">‚ö° Mapping</button>` : ''}
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function saveProject(e) {
            e.preventDefault();
            const id = document.getElementById('projectId').value;
            const data = {
                customer_id: document.getElementById('projectCustomer').value,
                title: document.getElementById('projectTitle').value,
                description: document.getElementById('projectDesc').value,
                status: document.getElementById('projectStatus').value,
                priority: document.getElementById('projectPriority').value,
                quote_amount: parseFloat(document.getElementById('projectQuote').value) || 0,
                due_date: document.getElementById('projectDue').value
            };

            try {
                const url = id ? `/api/crm/projects/${id}` : '/api/crm/projects';
                const res = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal('projectModal');
                    loadProjects();
                    loadStats();
                    loadCustomers();
                    alert('Project saved!');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editProject(id) {
            const p = projects.find(x => x.id === id);
            if (p) {
                document.getElementById('projectId').value = p.id;
                document.getElementById('projectCustomer').value = p.customer_id || '';
                document.getElementById('projectTitle').value = p.title;
                document.getElementById('projectDesc').value = p.description || '';
                document.getElementById('projectStatus').value = p.status;
                document.getElementById('projectPriority').value = p.priority;
                document.getElementById('projectQuote').value = p.quote_amount || '';
                document.getElementById('projectDue').value = p.due_date || '';
                openModal('projectModal');
            }
        }

        async function deleteProject(id) {
            if (!confirm('Delete this project?')) return;
            try {
                await fetch(`/api/crm/projects/${id}`, {method: 'DELETE'});
                loadProjects();
                loadStats();
                loadCustomers();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ==================== MARKUPS MANAGEMENT ====================
        let currentMarkupsProjectId = null;

        async function openMarkupsModal(projectId) {
            currentMarkupsProjectId = projectId;
            const project = projects.find(p => p.id === projectId);

            if (project) {
                document.getElementById('markupsProjectTitle').textContent = project.title;
            }

            // Reset form
            document.getElementById('addMarkupForm').reset();

            openModal('markupsModal');
            await loadMarkups(projectId);
            await loadProjectCostCentres(projectId);
        }

        async function loadMarkups(projectId) {
            const container = document.getElementById('markupsList');
            container.innerHTML = `<div class="loading"><div class="spinner"></div><p>Loading markups...</p></div>`;

            try {
                const res = await fetch(`/api/crm/projects/${projectId}/markups`);
                const data = await res.json();

                if (data.success) {
                    renderMarkups(data.markups);
                } else {
                    container.innerHTML = `<div class="empty-state"><p>Error loading markups: ${data.error}</p></div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="empty-state"><p>Error: ${e.message}</p></div>`;
            }
        }

        function renderMarkups(markups) {
            const container = document.getElementById('markupsList');

            if (!markups || markups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <div class="empty-icon">üìé</div>
                        <div class="empty-title">No markups yet</div>
                        <p>Add floor plans, quotes, and other documents to this project</p>
                    </div>
                `;
                return;
            }

            const typeIcons = {
                'quote': 'üìÑ',
                'takeoffs': 'üìê',
                'mapping': '‚ö°',
                'cad': 'üìè',
                'general': 'üìé'
            };

            const typeLabels = {
                'quote': 'Quote/PDF',
                'takeoffs': 'Takeoffs',
                'mapping': 'Electrical Mapping',
                'cad': 'CAD Drawing',
                'general': 'General'
            };

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Type</th>
                                <th>Name</th>
                                <th>Description</th>
                                <th>Created</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${markups.map(m => `
                                <tr>
                                    <td>
                                        <span style="font-size: 18px;">${typeIcons[m.type] || 'üìé'}</span>
                                        <span style="font-size: 12px; color: #666;">${typeLabels[m.type] || m.type}</span>
                                    </td>
                                    <td><strong>${m.name}</strong></td>
                                    <td style="font-size: 13px; color: #666; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                                        ${m.description || '-'}
                                    </td>
                                    <td style="font-size: 12px; color: #666;">
                                        ${new Date(m.created_at).toLocaleDateString()}
                                    </td>
                                    <td>
                                        <button class="btn btn-primary btn-small" onclick="openMarkup('${m.id}')" title="Open in module">
                                            Open
                                        </button>
                                        <button class="btn btn-danger btn-small" onclick="deleteMarkup('${m.id}')" title="Remove markup">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function addMarkup(e) {
            e.preventDefault();

            if (!currentMarkupsProjectId) {
                alert('No project selected');
                return;
            }

            const data = {
                type: document.getElementById('markupType').value,
                name: document.getElementById('markupName').value,
                session_id: document.getElementById('markupSessionId').value || '',
                filename: document.getElementById('markupFilename').value || '',
                description: document.getElementById('markupDescription').value || ''
            };

            try {
                const res = await fetch(`/api/crm/projects/${currentMarkupsProjectId}/markups`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });

                const result = await res.json();

                if (result.success) {
                    // Reset form
                    document.getElementById('addMarkupForm').reset();

                    // Reload markups
                    await loadMarkups(currentMarkupsProjectId);

                    // Update project in local array and re-render table
                    if (result.project) {
                        const idx = projects.findIndex(p => p.id === currentMarkupsProjectId);
                        if (idx !== -1) {
                            projects[idx] = result.project;
                            renderProjects();
                        }
                    }

                    alert('Markup added successfully!');
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteMarkup(markupId) {
            if (!confirm('Delete this markup?')) return;

            try {
                const res = await fetch(`/api/crm/projects/${currentMarkupsProjectId}/markups/${markupId}`, {
                    method: 'DELETE'
                });

                const result = await res.json();

                if (result.success) {
                    await loadMarkups(currentMarkupsProjectId);

                    // Reload projects to update markup count
                    await loadProjects();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function openMarkup(markupId) {
            try {
                const res = await fetch(`/api/crm/projects/${currentMarkupsProjectId}/markups/${markupId}/open`);
                const data = await res.json();

                if (data.success && data.url) {
                    // Open in new tab for downloads, same window for sessions
                    if (data.type === 'quote' || data.type === 'general') {
                        window.open(data.url, '_blank');
                    } else {
                        window.location.href = data.url;
                    }
                } else {
                    alert('Cannot open this markup. Make sure it has a valid session ID or filename.');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ==================== QUOTES MANAGEMENT ====================
        let currentQuoteId = null;

        async function loadQuotes() {
            try {
                const res = await fetch('/api/crm/quotes');
                const data = await res.json();
                if (data.success) {
                    quotes = data.quotes;
                    window.allQuotes = quotes; // Store globally for event linking
                    renderQuotes();
                    populateQuoteCustomerSelect();
                }
            } catch (e) {
                console.error('Quotes error:', e);
            }
        }

        function populateQuoteCustomerSelect() {
            const select = document.getElementById('quoteCustomer');
            if (select) {
                select.innerHTML = '<option value="">Select Customer</option>' +
                    customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
            }
        }

        function filterQuotes() {
            const status = document.getElementById('quoteStatusFilter').value;
            renderQuotes(status);
        }

        function renderQuotes(statusFilter = '') {
            const container = document.getElementById('quotesTable');
            let filteredQuotes = quotes;

            if (statusFilter) {
                filteredQuotes = quotes.filter(q => q.status === statusFilter);
            }

            if (filteredQuotes.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìã</div>
                        <div class="empty-title">No quotes yet</div>
                        <p>Create your first quote</p>
                    </div>
                `;
                return;
            }

            const statusColors = {
                'draft': 'status-pending',
                'sent': 'status-in-progress',
                'accepted': 'status-completed',
                'rejected': 'status-cancelled',
                'expired': 'status-on-hold'
            };

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Quote #</th>
                                <th>Title</th>
                                <th>Floorplan</th>
                                <th>Customer</th>
                                <th>Status</th>
                                <th>Amount</th>
                                <th>Attachments</th>
                                <th>Valid Until</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${filteredQuotes.map(q => {
                                const customer = customers.find(c => c.id === q.customer_id);
                                const markupCount = (q.markups || []).length;
                                const stockCount = (q.stock_items || []).length;
                                const hasFloorplan = q.floorplan_image || q.source === 'quote-automation';
                                return `
                                    <tr>
                                        <td><strong>${q.quote_number || '-'}</strong></td>
                                        <td>
                                            ${q.title}
                                            ${q.source === 'quote-automation' ? '<span style="font-size: 10px; background: linear-gradient(135deg, #14b8a6, #0d9488); color: white; padding: 2px 6px; border-radius: 4px; margin-left: 6px; font-weight: 600;">AI</span>' : ''}
                                        </td>
                                        <td style="text-align: center;">
                                            ${hasFloorplan ? `
                                                <button onclick="viewQuoteFloorplan('${q.id}')" style="border: none; background: none; cursor: pointer; padding: 0;" title="View floorplan">
                                                    <img src="${q.floorplan_image}" alt="Floorplan preview" style="width: 60px; height: 60px; object-fit: cover; border-radius: 8px; border: 2px solid var(--border-color); transition: transform 0.2s;" onmouseover="this.style.transform='scale(1.1)'" onmouseout="this.style.transform='scale(1)'">
                                                </button>
                                            ` : '<span style="color: #999;">-</span>'}
                                        </td>
                                        <td>${customer ? customer.name : '-'}</td>
                                        <td><span class="status-badge ${statusColors[q.status] || ''}">${q.status}</span></td>
                                        <td>$${(q.quote_amount || q.total_amount || 0).toLocaleString()}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-small" onclick="openQuoteMarkupsModal('${q.id}')" style="display: flex; align-items: center; gap: 6px;">
                                                <span>üìé</span> ${markupCount} / ${stockCount} items
                                            </button>
                                        </td>
                                        <td>${q.valid_until || '-'}</td>
                                        <td style="white-space: nowrap;">
                                            <button class="btn btn-secondary btn-small" onclick="editQuote('${q.id}')">Edit</button>
                                            ${q.status !== 'accepted' ? `<button class="btn btn-primary btn-small" onclick="convertToProject('${q.id}')" title="Convert to Project">Convert</button>` : ''}
                                            ${q.converted_to_project_id ? `<button class="btn btn-primary btn-small" onclick="goToProject('${q.converted_to_project_id}')">View Project</button>` : ''}
                                            <button class="btn btn-danger btn-small" onclick="deleteQuote('${q.id}')">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function saveQuote(e) {
            e.preventDefault();
            const id = document.getElementById('quoteId').value;
            const data = {
                quote_number: document.getElementById('quoteNumber').value,
                customer_id: document.getElementById('quoteCustomer').value,
                title: document.getElementById('quoteTitle').value,
                description: document.getElementById('quoteDesc').value,
                status: document.getElementById('quoteStatus').value,
                valid_until: document.getElementById('quoteValidUntil').value,
                materials_cost: parseFloat(document.getElementById('quoteMaterialsCost').value) || 0,
                labor_cost: parseFloat(document.getElementById('quoteLaborCost').value) || 0,
                markup_percentage: parseFloat(document.getElementById('quoteMarkupPct').value) || 20,
                quote_amount: parseFloat(document.getElementById('quoteAmount').value) || 0,
                notes: document.getElementById('quoteNotes').value
            };

            try {
                const url = id ? `/api/crm/quotes/${id}` : '/api/crm/quotes';
                const res = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal('quoteModal');
                    loadQuotes();
                    loadStats();
                    alert('Quote saved!');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editQuote(id) {
            const q = quotes.find(x => x.id === id);
            if (q) {
                document.getElementById('quoteId').value = q.id;
                document.getElementById('quoteNumber').value = q.quote_number || '';
                document.getElementById('quoteCustomer').value = q.customer_id || '';
                document.getElementById('quoteTitle').value = q.title;
                document.getElementById('quoteDesc').value = q.description || '';
                document.getElementById('quoteStatus').value = q.status;
                document.getElementById('quoteValidUntil').value = q.valid_until || '';
                document.getElementById('quoteMaterialsCost').value = q.materials_cost || '';
                document.getElementById('quoteLaborCost').value = q.labor_cost || '';
                document.getElementById('quoteMarkupPct').value = q.markup_percentage || 20;
                document.getElementById('quoteAmount').value = q.quote_amount || '';
                document.getElementById('quoteNotes').value = q.notes || '';
                openModal('quoteModal');
            }
        }

        async function deleteQuote(id) {
            if (!confirm('Delete this quote?')) return;
            try {
                await fetch(`/api/crm/quotes/${id}`, {method: 'DELETE'});
                loadQuotes();
                loadStats();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function viewQuoteFloorplan(quoteId) {
            // Find the quote
            const quote = quotes.find(q => q.id === quoteId);
            if (!quote) {
                alert('Quote not found');
                return;
            }

            if (!quote.floorplan_image) {
                alert('This quote does not have a floorplan');
                return;
            }

            // Populate modal with quote details
            const modal = document.getElementById('floorplanViewerModal');
            document.getElementById('floorplanViewerTitle').textContent = quote.title || 'Quote Floorplan';
            document.getElementById('floorplanViewerDescription').textContent = quote.description || '';
            document.getElementById('floorplanViewerImage').src = quote.floorplan_image;

            // Display components if available
            const componentsContainer = document.getElementById('floorplanComponentsList');
            if (quote.components && quote.components.length > 0) {
                componentsContainer.style.display = 'block';
                const componentsList = document.getElementById('floorplanComponents');
                componentsList.innerHTML = quote.components.map(comp => {
                    const totalPrice = comp.totalPrice || 0;
                    const componentsDetails = (comp.components || []).map(c =>
                        `${c.name} (${c.quantity}x @ $${c.price})`
                    ).join(', ');
                    return `
                        <div style="padding: 12px; background: var(--card-bg); border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600; color: var(--text-primary); margin-bottom: 4px;">
                                ${comp.type || 'Component'} - ${comp.room || 'Unknown Room'}
                            </div>
                            <div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 4px;">
                                ${componentsDetails}
                            </div>
                            <div style="font-weight: 600; color: var(--primary-color);">
                                Total: $${totalPrice.toFixed(2)}
                            </div>
                        </div>
                    `;
                }).join('');
            } else {
                componentsContainer.style.display = 'none';
            }

            // Open the modal
            openModal('floorplanViewerModal');
        }

        function downloadFloorplanFromModal() {
            const img = document.getElementById('floorplanViewerImage');
            const title = document.getElementById('floorplanViewerTitle').textContent;

            if (!img.src) {
                alert('No floorplan to download');
                return;
            }

            // Create a temporary link to download the image
            const link = document.createElement('a');
            link.href = img.src;
            link.download = `${title.replace(/[^a-z0-9]/gi, '_')}_floorplan.png`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        function openQuoteModal(status = 'draft') {
            // Reset form for new quote
            document.getElementById('quoteId').value = '';
            document.getElementById('quoteNumber').value = '';
            document.getElementById('quoteCustomer').value = '';
            document.getElementById('quoteTitle').value = '';
            document.getElementById('quoteDesc').value = '';
            document.getElementById('quoteStatus').value = status;
            document.getElementById('quoteValidUntil').value = '';
            document.getElementById('quoteMaterialsCost').value = '';
            document.getElementById('quoteLaborCost').value = '';
            document.getElementById('quoteMarkupPct').value = '20';
            document.getElementById('quoteAmount').value = '';
            document.getElementById('quoteNotes').value = '';

            // Update modal title based on status
            const statusLabels = {
                'open': 'New Quote (Open)',
                'sent': 'New Quote (Sent)',
                'supplier': 'New Supplier Quote',
                'draft': 'New Quote'
            };
            document.querySelector('#quoteModal h2').textContent = statusLabels[status] || 'New Quote';

            openModal('quoteModal');
        }

        function openPersonModal(type) {
            document.getElementById('personId').value = '';
            document.getElementById('personType').value = type;
            document.getElementById('personName').value = '';
            document.getElementById('personCompany').value = '';
            document.getElementById('personEmail').value = '';
            document.getElementById('personPhone').value = '';
            document.getElementById('personAddress').value = '';
            document.getElementById('personNotes').value = '';

            const labels = {
                'employee': 'Employee',
                'customer': 'Customer',
                'supplier': 'Supplier',
                'contractor': 'Contractor',
                'contact': 'Contact'
            };
            document.querySelector('#personModal h2').textContent = `Add ${labels[type]}`;
            openModal('personModal');
        }

        function openJobModal(status) {
            document.getElementById('jobId').value = '';
            document.getElementById('jobStatus').value = status;
            document.getElementById('jobName').value = '';
            document.getElementById('jobCustomer').value = '';
            document.getElementById('jobDescription').value = '';
            document.getElementById('jobStartDate').value = '';
            document.getElementById('jobDueDate').value = '';
            document.getElementById('jobValue').value = '';
            document.getElementById('jobRecurring').value = '';

            const labels = {
                'in_progress': 'In Progress Job',
                'upcoming': 'Upcoming Job',
                'pending': 'Pending Job',
                'finished': 'Finished Job',
                'recurring': 'Recurring Job'
            };
            document.querySelector('#jobModal h2').textContent = `Add ${labels[status]}`;

            // Show/hide recurring schedule field
            const recurringField = document.querySelector('#jobRecurring').closest('.form-group');
            if (recurringField) {
                recurringField.style.display = status === 'recurring' ? 'block' : 'none';
            }

            openModal('jobModal');
        }

        function openMaterialModal(type) {
            document.getElementById('materialId').value = '';
            document.getElementById('materialType').value = type;
            document.getElementById('materialName').value = '';
            document.getElementById('materialCategory').value = '';
            document.getElementById('materialQuantity').value = '';
            // materialUnit doesn't exist in the HTML form
            // document.getElementById('materialCost') should be materialPrice
            if (document.getElementById('materialPrice')) {
                document.getElementById('materialPrice').value = '';
            }
            document.getElementById('materialSupplier').value = '';
            // materialNotes doesn't exist in the HTML form

            const labels = {
                'stock': 'Stock Item',
                'order': 'Order Item'
            };
            document.querySelector('#materialModal h2').textContent = `Add ${labels[type]}`;
            openModal('materialModal');
        }

        function openPaymentModal(direction) {
            document.getElementById('paymentId').value = '';
            document.getElementById('paymentDirection').value = direction;
            document.getElementById('paymentAmount').value = '';
            // paymentMethod doesn't exist in HTML
            // paymentDate doesn't exist, they have paymentPaidDate
            if (document.getElementById('paymentPaidDate')) {
                document.getElementById('paymentPaidDate').value = '';
            }
            document.getElementById('paymentDueDate').value = '';
            document.getElementById('paymentStatus').value = 'pending';
            // paymentReference doesn't exist
            if (document.getElementById('paymentNotes')) {
                document.getElementById('paymentNotes').value = '';
            }

            const labels = {
                'to_suppliers': 'Payment to Supplier',
                'to_us': 'Payment to Us'
            };
            document.querySelector('#paymentModal h2').textContent = `Add ${labels[direction]}`;
            openModal('paymentModal');
        }

        function openEventModal(date = null) {
            document.getElementById('eventId').value = '';
            document.getElementById('eventTitle').value = '';
            document.getElementById('eventType').value = 'meeting';
            document.getElementById('eventStartDate').value = date || new Date().toISOString().split('T')[0];
            document.getElementById('eventStartTime').value = '';
            document.getElementById('eventEndDate').value = date || new Date().toISOString().split('T')[0];
            document.getElementById('eventEndTime').value = '';
            document.getElementById('eventAllDay').checked = false;
            document.getElementById('eventRecurrence').value = 'none';
            document.getElementById('eventLocation').value = '';
            document.getElementById('eventDescription').value = '';
            document.getElementById('eventColor').value = '#3b82f6';
            document.getElementById('eventReminder').value = '30';

            // Reset linking dropdowns
            if (document.getElementById('eventLinkedJob')) document.getElementById('eventLinkedJob').value = '';
            if (document.getElementById('eventLinkedQuote')) document.getElementById('eventLinkedQuote').value = '';
            if (document.getElementById('eventLinkedCustomer')) document.getElementById('eventLinkedCustomer').value = '';
            if (document.getElementById('eventLinkedProject')) document.getElementById('eventLinkedProject').value = '';
            if (document.getElementById('eventLinkedPerson')) document.getElementById('eventLinkedPerson').value = '';

            // Populate linking dropdowns
            populateEventLinkingDropdowns();

            document.querySelector('#eventModal h2').textContent = 'Add Event';
            openModal('eventModal');
        }

        async function convertToProject(quoteId) {
            if (!confirm('Convert this quote to a project? This will mark the quote as accepted.')) return;
            try {
                const res = await fetch(`/api/crm/quotes/${quoteId}/convert-to-project`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'}
                });
                const result = await res.json();
                if (result.success) {
                    alert('Quote converted to project successfully!');
                    loadQuotes();
                    loadProjects();
                    loadStats();
                } else {
                    alert('Error: ' + result.error);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function goToProject(projectId) {
            showSection('projects');
            // Highlight the project row
            setTimeout(() => {
                const row = document.querySelector(`tr[data-project-id="${projectId}"]`);
                if (row) row.scrollIntoView({behavior: 'smooth'});
            }, 100);
        }

        // Quote Markups Management
        async function openQuoteMarkupsModal(quoteId) {
            currentQuoteId = quoteId;
            const quote = quotes.find(q => q.id === quoteId);

            if (quote) {
                document.getElementById('quoteMarkupsTitle').textContent = `${quote.quote_number || 'Quote'}: ${quote.title}`;
            }

            document.getElementById('addQuoteMarkupForm').reset();
            document.getElementById('addQuoteStockForm').reset();

            openModal('quoteMarkupsModal');
            await loadQuoteMarkups(quoteId);
            await loadQuoteStockItems(quoteId);
            await loadQuoteCostCentres(quoteId);
        }

        async function loadQuoteMarkups(quoteId) {
            const container = document.getElementById('quoteMarkupsList');
            container.innerHTML = `<div class="loading"><div class="spinner"></div><p>Loading...</p></div>`;

            try {
                const res = await fetch(`/api/crm/quotes/${quoteId}/markups`);
                const data = await res.json();

                if (data.success) {
                    renderQuoteMarkups(data.markups);
                } else {
                    container.innerHTML = `<div class="empty-state"><p>Error: ${data.error}</p></div>`;
                }
            } catch (e) {
                container.innerHTML = `<div class="empty-state"><p>Error: ${e.message}</p></div>`;
            }
        }

        function renderQuoteMarkups(markups) {
            const container = document.getElementById('quoteMarkupsList');

            if (!markups || markups.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 20px;">
                        <p>No attachments yet</p>
                    </div>
                `;
                return;
            }

            const typeIcons = {
                'quote': 'üìÑ', 'takeoffs': 'üìê', 'mapping': '‚ö°',
                'cad': 'üìè', 'board': 'üî≤', 'general': 'üìé'
            };

            container.innerHTML = `
                <table style="width: 100%;">
                    <thead>
                        <tr><th>Type</th><th>Name</th><th>Actions</th></tr>
                    </thead>
                    <tbody>
                        ${markups.map(m => `
                            <tr>
                                <td>${typeIcons[m.type] || 'üìé'} ${m.type}</td>
                                <td>${m.name}</td>
                                <td>
                                    <button class="btn btn-primary btn-small" onclick="openQuoteMarkup('${m.id}')">Open</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteQuoteMarkup('${m.id}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        async function addQuoteMarkup(e) {
            e.preventDefault();
            if (!currentQuoteId) return;

            const data = {
                type: document.getElementById('quoteMarkupType').value,
                name: document.getElementById('quoteMarkupName').value,
                session_id: document.getElementById('quoteMarkupSessionId').value || '',
                filename: document.getElementById('quoteMarkupFilename').value || '',
                description: document.getElementById('quoteMarkupDescription').value || ''
            };

            try {
                const res = await fetch(`/api/crm/quotes/${currentQuoteId}/markups`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    document.getElementById('addQuoteMarkupForm').reset();
                    await loadQuoteMarkups(currentQuoteId);
                    loadQuotes();
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteQuoteMarkup(markupId) {
            if (!confirm('Delete this attachment?')) return;
            try {
                await fetch(`/api/crm/quotes/${currentQuoteId}/markups/${markupId}`, {method: 'DELETE'});
                await loadQuoteMarkups(currentQuoteId);
                loadQuotes();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function openQuoteMarkup(markupId) {
            try {
                const res = await fetch(`/api/crm/quotes/${currentQuoteId}/markups/${markupId}/open`);
                const data = await res.json();
                if (data.success && data.url) {
                    if (data.type === 'quote' || data.type === 'general') {
                        window.open(data.url, '_blank');
                    } else {
                        window.location.href = data.url;
                    }
                } else {
                    alert('Cannot open this attachment.');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Quote Stock Items Management
        async function loadQuoteStockItems(quoteId) {
            const container = document.getElementById('quoteStockItemsList');
            try {
                const res = await fetch(`/api/crm/quotes/${quoteId}/stock-items`);
                const data = await res.json();
                if (data.success) {
                    renderQuoteStockItems(data.stock_items);
                }
            } catch (e) {
                container.innerHTML = `<p>Error loading stock items</p>`;
            }
        }

        function renderQuoteStockItems(items) {
            const container = document.getElementById('quoteStockItemsList');
            if (!items || items.length === 0) {
                container.innerHTML = `<p style="color: #666; font-size: 13px;">No stock items linked</p>`;
                return;
            }

            const total = items.reduce((sum, i) => sum + (i.total_price || 0), 0);

            container.innerHTML = `
                <table style="width: 100%; font-size: 13px;">
                    <thead>
                        <tr><th>Item</th><th>Qty</th><th>Unit $</th><th>Total</th><th></th></tr>
                    </thead>
                    <tbody>
                        ${items.map(i => `
                            <tr>
                                <td>${i.name}</td>
                                <td>${i.quantity}</td>
                                <td>$${(i.unit_price || 0).toFixed(2)}</td>
                                <td>$${(i.total_price || 0).toFixed(2)}</td>
                                <td><button class="btn btn-danger btn-small" onclick="deleteQuoteStockItem('${i.id}')" style="padding: 4px 8px; font-size: 11px;">X</button></td>
                            </tr>
                        `).join('')}
                        <tr style="font-weight: bold; border-top: 2px solid #333;">
                            <td colspan="3">Total Materials</td>
                            <td>$${total.toFixed(2)}</td>
                            <td></td>
                        </tr>
                    </tbody>
                </table>
            `;
        }

        async function addQuoteStockItem(e) {
            e.preventDefault();
            if (!currentQuoteId) return;

            const data = {
                name: document.getElementById('stockItemName').value,
                quantity: parseInt(document.getElementById('stockItemQty').value) || 1,
                unit_price: parseFloat(document.getElementById('stockItemPrice').value) || 0
            };

            try {
                const res = await fetch(`/api/crm/quotes/${currentQuoteId}/stock-items`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    document.getElementById('addQuoteStockForm').reset();
                    await loadQuoteStockItems(currentQuoteId);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteQuoteStockItem(itemId) {
            try {
                await fetch(`/api/crm/quotes/${currentQuoteId}/stock-items/${itemId}`, {method: 'DELETE'});
                await loadQuoteStockItems(currentQuoteId);
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // ==================== COST CENTRES MANAGEMENT ====================

        // Project Cost Centres
        async function loadProjectCostCentres(projectId) {
            const container = document.getElementById('projectCostCentresList');
            const summary = document.getElementById('projectCostSummary');

            try {
                const res = await fetch(`/api/crm/projects/${projectId}/cost-centres`);
                const data = await res.json();

                if (data.success) {
                    renderProjectCostCentres(data.cost_centres);
                    summary.innerHTML = `
                        <div style="font-size: 24px; font-weight: 700; color: #556B2F;">$${data.total.toLocaleString(undefined, {minimumFractionDigits: 2})}</div>
                        <div style="font-size: 12px; color: #666;">Total Cost</div>
                        ${data.cost_centres.length > 0 ? `
                            <div style="margin-top: 12px; display: flex; gap: 8px; flex-wrap: wrap;">
                                ${data.cost_centres.map(cc => `
                                    <div style="padding: 4px 8px; border-radius: 4px; font-size: 11px; background: ${cc.color}20; color: ${cc.color}; border: 1px solid ${cc.color};">
                                        ${cc.name}: $${cc.subtotal.toLocaleString()}
                                    </div>
                                `).join('')}
                            </div>
                        ` : ''}
                    `;
                }
            } catch (e) {
                container.innerHTML = `<p>Error loading cost centres</p>`;
            }
        }

        function renderProjectCostCentres(costCentres) {
            const container = document.getElementById('projectCostCentresList');

            if (!costCentres || costCentres.length === 0) {
                container.innerHTML = `<p style="color: #666; font-size: 13px; text-align: center; padding: 20px;">No cost centres yet. Add one to organize your costs.</p>`;
                return;
            }

            container.innerHTML = costCentres.map(cc => `
                <div style="border: 2px solid ${cc.color}; border-radius: 10px; margin-bottom: 16px; overflow: hidden;">
                    <div style="background: ${cc.color}20; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: ${cc.color};">${cc.name}</strong>
                            ${cc.description ? `<span style="font-size: 12px; color: #666; margin-left: 8px;">${cc.description}</span>` : ''}
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600;">$${cc.subtotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                            <button class="btn btn-danger btn-small" onclick="deleteProjectCostCentre('${cc.id}')" style="padding: 4px 8px; font-size: 11px;">X</button>
                        </div>
                    </div>
                    <div style="padding: 12px;">
                        <!-- Add Item Form -->
                        <form onsubmit="addProjectCostCentreItem(event, '${cc.id}')" style="margin-bottom: 12px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <input type="text" placeholder="Item name" required style="flex: 2; min-width: 150px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <input type="number" placeholder="Qty" value="1" min="1" required style="width: 60px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <input type="number" placeholder="Unit $" step="0.01" required style="width: 80px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <button type="submit" class="btn btn-primary btn-small" style="padding: 6px 12px; font-size: 11px;">Add</button>
                            </div>
                        </form>
                        <!-- Items List -->
                        ${cc.items.length > 0 ? `
                            <table style="width: 100%; font-size: 12px;">
                                <thead>
                                    <tr style="background: var(--hover-bg);">
                                        <th style="padding: 6px; text-align: left;">Item</th>
                                        <th style="padding: 6px; text-align: center;">Qty</th>
                                        <th style="padding: 6px; text-align: right;">Unit $</th>
                                        <th style="padding: 6px; text-align: right;">Total</th>
                                        <th style="padding: 6px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cc.items.map(item => `
                                        <tr>
                                            <td style="padding: 6px;">${item.name}</td>
                                            <td style="padding: 6px; text-align: center;">${item.quantity}</td>
                                            <td style="padding: 6px; text-align: right;">$${item.unit_price.toFixed(2)}</td>
                                            <td style="padding: 6px; text-align: right; font-weight: 600;">$${item.total.toFixed(2)}</td>
                                            <td style="padding: 6px; text-align: center;">
                                                <button onclick="deleteProjectCostCentreItem('${cc.id}', '${item.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 10px;">X</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="font-size: 11px; color: #999; text-align: center;">No items yet</p>'}
                    </div>
                </div>
            `).join('');
        }

        async function addProjectCostCentre() {
            const name = prompt('Enter cost centre name (e.g., Lighting, Security, Labor):');
            if (!name) return;

            try {
                const res = await fetch(`/api/crm/projects/${currentMarkupsProjectId}/cost-centres`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });
                const result = await res.json();
                if (result.success) {
                    await loadProjectCostCentres(currentMarkupsProjectId);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteProjectCostCentre(centreId) {
            if (!confirm('Delete this cost centre and all its items?')) return;
            try {
                await fetch(`/api/crm/projects/${currentMarkupsProjectId}/cost-centres/${centreId}`, {method: 'DELETE'});
                await loadProjectCostCentres(currentMarkupsProjectId);
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function addProjectCostCentreItem(e, centreId) {
            e.preventDefault();
            const form = e.target;
            const inputs = form.querySelectorAll('input');

            const data = {
                name: inputs[0].value,
                quantity: parseInt(inputs[1].value) || 1,
                unit_price: parseFloat(inputs[2].value) || 0
            };

            try {
                const res = await fetch(`/api/crm/projects/${currentMarkupsProjectId}/cost-centres/${centreId}/items`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    form.reset();
                    inputs[1].value = '1';
                    await loadProjectCostCentres(currentMarkupsProjectId);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteProjectCostCentreItem(centreId, itemId) {
            try {
                await fetch(`/api/crm/projects/${currentMarkupsProjectId}/cost-centres/${centreId}/items/${itemId}`, {method: 'DELETE'});
                await loadProjectCostCentres(currentMarkupsProjectId);
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        // Quote Cost Centres
        async function loadQuoteCostCentres(quoteId) {
            const container = document.getElementById('quoteCostCentresList');

            try {
                const res = await fetch(`/api/crm/quotes/${quoteId}/cost-centres`);
                const data = await res.json();

                if (data.success) {
                    renderQuoteCostCentres(data.cost_centres);
                    document.getElementById('quoteCostTotal').textContent = `$${data.total.toLocaleString(undefined, {minimumFractionDigits: 2})}`;

                    // Update breakdown
                    const breakdown = document.getElementById('quoteCostBreakdown');
                    breakdown.innerHTML = data.cost_centres.map(cc => `
                        <div style="padding: 4px 8px; border-radius: 4px; font-size: 10px; background: ${cc.color}20; color: ${cc.color}; border: 1px solid ${cc.color};">
                            ${cc.name}: $${cc.subtotal.toLocaleString()}
                        </div>
                    `).join('');
                }
            } catch (e) {
                container.innerHTML = `<p>Error loading cost centres</p>`;
            }
        }

        function renderQuoteCostCentres(costCentres) {
            const container = document.getElementById('quoteCostCentresList');

            if (!costCentres || costCentres.length === 0) {
                container.innerHTML = `<p style="color: #666; font-size: 13px; text-align: center; padding: 20px;">No cost centres yet. Add one to organize your quote.</p>`;
                return;
            }

            container.innerHTML = costCentres.map(cc => `
                <div style="border: 2px solid ${cc.color}; border-radius: 10px; margin-bottom: 16px; overflow: hidden;">
                    <div style="background: ${cc.color}20; padding: 12px 16px; display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <strong style="color: ${cc.color};">${cc.name}</strong>
                        </div>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span style="font-weight: 600;">$${cc.subtotal.toLocaleString(undefined, {minimumFractionDigits: 2})}</span>
                            <button class="btn btn-danger btn-small" onclick="deleteQuoteCostCentre('${cc.id}')" style="padding: 4px 8px; font-size: 11px;">X</button>
                        </div>
                    </div>
                    <div style="padding: 12px;">
                        <form onsubmit="addQuoteCostCentreItem(event, '${cc.id}')" style="margin-bottom: 12px;">
                            <div style="display: flex; gap: 8px; flex-wrap: wrap;">
                                <input type="text" placeholder="Item name" required style="flex: 2; min-width: 150px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <input type="number" placeholder="Qty" value="1" min="1" required style="width: 60px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <input type="number" placeholder="Unit $" step="0.01" required style="width: 80px; padding: 6px 10px; border: 1px solid #ddd; border-radius: 6px; font-size: 12px;">
                                <button type="submit" class="btn btn-primary btn-small" style="padding: 6px 12px; font-size: 11px;">Add</button>
                            </div>
                        </form>
                        ${cc.items.length > 0 ? `
                            <table style="width: 100%; font-size: 12px;">
                                <thead>
                                    <tr style="background: var(--hover-bg);">
                                        <th style="padding: 6px; text-align: left;">Item</th>
                                        <th style="padding: 6px; text-align: center;">Qty</th>
                                        <th style="padding: 6px; text-align: right;">Unit $</th>
                                        <th style="padding: 6px; text-align: right;">Total</th>
                                        <th style="padding: 6px;"></th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${cc.items.map(item => `
                                        <tr>
                                            <td style="padding: 6px;">${item.name}</td>
                                            <td style="padding: 6px; text-align: center;">${item.quantity}</td>
                                            <td style="padding: 6px; text-align: right;">$${item.unit_price.toFixed(2)}</td>
                                            <td style="padding: 6px; text-align: right; font-weight: 600;">$${item.total.toFixed(2)}</td>
                                            <td style="padding: 6px; text-align: center;">
                                                <button onclick="deleteQuoteCostCentreItem('${cc.id}', '${item.id}')" style="background: #dc3545; color: white; border: none; padding: 2px 6px; border-radius: 4px; cursor: pointer; font-size: 10px;">X</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        ` : '<p style="font-size: 11px; color: #999; text-align: center;">No items yet</p>'}
                    </div>
                </div>
            `).join('');
        }

        async function addQuoteCostCentre() {
            const name = prompt('Enter cost centre name (e.g., Lighting, Security, Labor):');
            if (!name) return;

            try {
                const res = await fetch(`/api/crm/quotes/${currentQuoteId}/cost-centres`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name})
                });
                const result = await res.json();
                if (result.success) {
                    await loadQuoteCostCentres(currentQuoteId);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteQuoteCostCentre(centreId) {
            if (!confirm('Delete this cost centre and all its items?')) return;
            try {
                await fetch(`/api/crm/quotes/${currentQuoteId}/cost-centres/${centreId}`, {method: 'DELETE'});
                await loadQuoteCostCentres(currentQuoteId);
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function addQuoteCostCentreItem(e, centreId) {
            e.preventDefault();
            const form = e.target;
            const inputs = form.querySelectorAll('input');

            const data = {
                name: inputs[0].value,
                quantity: parseInt(inputs[1].value) || 1,
                unit_price: parseFloat(inputs[2].value) || 0
            };

            try {
                const res = await fetch(`/api/crm/quotes/${currentQuoteId}/cost-centres/${centreId}/items`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    form.reset();
                    inputs[1].value = '1';
                    await loadQuoteCostCentres(currentQuoteId);
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function deleteQuoteCostCentreItem(centreId, itemId) {
            try {
                await fetch(`/api/crm/quotes/${currentQuoteId}/cost-centres/${centreId}/items/${itemId}`, {method: 'DELETE'});
                await loadQuoteCostCentres(currentQuoteId);
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadCalendar() {
            try {
                const res = await fetch('/api/crm/calendar');
                const data = await res.json();
                if (data.success) {
                    calendar = data.events;
                    renderCalendar();
                }
            } catch (e) {
                console.error('Calendar error:', e);
            }
        }

        function renderCalendar() {
            const container = document.getElementById('calendarTable');
            if (calendar.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üìÖ</div>
                        <div class="empty-title">No events scheduled</div>
                        <p>Schedule your first event</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Title</th>
                                <th>Date</th>
                                <th>Time</th>
                                <th>Type</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${calendar.map(e => `
                                <tr>
                                    <td><strong>${e.title}</strong></td>
                                    <td>${e.date}</td>
                                    <td>${e.time}</td>
                                    <td>${e.type}</td>
                                    <td><span class="status-badge status-${e.status}">${e.status}</span></td>
                                    <td>
                                        <button class="btn btn-secondary btn-small" onclick="editEvent('${e.id}')">Edit</button>
                                        <button class="btn btn-danger btn-small" onclick="deleteEvent('${e.id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function saveEvent(e) {
            e.preventDefault();
            const id = document.getElementById('eventId').value;
            const data = {
                title: document.getElementById('eventTitle').value,
                date: document.getElementById('eventDate').value,
                time: document.getElementById('eventTime').value,
                type: document.getElementById('eventType').value,
                description: document.getElementById('eventDesc').value
            };

            try {
                const url = id ? `/api/crm/calendar/${id}` : '/api/crm/calendar';
                const res = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal('eventModal');
                    loadCalendar();
                    loadStats();
                    document.getElementById('eventForm').reset();
                    alert('Event saved!');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editEvent(id) {
            const evt = calendar.find(x => x.id === id);
            if (evt) {
                document.getElementById('eventId').value = evt.id;
                document.getElementById('eventTitle').value = evt.title;
                document.getElementById('eventDate').value = evt.date;
                document.getElementById('eventTime').value = evt.time;
                document.getElementById('eventType').value = evt.type;
                document.getElementById('eventDesc').value = evt.description || '';
                openModal('eventModal');
            }
        }

        async function deleteEvent(id) {
            if (!confirm('Delete this event?')) return;
            try {
                await fetch(`/api/crm/calendar/${id}`, {method: 'DELETE'});
                loadCalendar();
                loadStats();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadTechnicians() {
            try {
                const res = await fetch('/api/crm/technicians');
                const data = await res.json();
                if (data.success) {
                    technicians = data.technicians;
                    renderTechnicians();
                }
            } catch (e) {
                console.error('Technicians error:', e);
            }
        }

        function renderTechnicians() {
            const container = document.getElementById('techTable');
            if (technicians.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üë∑</div>
                        <div class="empty-title">No technicians yet</div>
                        <p>Add your first team member</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Skills</th>
                                <th>Status</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${technicians.map(t => `
                                <tr>
                                    <td><strong>${t.name}</strong></td>
                                    <td>${t.email || '-'}</td>
                                    <td>${t.phone || '-'}</td>
                                    <td>${(t.skills || []).join(', ')}</td>
                                    <td><span class="status-badge status-${t.status}">${t.status}</span></td>
                                    <td>
                                        <button class="btn btn-secondary btn-small" onclick="editTechnician('${t.id}')">Edit</button>
                                        <button class="btn btn-danger btn-small" onclick="deleteTechnician('${t.id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function saveTechnician(e) {
            e.preventDefault();
            const id = document.getElementById('techId').value;
            const skills = document.getElementById('techSkills').value.split(',').map(s => s.trim()).filter(Boolean);
            const data = {
                name: document.getElementById('techName').value,
                email: document.getElementById('techEmail').value,
                phone: document.getElementById('techPhone').value,
                skills: skills
            };

            try {
                const url = id ? `/api/crm/technicians/${id}` : '/api/crm/technicians';
                const res = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal('techModal');
                    loadTechnicians();
                    document.getElementById('techForm').reset();
                    alert('Technician saved!');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editTechnician(id) {
            const tech = technicians.find(x => x.id === id);
            if (tech) {
                document.getElementById('techId').value = tech.id;
                document.getElementById('techName').value = tech.name;
                document.getElementById('techEmail').value = tech.email || '';
                document.getElementById('techPhone').value = tech.phone || '';
                document.getElementById('techSkills').value = (tech.skills || []).join(', ');
                openModal('techModal');
            }
        }

        async function deleteTechnician(id) {
            if (!confirm('Delete this technician?')) return;
            try {
                await fetch(`/api/crm/technicians/${id}`, {method: 'DELETE'});
                loadTechnicians();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadInventory() {
            try {
                const res = await fetch('/api/crm/inventory');
                const data = await res.json();
                if (data.success) {
                    inventory = data.inventory;
                    renderInventory();
                }
            } catch (e) {
                console.error('Inventory error:', e);
            }
        }

        function renderInventory() {
            const container = document.getElementById('inventoryTable');
            if (inventory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üì¶</div>
                        <div class="empty-title">No inventory yet</div>
                        <p>Add your first item</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>SKU</th>
                                <th>Category</th>
                                <th>Quantity</th>
                                <th>Unit Cost</th>
                                <th>Total Value</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${inventory.map(i => `
                                <tr>
                                    <td><strong>${i.name}</strong></td>
                                    <td>${i.sku || '-'}</td>
                                    <td>${i.category}</td>
                                    <td>${i.quantity || 0}</td>
                                    <td>$${(i.unit_cost || 0).toFixed(2)}</td>
                                    <td>$${((i.quantity || 0) * (i.unit_cost || 0)).toFixed(2)}</td>
                                    <td>
                                        <button class="btn btn-secondary btn-small" onclick="editInventory('${i.id}')">Edit</button>
                                        <button class="btn btn-danger btn-small" onclick="deleteInventory('${i.id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function saveInventory(e) {
            e.preventDefault();
            const id = document.getElementById('invId').value;
            const data = {
                name: document.getElementById('invName').value,
                sku: document.getElementById('invSKU').value,
                category: document.getElementById('invCategory').value,
                quantity: parseInt(document.getElementById('invQty').value) || 0,
                unit_cost: parseFloat(document.getElementById('invCost').value) || 0
            };

            try {
                const url = id ? `/api/crm/inventory/${id}` : '/api/crm/inventory';
                const res = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal('inventoryModal');
                    loadInventory();
                    loadStats();
                    document.getElementById('inventoryForm').reset();
                    alert('Item saved!');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editInventory(id) {
            const item = inventory.find(x => x.id === id);
            if (item) {
                document.getElementById('invId').value = item.id;
                document.getElementById('invName').value = item.name;
                document.getElementById('invSKU').value = item.sku || '';
                document.getElementById('invCategory').value = item.category;
                document.getElementById('invQty').value = item.quantity || 0;
                document.getElementById('invCost').value = item.unit_cost || 0;
                openModal('inventoryModal');
            }
        }

        async function deleteInventory(id) {
            if (!confirm('Delete this inventory item?')) return;
            try {
                await fetch(`/api/crm/inventory/${id}`, {method: 'DELETE'});
                loadInventory();
                loadStats();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadSuppliers() {
            try {
                const res = await fetch('/api/crm/suppliers');
                const data = await res.json();
                if (data.success) {
                    suppliers = data.suppliers;
                    renderSuppliers();
                }
            } catch (e) {
                console.error('Suppliers error:', e);
            }
        }

        function renderSuppliers() {
            const container = document.getElementById('suppliersTable');
            if (suppliers.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üè≠</div>
                        <div class="empty-title">No suppliers yet</div>
                        <p>Add your first supplier</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Company</th>
                                <th>Email</th>
                                <th>Phone</th>
                                <th>Website</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${suppliers.map(s => `
                                <tr>
                                    <td><strong>${s.name}</strong></td>
                                    <td>${s.email || '-'}</td>
                                    <td>${s.phone || '-'}</td>
                                    <td>${s.website || '-'}</td>
                                    <td>
                                        <button class="btn btn-secondary btn-small" onclick="editSupplier('${s.id}')">Edit</button>
                                        <button class="btn btn-danger btn-small" onclick="deleteSupplier('${s.id}')">Delete</button>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function saveSupplier(e) {
            e.preventDefault();
            const id = document.getElementById('supplierId').value;
            const data = {
                name: document.getElementById('supplierName').value,
                email: document.getElementById('supplierEmail').value,
                phone: document.getElementById('supplierPhone').value,
                website: document.getElementById('supplierWeb').value
            };

            try {
                const url = id ? `/api/crm/suppliers/${id}` : '/api/crm/suppliers';
                const res = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal('supplierModal');
                    loadSuppliers();
                    document.getElementById('supplierForm').reset();
                    alert('Supplier saved!');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editSupplier(id) {
            const supplier = suppliers.find(x => x.id === id);
            if (supplier) {
                document.getElementById('supplierId').value = supplier.id;
                document.getElementById('supplierName').value = supplier.name;
                document.getElementById('supplierEmail').value = supplier.email || '';
                document.getElementById('supplierPhone').value = supplier.phone || '';
                document.getElementById('supplierWeb').value = supplier.website || '';
                openModal('supplierModal');
            }
        }

        async function deleteSupplier(id) {
            if (!confirm('Delete this supplier?')) return;
            try {
                await fetch(`/api/crm/suppliers/${id}`, {method: 'DELETE'});
                loadSuppliers();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadCommunications() {
            try {
                const res = await fetch('/api/crm/communications');
                const data = await res.json();
                if (data.success) {
                    communications = data.communications;
                    renderCommunications();
                }
            } catch (e) {
                console.error('Communications error:', e);
            }
        }

        function renderCommunications() {
            const container = document.getElementById('commTable');
            if (communications.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">üí¨</div>
                        <div class="empty-title">No communications yet</div>
                        <p>Log your first interaction</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = `
                <div class="table-container">
                    <table>
                        <thead>
                            <tr>
                                <th>Date</th>
                                <th>Type</th>
                                <th>Customer</th>
                                <th>Subject</th>
                                <th>By</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${communications.map(c => {
                                const customer = customers.find(cust => cust.id === c.customer_id);
                                const date = new Date(c.created_at).toLocaleDateString();
                                return `
                                    <tr>
                                        <td>${date}</td>
                                        <td>${c.type}</td>
                                        <td>${customer ? customer.name : '-'}</td>
                                        <td>${c.subject || '-'}</td>
                                        <td>${c.created_by || 'System'}</td>
                                        <td>
                                            <button class="btn btn-secondary btn-small" onclick="editCommunication('${c.id}')">Edit</button>
                                            <button class="btn btn-danger btn-small" onclick="deleteCommunication('${c.id}')">Delete</button>
                                        </td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
        }

        async function saveComm(e) {
            e.preventDefault();
            const id = document.getElementById('commId').value;
            const data = {
                customer_id: document.getElementById('commCustomer').value,
                type: document.getElementById('commType').value,
                subject: document.getElementById('commSubject').value,
                content: document.getElementById('commContent').value
            };

            try {
                const url = id ? `/api/crm/communications/${id}` : '/api/crm/communications';
                const res = await fetch(url, {
                    method: id ? 'PUT' : 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify(data)
                });
                const result = await res.json();
                if (result.success) {
                    closeModal('commModal');
                    loadCommunications();
                    document.getElementById('commForm').reset();
                    alert('Communication saved!');
                }
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        function editCommunication(id) {
            const comm = communications.find(x => x.id === id);
            if (comm) {
                document.getElementById('commId').value = comm.id;
                document.getElementById('commCustomer').value = comm.customer_id || '';
                document.getElementById('commType').value = comm.type;
                document.getElementById('commSubject').value = comm.subject || '';
                document.getElementById('commContent').value = comm.content || '';
                openModal('commModal');
            }
        }

        async function deleteCommunication(id) {
            if (!confirm('Delete this communication?')) return;
            try {
                await fetch(`/api/crm/communications/${id}`, {method: 'DELETE'});
                loadCommunications();
            } catch (e) {
                alert('Error: ' + e.message);
            }
        }

        async function loadIntegrations() {
            try {
                const res = await fetch('/api/crm/integrations');
                const data = await res.json();
                if (data.success) {
                    renderIntegrations(data.integrations);
                }
            } catch (e) {
                console.error('Integrations error:', e);
            }
        }

        function renderIntegrations(integrations) {
            const container = document.getElementById('integrationsGrid');
            container.innerHTML = `
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                    ${Object.entries(integrations).map(([name, config]) => `
                        <div class="card">
                            <h3 style="margin-bottom: 12px; text-transform: capitalize;">${name}</h3>
                            <p style="color: #666; margin-bottom: 16px;">
                                Status: <span class="status-badge status-${config.enabled ? 'active' : 'cancelled'}">
                                    ${config.enabled ? 'Enabled' : 'Disabled'}
                                </span>
                            </p>
                            <button class="btn btn-secondary btn-small">Configure</button>
                        </div>
                    `).join('')}
                </div>
            `;
        }

        // HELPERS
        function populateCustomerDropdowns() {
            const selects = ['projectCustomer', 'commCustomer'];
            selects.forEach(id => {
                const select = document.getElementById(id);
                if (select) {
                    select.innerHTML = '<option value="">Select customer...</option>' +
                        customers.map(c => `<option value="${c.id}">${c.name}</option>`).join('');
                }
            });
        }

        function openModal(modalId) {
            console.log('openModal called with ID:', modalId);
            const modal = document.getElementById(modalId);
            if (!modal) {
                console.error(`Modal with ID "${modalId}" not found`);
                return;
            }
            modal.classList.add('active');
            console.log('Modal opened:', modalId);
            // Reset form if new
            const form = modal.querySelector('form');
            if (form) {
                const hiddenInput = form.querySelector('input[type="hidden"]');
                if (hiddenInput && !hiddenInput.value) {
                    form.reset();
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
            const form = document.querySelector(`#${modalId} form`);
            if (form) form.reset();
        }
    </script>
<!-- AI Chat Bubble & Panel - Add this before </body> -->
<div id="aiChatBubble" class="ai-chat-bubble" onclick="toggleAIChat()">
    üß†
</div>

<div id="aiChatPanel" class="ai-chat-panel">
    <div class="ai-chat-header">
        <div style="flex: 1;">
            <h3>ü§ñ AI Assistant</h3>
            <div style="display: flex; gap: 8px; margin-top: 8px; flex-wrap: wrap;">
                <button id="agentModeToggle" onclick="toggleAgentMode()" style="
                    background: #999;
                    color: white;
                    border: none;
                    padding: 5px 12px;
                    border-radius: 5px;
                    font-size: 0.85em;
                    cursor: pointer;
                ">üîí Learning: OFF</button>
                <button onclick="document.getElementById('aiChatFileInput').click()" style="
                    background: #556B2F;
                    color: white;
                    border: none;
                    padding: 5px 12px;
                    border-radius: 5px;
                    font-size: 0.85em;
                    cursor: pointer;
                ">üìé Upload</button>
                <input type="file" id="aiChatFileInput" multiple accept=".pdf,.png,.jpg,.jpeg,.doc,.docx,text/*" style="display: none;" onchange="uploadAIChatFiles()">
            </div>
            <div id="agentModeStatus" style="font-size: 0.75em; color: #999; margin-top: 5px;">üîí Read-only mode</div>
        </div>
        <button onclick="toggleAIChat()" style="background: none; border: none; font-size: 24px; cursor: pointer; color: white;">√ó</button>
    </div>
    <div class="ai-chat-messages" id="aiChatMessages">
        <div class="ai-message">
            <strong>ü§ñ AI:</strong> Hi! I can help with CRM questions and tasks. Use üìé Upload to teach me with documents. Toggle Learning Mode ON to let me modify the app and learn from you.
        </div>
    </div>
    <div class="ai-chat-input">
        <input type="text" id="aiChatInput" placeholder="Ask me anything...">
        <button id="aiChatSendBtn" onclick="sendAIMessage()">Send</button>
    </div>
</div>

<style>
    .ai-chat-bubble {
        display: none !important; /* Hidden - using main chatbot component instead */
    }

    .ai-chat-bubble:hover {
        transform: scale(1.1);
        box-shadow: 0 6px 20px rgba(85, 107, 47, 0.6);
    }

    .ai-chat-panel {
        position: fixed;
        bottom: 100px;
        right: 30px;
        width: 400px;
        height: 500px;
        background: white;
        border-radius: 16px;
        box-shadow: 0 8px 32px rgba(0,0,0,0.2);
        display: none;
        flex-direction: column;
        z-index: 9999;
    }

    .ai-chat-panel.active {
        display: flex;
    }

    .ai-chat-header {
        background: linear-gradient(135deg, #556B2F 0%, #6B8E23 100%);
        color: white;
        padding: 20px;
        border-radius: 16px 16px 0 0;
        display: flex;
        justify-content: space-between;
        align-items: flex-start;
    }

    .ai-chat-header h3 {
        margin: 0;
        font-size: 18px;
    }

    .ai-chat-messages {
        flex: 1;
        overflow-y: auto;
        padding: 20px;
        background: var(--bg-primary);
    }

    .ai-message {
        background: var(--bg-secondary);
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .user-message {
        background: linear-gradient(135deg, #556B2F 0%, #6B8E23 100%);
        color: white;
        padding: 12px;
        border-radius: 8px;
        margin-bottom: 10px;
        text-align: right;
    }

    .ai-chat-input {
        padding: 15px;
        border-top: 1px solid #ddd;
        display: flex;
        gap: 10px;
    }

    .ai-chat-input input {
        flex: 1;
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 8px;
        font-size: 14px;
    }

    .ai-chat-input button {
        padding: 10px 20px;
        background: linear-gradient(135deg, #556B2F 0%, #6B8E23 100%);
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        font-weight: 600;
    }

    .ai-chat-input button:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }
</style>

<script>
    console.log('CRM Script Block 2: Loaded (AI Chat & Dark Mode)');

    // ============================================================================
    // DARK MODE TOGGLE - Define this first so DOMContentLoaded can find it
    // ============================================================================

    function initDarkMode() {
        console.log('üåô initDarkMode function called');
        const themeToggle = document.getElementById('themeToggle');
        const sunIcon = document.getElementById('sunIcon');
        const moonIcon = document.getElementById('moonIcon');
        const htmlElement = document.documentElement;

        console.log('üîç Looking for theme toggle elements...');
        console.log('  - themeToggle button:', themeToggle);
        console.log('  - sunIcon:', sunIcon);
        console.log('  - moonIcon:', moonIcon);

        if (!themeToggle) {
            console.error('‚ùå CRITICAL: Theme toggle button not found! id="themeToggle" does not exist in DOM');
            return;
        }
        if (!sunIcon) {
            console.error('‚ùå CRITICAL: Sun icon not found! id="sunIcon" does not exist in DOM');
            return;
        }
        if (!moonIcon) {
            console.error('‚ùå CRITICAL: Moon icon not found! id="moonIcon" does not exist in DOM');
            return;
        }

        console.log('‚úÖ All theme toggle elements found successfully');

        // Check for saved theme preference or default to 'light' mode
        const currentTheme = localStorage.getItem('theme') || 'light';
        console.log('üíæ Current theme from localStorage:', currentTheme);

        // Set initial theme
        if (currentTheme === 'dark') {
            htmlElement.setAttribute('data-theme', 'dark');
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
            console.log('üåô Initial theme set to DARK');
        } else {
            console.log('‚òÄÔ∏è Initial theme set to LIGHT');
        }

        // Toggle theme on button click
        themeToggle.addEventListener('click', function(e) {
            console.log('üñ±Ô∏è THEME TOGGLE CLICKED!', e);
            const theme = htmlElement.getAttribute('data-theme');
            console.log('üìä Current theme attribute:', theme);

            if (theme === 'dark') {
                htmlElement.setAttribute('data-theme', 'light');
                localStorage.setItem('theme', 'light');
                sunIcon.style.display = 'block';
                moonIcon.style.display = 'none';
                console.log('‚òÄÔ∏è Switched to LIGHT mode');
            } else {
                htmlElement.setAttribute('data-theme', 'dark');
                localStorage.setItem('theme', 'dark');
                sunIcon.style.display = 'none';
                moonIcon.style.display = 'block';
                console.log('üåô Switched to DARK mode');
            }

            // Reinitialize charts with new theme colors
            setTimeout(() => {
                if (typeof loadStats === 'function') {
                    loadStats();
                    console.log('üìä Charts reloaded with new theme');
                }
            }, 100);
        });
        console.log('‚úÖ Dark mode click event listener attached successfully to button');
    }

    // Initialize dark mode when DOM is ready
    document.addEventListener('DOMContentLoaded', function() {
        console.log('CRM Block 2: DOM ready - Initializing dark mode');
        initDarkMode();
        console.log('CRM: Dark mode initialization complete');
    });

    let agentMode = false;

    function toggleAIChat() {
        document.getElementById('aiChatPanel').classList.toggle('active');
    }

    function toggleAgentMode() {
        agentMode = !agentMode;
        const btn = document.getElementById('agentModeToggle');
        const status = document.getElementById('agentModeStatus');
        if (agentMode) {
            btn.textContent = 'üîì Learning: ON';
            btn.style.background = '#6B8E23';
            status.textContent = 'üîì Can modify app & learn';
            status.style.color = '#6B8E23';
        } else {
            btn.textContent = 'üîí Learning: OFF';
            btn.style.background = '#999';
            status.textContent = 'üîí Read-only mode';
            status.style.color = '#999';
        }
    }

    async function uploadAIChatFiles() {
        const fileInput = document.getElementById('aiChatFileInput');
        const messages = document.getElementById('aiChatMessages');

        if (!fileInput.files || fileInput.files.length === 0) return;

        const formData = new FormData();
        for (let file of fileInput.files) {
            formData.append('files', file);
        }
        formData.append('notes', `Uploaded via CRM chat on ${new Date().toLocaleString()}`);

        try {
            messages.innerHTML += `<div style="text-align: center; padding: 8px; color: #999; font-size: 0.9em;">Uploading ${fileInput.files.length} file(s)...</div>`;
            messages.scrollTop = messages.scrollHeight;

            const response = await fetch('/api/upload-learning-data', {
                method: 'POST',
                body: formData
            });

            const data = await response.json();

            if (data.success) {
                messages.innerHTML += `<div class="ai-message" style="background: #d4edda;"><strong>‚úÖ System:</strong> Uploaded and learned from ${fileInput.files.length} file(s)!</div>`;
                fileInput.value = '';
            } else {
                messages.innerHTML += `<div class="ai-message" style="background: #f8d7da;"><strong>‚ùå Error:</strong> ${data.error}</div>`;
            }

            messages.scrollTop = messages.scrollHeight;
        } catch (error) {
            messages.innerHTML += `<div class="ai-message" style="background: #f8d7da;"><strong>‚ùå Error:</strong> ${error.message}</div>`;
            messages.scrollTop = messages.scrollHeight;
        }
    }

    let conversationHistory = [];

    async function sendAIMessage() {
        const input = document.getElementById('aiChatInput');
        const messages = document.getElementById('aiChatMessages');
        const sendBtn = document.getElementById('aiChatSendBtn');
        const question = input.value.trim();

        if (!question) return;

        // Add user message
        messages.innerHTML += `<div class="user-message"><strong>You:</strong> ${question}</div>`;
        input.value = '';
        sendBtn.disabled = true;

        // Add to history
        conversationHistory.push({
            role: 'user',
            content: question
        });

        // Scroll to bottom
        messages.scrollTop = messages.scrollHeight;

        try {
            const response = await fetch('/api/ai-chat', {
                method: 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify({
                    message: question,
                    agent_mode: agentMode,
                    conversation_history: conversationHistory.slice(-10), // Keep last 10 messages
                    current_page: 'crm'
                })
            });

            const data = await response.json();

            if (data.success && data.response) {
                messages.innerHTML += `<div class="ai-message"><strong>ü§ñ AI:</strong> ${data.response.replace(/\n/g, '<br>')}</div>`;

                // Add to history
                conversationHistory.push({
                    role: 'assistant',
                    content: data.response
                });
            }

            if (data.actions_taken && data.actions_taken.length > 0) {
                data.actions_taken.forEach(action => {
                    messages.innerHTML += `<div class="ai-message" style="background: #e8f5e9;"><strong>‚úÖ Action:</strong> ${action.description || action.action}</div>`;
                });

                // Reload data if actions were taken
                loadAllData();
            }
        } catch (error) {
            messages.innerHTML += `<div class="ai-message" style="background: #fee;"><strong>‚ùå Error:</strong> ${error.message}</div>`;
        }

        sendBtn.disabled = false;
        messages.scrollTop = messages.scrollHeight;
    }

    // Enter key to send
    document.addEventListener('DOMContentLoaded', function() {
        const input = document.getElementById('aiChatInput');
        if (input) {
            input.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    sendAIMessage();
                }
            });
        }
    });

    // ========== INVENTORY MANAGEMENT ==========
    // Note: 'inventory' is already declared globally in first script block
    let filteredInventory = [];

    async function loadInventory() {
        try {
            const res = await fetch('/api/inventory');
            const data = await res.json();
            if (data.success) {
                inventory = data.inventory;
                filteredInventory = inventory;
                renderInventory();
            }
        } catch (e) {
            console.error('Inventory error:', e);
        }
    }

    function filterInventory() {
        const typeFilter = document.getElementById('inventoryTypeFilter').value;
        const tierFilter = document.getElementById('inventoryTierFilter').value;
        
        filteredInventory = inventory.filter(item => {
            const typeMatch = !typeFilter || item.automation_type === typeFilter;
            const tierMatch = !tierFilter || item.tier === tierFilter;
            return typeMatch && tierMatch;
        });
        
        renderInventory();
    }

    function renderInventory() {
        const container = document.getElementById('inventoryTable');
        if (!filteredInventory || filteredInventory.length === 0) {
            container.innerHTML = '<div style="text-align:center;padding:40px;color:#999;">No inventory items found. Import from Simpro to add products.</div>';
            return;
        }

        const typeIcons = {
            lighting: 'üí°', shading: 'ü™ü', security_access: 'üîê',
            climate: 'üå°', audio: 'üîä', networking: 'üåê',
            power: '‚ö°', other: 'üì¶'
        };

        container.innerHTML = `
            <div style="overflow-x: auto;">
                <table style="width:100%;border-collapse:collapse;">
                    <thead style="background:#f8f9fa;">
                        <tr>
                            <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Item</th>
                            <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">SKU</th>
                            <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Type</th>
                            <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Tier</th>
                            <th style="padding:12px;text-align:right;border-bottom:2px solid #dee2e6;">Price</th>
                            <th style="padding:12px;text-align:center;border-bottom:2px solid #dee2e6;">Stock</th>
                            <th style="padding:12px;text-align:left;border-bottom:2px solid #dee2e6;">Source</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${filteredInventory.map(item => {
                            const price = item.price && item.price[item.tier] ? item.price[item.tier] : (item.price && item.price.basic ? item.price.basic : 0);
                            return `
                                <tr style="border-bottom:1px solid #e9ecef;">
                                    <td style="padding:12px;">
                                        <div style="font-weight:600;">${item.name || 'Unknown'}</div>
                                        <div style="font-size:0.85em;color:#666;margin-top:4px;">${(item.description || '').substring(0, 60)}...</div>
                                    </td>
                                    <td style="padding:12px;">${item.sku || '-'}</td>
                                    <td style="padding:12px;">${typeIcons[item.automation_type] || 'üì¶'} ${item.automation_type || 'other'}</td>
                                    <td style="padding:12px;">
                                        <span style="padding:4px 12px;border-radius:12px;font-size:0.85em;font-weight:600;
                                            ${item.tier === 'basic' ? 'background:#e3f2fd;color:#1976d2;' : 
                                              item.tier === 'premium' ? 'background:#fff3e0;color:#f57c00;' : 
                                              'background:#f3e5f5;color:#7b1fa2;'}">
                                            ${item.tier || 'basic'}
                                        </span>
                                    </td>
                                    <td style="padding:12px;text-align:right;font-weight:600;">$${price.toFixed(2)}</td>
                                    <td style="padding:12px;text-align:center;">${item.stock_quantity || 0}</td>
                                    <td style="padding:12px;">
                                        <span style="padding:3px 8px;border-radius:6px;font-size:0.8em;background:#f5f5f5;color:#666;">
                                            ${item.source || 'manual'}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    // Load inventory when page loads
    if (window.location.hash === '#inventory') {
        loadInventory();
    }

    // ==================== GOOGLE INTEGRATION FUNCTIONS ====================

    function toggleGoogleConfig() {
        const form = document.getElementById('googleConfigForm');
        form.style.display = form.style.display === 'none' ? 'block' : 'none';

        if (form.style.display === 'block') {
            loadGoogleConfig();
        }
    }

    async function loadGoogleConfig() {
        try {
            const res = await fetch('/api/crm/google/config');
            const data = await res.json();

            if (data.success) {
                document.getElementById('googleClientId').value = data.config.client_id || '';
                document.getElementById('googleRedirectUri').value = data.config.redirect_uri || '';
                document.getElementById('googleCalendarEnabled').checked = data.config.calendar_enabled || false;
                document.getElementById('googleGmailEnabled').checked = data.config.gmail_enabled || false;

                // Update connection status
                updateGoogleConnectionStatus(data.config.connected);
            }
        } catch (e) {
            console.error('Error loading Google config:', e);
        }
    }

    function updateGoogleConnectionStatus(connected) {
        const status = document.getElementById('googleConnectionStatus');
        const btnConnect = document.getElementById('btnConnectGoogle');
        const btnDisconnect = document.getElementById('btnDisconnectGoogle');

        if (connected) {
            status.textContent = 'Connected';
            status.className = 'status-badge status-completed';
            btnConnect.style.display = 'none';
            btnDisconnect.style.display = 'inline-block';
        } else {
            status.textContent = 'Not Connected';
            status.className = 'status-badge status-pending';
            btnConnect.style.display = 'inline-block';
            btnDisconnect.style.display = 'none';
        }
    }

    async function saveGoogleConfig(e) {
        e.preventDefault();

        const config = {
            client_id: document.getElementById('googleClientId').value,
            client_secret: document.getElementById('googleClientSecret').value,
            redirect_uri: document.getElementById('googleRedirectUri').value,
            calendar_enabled: document.getElementById('googleCalendarEnabled').checked,
            gmail_enabled: document.getElementById('googleGmailEnabled').checked
        };

        try {
            const res = await fetch('/api/crm/google/config', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(config)
            });
            const data = await res.json();

            if (data.success) {
                showNotification('Google configuration saved', 'success');
            } else {
                showNotification(data.error || 'Failed to save configuration', 'error');
            }
        } catch (e) {
            showNotification('Error saving configuration', 'error');
        }
    }

    async function connectGoogle() {
        try {
            const res = await fetch('/api/crm/google/auth-url');
            const data = await res.json();

            if (data.success) {
                // Open Google OAuth in new window
                const authWindow = window.open(data.auth_url, 'Google Auth', 'width=600,height=700');

                // Listen for callback
                window.addEventListener('message', async function handler(event) {
                    if (event.data.type === 'google-auth-callback') {
                        authWindow.close();
                        window.removeEventListener('message', handler);

                        // Exchange code for tokens
                        const callbackRes = await fetch('/api/crm/google/callback', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ code: event.data.code })
                        });
                        const callbackData = await callbackRes.json();

                        if (callbackData.success) {
                            showNotification('Google account connected successfully', 'success');
                            updateGoogleConnectionStatus(true);
                        } else {
                            showNotification(callbackData.error || 'Failed to connect', 'error');
                        }
                    }
                });

                // Show instructions for manual code entry
                showNotification('Complete authorization in the new window. If redirected, copy the code from the URL and enter it below.', 'info');

            } else {
                showNotification(data.error || 'Failed to get auth URL', 'error');
            }
        } catch (e) {
            showNotification('Error connecting to Google', 'error');
        }
    }

    async function disconnectGoogle() {
        if (!confirm('Are you sure you want to disconnect your Google account?')) return;

        try {
            const res = await fetch('/api/crm/google/disconnect', {
                method: 'POST'
            });
            const data = await res.json();

            if (data.success) {
                showNotification('Google account disconnected', 'success');
                updateGoogleConnectionStatus(false);
            } else {
                showNotification(data.error || 'Failed to disconnect', 'error');
            }
        } catch (e) {
            showNotification('Error disconnecting', 'error');
        }
    }

    async function loadGoogleCalendarEvents() {
        const container = document.getElementById('googleCalendarEvents');
        container.innerHTML = '<div class="loading"><div class="spinner"></div><p>Loading events...</p></div>';

        try {
            const res = await fetch('/api/crm/google/calendar/events');
            const data = await res.json();

            if (data.success) {
                if (data.events.length === 0) {
                    container.innerHTML = `
                        <div class="empty-state" style="padding: 40px;">
                            <div class="empty-icon">üìÖ</div>
                            <div class="empty-title">No upcoming events</div>
                        </div>
                    `;
                } else {
                    container.innerHTML = data.events.map(event => `
                        <div style="padding: 12px; border: 1px solid #e9ecef; border-radius: 8px; margin-bottom: 8px;">
                            <div style="font-weight: 600;">${event.summary || 'Untitled'}</div>
                            <div style="font-size: 12px; color: #666; margin-top: 4px;">
                                ${formatEventTime(event.start)} - ${formatEventTime(event.end)}
                            </div>
                            ${event.location ? `<div style="font-size: 12px; color: #888; margin-top: 4px;">üìç ${event.location}</div>` : ''}
                        </div>
                    `).join('');
                }
            } else {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <div class="empty-icon">‚ö†Ô∏è</div>
                        <div class="empty-title">Error loading events</div>
                        <p>${data.error || 'Please connect your Google account'}</p>
                    </div>
                `;
            }
        } catch (e) {
            container.innerHTML = `
                <div class="empty-state" style="padding: 40px;">
                    <div class="empty-icon">‚ö†Ô∏è</div>
                    <div class="empty-title">Error</div>
                    <p>${e.message}</p>
                </div>
            `;
        }
    }

    function formatEventTime(eventTime) {
        if (!eventTime) return '';
        const date = eventTime.dateTime || eventTime.date;
        if (!date) return '';
        return new Date(date).toLocaleString();
    }

    async function createGoogleCalendarEvent(e) {
        e.preventDefault();

        const startTime = new Date(document.getElementById('googleEventStart').value).toISOString();
        const endTime = new Date(document.getElementById('googleEventEnd').value).toISOString();
        const attendeesStr = document.getElementById('googleEventAttendees').value;
        const attendees = attendeesStr ? attendeesStr.split(',').map(e => e.trim()).filter(e => e) : [];
        const reminderMinutes = document.getElementById('googleEventReminder').value;

        const eventData = {
            title: document.getElementById('googleEventTitle').value,
            description: document.getElementById('googleEventDescription').value,
            location: document.getElementById('googleEventLocation').value,
            start_time: startTime,
            end_time: endTime,
            attendees: attendees,
            timezone: Intl.DateTimeFormat().resolvedOptions().timeZone
        };

        if (reminderMinutes) {
            eventData.reminder_minutes = parseInt(reminderMinutes);
        }

        try {
            const res = await fetch('/api/crm/google/calendar/events', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(eventData)
            });
            const data = await res.json();

            if (data.success) {
                showNotification('Event created successfully', 'success');
                closeModal('googleEventModal');
                document.querySelector('#googleEventModal form').reset();
                loadGoogleCalendarEvents();
            } else {
                showNotification(data.error || 'Failed to create event', 'error');
            }
        } catch (e) {
            showNotification('Error creating event', 'error');
        }
    }

    async function sendGmailEmail(e) {
        e.preventDefault();

        const emailData = {
            to: document.getElementById('gmailTo').value,
            subject: document.getElementById('gmailSubject').value,
            body: document.getElementById('gmailBody').value
        };

        try {
            const res = await fetch('/api/crm/google/gmail/send', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(emailData)
            });
            const data = await res.json();

            if (data.success) {
                showNotification('Email sent successfully', 'success');
                document.getElementById('gmailTo').value = '';
                document.getElementById('gmailSubject').value = '';
                document.getElementById('gmailBody').value = '';
            } else {
                showNotification(data.error || 'Failed to send email', 'error');
            }
        } catch (e) {
            showNotification('Error sending email', 'error');
        }
    }

    // Load Google config when section is shown
    document.addEventListener('DOMContentLoaded', function() {
        const googleSection = document.getElementById('google-integrations');
        if (googleSection) {
            const observer = new MutationObserver(function(mutations) {
                mutations.forEach(function(mutation) {
                    if (mutation.target.classList.contains('active')) {
                        loadGoogleConfig();
                    }
                });
            });
            observer.observe(googleSection, { attributes: true, attributeFilter: ['class'] });
        }
    });

    // ============================================================================
    // CRM EXTENDED MODULES - PEOPLE, JOBS, MATERIALS, PAYMENTS
    // ============================================================================

    // STATE for new modules
    let people = [];
    let jobs = [];
    let materials = [];
    let payments = [];

    // Add to loadAllData function
    const originalLoadAllData = loadAllData;
    loadAllData = async function() {
        await originalLoadAllData();
        await Promise.all([
            loadPeople('employee'),
            loadPeople('customer'),
            loadPeople('supplier'),
            loadPeople('contractor'),
            loadPeople('contact'),
            loadJobs('in_progress'),
            loadJobs('upcoming'),
            loadJobs('pending'),
            loadJobs('finished'),
            loadJobs('recurring'),
            loadMaterials('stock'),
            loadMaterials('order'),
            loadPayments('to_us'),
            loadPayments('to_suppliers')
        ]);
    };

    // ============================================================================
    // PEOPLE MODULE
    // ============================================================================

    async function loadPeople(type) {
        try {
            const res = await fetch(`/api/crm/people?type=${type}`);
            const data = await res.json();
            if (data.success) {
                // Store globally for event linking
                if (!window.allPeople) window.allPeople = [];
                // Add or update people for this type
                window.allPeople = window.allPeople.filter(p => p.type !== type).concat(data.people);
                renderPeople(data.people, type);
            }
        } catch (e) {
            console.error(`Error loading ${type}:`, e);
        }
    }

    function renderPeople(peopleList, type) {
        const containerId = type === 'employee' ? 'employeesTable' :
                           type === 'customer' ? 'customersTableNew' :
                           type === 'supplier' ? 'suppliersTableNew' :
                           type === 'contractor' ? 'contractorsTable' :
                           'contactsTable';

        const container = document.getElementById(containerId);
        if (!container) return;

        if (peopleList.length === 0) {
            const labels = {
                'employee': 'employees',
                'customer': 'customers',
                'supplier': 'suppliers',
                'contractor': 'contractors',
                'contact': 'contacts'
            };
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üë§</div>
                    <div class="empty-title">No ${labels[type]} yet</div>
                    <p>Add your first ${type} to get started</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Company</th>
                            <th>Email</th>
                            <th>Phone</th>
                            <th>Address</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${peopleList.map(p => `
                            <tr>
                                <td><strong>${p.name}</strong></td>
                                <td>${p.company || '-'}</td>
                                <td>${p.email || '-'}</td>
                                <td>${p.phone || '-'}</td>
                                <td>${p.address || '-'}</td>
                                <td>
                                    <button class="btn btn-secondary btn-small" onclick="addPersonToCalendar('${p.id}', '${p.name}', '${type}')" title="Schedule Meeting">üìÖ</button>
                                    <button class="btn btn-secondary btn-small" onclick="editPerson('${p.id}', '${type}')">Edit</button>
                                    <button class="btn btn-danger btn-small" onclick="deletePerson('${p.id}', '${type}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function searchPeople(type) {
        const searchId = type === 'employee' ? 'employeeSearch' :
                        type === 'customer' ? 'customerSearch' :
                        type === 'supplier' ? 'suppliersSearch' :
                        type === 'contractor' ? 'contractorSearch' :
                        'contactSearch';

        const search = document.getElementById(searchId).value.toLowerCase();
        // Reload with search filter
        loadPeople(type, search);
    }

    // openPersonModal moved to first script block


    function editPerson(id, type) {
        fetch(`/api/crm/people/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const p = data.person;
                    document.getElementById('personId').value = p.id;
                    document.getElementById('personType').value = p.type;
                    document.getElementById('personName').value = p.name;
                    document.getElementById('personCompany').value = p.company || '';
                    document.getElementById('personEmail').value = p.email || '';
                    document.getElementById('personPhone').value = p.phone || '';
                    document.getElementById('personAddress').value = p.address || '';
                    document.getElementById('personNotes').value = p.notes || '';

                    const labels = {
                        'employee': 'Employee',
                        'customer': 'Customer',
                        'supplier': 'Supplier',
                        'contractor': 'Contractor',
                        'contact': 'Contact'
                    };
                    document.querySelector('#personModal h2').textContent = `Edit ${labels[type]}`;
                    openModal('personModal');
                }
            });
    }

    async function savePerson(e) {
        e.preventDefault();
        const id = document.getElementById('personId').value;
        const type = document.getElementById('personType').value;

        const data = {
            type: type,
            name: document.getElementById('personName').value,
            company: document.getElementById('personCompany').value,
            email: document.getElementById('personEmail').value,
            phone: document.getElementById('personPhone').value,
            address: document.getElementById('personAddress').value,
            notes: document.getElementById('personNotes').value
        };

        try {
            const url = id ? `/api/crm/people/${id}` : '/api/crm/people';
            const res = await fetch(url, {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (result.success) {
                closeModal('personModal');
                loadPeople(type);
                showToast(`${type.charAt(0).toUpperCase() + type.slice(1)} saved successfully!`, 'success');
            } else {
                showToast('Error saving: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function deletePerson(id, type) {
        if (!confirm('Are you sure you want to delete this person?')) return;

        try {
            const res = await fetch(`/api/crm/people/${id}`, {method: 'DELETE'});
            const result = await res.json();

            if (result.success) {
                loadPeople(type);
                showToast('Person deleted successfully', 'success');
            } else {
                showToast('Error deleting: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    // ============================================================================
    // JOBS MODULE
    // ============================================================================

    async function loadJobs(status) {
        try {
            const res = await fetch(`/api/crm/jobs?status=${status}`);
            const data = await res.json();
            if (data.success) {
                // Store globally for event linking
                if (!window.allJobs) window.allJobs = [];
                // Add or update jobs for this status
                window.allJobs = window.allJobs.filter(j => j.status !== status).concat(data.jobs);
                renderJobs(data.jobs, status);
            }
        } catch (e) {
            console.error(`Error loading ${status} jobs:`, e);
        }
    }

    function renderJobs(jobsList, status) {
        const containerMap = {
            'in_progress': 'jobsInProgressTable',
            'upcoming': 'jobsUpcomingTable',
            'pending': 'jobsPendingTable',
            'finished': 'jobsFinishedTable',
            'recurring': 'jobsRecurringTable'
        };

        const container = document.getElementById(containerMap[status]);
        if (!container) return;

        if (jobsList.length === 0) {
            const labels = {
                'in_progress': 'jobs in progress',
                'upcoming': 'upcoming jobs',
                'pending': 'pending jobs',
                'finished': 'finished jobs',
                'recurring': 'recurring jobs'
            };
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üíº</div>
                    <div class="empty-title">No ${labels[status]}</div>
                    <p>Add your first job to get started</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Customer</th>
                            <th>Start Date</th>
                            <th>Due Date</th>
                            <th>Value</th>
                            ${status === 'recurring' ? '<th>Schedule</th>' : ''}
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${jobsList.map(j => `
                            <tr>
                                <td><strong>${j.name}</strong></td>
                                <td>${j.customer_id || '-'}</td>
                                <td>${j.start_date || '-'}</td>
                                <td>${j.due_date || '-'}</td>
                                <td>$${(j.value || 0).toLocaleString()}</td>
                                ${status === 'recurring' ? `<td>${j.recurring_schedule || '-'}</td>` : ''}
                                <td>
                                    <button class="btn btn-secondary btn-small" onclick="addJobToCalendar('${j.id}', '${j.name}', '${j.start_date}', '${j.due_date}')" title="Add to Calendar">üìÖ</button>
                                    <button class="btn btn-secondary btn-small" onclick="editJob('${j.id}', '${status}')">Edit</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteJob('${j.id}', '${status}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function searchJobs(status) {
        const searchMap = {
            'in_progress': 'jobsInProgressSearch',
            'upcoming': 'jobsUpcomingSearch',
            'pending': 'jobsPendingSearch',
            'finished': 'jobsFinishedSearch',
            'recurring': 'jobsRecurringSearch'
        };

        const search = document.getElementById(searchMap[status]).value.toLowerCase();
        loadJobs(status, search);
    }

    // openJobModal moved to first script block


    function editJob(id, status) {
        fetch(`/api/crm/jobs/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const j = data.job;
                    document.getElementById('jobId').value = j.id;
                    document.getElementById('jobStatus').value = j.status;
                    document.getElementById('jobName').value = j.name;
                    document.getElementById('jobCustomer').value = j.customer_id || '';
                    document.getElementById('jobDescription').value = j.description || '';
                    document.getElementById('jobStartDate').value = j.start_date || '';
                    document.getElementById('jobDueDate').value = j.due_date || '';
                    document.getElementById('jobValue').value = j.value || '';
                    document.getElementById('jobRecurring').value = j.recurring_schedule || '';

                    const labels = {
                        'in_progress': 'In Progress Job',
                        'upcoming': 'Upcoming Job',
                        'pending': 'Pending Job',
                        'finished': 'Finished Job',
                        'recurring': 'Recurring Job'
                    };
                    document.querySelector('#jobModal h2').textContent = `Edit ${labels[status]}`;

                    // Show/hide recurring schedule field
                    const recurringField = document.querySelector('#jobRecurring').closest('.form-group');
                    recurringField.style.display = status === 'recurring' ? 'block' : 'none';

                    openModal('jobModal');
                }
            });
    }

    async function saveJob(e) {
        e.preventDefault();
        const id = document.getElementById('jobId').value;
        const status = document.getElementById('jobStatus').value;

        const data = {
            status: status,
            name: document.getElementById('jobName').value,
            customer_id: document.getElementById('jobCustomer').value,
            description: document.getElementById('jobDescription').value,
            start_date: document.getElementById('jobStartDate').value,
            due_date: document.getElementById('jobDueDate').value,
            value: parseFloat(document.getElementById('jobValue').value) || 0,
            recurring_schedule: document.getElementById('jobRecurring').value
        };

        try {
            const url = id ? `/api/crm/jobs/${id}` : '/api/crm/jobs';
            const res = await fetch(url, {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (result.success) {
                closeModal('jobModal');
                loadJobs(status);
                showToast('Job saved successfully!', 'success');
            } else {
                showToast('Error saving: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function deleteJob(id, status) {
        if (!confirm('Are you sure you want to delete this job?')) return;

        try {
            const res = await fetch(`/api/crm/jobs/${id}`, {method: 'DELETE'});
            const result = await res.json();

            if (result.success) {
                loadJobs(status);
                showToast('Job deleted successfully', 'success');
            } else {
                showToast('Error deleting: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    // ============================================================================
    // MATERIALS MODULE
    // ============================================================================

    async function loadMaterials(type, location = null) {
        try {
            let url = `/api/crm/materials?type=${type}`;
            if (location) url += `&location=${location}`;

            const res = await fetch(url);
            const data = await res.json();
            if (data.success) {
                renderMaterials(data.materials, type);
            }
        } catch (e) {
            console.error(`Error loading ${type} materials:`, e);
        }
    }

    function filterMaterials(type) {
        const filterId = type === 'stock' ? 'stockLocationFilter' : 'ordersLocationFilter';
        const location = document.getElementById(filterId).value;
        loadMaterials(type, location);
    }

    function renderMaterials(materialsList, type) {
        const containerId = type === 'stock' ? 'stockTable' : 'ordersTable';
        const container = document.getElementById(containerId);
        if (!container) return;

        if (materialsList.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üì¶</div>
                    <div class="empty-title">No ${type} materials</div>
                    <p>Add your first material to get started</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>Category</th>
                            <th>Location</th>
                            <th>Quantity</th>
                            <th>Unit Price</th>
                            <th>Total Value</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${materialsList.map(m => `
                            <tr>
                                <td><strong>${m.name}</strong></td>
                                <td>${m.category || '-'}</td>
                                <td>${m.location || '-'}</td>
                                <td>${m.quantity || 0}</td>
                                <td>$${(m.unit_price || 0).toFixed(2)}</td>
                                <td>$${((m.quantity || 0) * (m.unit_price || 0)).toFixed(2)}</td>
                                <td>
                                    <button class="btn btn-secondary btn-small" onclick="editMaterial('${m.id}', '${type}')">Edit</button>
                                    <button class="btn btn-danger btn-small" onclick="deleteMaterial('${m.id}', '${type}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function searchMaterials(type) {
        const searchId = type === 'stock' ? 'stockSearch' : 'ordersSearch';
        const search = document.getElementById(searchId).value.toLowerCase();
        loadMaterials(type, null, search);
    }

    // openMaterialModal moved to first script block


    function editMaterial(id, type) {
        fetch(`/api/crm/materials/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const m = data.material;
                    document.getElementById('materialId').value = m.id;
                    document.getElementById('materialType').value = m.type;
                    document.getElementById('materialName').value = m.name;
                    document.getElementById('materialCategory').value = m.category || '';
                    document.getElementById('materialLocation').value = m.location || 'sydney';
                    document.getElementById('materialQuantity').value = m.quantity || '';
                    document.getElementById('materialPrice').value = m.unit_price || '';
                    document.getElementById('materialSupplier').value = m.supplier_id || '';

                    document.querySelector('#materialModal h2').textContent = type === 'stock' ? 'Edit Stock Item' : 'Edit Order';
                    openModal('materialModal');
                }
            });
    }

    async function saveMaterial(e) {
        e.preventDefault();
        const id = document.getElementById('materialId').value;
        const type = document.getElementById('materialType').value;

        const data = {
            type: type,
            name: document.getElementById('materialName').value,
            category: document.getElementById('materialCategory').value,
            location: document.getElementById('materialLocation').value,
            quantity: parseInt(document.getElementById('materialQuantity').value) || 0,
            unit_price: parseFloat(document.getElementById('materialPrice').value) || 0,
            supplier_id: document.getElementById('materialSupplier').value
        };

        try {
            const url = id ? `/api/crm/materials/${id}` : '/api/crm/materials';
            const res = await fetch(url, {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (result.success) {
                closeModal('materialModal');
                loadMaterials(type);
                showToast('Material saved successfully!', 'success');
            } else {
                showToast('Error saving: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function deleteMaterial(id, type) {
        if (!confirm('Are you sure you want to delete this material?')) return;

        try {
            const res = await fetch(`/api/crm/materials/${id}`, {method: 'DELETE'});
            const result = await res.json();

            if (result.success) {
                loadMaterials(type);
                showToast('Material deleted successfully', 'success');
            } else {
                showToast('Error deleting: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    // ============================================================================
    // PAYMENTS MODULE
    // ============================================================================

    async function loadPayments(direction, status = null) {
        try {
            let url = `/api/crm/payments?direction=${direction}`;
            if (status) url += `&status=${status}`;

            const res = await fetch(url);
            const data = await res.json();
            if (data.success) {
                renderPayments(data.payments, direction);
            }
        } catch (e) {
            console.error(`Error loading ${direction} payments:`, e);
        }
    }

    function filterPayments(direction) {
        const filterId = direction === 'to_suppliers' ? 'paymentsToSuppliersFilter' : 'paymentsToUsFilter';
        const status = document.getElementById(filterId).value;
        loadPayments(direction, status);
    }

    function renderPayments(paymentsList, direction) {
        const containerId = direction === 'to_suppliers' ? 'paymentsToSuppliersTable' : 'paymentsToUsTable';
        const container = document.getElementById(containerId);
        if (!container) return;

        if (paymentsList.length === 0) {
            container.innerHTML = `
                <div class="empty-state">
                    <div class="empty-icon">üí∞</div>
                    <div class="empty-title">No payments</div>
                    <p>Add your first payment to get started</p>
                </div>
            `;
            return;
        }

        container.innerHTML = `
            <div class="table-container">
                <table>
                    <thead>
                        <tr>
                            <th>Amount</th>
                            <th>Status</th>
                            <th>Due Date</th>
                            <th>Paid Date</th>
                            <th>Person</th>
                            <th>Notes</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${paymentsList.map(p => `
                            <tr>
                                <td><strong>$${(p.amount || 0).toLocaleString()}</strong></td>
                                <td><span class="status-badge status-${p.status}">${p.status}</span></td>
                                <td>${p.due_date || '-'}</td>
                                <td>${p.paid_date || '-'}</td>
                                <td>${p.person_id || '-'}</td>
                                <td>${p.notes || '-'}</td>
                                <td>
                                    <button class="btn btn-secondary btn-small" onclick="addPaymentToCalendar('${p.id}', '${p.amount}', '${p.due_date}', '${direction}')" title="Add Payment Reminder">üìÖ</button>
                                    <button class="btn btn-secondary btn-small" onclick="editPayment('${p.id}', '${direction}')">Edit</button>
                                    <button class="btn btn-danger btn-small" onclick="deletePayment('${p.id}', '${direction}')">Delete</button>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            </div>
        `;
    }

    function searchPayments(direction) {
        const searchId = direction === 'to_suppliers' ? 'paymentsToSuppliersSearch' : 'paymentsToUsSearch';
        const search = document.getElementById(searchId).value.toLowerCase();
        loadPayments(direction, null, search);
    }

    // openPaymentModal moved to first script block


    function editPayment(id, direction) {
        fetch(`/api/crm/payments/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const p = data.payment;
                    document.getElementById('paymentId').value = p.id;
                    document.getElementById('paymentDirection').value = p.direction;
                    document.getElementById('paymentAmount').value = p.amount || '';
                    document.getElementById('paymentStatus').value = p.status || 'pending';
                    document.getElementById('paymentDueDate').value = p.due_date || '';
                    document.getElementById('paymentPaidDate').value = p.paid_date || '';
                    document.getElementById('paymentPerson').value = p.person_id || '';
                    document.getElementById('paymentNotes').value = p.notes || '';

                    document.querySelector('#paymentModal h2').textContent = direction === 'to_suppliers' ? 'Edit Payment to Supplier' : 'Edit Payment to Us';
                    openModal('paymentModal');
                }
            });
    }

    async function savePayment(e) {
        e.preventDefault();
        const id = document.getElementById('paymentId').value;
        const direction = document.getElementById('paymentDirection').value;

        const data = {
            direction: direction,
            amount: parseFloat(document.getElementById('paymentAmount').value) || 0,
            status: document.getElementById('paymentStatus').value,
            due_date: document.getElementById('paymentDueDate').value,
            paid_date: document.getElementById('paymentPaidDate').value,
            person_id: document.getElementById('paymentPerson').value,
            notes: document.getElementById('paymentNotes').value
        };

        try {
            const url = id ? `/api/crm/payments/${id}` : '/api/crm/payments';
            const res = await fetch(url, {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (result.success) {
                closeModal('paymentModal');
                loadPayments(direction);
                showToast('Payment saved successfully!', 'success');
            } else {
                showToast('Error saving: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    async function deletePayment(id, direction) {
        if (!confirm('Are you sure you want to delete this payment?')) return;

        try {
            const res = await fetch(`/api/crm/payments/${id}`, {method: 'DELETE'});
            const result = await res.json();

            if (result.success) {
                loadPayments(direction);
                showToast('Payment deleted successfully', 'success');
            } else {
                showToast('Error deleting: ' + result.error, 'error');
            }
        } catch (e) {
            showToast('Error: ' + e.message, 'error');
        }
    }

    // ============================================================================
    // CALENDAR/SCHEDULES MODULE
    // ============================================================================

    let calendarEvents = [];
    let currentCalendarDate = new Date();
    let currentCalendarView = 'monthly';
    let selectedDate = null;

    // Initialize calendar when page loads
    document.addEventListener('DOMContentLoaded', function() {
        loadCalendarEvents();
    });

    async function loadCalendarEvents() {
        try {
            const res = await fetch('/api/crm/calendar/events');
            const data = await res.json();

            if (data.success) {
                calendarEvents = data.events;
                renderCalendar();
            }
        } catch (e) {
            console.error('Error loading calendar events:', e);
        }
    }

    function renderCalendar() {
        const viewMode = document.getElementById('calendarViewMode').value;
        currentCalendarView = viewMode;

        if (viewMode === 'monthly') {
            renderMonthlyCalendar();
        } else if (viewMode === 'weekly') {
            renderWeeklyCalendar();
        } else if (viewMode === 'daily') {
            renderDailyCalendar();
        }

        updateCalendarTitle();
    }

    function renderMonthlyCalendar() {
        const monthlyCalendar = document.getElementById('monthlyCalendar');
        const weeklyCalendar = document.getElementById('weeklyCalendar');

        monthlyCalendar.style.display = 'grid';
        weeklyCalendar.style.display = 'none';

        const year = currentCalendarDate.getFullYear();
        const month = currentCalendarDate.getMonth();

        // Get first day of month and number of days
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        const daysInMonth = lastDay.getDate();
        const startDayOfWeek = firstDay.getDay(); // 0 = Sunday

        // Build calendar HTML
        let html = '';

        // Day headers
        const dayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
        dayNames.forEach(day => {
            html += `<div style="background: #f3f4f6; padding: 12px; font-weight: 600; text-align: center; font-size: 14px;">${day}</div>`;
        });

        // Empty cells before first day
        for (let i = 0; i < startDayOfWeek; i++) {
            html += '<div style="background: #fafafa; min-height: 100px;"></div>';
        }

        // Days of month
        for (let day = 1; day <= daysInMonth; day++) {
            const date = new Date(year, month, day);
            const dateStr = date.toISOString().split('T')[0];
            const isToday = dateStr === new Date().toISOString().split('T')[0];
            const isSelected = selectedDate === dateStr;

            // Get events for this day
            const dayEvents = calendarEvents.filter(e => e.start_date === dateStr);

            html += `
                <div onclick="selectCalendarDay('${dateStr}')" style="background: var(--bg-secondary); min-height: 100px; padding: 8px; cursor: pointer; border-left: 3px solid ${isSelected ? '#3b82f6' : 'transparent'}; position: relative;">
                    <div style="font-weight: ${isToday ? '700' : '500'}; color: ${isToday ? '#3b82f6' : 'var(--text-primary)'}; margin-bottom: 4px; font-size: 14px;">
                        ${day}
                        ${isToday ? '<span style="background: #3b82f6; color: white; border-radius: 50%; width: 6px; height: 6px; display: inline-block; margin-left: 4px;"></span>' : ''}
                    </div>
                    <div style="font-size: 11px;">
                        ${dayEvents.slice(0, 3).map(e => `
                            <div style="background: ${e.color || '#3b82f6'}; color: white; padding: 2px 6px; border-radius: 3px; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis;" title="${e.title}">
                                ${e.title}
                            </div>
                        `).join('')}
                        ${dayEvents.length > 3 ? `<div style="color: var(--text-secondary); padding: 2px 6px;">+${dayEvents.length - 3} more</div>` : ''}
                    </div>
                </div>
            `;
        }

        monthlyCalendar.innerHTML = html;
    }

    function renderWeeklyCalendar() {
        const monthlyCalendar = document.getElementById('monthlyCalendar');
        const weeklyCalendar = document.getElementById('weeklyCalendar');
        const weeklyGrid = document.getElementById('weeklyGrid');

        monthlyCalendar.style.display = 'none';
        weeklyCalendar.style.display = 'block';

        // Get week start (Sunday)
        const weekStart = new Date(currentCalendarDate);
        weekStart.setDate(weekStart.getDate() - weekStart.getDay());

        let html = '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; border: 1px solid #e5e7eb;">';

        // Day headers
        const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        for (let i = 0; i < 7; i++) {
            const date = new Date(weekStart);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const isToday = dateStr === new Date().toISOString().split('T')[0];

            html += `
                <div style="background: #f3f4f6; padding: 16px; text-align: center;">
                    <div style="font-weight: 600; font-size: 14px;">${dayNames[i]}</div>
                    <div style="font-size: 24px; font-weight: ${isToday ? '700' : '500'}; color: ${isToday ? '#3b82f6' : '#374151'}; margin-top: 8px;">
                        ${date.getDate()}
                    </div>
                </div>
            `;
        }
        html += '</div>';

        // Events for each day
        html += '<div style="display: grid; grid-template-columns: repeat(7, 1fr); gap: 1px; background: #e5e7eb; border: 1px solid #e5e7eb; margin-top: 1px;">';
        for (let i = 0; i < 7; i++) {
            const date = new Date(weekStart);
            date.setDate(date.getDate() + i);
            const dateStr = date.toISOString().split('T')[0];
            const dayEvents = calendarEvents.filter(e => e.start_date === dateStr);

            html += `
                <div style="background: var(--bg-secondary); min-height: 300px; padding: 12px;">
                    ${dayEvents.map(e => `
                        <div onclick="editCalendarEvent('${e.id}')" style="background: ${e.color || '#3b82f6'}; color: white; padding: 8px; border-radius: 6px; margin-bottom: 8px; cursor: pointer; font-size: 13px;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${e.title}</div>
                            <div style="font-size: 11px; opacity: 0.9;">
                                ${e.start_time || 'All day'}
                                ${e.location ? `<br/>üìç ${e.location}` : ''}
                            </div>
                        </div>
                    `).join('')}
                </div>
            `;
        }
        html += '</div>';

        weeklyGrid.innerHTML = html;
    }

    function renderDailyCalendar() {
        // For daily view, show similar to weekly but just one day
        renderWeeklyCalendar();
    }

    function updateCalendarTitle() {
        const titleEl = document.getElementById('calendarCurrentDate');
        const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];

        if (currentCalendarView === 'monthly') {
            titleEl.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getFullYear()}`;
        } else if (currentCalendarView === 'weekly') {
            const weekStart = new Date(currentCalendarDate);
            weekStart.setDate(weekStart.getDate() - weekStart.getDay());
            const weekEnd = new Date(weekStart);
            weekEnd.setDate(weekEnd.getDate() + 6);
            titleEl.textContent = `${monthNames[weekStart.getMonth()]} ${weekStart.getDate()} - ${monthNames[weekEnd.getMonth()]} ${weekEnd.getDate()}, ${weekStart.getFullYear()}`;
        } else {
            titleEl.textContent = `${monthNames[currentCalendarDate.getMonth()]} ${currentCalendarDate.getDate()}, ${currentCalendarDate.getFullYear()}`;
        }
    }

    function selectCalendarDay(dateStr) {
        selectedDate = dateStr;
        renderCalendar();

        // Show events for selected day
        const dayEvents = calendarEvents.filter(e => e.start_date === dateStr);
        const eventsContainer = document.getElementById('selectedDayEvents');
        const eventsList = document.getElementById('selectedDayEventsList');

        if (dayEvents.length > 0) {
            eventsContainer.style.display = 'block';
            eventsList.innerHTML = dayEvents.map(e => `
                <div style="background: #f9fafb; border-left: 4px solid ${e.color || '#3b82f6'}; padding: 12px; margin-bottom: 8px; border-radius: 6px; cursor: pointer;" onclick="editCalendarEvent('${e.id}')">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${e.title}</div>
                            <div style="font-size: 13px; color: #6b7280;">
                                ${e.start_time || 'All day'}${e.end_time ? ' - ' + e.end_time : ''}
                                ${e.location ? `<br/>üìç ${e.location}` : ''}
                                ${e.description ? `<br/>${e.description}` : ''}
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); deleteCalendarEvent('${e.id}')" class="btn btn-danger btn-small">Delete</button>
                    </div>
                </div>
            `).join('');
        } else {
            eventsContainer.style.display = 'none';
        }
    }

    function changeCalendarView() {
        renderCalendar();
    }

    function calendarToday() {
        currentCalendarDate = new Date();
        selectedDate = null;
        renderCalendar();
    }

    function calendarPrevious() {
        if (currentCalendarView === 'monthly') {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
        } else if (currentCalendarView === 'weekly') {
            currentCalendarDate.setDate(currentCalendarDate.getDate() - 7);
        } else {
            currentCalendarDate.setDate(currentCalendarDate.getDate() - 1);
        }
        renderCalendar();
    }

    function calendarNext() {
        if (currentCalendarView === 'monthly') {
            currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
        } else if (currentCalendarView === 'weekly') {
            currentCalendarDate.setDate(currentCalendarDate.getDate() + 7);
        } else {
            currentCalendarDate.setDate(currentCalendarDate.getDate() + 1);
        }
        renderCalendar();
    }

    // openEventModal moved to first script block


    function populateEventLinkingDropdowns() {
        // Jobs
        const jobsSelect = document.getElementById('eventLinkedJob');
        if (jobsSelect && window.allJobs) {
            jobsSelect.innerHTML = '<option value="">-- No Job Linked --</option>';
            window.allJobs.forEach(job => {
                const opt = document.createElement('option');
                opt.value = job.id;
                opt.textContent = `${job.name || job.title || 'Job #' + job.id}`;
                jobsSelect.appendChild(opt);
            });
        }

        // Quotes
        const quotesSelect = document.getElementById('eventLinkedQuote');
        if (quotesSelect && window.allQuotes) {
            quotesSelect.innerHTML = '<option value="">-- No Quote Linked --</option>';
            window.allQuotes.forEach(quote => {
                const opt = document.createElement('option');
                opt.value = quote.id;
                opt.textContent = `Quote #${quote.id} - ${quote.customer_name || ''}`;
                quotesSelect.appendChild(opt);
            });
        }

        // Customers
        const customersSelect = document.getElementById('eventLinkedCustomer');
        if (customersSelect && window.allCustomers) {
            customersSelect.innerHTML = '<option value="">-- No Customer Linked --</option>';
            window.allCustomers.forEach(customer => {
                const opt = document.createElement('option');
                opt.value = customer.id;
                opt.textContent = customer.name || `Customer #${customer.id}`;
                customersSelect.appendChild(opt);
            });
        }

        // Projects
        const projectsSelect = document.getElementById('eventLinkedProject');
        if (projectsSelect && window.allProjects) {
            projectsSelect.innerHTML = '<option value="">-- No Project Linked --</option>';
            window.allProjects.forEach(project => {
                const opt = document.createElement('option');
                opt.value = project.id;
                opt.textContent = project.name || `Project #${project.id}`;
                projectsSelect.appendChild(opt);
            });
        }

        // People
        const peopleSelect = document.getElementById('eventLinkedPerson');
        if (peopleSelect && window.allPeople) {
            peopleSelect.innerHTML = '<option value="">-- No Person Linked --</option>';
            window.allPeople.forEach(person => {
                const opt = document.createElement('option');
                opt.value = person.id;
                opt.textContent = `${person.name || ''} (${person.type || ''})`.trim();
                peopleSelect.appendChild(opt);
            });
        }
    }

    function editCalendarEvent(id) {
        fetch(`/api/crm/calendar/events/${id}`)
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    const e = data.event;
                    document.getElementById('eventId').value = e.id;
                    document.getElementById('eventTitle').value = e.title;
                    document.getElementById('eventType').value = e.type || 'event';
                    document.getElementById('eventStartDate').value = e.start_date;
                    document.getElementById('eventStartTime').value = e.start_time || '';
                    document.getElementById('eventEndDate').value = e.end_date || '';
                    document.getElementById('eventEndTime').value = e.end_time || '';
                    document.getElementById('eventAllDay').checked = e.all_day || false;
                    document.getElementById('eventRecurrence').value = e.recurrence || 'none';
                    document.getElementById('eventLocation').value = e.location || '';
                    document.getElementById('eventDescription').value = e.description || '';
                    document.getElementById('eventColor').value = e.color || '#3b82f6';
                    document.getElementById('eventReminder').value = e.reminder_minutes || '0';

                    document.querySelector('#eventModal h2').textContent = 'Edit Event';
                    openModal('eventModal');
                }
            });
    }

    async function saveCalendarEvent(e) {
        e.preventDefault();
        const id = document.getElementById('eventId').value;

        const data = {
            title: document.getElementById('eventTitle').value,
            type: document.getElementById('eventType').value,
            start_date: document.getElementById('eventStartDate').value,
            start_time: document.getElementById('eventStartTime').value,
            end_date: document.getElementById('eventEndDate').value || document.getElementById('eventStartDate').value,
            end_time: document.getElementById('eventEndTime').value,
            all_day: document.getElementById('eventAllDay').checked,
            recurrence: document.getElementById('eventRecurrence').value,
            location: document.getElementById('eventLocation').value,
            description: document.getElementById('eventDescription').value,
            color: document.getElementById('eventColor').value,
            reminder_minutes: parseInt(document.getElementById('eventReminder').value) || 0,
            linked_job_id: document.getElementById('eventLinkedJob')?.value || null,
            linked_quote_id: document.getElementById('eventLinkedQuote')?.value || null,
            linked_customer_id: document.getElementById('eventLinkedCustomer')?.value || null,
            linked_project_id: document.getElementById('eventLinkedProject')?.value || null,
            linked_person_id: document.getElementById('eventLinkedPerson')?.value || null
        };

        try {
            const url = id ? `/api/crm/calendar/events/${id}` : '/api/crm/calendar/events';
            const res = await fetch(url, {
                method: id ? 'PUT' : 'POST',
                headers: {'Content-Type': 'application/json'},
                body: JSON.stringify(data)
            });
            const result = await res.json();

            if (result.success) {
                closeModal('eventModal');
                await loadCalendarEvents();
                showToast('Event saved successfully!', 'success');
            } else {
                showToast('Error saving: ' + result.error, 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    async function deleteCalendarEvent(id) {
        if (!confirm('Are you sure you want to delete this event?')) return;

        try {
            const res = await fetch(`/api/crm/calendar/events/${id}`, {method: 'DELETE'});
            const result = await res.json();

            if (result.success) {
                await loadCalendarEvents();
                showToast('Event deleted successfully', 'success');
            } else {
                showToast('Error deleting: ' + result.error, 'error');
            }
        } catch (err) {
            showToast('Error: ' + err.message, 'error');
        }
    }

    function syncGoogleCalendar() {
        showToast('Google Calendar sync will be available after connecting your Google account', 'info');
        // This will be implemented when Google Calendar integration is set up
    }

    // ============================================================================
    // QUICK ADD TO CALENDAR FUNCTIONS
    // ============================================================================

    function addJobToCalendar(jobId, jobName, startDate, dueDate) {
        // Pre-fill event modal with job details
        document.getElementById('eventId').value = '';
        document.getElementById('eventTitle').value = `Job: ${jobName}`;
        document.getElementById('eventType').value = 'job';
        document.getElementById('eventStartDate').value = startDate || new Date().toISOString().split('T')[0];
        document.getElementById('eventStartTime').value = '09:00';
        document.getElementById('eventEndDate').value = dueDate || startDate || new Date().toISOString().split('T')[0];
        document.getElementById('eventEndTime').value = '17:00';
        document.getElementById('eventAllDay').checked = false;
        document.getElementById('eventRecurrence').value = 'none';
        document.getElementById('eventLocation').value = '';
        document.getElementById('eventDescription').value = `Scheduled work for job: ${jobName}`;
        document.getElementById('eventColor').value = '#10b981'; // Green for jobs
        document.getElementById('eventReminder').value = '60'; // 1 hour reminder

        document.querySelector('#eventModal h2').textContent = 'Schedule Job in Calendar';
        openModal('eventModal');
        showToast('Job details loaded - adjust and save to calendar', 'info');
    }

    function addPersonToCalendar(personId, personName, personType) {
        // Pre-fill event modal for meeting with person
        const typeLabels = {
            'customer': 'Customer Meeting',
            'supplier': 'Supplier Meeting',
            'contractor': 'Contractor Meeting',
            'employee': 'Employee Meeting',
            'contact': 'Meeting'
        };

        document.getElementById('eventId').value = '';
        document.getElementById('eventTitle').value = `${typeLabels[personType]}: ${personName}`;
        document.getElementById('eventType').value = 'meeting';
        document.getElementById('eventStartDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('eventStartTime').value = '10:00';
        document.getElementById('eventEndDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('eventEndTime').value = '11:00';
        document.getElementById('eventAllDay').checked = false;
        document.getElementById('eventRecurrence').value = 'none';
        document.getElementById('eventLocation').value = '';
        document.getElementById('eventDescription').value = `Meeting with ${personName}`;
        document.getElementById('eventColor').value = '#3b82f6'; // Blue for meetings
        document.getElementById('eventReminder').value = '30'; // 30 min reminder

        document.querySelector('#eventModal h2').textContent = 'Schedule Meeting';
        openModal('eventModal');
        showToast('Meeting details loaded - adjust and save to calendar', 'info');
    }

    function addPaymentToCalendar(paymentId, amount, dueDate, direction) {
        // Pre-fill event modal for payment reminder
        const directionLabel = direction === 'to_suppliers' ? 'Payment to Supplier' : 'Payment Due';
        const amountFormatted = parseFloat(amount).toLocaleString();

        document.getElementById('eventId').value = '';
        document.getElementById('eventTitle').value = `${directionLabel}: $${amountFormatted}`;
        document.getElementById('eventType').value = 'reminder';
        document.getElementById('eventStartDate').value = dueDate || new Date().toISOString().split('T')[0];
        document.getElementById('eventStartTime').value = '09:00';
        document.getElementById('eventEndDate').value = dueDate || new Date().toISOString().split('T')[0];
        document.getElementById('eventEndTime').value = '';
        document.getElementById('eventAllDay').checked = true;
        document.getElementById('eventRecurrence').value = 'none';
        document.getElementById('eventLocation').value = '';
        document.getElementById('eventDescription').value = `Payment reminder: $${amountFormatted} ${direction === 'to_suppliers' ? 'to supplier' : 'due from customer'}`;
        document.getElementById('eventColor').value = '#f59e0b'; // Orange for payment reminders
        document.getElementById('eventReminder').value = '1440'; // 1 day reminder

        document.querySelector('#eventModal h2').textContent = 'Schedule Payment Reminder';
        openModal('eventModal');
        showToast('Payment reminder loaded - adjust and save to calendar', 'info');
    }

    // initDarkMode moved to top of script block (line ~4797) for proper initialization order

</script>

<!-- Footer -->
<footer style="text-align: center; padding: 20px; color: var(--text-secondary); font-size: 12px; font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; transition: color 0.3s ease;">
    ¬© 2025 Integratd Living. All rights reserved.
</footer>

<!-- AI Assistant Chatbot -->
{% include 'chatbot_component.html' %}

</body>
</html>

/**
 * Multi-Page PDF Export System
 * Professional PDF generation for complete electrical projects
 * Exports all sheets, schedules, and documentation
 */

/**
 * Export all sheets to a single PDF document
 */
async function exportAllSheetsToPDF() {
    console.log('ðŸ“„ Exporting all sheets to PDF...');

    if (typeof jsPDF === 'undefined') {
        alert('PDF library not loaded. Please refresh the page.');
        return;
    }

    // Show loading overlay
    showLoadingOverlay('Generating Multi-Page PDF...');

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a3' // A3 size for electrical drawings
        });

        let isFirstPage = true;

        // Add cover page
        addCoverPage(pdf);
        isFirstPage = false;

        // Add table of contents
        pdf.addPage();
        addTableOfContents(pdf, sheets);

        // Export each sheet
        for (let i = 0; i < sheets.length; i++) {
            const sheet = sheets[i];

            // Add new page
            pdf.addPage();

            // Switch to this sheet temporarily to export it
            const originalSheet = currentSheetIndex;
            switchToSheet(i);

            // Wait for canvas to render
            await new Promise(resolve => setTimeout(resolve, 500));

            // Add sheet to PDF
            await addSheetToPDF(pdf, sheet, i + 1, sheets.length);

            // Restore original sheet
            switchToSheet(originalSheet);
        }

        // Add panel schedule if exists
        const panelScheduleData = await generatePanelScheduleData();
        if (panelScheduleData && panelScheduleData.length > 0) {
            pdf.addPage();
            addPanelSchedulePage(pdf, panelScheduleData);
        }

        // Add cable schedule if exists
        const cableScheduleData = await generateCableScheduleData();
        if (cableScheduleData && cableScheduleData.length > 0) {
            pdf.addPage();
            addCableSchedulePage(pdf, cableScheduleData);
        }

        // Save PDF
        const projectName = document.getElementById('projectName')?.value || 'Electrical_Project';
        const fileName = `${projectName.replace(/[^a-z0-9]/gi, '_')}_Complete.pdf`;

        pdf.save(fileName);

        hideLoadingOverlay();
        showNotification(`âœ… PDF exported successfully: ${fileName}`);

    } catch (error) {
        console.error('PDF export error:', error);
        hideLoadingOverlay();
        alert('Error exporting PDF: ' + error.message);
    }
}

/**
 * Add cover page to PDF
 */
function addCoverPage(pdf) {
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // Title
    pdf.setFontSize(32);
    pdf.setFont(undefined, 'bold');
    pdf.text('ELECTRICAL CAD DRAWINGS', pageWidth / 2, 60, { align: 'center' });

    // Project info
    pdf.setFontSize(20);
    pdf.setFont(undefined, 'normal');
    const projectName = document.getElementById('projectName')?.value || 'Untitled Project';
    pdf.text(projectName, pageWidth / 2, 90, { align: 'center' });

    // Drawing info
    pdf.setFontSize(14);
    const drawingNumber = document.getElementById('drawingNumber')?.value || 'E-001';
    pdf.text(`Drawing Number: ${drawingNumber}`, pageWidth / 2, 110, { align: 'center' });

    const scale = document.getElementById('scale')?.value || '1:100';
    pdf.text(`Scale: ${scale}`, pageWidth / 2, 125, { align: 'center' });

    // Date
    const today = new Date().toLocaleDateString();
    pdf.text(`Date: ${today}`, pageWidth / 2, 140, { align: 'center' });

    // Standards compliance
    pdf.setFontSize(12);
    pdf.text('Standards Compliance:', pageWidth / 2, 170, { align: 'center' });
    pdf.setFontSize(10);
    pdf.text('AS/NZS 3000:2018 - Electrical Installations', pageWidth / 2, 180, { align: 'center' });
    pdf.text('AS/NZS 3008.1.1 - Cable Selection', pageWidth / 2, 188, { align: 'center' });
    pdf.text('AS/NZS 1100.101 - Technical Drawing Standards', pageWidth / 2, 196, { align: 'center' });

    // Footer
    pdf.setFontSize(8);
    pdf.setTextColor(128, 128, 128);
    pdf.text('Generated by Integrated Living Electrical CAD Designer', pageWidth / 2, pageHeight - 10, { align: 'center' });
    pdf.setTextColor(0, 0, 0);
}

/**
 * Add table of contents
 */
function addTableOfContents(pdf, sheets) {
    const pageWidth = pdf.internal.pageSize.getWidth();

    pdf.setFontSize(24);
    pdf.setFont(undefined, 'bold');
    pdf.text('TABLE OF CONTENTS', pageWidth / 2, 30, { align: 'center' });

    pdf.setFontSize(12);
    pdf.setFont(undefined, 'normal');

    let yPos = 50;
    let pageNum = 3; // Start after cover and TOC

    // Sheets
    pdf.setFont(undefined, 'bold');
    pdf.text('Electrical Drawings', 20, yPos);
    yPos += 10;

    pdf.setFont(undefined, 'normal');
    sheets.forEach((sheet, index) => {
        pdf.text(`${index + 1}. ${sheet.name}`, 30, yPos);
        pdf.text(`Page ${pageNum}`, pageWidth - 30, yPos, { align: 'right' });
        yPos += 8;
        pageNum++;
    });

    // Schedules
    yPos += 10;
    pdf.setFont(undefined, 'bold');
    pdf.text('Schedules & Documentation', 20, yPos);
    yPos += 10;

    pdf.setFont(undefined, 'normal');
    pdf.text('Panel Schedule', 30, yPos);
    pdf.text(`Page ${pageNum}`, pageWidth - 30, yPos, { align: 'right' });
    yPos += 8;
    pageNum++;

    pdf.text('Cable Schedule', 30, yPos);
    pdf.text(`Page ${pageNum}`, pageWidth - 30, yPos, { align: 'right' });
}

/**
 * Add individual sheet to PDF
 */
async function addSheetToPDF(pdf, sheet, pageNumber, totalPages) {
    const pageWidth = pdf.internal.pageSize.getWidth();
    const pageHeight = pdf.internal.pageSize.getHeight();

    // Header
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'bold');
    pdf.text(sheet.name, 15, 15);

    pdf.setFont(undefined, 'normal');
    pdf.text(`Page ${pageNumber} of ${totalPages}`, pageWidth - 15, 15, { align: 'right' });

    // Export canvas as image
    const dataURL = canvas.toDataURL({
        format: 'png',
        quality: 1.0,
        multiplier: 2 // High resolution
    });

    // Calculate dimensions to fit on page (with margins)
    const margin = 20;
    const availableWidth = pageWidth - (margin * 2);
    const availableHeight = pageHeight - (margin * 3); // Extra margin for header/footer

    // Add image to PDF
    pdf.addImage(dataURL, 'PNG', margin, margin + 10, availableWidth, availableHeight);

    // Footer
    pdf.setFontSize(8);
    pdf.setTextColor(128, 128, 128);
    const projectName = document.getElementById('projectName')?.value || 'Untitled Project';
    const drawingNumber = document.getElementById('drawingNumber')?.value || 'E-001';
    const today = new Date().toLocaleDateString();

    pdf.text(`${projectName} | ${drawingNumber} | ${today}`, pageWidth / 2, pageHeight - 10, { align: 'center' });
    pdf.setTextColor(0, 0, 0);
}

/**
 * Add panel schedule page
 */
function addPanelSchedulePage(pdf, scheduleData) {
    const pageWidth = pdf.internal.pageSize.getWidth();

    // Header
    pdf.setFontSize(20);
    pdf.setFont(undefined, 'bold');
    pdf.text('ELECTRICAL PANEL SCHEDULE', pageWidth / 2, 20, { align: 'center' });

    // Summary
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'normal');
    const totalLoad = scheduleData.reduce((sum, c) => sum + c.load_watts, 0);
    const totalAmps = scheduleData.reduce((sum, c) => sum + parseFloat(c.load_amps), 0);

    pdf.text(`Total Circuits: ${scheduleData.length}`, 20, 35);
    pdf.text(`Total Load: ${totalLoad.toFixed(0)}W (${totalAmps.toFixed(2)}A)`, 20, 42);
    pdf.text(`Main Breaker Required: ${Math.ceil(totalAmps * 1.25)}A (with 25% margin)`, 20, 49);
    pdf.text(`Standard: AS/NZS 3000:2018`, 20, 56);

    // Table
    const headers = ['Cct#', 'Description', 'Devices', 'Load (W)', 'Load (A)', 'Cable', 'Breaker', 'RCD', 'V.Drop', 'âœ“'];
    const rows = scheduleData.map(c => [
        c.circuit_number,
        c.description,
        c.device_count,
        c.load_watts,
        c.load_amps,
        c.cable_size + 'mmÂ²',
        c.breaker_rating + 'A',
        c.rcd_required ? '30mA' : 'â€”',
        c.voltage_drop || 'N/A',
        c.compliant ? 'âœ“' : 'âš '
    ]);

    pdf.autoTable({
        head: [headers],
        body: rows,
        startY: 65,
        theme: 'grid',
        headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [248, 249, 250] },
        margin: { left: 15, right: 15 }
    });
}

/**
 * Add cable schedule page
 */
function addCableSchedulePage(pdf, scheduleData) {
    const pageWidth = pdf.internal.pageSize.getWidth();

    // Header
    pdf.setFontSize(20);
    pdf.setFont(undefined, 'bold');
    pdf.text('CABLE SCHEDULE', pageWidth / 2, 20, { align: 'center' });

    // Summary
    pdf.setFontSize(10);
    pdf.setFont(undefined, 'normal');
    const totalLength = scheduleData.reduce((sum, item) => sum + parseFloat(item.route_length), 0);
    const totalCables = scheduleData.reduce((sum, item) => sum + item.cable_count, 0);

    pdf.text(`Total Cable Types: ${scheduleData.length}`, 20, 35);
    pdf.text(`Total Cable Runs: ${totalCables}`, 20, 42);
    pdf.text(`Total Length: ${totalLength.toFixed(1)}m`, 20, 49);
    pdf.text(`Standards: AS/NZS 3008.1.1, AS/NZS 5000.1`, 20, 56);

    // Table
    const headers = ['#', 'Type', 'Description', 'Size', 'Cores', 'Color', 'Length', 'Runs', 'Rating'];
    const rows = scheduleData.map(c => [
        c.item,
        c.cable_type,
        c.description,
        c.size + 'mmÂ²',
        c.cores,
        c.color,
        c.route_length + 'm',
        c.cable_count,
        c.current_rating + 'A'
    ]);

    pdf.autoTable({
        head: [headers],
        body: rows,
        startY: 65,
        theme: 'grid',
        headStyles: { fillColor: [44, 62, 80], textColor: 255, fontStyle: 'bold' },
        alternateRowStyles: { fillColor: [248, 249, 250] },
        margin: { left: 15, right: 15 },
        styles: { fontSize: 9 }
    });
}

/**
 * Helper function to get panel schedule data
 */
async function generatePanelScheduleData() {
    try {
        const devices = collectDevicesFromCanvas();
        if (devices.length === 0) return null;

        const circuits = groupDevicesByCircuit(devices);
        const schedule = await calculateCircuitParameters(circuits);

        return schedule;
    } catch (error) {
        console.error('Error generating panel schedule:', error);
        return null;
    }
}

/**
 * Helper function to get cable schedule data
 */
async function generateCableScheduleData() {
    try {
        const cables = collectCablesFromCanvas();
        if (cables.length === 0) return null;

        const schedule = await analyzeCables(cables);

        return schedule;
    } catch (error) {
        console.error('Error generating cable schedule:', error);
        return null;
    }
}

/**
 * Show/hide loading overlay
 */
function showLoadingOverlay(message) {
    let overlay = document.getElementById('pdfLoadingOverlay');

    if (!overlay) {
        overlay = document.createElement('div');
        overlay.id = 'pdfLoadingOverlay';
        overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 10000; display: flex; align-items: center; justify-content: center;';

        const content = document.createElement('div');
        content.style.cssText = 'text-align: center; color: white;';
        content.innerHTML = `
            <div style="width: 60px; height: 60px; border: 4px solid #34495e; border-top-color: #3498db; border-radius: 50%; margin: 0 auto 20px; animation: spin 1s linear infinite;"></div>
            <div id="pdfLoadingText" style="font-size: 1.2em; margin-bottom: 10px;">${message}</div>
            <div style="font-size: 0.9em; color: #95a5a6;">This may take a moment...</div>
        `;

        overlay.appendChild(content);
        document.body.appendChild(overlay);
    } else {
        overlay.style.display = 'flex';
        document.getElementById('pdfLoadingText').textContent = message;
    }
}

function hideLoadingOverlay() {
    const overlay = document.getElementById('pdfLoadingOverlay');
    if (overlay) {
        overlay.style.display = 'none';
    }
}

/**
 * Show success notification
 */
function showNotification(message) {
    const notification = document.createElement('div');
    notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: #27ae60; color: white; padding: 15px 20px; border-radius: 4px; box-shadow: 0 4px 12px rgba(0,0,0,0.3); z-index: 10001; font-size: 14px;';
    notification.textContent = message;

    document.body.appendChild(notification);

    setTimeout(() => {
        notification.remove();
    }, 5000);
}

/**
 * Export current sheet only to PDF
 */
function exportCurrentSheetToPDF() {
    console.log('ðŸ“„ Exporting current sheet to PDF...');

    if (typeof jsPDF === 'undefined') {
        alert('PDF library not loaded. Please refresh the page.');
        return;
    }

    try {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF({
            orientation: 'landscape',
            unit: 'mm',
            format: 'a3'
        });

        const pageWidth = pdf.internal.pageSize.getWidth();
        const pageHeight = pdf.internal.pageSize.getHeight();

        // Header
        const currentSheet = sheets[currentSheetIndex];
        pdf.setFontSize(12);
        pdf.setFont(undefined, 'bold');
        pdf.text(currentSheet.name, 15, 15);

        const projectName = document.getElementById('projectName')?.value || 'Untitled Project';
        pdf.text(projectName, pageWidth - 15, 15, { align: 'right' });

        // Export canvas
        const dataURL = canvas.toDataURL({
            format: 'png',
            quality: 1.0,
            multiplier: 2
        });

        const margin = 20;
        const availableWidth = pageWidth - (margin * 2);
        const availableHeight = pageHeight - (margin * 3);

        pdf.addImage(dataURL, 'PNG', margin, margin + 10, availableWidth, availableHeight);

        // Footer
        pdf.setFontSize(8);
        pdf.setTextColor(128, 128, 128);
        const drawingNumber = document.getElementById('drawingNumber')?.value || 'E-001';
        const today = new Date().toLocaleDateString();
        pdf.text(`${drawingNumber} | ${today}`, pageWidth / 2, pageHeight - 10, { align: 'center' });

        // Save
        const fileName = `${currentSheet.name.replace(/[^a-z0-9]/gi, '_')}.pdf`;
        pdf.save(fileName);

        showNotification(`âœ… PDF exported: ${fileName}`);

    } catch (error) {
        console.error('PDF export error:', error);
        alert('Error exporting PDF: ' + error.message);
    }
}
